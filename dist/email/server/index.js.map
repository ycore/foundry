{"version":3,"file":"index.js","sources":["../../../src/email/server/email.middleware.ts","../../../src/email/server/email.service.ts","../../../src/email/server/render-email.ts"],"sourcesContent":["import { setContext } from '@ycore/forge/context';\nimport type { MiddlewareFunction } from 'react-router';\nimport { emailContext } from '@ycore/foundry/email';\nimport type { EmailConfig } from '../@types/email.types';\n\n/**\n * Email configuration middleware\n *\n * Injects email configuration into React Router context for use by email services.\n * This eliminates prop-drilling of email config through function parameters.\n */\nexport function emailConfigMiddleware(emailConfig: EmailConfig): MiddlewareFunction<Response> {\n  return async ({ context }, next) => {\n    setContext(context, emailContext, emailConfig);\n    return next();\n  };\n}\n","import { getContext } from '@ycore/forge/context';\nimport { logger } from '@ycore/forge/logger';\nimport { err, flattenError, isError, ok, type Result } from '@ycore/forge/result';\nimport { getBindings } from '@ycore/forge/services';\nimport type { RouterContextProvider } from 'react-router';\nimport { createEmailProvider, defaultEmailConfig, emailContext, getProviderConfig } from '@ycore/foundry/email';\nimport type { EmailProviderConfig, SendMailOptions } from '../@types/email.types';\n\n/**\n * Send email with cascading configuration fallback\n *\n * This is the primary email sending function for the application.\n * It implements a predictable configuration cascade:\n * 1. Provided options (highest priority)\n * 2. Email context from middleware\n * 3. Default email config (lowest priority)\n */\nexport async function sendMail(context: Readonly<RouterContextProvider>, options: SendMailOptions): Promise<Result<void>> {\n  try {\n    const { to, template, from: optionsFrom, provider: optionsProvider, apiKey: optionsApiKey } = options;\n\n    // Get email config from context (may be null if middleware not configured)\n    const emailConfig = getContext(context, emailContext, null);\n    const provider = optionsProvider || emailConfig?.active || defaultEmailConfig.active;\n\n    if (!provider) {\n      logger.error('email_no_provider', { optionsProvider, contextActive: emailConfig?.active, defaultActive: defaultEmailConfig.active, to });\n      return err('No email provider configured');\n    }\n\n    // Get provider config with cascading fallback\n    const providerConfig = (emailConfig && getProviderConfig(emailConfig, provider)) || getProviderConfig(defaultEmailConfig, provider);\n    if (!providerConfig) {\n      logger.error('email_provider_config_missing', { provider, to, contextProviders: emailConfig?.providers.map((p: EmailProviderConfig) => p.name) });\n      return err(`Provider configuration not found for: ${provider}`);\n    }\n\n    // Determine apiKey with cascading fallback\n    let apiKey = optionsApiKey;\n    if (!apiKey && providerConfig.apiKey) {\n      const bindings = getBindings(context);\n      apiKey = bindings[providerConfig.apiKey as keyof typeof bindings] as string | undefined;\n    }\n\n    // Determine from address with cascading fallback\n    const from = optionsFrom || providerConfig.sendFrom;\n\n    // Create email provider instance\n    const emailProviderResult = createEmailProvider(provider);\n    if (isError(emailProviderResult)) {\n      logger.error('email_provider_creation_failed', { provider, to, error: flattenError(emailProviderResult) });\n      return emailProviderResult;\n    }\n\n    // Send email\n    const sendResult = await emailProviderResult.sendEmail({\n      apiKey: apiKey || '',\n      to,\n      from,\n      template: {\n        subject: template.subject,\n        text: template.text,\n        html: template.html,\n      },\n    });\n\n    if (isError(sendResult)) {\n      logger.error('email_send_failed', { to, from, provider, error: flattenError(sendResult) });\n      return sendResult;\n    }\n\n    return ok(undefined);\n  } catch (error) {\n    logger.error('email_send_unexpected_error', { to: options.to, error: error });\n    return err('Failed to send email', { error });\n  }\n}\n","/**\n * Email Template Renderer\n *\n * This file provides the rendering interface for email templates\n * using the new custom email components system.\n */\n\nimport { type EmailRenderOptions, type EmailTemplatePropsWithSubject as NewEmailTemplatePropsWithSubject, renderEmail } from '@ycore/componentry/email/server';\nimport type { EmailTemplate } from '../@types/email.types';\nimport type { EmailTemplateObject } from '../@types/email-template-builder';\n\n/**\n * Generic email template renderer - handles rendering React email templates to HTML and plaintext\n *\n * Accepts EmailTemplateObject created by defineEmailTemplate() and renders it with the provided data.\n * Automatically extracts subject from the template definition and applies Tailwind styles map.\n *\n * @example\n * ```typescript\n * const email = await renderEmailTemplate(ContactEmailTemplate, {\n *   name: 'John Doe',\n *   email: 'john@example.com',\n *   message: 'Hello!',\n *   origin: 'https://example.com',\n * });\n * ```\n */\nexport async function renderEmailTemplate<TData>(template: EmailTemplateObject<TData>, data: TData, options?: EmailRenderOptions): Promise<EmailTemplate> {\n  // Use the new renderEmail function from custom components\n  const result = await renderEmail(\n    template.component,\n    {\n      ...data,\n      subject: template.subject,\n    } as NewEmailTemplatePropsWithSubject<TData>,\n    {\n      ...options,\n      tailwindStylesMap: template.stylesMap ?? options?.tailwindStylesMap,\n    }\n  );\n\n  return {\n    subject: result.subject || '',\n    html: result.html,\n    text: result.text,\n  };\n}\n"],"names":[],"mappings":";;;;;;AAWO,SAAS,sBAAsB,aAAwD;AAC5F,SAAO,OAAO,EAAE,QAAA,GAAW,SAAS;AAClC,eAAW,SAAS,cAAc,WAAW;AAC7C,WAAO,KAAA;AAAA,EACT;AACF;ACCA,eAAsB,SAAS,SAA0C,SAAiD;AACxH,MAAI;AACF,UAAM,EAAE,IAAI,UAAU,MAAM,aAAa,UAAU,iBAAiB,QAAQ,cAAA,IAAkB;AAG9F,UAAM,cAAc,WAAW,SAAS,cAAc,IAAI;AAC1D,UAAM,WAAW,mBAAmB,aAAa,UAAU,mBAAmB;AAE9E,QAAI,CAAC,UAAU;AACb,aAAO,MAAM,qBAAqB,EAAE,iBAAiB,eAAe,aAAa,QAAQ,eAAe,mBAAmB,QAAQ,GAAA,CAAI;AACvI,aAAO,IAAI,8BAA8B;AAAA,IAC3C;AAGA,UAAM,iBAAkB,eAAe,kBAAkB,aAAa,QAAQ,KAAM,kBAAkB,oBAAoB,QAAQ;AAClI,QAAI,CAAC,gBAAgB;AACnB,aAAO,MAAM,iCAAiC,EAAE,UAAU,IAAI,kBAAkB,aAAa,UAAU,IAAI,CAAC,MAA2B,EAAE,IAAI,GAAG;AAChJ,aAAO,IAAI,yCAAyC,QAAQ,EAAE;AAAA,IAChE;AAGA,QAAI,SAAS;AACb,QAAI,CAAC,UAAU,eAAe,QAAQ;AACpC,YAAM,WAAW,YAAY,OAAO;AACpC,eAAS,SAAS,eAAe,MAA+B;AAAA,IAClE;AAGA,UAAM,OAAO,eAAe,eAAe;AAG3C,UAAM,sBAAsB,oBAAoB,QAAQ;AACxD,QAAI,QAAQ,mBAAmB,GAAG;AAChC,aAAO,MAAM,kCAAkC,EAAE,UAAU,IAAI,OAAO,aAAa,mBAAmB,GAAG;AACzG,aAAO;AAAA,IACT;AAGA,UAAM,aAAa,MAAM,oBAAoB,UAAU;AAAA,MACrD,QAAQ,UAAU;AAAA,MAClB;AAAA,MACA;AAAA,MACA,UAAU;AAAA,QACR,SAAS,SAAS;AAAA,QAClB,MAAM,SAAS;AAAA,QACf,MAAM,SAAS;AAAA,MAAA;AAAA,IACjB,CACD;AAED,QAAI,QAAQ,UAAU,GAAG;AACvB,aAAO,MAAM,qBAAqB,EAAE,IAAI,MAAM,UAAU,OAAO,aAAa,UAAU,GAAG;AACzF,aAAO;AAAA,IACT;AAEA,WAAO,GAAG,MAAS;AAAA,EACrB,SAAS,OAAO;AACd,WAAO,MAAM,+BAA+B,EAAE,IAAI,QAAQ,IAAI,OAAc;AAC5E,WAAO,IAAI,wBAAwB,EAAE,OAAO;AAAA,EAC9C;AACF;ACjDA,eAAsB,oBAA2B,UAAsC,MAAa,SAAsD;AAExJ,QAAM,SAAS,MAAM;AAAA,IACnB,SAAS;AAAA,IACT;AAAA,MACE,GAAG;AAAA,MACH,SAAS,SAAS;AAAA,IAAA;AAAA,IAEpB;AAAA,MACE,GAAG;AAAA,MACH,mBAAmB,SAAS,aAAa,SAAS;AAAA,IAAA;AAAA,EACpD;AAGF,SAAO;AAAA,IACL,SAAS,OAAO,WAAW;AAAA,IAC3B,MAAM,OAAO;AAAA,IACb,MAAM,OAAO;AAAA,EAAA;AAEjB;"}