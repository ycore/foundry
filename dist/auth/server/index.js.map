{"version":3,"file":"index.js","sources":["../../../src/auth/server/auth.context.ts","../../../src/auth/auth.config.ts","../../../../../node_modules/.bun/@react-router+cloudflare@7.9.4+9d8362929d289c67/node_modules/@react-router/cloudflare/dist/index.mjs","../../../src/auth/server/session.ts","../../../src/auth/server/auth.middleware.ts","../../../src/auth/server/auth.validation.ts","../../../../../node_modules/.bun/drizzle-orm@0.44.6/node_modules/drizzle-orm/entity.js","../../../../../node_modules/.bun/drizzle-orm@0.44.6/node_modules/drizzle-orm/column.js","../../../../../node_modules/.bun/drizzle-orm@0.44.6/node_modules/drizzle-orm/column-builder.js","../../../../../node_modules/.bun/drizzle-orm@0.44.6/node_modules/drizzle-orm/table.utils.js","../../../../../node_modules/.bun/drizzle-orm@0.44.6/node_modules/drizzle-orm/pg-core/columns/enum.js","../../../../../node_modules/.bun/drizzle-orm@0.44.6/node_modules/drizzle-orm/subquery.js","../../../../../node_modules/.bun/drizzle-orm@0.44.6/node_modules/drizzle-orm/tracing.js","../../../../../node_modules/.bun/drizzle-orm@0.44.6/node_modules/drizzle-orm/view-common.js","../../../../../node_modules/.bun/drizzle-orm@0.44.6/node_modules/drizzle-orm/table.js","../../../../../node_modules/.bun/drizzle-orm@0.44.6/node_modules/drizzle-orm/sql/sql.js","../../../../../node_modules/.bun/drizzle-orm@0.44.6/node_modules/drizzle-orm/utils.js","../../../../../node_modules/.bun/drizzle-orm@0.44.6/node_modules/drizzle-orm/sql/expressions/conditions.js","../../../../../node_modules/.bun/drizzle-orm@0.44.6/node_modules/drizzle-orm/sqlite-core/foreign-keys.js","../../../../../node_modules/.bun/drizzle-orm@0.44.6/node_modules/drizzle-orm/sqlite-core/unique-constraint.js","../../../../../node_modules/.bun/drizzle-orm@0.44.6/node_modules/drizzle-orm/sqlite-core/columns/common.js","../../../../../node_modules/.bun/drizzle-orm@0.44.6/node_modules/drizzle-orm/sqlite-core/columns/blob.js","../../../../../node_modules/.bun/drizzle-orm@0.44.6/node_modules/drizzle-orm/sqlite-core/columns/custom.js","../../../../../node_modules/.bun/drizzle-orm@0.44.6/node_modules/drizzle-orm/sqlite-core/columns/integer.js","../../../../../node_modules/.bun/drizzle-orm@0.44.6/node_modules/drizzle-orm/sqlite-core/columns/numeric.js","../../../../../node_modules/.bun/drizzle-orm@0.44.6/node_modules/drizzle-orm/sqlite-core/columns/real.js","../../../../../node_modules/.bun/drizzle-orm@0.44.6/node_modules/drizzle-orm/sqlite-core/columns/text.js","../../../../../node_modules/.bun/drizzle-orm@0.44.6/node_modules/drizzle-orm/sqlite-core/columns/all.js","../../../../../node_modules/.bun/drizzle-orm@0.44.6/node_modules/drizzle-orm/sqlite-core/table.js","../../../src/auth/schema/schema.ts","../../../src/auth/server/repository.ts","../../../src/auth/server/auth-profile.ts","../../../src/email/email.context.ts","../../../src/email/email.config.ts","../../../src/email/providers/base-provider.ts","../../../src/email/providers/local-dev.ts","../../../src/email/providers/mailchannels.ts","../../../src/email/providers/resend.ts","../../../src/email/providers/test-mock.ts","../../../src/email/email-provider.ts","../../../src/email/server/email.service.ts","../../../src/email/server/render-email.ts","../../../src/email/@types/email-template-builder.ts","../../../src/auth/templates/tailwind.styles.ts","../../../src/auth/templates/recovery-verification.tsx","../../../src/auth/server/totp-service.ts","../../../src/auth/server/recovery-service.ts","../../../src/auth/server/auth-recover.ts","../../../src/auth/auth.constants.ts","../../../src/auth/server/webauthn.ts","../../../src/auth/server/webauthn-utils.ts","../../../src/auth/server/webauthn-config.ts","../../../src/auth/server/webauthn-validation.ts","../../../src/auth/server/auth-signin.ts","../../../src/auth/server/auth-signout.ts","../../../src/auth/templates/auth-totp.tsx","../../../src/auth/server/verification-service.ts","../../../src/auth/server/auth-signup.ts","../../../src/auth/server/auth-verify.ts","../../../src/auth/templates/email-change-notification.tsx","../../../src/auth/templates/email-change-verification.tsx","../../../src/auth/server/email-change-service.ts","../../../src/auth/server/passkey-manager.ts","../../../src/auth/server/webauthn-credential.ts"],"sourcesContent":["import { getContext, requireContext } from '@ycore/forge/context';\nimport type { AppLoadContext } from 'react-router';\nimport { createContext } from 'react-router';\n\nimport type { AuthConfig } from '../@types/auth.config.types';\nimport type { User } from '../schema';\n\nexport const authConfigContext = createContext<AuthConfig | null>(null);\n\nexport const authUserContext = createContext<User | null>(null);\n\n/**\n * Require authenticated user from context\n * Throws Response(401) if user is not authenticated\n *\n * Note: Context only contains VERIFIED users (passkey + email verified).\n * Unverified users exist in session but NOT in context.\n * \"Authenticated\" always means \"fully verified\" in this system.\n *\n * @example\n * export const loader = async ({ context }) => {\n *   const user = requireAuthUser(context);\n *   return { user }; // user is guaranteed to be verified\n * };\n */\nexport function requireAuthUser(context: AppLoadContext): User {\n  const user = requireContext(context, authUserContext, {\n    errorMessage: 'Authentication required - user must be logged in to access this resource',\n    errorStatus: 401,\n  });\n\n  return user;\n}\n\n/**\n * Get authenticated user from context (optional)\n * Returns null if user is not authenticated\n *\n * Note: Context only contains VERIFIED users (passkey + email verified).\n * Returns null for both guests AND unverified users.\n * \"Authenticated\" always means \"fully verified\" in this system.\n *\n * @example\n * export const loader = async ({ context }) => {\n *   const user = getAuthUser(context);\n *   return { user, isGuest: !user }; // user is verified or null\n * };\n */\nexport function getAuthUser(context: AppLoadContext): User | null {\n  return getContext(context, authUserContext, null);\n}\n\n/**\n * Check if a user is currently authenticated\n * Returns true if a user is present in context, false otherwise\n *\n * Note: \"Authenticated\" means FULLY VERIFIED (passkey + email).\n * Returns false for both guests AND unverified users.\n * Context only contains verified users; unverified users exist in session only.\n *\n * @example\n * export const loader = async ({ context }) => {\n *   const authenticated = isAuthenticated(context);\n *   return { isAuthenticated: authenticated }; // true = verified\n * };\n */\nexport function isAuthenticated(context: AppLoadContext): boolean {\n  return getContext(context, authUserContext, null) !== null;\n}\n","import type { AuthConfig, AuthRoutes } from './@types/auth.config.types';\n\nexport const defaultAuthRoutes: AuthRoutes = {\n  signup: '/auth/signup',\n  signin: '/auth/signin',\n  signout: '/auth/signout',\n  signedin: '/',\n  signedout: '/',\n  recover: '/auth/recover',\n  verify: '/auth/verify',\n  profile: '/auth/profile',\n};\n\nexport const defaultAuthConfig: AuthConfig = {\n  routes: defaultAuthRoutes,\n  session: {\n    kvBinding: 'UNCONFIGURED',\n    secretKey: 'UNCONFIGURED',\n    cookie: {\n      name: '__auth_session',\n      httpOnly: true,\n      maxAge: 60 * 60 * 24 * 30,\n      path: '/',\n      sameSite: 'lax',\n      secure: 'auto', // Will be determined by environment\n    },\n  },\n  webauthn: {\n    rpName: 'React Router Cloudflare App',\n    challengeSessionKey: 'challenge',\n    requireUserVerification: true, // More secure\n  },\n  verification: {\n    digits: 6,\n    period: 60 * 8, // 8 minutes in seconds\n    maxAttempts: 3,\n    window: 1, // Â±30 seconds\n    resendCooldown: 60, // seconds\n  },\n};\n","/**\n * @react-router/cloudflare v7.9.4\n *\n * Copyright (c) Remix Software Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE.md file in the root directory of this source tree.\n *\n * @license MIT\n */\n\n// sessions/workersKVStorage.ts\nimport { createSessionStorage } from \"react-router\";\nfunction createWorkersKVSessionStorage({\n  cookie,\n  kv\n}) {\n  return createSessionStorage({\n    cookie,\n    async createData(data, expires) {\n      while (true) {\n        let randomBytes = crypto.getRandomValues(new Uint8Array(8));\n        let id = [...randomBytes].map((x) => x.toString(16).padStart(2, \"0\")).join(\"\");\n        if (await kv.get(id, \"json\")) {\n          continue;\n        }\n        await kv.put(id, JSON.stringify(data), {\n          expiration: expires ? Math.round(expires.getTime() / 1e3) : void 0\n        });\n        return id;\n      }\n    },\n    async readData(id) {\n      let session = await kv.get(id);\n      if (!session) {\n        return null;\n      }\n      return JSON.parse(session);\n    },\n    async updateData(id, data, expires) {\n      await kv.put(id, JSON.stringify(data), {\n        expiration: expires ? Math.round(expires.getTime() / 1e3) : void 0\n      });\n    },\n    async deleteData(id) {\n      await kv.delete(id);\n    }\n  });\n}\n\n// worker.ts\nimport { createRequestHandler as createReactRouterRequestHandler } from \"react-router\";\nfunction createRequestHandler({\n  build,\n  mode,\n  getLoadContext = ({ context }) => ({\n    ...context,\n    cloudflare: {\n      ...context.cloudflare,\n      cf: context.cloudflare.request.cf\n    }\n  })\n}) {\n  let handleRequest = createReactRouterRequestHandler(build, mode);\n  return async (cloudflare) => {\n    let loadContext = await getLoadContext({\n      request: cloudflare.request,\n      context: {\n        cloudflare: {\n          ...cloudflare,\n          cf: cloudflare.request.cf,\n          ctx: {\n            waitUntil: cloudflare.waitUntil.bind(cloudflare),\n            passThroughOnException: cloudflare.passThroughOnException.bind(cloudflare)\n          },\n          caches\n        }\n      }\n    });\n    return handleRequest(cloudflare.request, loadContext);\n  };\n}\nfunction createPagesFunctionHandler({\n  build,\n  getLoadContext,\n  mode\n}) {\n  let handleRequest = createRequestHandler({\n    build,\n    getLoadContext,\n    mode\n  });\n  let handleFetch = async (context) => {\n    let response;\n    context.request.headers.delete(\"if-none-match\");\n    try {\n      response = await context.env.ASSETS.fetch(\n        context.request.url,\n        context.request.clone()\n      );\n      response = response && response.status >= 200 && response.status < 400 ? new Response(response.body, response) : void 0;\n    } catch {\n    }\n    if (!response) {\n      response = await handleRequest(context);\n    }\n    return response;\n  };\n  return async (context) => {\n    try {\n      return await handleFetch(context);\n    } catch (error) {\n      if (process.env.NODE_ENV === \"development\" && error instanceof Error) {\n        console.error(error);\n        return new Response(error.message || error.toString(), {\n          status: 500\n        });\n      }\n      return new Response(\"Internal Error\", {\n        status: 500\n      });\n    }\n  };\n}\nexport {\n  createPagesFunctionHandler,\n  createRequestHandler,\n  createWorkersKVSessionStorage\n};\n","import { createWorkersKVSessionStorage } from '@react-router/cloudflare';\nimport { getContext } from '@ycore/forge/context';\nimport type { Result } from '@ycore/forge/result';\nimport { err, ok } from '@ycore/forge/result';\nimport { getBindings, getKVStore, isProduction, UNCONFIGURED } from '@ycore/forge/services';\nimport type { RouterContextProvider, Session } from 'react-router';\n\nimport type { SessionData, SessionFlashData } from '../@types/auth.types';\nimport { authConfigContext } from './auth.context';\n\nconst challengeKvTemplate = (email: string): string => `challenge:${email}`;\nconst challengeUniqueKvTemplate = (challenge: string): string => `challenge-unique:${challenge}`;\n\n/**\n * Resolves auth bindings from context following CSRF middleware pattern\n * Centralizes binding resolution with proper error handling\n */\nfunction resolveAuthBindings(context: Readonly<RouterContextProvider>): { secret: string; kv: KVNamespace } {\n  const authConfig = getContext(context, authConfigContext);\n  if (!authConfig) {\n    throw new Error('Auth configuration not found in context. Ensure auth middleware is properly configured.');\n  }\n\n  const { session } = authConfig;\n\n  // Check for unconfigured values\n  if (session.kvBinding === UNCONFIGURED) {\n    throw new Error('Auth session KV binding is not configured. Please specify kvBinding in your auth config.');\n  }\n  if (session.secretKey === UNCONFIGURED) {\n    throw new Error('Auth session secret key is not configured. Please specify secretKey in your auth config.');\n  }\n\n  const bindings = getBindings(context);\n\n  const secret = bindings[session.secretKey as keyof typeof bindings] as string | undefined;\n  if (!secret) {\n    throw new Error(`Auth secret binding '${session.secretKey}' not found in environment. ` + `Available bindings: ${Object.keys(bindings).join(', ')}`);\n  }\n\n  const kv = getKVStore(context, session.kvBinding);\n  if (!kv) {\n    throw new Error(`KV binding '${session.kvBinding}' not found for session. `);\n  }\n\n  return { secret, kv };\n}\n\nexport function createAuthSessionStorage(context: Readonly<RouterContextProvider>) {\n  const authConfig = getContext(context, authConfigContext);\n  if (!authConfig) {\n    throw new Error('Auth configuration not found in context. Ensure auth middleware is properly configured.');\n  }\n\n  const { secret, kv } = resolveAuthBindings(context);\n  const { session } = authConfig;\n\n  return createWorkersKVSessionStorage<SessionData, SessionFlashData>({\n    kv,\n    cookie: {\n      name: session.cookie.name,\n      httpOnly: session.cookie.httpOnly,\n      maxAge: session.cookie.maxAge,\n      path: session.cookie.path,\n      sameSite: session.cookie.sameSite,\n      secrets: [secret],\n      secure: session.cookie.secure === 'auto' ? isProduction(context) : (session.cookie.secure ?? false),\n    },\n  });\n}\n\n/**\n * Get session from request\n */\nexport async function getAuthSession(request: Request, context: Readonly<RouterContextProvider>): Promise<Result<SessionData | null>> {\n  try {\n    const sessionStorage = createAuthSessionStorage(context);\n    const session = await sessionStorage.getSession(request.headers.get('Cookie'));\n\n    const user = session.get('user');\n    const challenge = session.get('challenge');\n\n    if (!user) {\n      return ok(null);\n    }\n\n    return ok({ user, challenge });\n  } catch (error) {\n    return err('Failed to get session', { error });\n  }\n}\n\n/**\n * Verify challenge uniqueness\n */\nexport async function verifyChallengeUniqueness(challenge: string, context: Readonly<RouterContextProvider>): Promise<Result<boolean>> {\n  try {\n    const { kv } = resolveAuthBindings(context);\n\n    const uniqueKey = challengeUniqueKvTemplate(challenge);\n    const existing = await kv.get(uniqueKey);\n\n    if (existing) {\n      return err('Challenge already used', { challenge });\n    }\n\n    // Mark challenge as used with 5 minute TTL\n    await kv.put(uniqueKey, 'used', { expirationTtl: 300 });\n    return ok(true);\n  } catch (error) {\n    return err('Failed to verify challenge uniqueness', { challenge, error });\n  }\n}\n\n/**\n * Clean up challenge session\n */\nexport async function cleanupChallengeSession(email: string, context: Readonly<RouterContextProvider>): Promise<Result<void>> {\n  try {\n    const { kv } = resolveAuthBindings(context);\n\n    const challengeKey = challengeKvTemplate(email);\n    await kv.delete(challengeKey);\n\n    return ok(undefined);\n  } catch (error) {\n    return err('Failed to cleanup challenge session', { email, error });\n  }\n}\n\n/**\n * Create a challenge session for WebAuthn registration/authentication\n *\n * @param context - Router context provider\n * @param challenge - The generated challenge string\n * @returns Result with Set-Cookie header value\n *\n * @example\n * ```ts\n * const challenge = generateChallenge();\n * const result = await createChallengeSession(context, challenge);\n * if (isError(result)) {\n *   return respondError(result);\n * }\n * return respondOk({ challenge }, { headers: { 'Set-Cookie': result } });\n * ```\n */\nexport async function createChallengeSession(context: Readonly<RouterContextProvider>, challenge: string): Promise<Result<string>> {\n  try {\n    const sessionStorage = createAuthSessionStorage(context);\n    const session = await sessionStorage.getSession();\n\n    session.set('challenge', challenge);\n    session.set('challengeCreatedAt', Date.now());\n\n    const cookie = await sessionStorage.commitSession(session);\n    return ok(cookie);\n  } catch (error) {\n    return err('Failed to create challenge session', { error });\n  }\n}\n\n/**\n * Get challenge from session with validation\n *\n * @param request - The incoming request\n * @param context - Router context provider\n * @returns Result with challenge data or error\n *\n * @example\n * ```ts\n * const result = await getChallengeFromSession(request, context);\n * if (isError(result)) {\n *   return respondError(result);\n * }\n * const { challenge, challengeCreatedAt, session } = result;\n * ```\n */\nexport async function getChallengeFromSession(request: Request, context: Readonly<RouterContextProvider>): Promise<Result<{ challenge: string; challengeCreatedAt: number; session: Session<SessionData, SessionFlashData> }>> {\n  try {\n    const sessionStorage = createAuthSessionStorage(context);\n    const session = await sessionStorage.getSession(request.headers.get('Cookie'));\n    const storedChallenge = session.get('challenge');\n    const challengeCreatedAt = session.get('challengeCreatedAt');\n\n    if (!storedChallenge || !challengeCreatedAt) {\n      return err('Invalid session. Please refresh and try again.', { field: 'general' });\n    }\n\n    return ok({ challenge: storedChallenge, challengeCreatedAt, session });\n  } catch (error) {\n    return err('Failed to get challenge from session', { error });\n  }\n}\n\n/**\n * Destroy a challenge session (clears challenge data)\n *\n * @param session - The session object to destroy\n * @param context - Router context provider\n * @returns Result with void on success\n *\n * @example\n * ```ts\n * const result = await destroyChallengeSession(session, context);\n * if (isError(result)) {\n *   logger.warning('challenge_cleanup_failed', { error: result });\n * }\n * ```\n */\nexport async function destroyChallengeSession(session: Session<SessionData, SessionFlashData>, context: Readonly<RouterContextProvider>): Promise<Result<void>> {\n  try {\n    const sessionStorage = createAuthSessionStorage(context);\n    await sessionStorage.destroySession(session);\n    return ok(undefined);\n  } catch (error) {\n    return err('Failed to destroy challenge session', { error });\n  }\n}\n\n/**\n * Create new session (for authenticated users only)\n */\nexport async function createAuthSession(context: Readonly<RouterContextProvider>, sessionData: SessionData): Promise<Result<string>> {\n  try {\n    const sessionStorage = createAuthSessionStorage(context);\n\n    // SECURITY: Always create a new session to prevent session fixation attacks\n    // Don't reuse any existing session - create completely fresh session\n    const newSession = await sessionStorage.getSession(); // Creates new session\n\n    newSession.set('user', sessionData.user);\n    newSession.set('authenticatedAt', Date.now());\n\n    const cookie = await sessionStorage.commitSession(newSession);\n    return ok(cookie);\n  } catch (error) {\n    return err('Failed to create session', { error });\n  }\n}\n\n/**\n * Update existing session with new user data\n * Used when user data changes (e.g., email change, profile updates)\n */\nexport async function updateAuthSession(request: Request, context: Readonly<RouterContextProvider>, sessionData: Partial<SessionData>): Promise<Result<string>> {\n  try {\n    const sessionStorage = createAuthSessionStorage(context);\n    const session = await sessionStorage.getSession(request.headers.get('Cookie'));\n\n    // Update user data if provided\n    if (sessionData.user) {\n      session.set('user', sessionData.user);\n    }\n\n    // Keep the original authenticatedAt timestamp\n    // Only update if specifically provided\n    if (sessionData.challenge !== undefined) {\n      session.set('challenge', sessionData.challenge);\n    }\n\n    const cookie = await sessionStorage.commitSession(session);\n    return ok(cookie);\n  } catch (error) {\n    return err('Failed to update session', { error });\n  }\n}\n\n/**\n * Destroy session with proper cookie clearing\n */\nexport async function destroyAuthSession(request: Request, context: Readonly<RouterContextProvider>): Promise<Result<string>> {\n  try {\n    const sessionStorage = createAuthSessionStorage(context);\n    const session = await sessionStorage.getSession(request.headers.get('Cookie'));\n\n    // Get email from session for cleanup\n    const email = session.get('email');\n    if (email) {\n      await cleanupChallengeSession(email, context);\n    }\n\n    // Destroy the session and get the clearing cookie\n    const cookie = await sessionStorage.destroySession(session);\n    return ok(cookie);\n  } catch (error) {\n    return err('Failed to destroy session', { error });\n  }\n}\n","import { setContext } from '@ycore/forge/context';\nimport { logger } from '@ycore/forge/logger';\nimport { isError, middlewarePassthrough } from '@ycore/forge/result';\nimport { type MiddlewareFunction, redirect } from 'react-router';\n\nimport type { AuthConfig } from '../@types/auth.config.types';\nimport { defaultAuthConfig, defaultAuthRoutes } from '../auth.config';\nimport { authConfigContext, authUserContext, getAuthUser } from './auth.context';\nimport { createAuthSessionStorage, destroyAuthSession, getAuthSession } from './session';\n\n/**\n * Middleware that sets up auth configuration and loads user session\n * Only sets user in context if email is verified (fully authenticated)\n */\nexport function authSessionMiddleware(authConfig: AuthConfig): MiddlewareFunction<Response> {\n  return async ({ request, context }, next) => {\n    // Set auth config in context for services to use\n    setContext(context, authConfigContext, authConfig);\n\n    // Load user from session\n    const authSession = await getAuthSession(request, context);\n\n    // If session loaded successfully and has an active user, set it in context\n    // Unverified/unrecovered users remain in session but NOT in context\n    if (!isError(authSession) && authSession !== null && authSession.user) {\n      if (authSession.user.status === 'active') {\n        setContext(context, authUserContext, authSession.user);\n      }\n      return next();\n    }\n\n    // Check if there's an orphaned session cookie that needs cleanup\n    const cookieHeader = request.headers.get('Cookie');\n    const sessionCookieName = authConfig?.session.cookie.name || defaultAuthConfig.session.cookie.name;\n    if (cookieHeader?.includes(sessionCookieName)) {\n      // Get the session to check if it has any valid data (user, challenge, etc.)\n      const sessionStorage = createAuthSessionStorage(context);\n      const session = await sessionStorage.getSession(cookieHeader);\n\n      // Only destroy if session is truly empty (no user or challenge)\n      const hasUser = session.get('user');\n      const hasChallenge = session.get('challenge');\n\n      if (!hasUser && !hasChallenge) {\n        // Truly orphaned session - clean it up\n        const destroyResult = await destroyAuthSession(request, context);\n\n        if (!isError(destroyResult)) {\n          const response = await next();\n          return middlewarePassthrough(response, { set: { 'Set-Cookie': destroyResult } });\n        }\n      }\n    }\n\n    return next();\n  };\n}\n\n/**\n * Combined middleware for auth routes that:\n * 1. Sets up auth configuration\n * 2. Loads user session\n * 3. Redirects verified users to signedin route\n * 4. Redirects unverified users to verify route\n */\nexport function unguardedAuthMiddleware(authConfig: AuthConfig): MiddlewareFunction<Response>[] {\n  return [authSessionMiddleware(authConfig), unprotectedAuthMiddleware(authConfig)];\n}\n\n/**\n * Combined middleware for protected routes that:\n * 1. Sets up auth configuration\n * 2. Loads user session\n * 3. Requires authentication\n */\nexport function guardedAuthMiddleware(authConfig: AuthConfig): MiddlewareFunction<Response>[] {\n  return [authSessionMiddleware(authConfig), protectedAuthMiddleware(authConfig)];\n}\n\n/**\n * Combined middleware for verify route that:\n * 1. Sets up auth configuration\n * 2. Loads user session\n * 3. Redirects verified users to signedin route\n * 4. Redirects users without session to signin route\n * 5. Only allows unverified users (session but not verified)\n */\nexport function verifyRouteMiddleware(authConfig: AuthConfig): MiddlewareFunction<Response>[] {\n  return [authSessionMiddleware(authConfig), verifyAuthMiddleware(authConfig)];\n}\n\n/**\n * Middleware specifically for the verify route.\n * Ensures only unverified users can access it.\n */\nfunction verifyAuthMiddleware(authConfig: AuthConfig): MiddlewareFunction<Response> {\n  return async ({ request, context }, next) => {\n    // Check if already fully authenticated (verified user in context)\n    const user = getAuthUser(context);\n    if (user) {\n      throw redirect(authConfig?.routes.signedin || defaultAuthRoutes.signedin);\n    }\n\n    // Check if has session (unverified)\n    const sessionResult = await getAuthSession(request, context);\n    if (isError(sessionResult) || !sessionResult?.user) {\n      throw redirect(authConfig?.routes.signin || defaultAuthRoutes.signin);\n    }\n\n    // Has unverified session - allow access to verify page\n    return next();\n  };\n}\n\n/**\n * Middleware that requires authentication for protected routes.\n * Redirects to configured signedOutRoute if user is not authenticated.\n *\n * Note: Context only contains verified users (set by authSessionMiddleware),\n * so if user exists in context, they are fully authenticated.\n */\nfunction protectedAuthMiddleware(authConfig: AuthConfig): MiddlewareFunction<Response> {\n  return async ({ context }, next) => {\n    const user = getAuthUser(context);\n    if (!user) {\n      throw redirect(authConfig?.routes.signedout || defaultAuthRoutes.signedout);\n    }\n\n    return next();\n  };\n}\n\n/**\n * Middleware for public routes that should redirect if user has a session.\n * Redirects verified users to signedin route.\n * Redirects unverified users to verify route.\n * Only allows users with no session to access signin/signup pages.\n */\nfunction unprotectedAuthMiddleware(authConfig: AuthConfig): MiddlewareFunction<Response> {\n  return async ({ request, context }, next) => {\n    // Check if fully authenticated (verified user in context)\n    const user = getAuthUser(context);\n    if (user) {\n      throw redirect(authConfig?.routes.signedin || defaultAuthRoutes.signedin);\n    }\n\n    // Check if has unverified session (user in session but not active status)\n    const sessionResult = await getAuthSession(request, context);\n    if (!isError(sessionResult) && sessionResult?.user && sessionResult.user.status !== 'active') {\n      logger.info('unverified_user_redirecting_to_verify', {\n        userId: sessionResult.user.id,\n        email: sessionResult.user.email,\n        status: sessionResult.user.status,\n      });\n      throw redirect(authConfig?.routes.verify || defaultAuthRoutes.verify);\n    }\n\n    return next();\n  };\n}\n","import { email, maxLength, minLength, nonEmpty, object, pipe, string } from 'valibot';\n\n// Base email validation - reused across all auth forms\nconst emailField = pipe(string(), nonEmpty('Please enter your email.'), email('Please enter a valid email.'), maxLength(254, 'Email exceeds maximum length'));\n\n// Base display name validation\nconst displayNameField = pipe(string(), nonEmpty('Display name is required'), minLength(1, 'Display name is required'));\n\nexport const authFormSchema = object({ email: emailField });\n\nexport const signupFormSchema = object({ email: emailField, displayName: displayNameField });\n\nexport const signinFormSchema = object({ email: emailField });\n\nexport const changeEmailSchema = object({ newEmail: emailField });\n","const entityKind = Symbol.for(\"drizzle:entityKind\");\nconst hasOwnEntityKind = Symbol.for(\"drizzle:hasOwnEntityKind\");\nfunction is(value, type) {\n  if (!value || typeof value !== \"object\") {\n    return false;\n  }\n  if (value instanceof type) {\n    return true;\n  }\n  if (!Object.prototype.hasOwnProperty.call(type, entityKind)) {\n    throw new Error(\n      `Class \"${type.name ?? \"<unknown>\"}\" doesn't look like a Drizzle entity. If this is incorrect and the class is provided by Drizzle, please report this as a bug.`\n    );\n  }\n  let cls = Object.getPrototypeOf(value).constructor;\n  if (cls) {\n    while (cls) {\n      if (entityKind in cls && cls[entityKind] === type[entityKind]) {\n        return true;\n      }\n      cls = Object.getPrototypeOf(cls);\n    }\n  }\n  return false;\n}\nexport {\n  entityKind,\n  hasOwnEntityKind,\n  is\n};\n//# sourceMappingURL=entity.js.map","import { entityKind } from \"./entity.js\";\nclass Column {\n  constructor(table, config) {\n    this.table = table;\n    this.config = config;\n    this.name = config.name;\n    this.keyAsName = config.keyAsName;\n    this.notNull = config.notNull;\n    this.default = config.default;\n    this.defaultFn = config.defaultFn;\n    this.onUpdateFn = config.onUpdateFn;\n    this.hasDefault = config.hasDefault;\n    this.primary = config.primaryKey;\n    this.isUnique = config.isUnique;\n    this.uniqueName = config.uniqueName;\n    this.uniqueType = config.uniqueType;\n    this.dataType = config.dataType;\n    this.columnType = config.columnType;\n    this.generated = config.generated;\n    this.generatedIdentity = config.generatedIdentity;\n  }\n  static [entityKind] = \"Column\";\n  name;\n  keyAsName;\n  primary;\n  notNull;\n  default;\n  defaultFn;\n  onUpdateFn;\n  hasDefault;\n  isUnique;\n  uniqueName;\n  uniqueType;\n  dataType;\n  columnType;\n  enumValues = void 0;\n  generated = void 0;\n  generatedIdentity = void 0;\n  config;\n  mapFromDriverValue(value) {\n    return value;\n  }\n  mapToDriverValue(value) {\n    return value;\n  }\n  // ** @internal */\n  shouldDisableInsert() {\n    return this.config.generated !== void 0 && this.config.generated.type !== \"byDefault\";\n  }\n}\nexport {\n  Column\n};\n//# sourceMappingURL=column.js.map","import { entityKind } from \"./entity.js\";\nclass ColumnBuilder {\n  static [entityKind] = \"ColumnBuilder\";\n  config;\n  constructor(name, dataType, columnType) {\n    this.config = {\n      name,\n      keyAsName: name === \"\",\n      notNull: false,\n      default: void 0,\n      hasDefault: false,\n      primaryKey: false,\n      isUnique: false,\n      uniqueName: void 0,\n      uniqueType: void 0,\n      dataType,\n      columnType,\n      generated: void 0\n    };\n  }\n  /**\n   * Changes the data type of the column. Commonly used with `json` columns. Also, useful for branded types.\n   *\n   * @example\n   * ```ts\n   * const users = pgTable('users', {\n   * \tid: integer('id').$type<UserId>().primaryKey(),\n   * \tdetails: json('details').$type<UserDetails>().notNull(),\n   * });\n   * ```\n   */\n  $type() {\n    return this;\n  }\n  /**\n   * Adds a `not null` clause to the column definition.\n   *\n   * Affects the `select` model of the table - columns *without* `not null` will be nullable on select.\n   */\n  notNull() {\n    this.config.notNull = true;\n    return this;\n  }\n  /**\n   * Adds a `default <value>` clause to the column definition.\n   *\n   * Affects the `insert` model of the table - columns *with* `default` are optional on insert.\n   *\n   * If you need to set a dynamic default value, use {@link $defaultFn} instead.\n   */\n  default(value) {\n    this.config.default = value;\n    this.config.hasDefault = true;\n    return this;\n  }\n  /**\n   * Adds a dynamic default value to the column.\n   * The function will be called when the row is inserted, and the returned value will be used as the column value.\n   *\n   * **Note:** This value does not affect the `drizzle-kit` behavior, it is only used at runtime in `drizzle-orm`.\n   */\n  $defaultFn(fn) {\n    this.config.defaultFn = fn;\n    this.config.hasDefault = true;\n    return this;\n  }\n  /**\n   * Alias for {@link $defaultFn}.\n   */\n  $default = this.$defaultFn;\n  /**\n   * Adds a dynamic update value to the column.\n   * The function will be called when the row is updated, and the returned value will be used as the column value if none is provided.\n   * If no `default` (or `$defaultFn`) value is provided, the function will be called when the row is inserted as well, and the returned value will be used as the column value.\n   *\n   * **Note:** This value does not affect the `drizzle-kit` behavior, it is only used at runtime in `drizzle-orm`.\n   */\n  $onUpdateFn(fn) {\n    this.config.onUpdateFn = fn;\n    this.config.hasDefault = true;\n    return this;\n  }\n  /**\n   * Alias for {@link $onUpdateFn}.\n   */\n  $onUpdate = this.$onUpdateFn;\n  /**\n   * Adds a `primary key` clause to the column definition. This implicitly makes the column `not null`.\n   *\n   * In SQLite, `integer primary key` implicitly makes the column auto-incrementing.\n   */\n  primaryKey() {\n    this.config.primaryKey = true;\n    this.config.notNull = true;\n    return this;\n  }\n  /** @internal Sets the name of the column to the key within the table definition if a name was not given. */\n  setName(name) {\n    if (this.config.name !== \"\") return;\n    this.config.name = name;\n  }\n}\nexport {\n  ColumnBuilder\n};\n//# sourceMappingURL=column-builder.js.map","const TableName = Symbol.for(\"drizzle:Name\");\nexport {\n  TableName\n};\n//# sourceMappingURL=table.utils.js.map","import { entityKind } from \"../../entity.js\";\nimport { PgColumn, PgColumnBuilder } from \"./common.js\";\nclass PgEnumObjectColumnBuilder extends PgColumnBuilder {\n  static [entityKind] = \"PgEnumObjectColumnBuilder\";\n  constructor(name, enumInstance) {\n    super(name, \"string\", \"PgEnumObjectColumn\");\n    this.config.enum = enumInstance;\n  }\n  /** @internal */\n  build(table) {\n    return new PgEnumObjectColumn(\n      table,\n      this.config\n    );\n  }\n}\nclass PgEnumObjectColumn extends PgColumn {\n  static [entityKind] = \"PgEnumObjectColumn\";\n  enum;\n  enumValues = this.config.enum.enumValues;\n  constructor(table, config) {\n    super(table, config);\n    this.enum = config.enum;\n  }\n  getSQLType() {\n    return this.enum.enumName;\n  }\n}\nconst isPgEnumSym = Symbol.for(\"drizzle:isPgEnum\");\nfunction isPgEnum(obj) {\n  return !!obj && typeof obj === \"function\" && isPgEnumSym in obj && obj[isPgEnumSym] === true;\n}\nclass PgEnumColumnBuilder extends PgColumnBuilder {\n  static [entityKind] = \"PgEnumColumnBuilder\";\n  constructor(name, enumInstance) {\n    super(name, \"string\", \"PgEnumColumn\");\n    this.config.enum = enumInstance;\n  }\n  /** @internal */\n  build(table) {\n    return new PgEnumColumn(\n      table,\n      this.config\n    );\n  }\n}\nclass PgEnumColumn extends PgColumn {\n  static [entityKind] = \"PgEnumColumn\";\n  enum = this.config.enum;\n  enumValues = this.config.enum.enumValues;\n  constructor(table, config) {\n    super(table, config);\n    this.enum = config.enum;\n  }\n  getSQLType() {\n    return this.enum.enumName;\n  }\n}\nfunction pgEnum(enumName, input) {\n  return Array.isArray(input) ? pgEnumWithSchema(enumName, [...input], void 0) : pgEnumObjectWithSchema(enumName, input, void 0);\n}\nfunction pgEnumWithSchema(enumName, values, schema) {\n  const enumInstance = Object.assign(\n    (name) => new PgEnumColumnBuilder(name ?? \"\", enumInstance),\n    {\n      enumName,\n      enumValues: values,\n      schema,\n      [isPgEnumSym]: true\n    }\n  );\n  return enumInstance;\n}\nfunction pgEnumObjectWithSchema(enumName, values, schema) {\n  const enumInstance = Object.assign(\n    (name) => new PgEnumObjectColumnBuilder(name ?? \"\", enumInstance),\n    {\n      enumName,\n      enumValues: Object.values(values),\n      schema,\n      [isPgEnumSym]: true\n    }\n  );\n  return enumInstance;\n}\nexport {\n  PgEnumColumn,\n  PgEnumColumnBuilder,\n  PgEnumObjectColumn,\n  PgEnumObjectColumnBuilder,\n  isPgEnum,\n  pgEnum,\n  pgEnumObjectWithSchema,\n  pgEnumWithSchema\n};\n//# sourceMappingURL=enum.js.map","import { entityKind } from \"./entity.js\";\nclass Subquery {\n  static [entityKind] = \"Subquery\";\n  constructor(sql, fields, alias, isWith = false, usedTables = []) {\n    this._ = {\n      brand: \"Subquery\",\n      sql,\n      selectedFields: fields,\n      alias,\n      isWith,\n      usedTables\n    };\n  }\n  // getSQL(): SQL<unknown> {\n  // \treturn new SQL([this]);\n  // }\n}\nclass WithSubquery extends Subquery {\n  static [entityKind] = \"WithSubquery\";\n}\nexport {\n  Subquery,\n  WithSubquery\n};\n//# sourceMappingURL=subquery.js.map","import { iife } from \"./tracing-utils.js\";\nimport { npmVersion } from \"./version.js\";\nlet otel;\nlet rawTracer;\nconst tracer = {\n  startActiveSpan(name, fn) {\n    if (!otel) {\n      return fn();\n    }\n    if (!rawTracer) {\n      rawTracer = otel.trace.getTracer(\"drizzle-orm\", npmVersion);\n    }\n    return iife(\n      (otel2, rawTracer2) => rawTracer2.startActiveSpan(\n        name,\n        (span) => {\n          try {\n            return fn(span);\n          } catch (e) {\n            span.setStatus({\n              code: otel2.SpanStatusCode.ERROR,\n              message: e instanceof Error ? e.message : \"Unknown error\"\n              // eslint-disable-line no-instanceof/no-instanceof\n            });\n            throw e;\n          } finally {\n            span.end();\n          }\n        }\n      ),\n      otel,\n      rawTracer\n    );\n  }\n};\nexport {\n  tracer\n};\n//# sourceMappingURL=tracing.js.map","const ViewBaseConfig = Symbol.for(\"drizzle:ViewBaseConfig\");\nexport {\n  ViewBaseConfig\n};\n//# sourceMappingURL=view-common.js.map","import { entityKind } from \"./entity.js\";\nimport { TableName } from \"./table.utils.js\";\nconst Schema = Symbol.for(\"drizzle:Schema\");\nconst Columns = Symbol.for(\"drizzle:Columns\");\nconst ExtraConfigColumns = Symbol.for(\"drizzle:ExtraConfigColumns\");\nconst OriginalName = Symbol.for(\"drizzle:OriginalName\");\nconst BaseName = Symbol.for(\"drizzle:BaseName\");\nconst IsAlias = Symbol.for(\"drizzle:IsAlias\");\nconst ExtraConfigBuilder = Symbol.for(\"drizzle:ExtraConfigBuilder\");\nconst IsDrizzleTable = Symbol.for(\"drizzle:IsDrizzleTable\");\nclass Table {\n  static [entityKind] = \"Table\";\n  /** @internal */\n  static Symbol = {\n    Name: TableName,\n    Schema,\n    OriginalName,\n    Columns,\n    ExtraConfigColumns,\n    BaseName,\n    IsAlias,\n    ExtraConfigBuilder\n  };\n  /**\n   * @internal\n   * Can be changed if the table is aliased.\n   */\n  [TableName];\n  /**\n   * @internal\n   * Used to store the original name of the table, before any aliasing.\n   */\n  [OriginalName];\n  /** @internal */\n  [Schema];\n  /** @internal */\n  [Columns];\n  /** @internal */\n  [ExtraConfigColumns];\n  /**\n   *  @internal\n   * Used to store the table name before the transformation via the `tableCreator` functions.\n   */\n  [BaseName];\n  /** @internal */\n  [IsAlias] = false;\n  /** @internal */\n  [IsDrizzleTable] = true;\n  /** @internal */\n  [ExtraConfigBuilder] = void 0;\n  constructor(name, schema, baseName) {\n    this[TableName] = this[OriginalName] = name;\n    this[Schema] = schema;\n    this[BaseName] = baseName;\n  }\n}\nfunction isTable(table) {\n  return typeof table === \"object\" && table !== null && IsDrizzleTable in table;\n}\nfunction getTableName(table) {\n  return table[TableName];\n}\nfunction getTableUniqueName(table) {\n  return `${table[Schema] ?? \"public\"}.${table[TableName]}`;\n}\nexport {\n  BaseName,\n  Columns,\n  ExtraConfigBuilder,\n  ExtraConfigColumns,\n  IsAlias,\n  OriginalName,\n  Schema,\n  Table,\n  getTableName,\n  getTableUniqueName,\n  isTable\n};\n//# sourceMappingURL=table.js.map","import { entityKind, is } from \"../entity.js\";\nimport { isPgEnum } from \"../pg-core/columns/enum.js\";\nimport { Subquery } from \"../subquery.js\";\nimport { tracer } from \"../tracing.js\";\nimport { ViewBaseConfig } from \"../view-common.js\";\nimport { Column } from \"../column.js\";\nimport { IsAlias, Table } from \"../table.js\";\nclass FakePrimitiveParam {\n  static [entityKind] = \"FakePrimitiveParam\";\n}\nfunction isSQLWrapper(value) {\n  return value !== null && value !== void 0 && typeof value.getSQL === \"function\";\n}\nfunction mergeQueries(queries) {\n  const result = { sql: \"\", params: [] };\n  for (const query of queries) {\n    result.sql += query.sql;\n    result.params.push(...query.params);\n    if (query.typings?.length) {\n      if (!result.typings) {\n        result.typings = [];\n      }\n      result.typings.push(...query.typings);\n    }\n  }\n  return result;\n}\nclass StringChunk {\n  static [entityKind] = \"StringChunk\";\n  value;\n  constructor(value) {\n    this.value = Array.isArray(value) ? value : [value];\n  }\n  getSQL() {\n    return new SQL([this]);\n  }\n}\nclass SQL {\n  constructor(queryChunks) {\n    this.queryChunks = queryChunks;\n    for (const chunk of queryChunks) {\n      if (is(chunk, Table)) {\n        const schemaName = chunk[Table.Symbol.Schema];\n        this.usedTables.push(\n          schemaName === void 0 ? chunk[Table.Symbol.Name] : schemaName + \".\" + chunk[Table.Symbol.Name]\n        );\n      }\n    }\n  }\n  static [entityKind] = \"SQL\";\n  /** @internal */\n  decoder = noopDecoder;\n  shouldInlineParams = false;\n  /** @internal */\n  usedTables = [];\n  append(query) {\n    this.queryChunks.push(...query.queryChunks);\n    return this;\n  }\n  toQuery(config) {\n    return tracer.startActiveSpan(\"drizzle.buildSQL\", (span) => {\n      const query = this.buildQueryFromSourceParams(this.queryChunks, config);\n      span?.setAttributes({\n        \"drizzle.query.text\": query.sql,\n        \"drizzle.query.params\": JSON.stringify(query.params)\n      });\n      return query;\n    });\n  }\n  buildQueryFromSourceParams(chunks, _config) {\n    const config = Object.assign({}, _config, {\n      inlineParams: _config.inlineParams || this.shouldInlineParams,\n      paramStartIndex: _config.paramStartIndex || { value: 0 }\n    });\n    const {\n      casing,\n      escapeName,\n      escapeParam,\n      prepareTyping,\n      inlineParams,\n      paramStartIndex\n    } = config;\n    return mergeQueries(chunks.map((chunk) => {\n      if (is(chunk, StringChunk)) {\n        return { sql: chunk.value.join(\"\"), params: [] };\n      }\n      if (is(chunk, Name)) {\n        return { sql: escapeName(chunk.value), params: [] };\n      }\n      if (chunk === void 0) {\n        return { sql: \"\", params: [] };\n      }\n      if (Array.isArray(chunk)) {\n        const result = [new StringChunk(\"(\")];\n        for (const [i, p] of chunk.entries()) {\n          result.push(p);\n          if (i < chunk.length - 1) {\n            result.push(new StringChunk(\", \"));\n          }\n        }\n        result.push(new StringChunk(\")\"));\n        return this.buildQueryFromSourceParams(result, config);\n      }\n      if (is(chunk, SQL)) {\n        return this.buildQueryFromSourceParams(chunk.queryChunks, {\n          ...config,\n          inlineParams: inlineParams || chunk.shouldInlineParams\n        });\n      }\n      if (is(chunk, Table)) {\n        const schemaName = chunk[Table.Symbol.Schema];\n        const tableName = chunk[Table.Symbol.Name];\n        return {\n          sql: schemaName === void 0 || chunk[IsAlias] ? escapeName(tableName) : escapeName(schemaName) + \".\" + escapeName(tableName),\n          params: []\n        };\n      }\n      if (is(chunk, Column)) {\n        const columnName = casing.getColumnCasing(chunk);\n        if (_config.invokeSource === \"indexes\") {\n          return { sql: escapeName(columnName), params: [] };\n        }\n        const schemaName = chunk.table[Table.Symbol.Schema];\n        return {\n          sql: chunk.table[IsAlias] || schemaName === void 0 ? escapeName(chunk.table[Table.Symbol.Name]) + \".\" + escapeName(columnName) : escapeName(schemaName) + \".\" + escapeName(chunk.table[Table.Symbol.Name]) + \".\" + escapeName(columnName),\n          params: []\n        };\n      }\n      if (is(chunk, View)) {\n        const schemaName = chunk[ViewBaseConfig].schema;\n        const viewName = chunk[ViewBaseConfig].name;\n        return {\n          sql: schemaName === void 0 || chunk[ViewBaseConfig].isAlias ? escapeName(viewName) : escapeName(schemaName) + \".\" + escapeName(viewName),\n          params: []\n        };\n      }\n      if (is(chunk, Param)) {\n        if (is(chunk.value, Placeholder)) {\n          return { sql: escapeParam(paramStartIndex.value++, chunk), params: [chunk], typings: [\"none\"] };\n        }\n        const mappedValue = chunk.value === null ? null : chunk.encoder.mapToDriverValue(chunk.value);\n        if (is(mappedValue, SQL)) {\n          return this.buildQueryFromSourceParams([mappedValue], config);\n        }\n        if (inlineParams) {\n          return { sql: this.mapInlineParam(mappedValue, config), params: [] };\n        }\n        let typings = [\"none\"];\n        if (prepareTyping) {\n          typings = [prepareTyping(chunk.encoder)];\n        }\n        return { sql: escapeParam(paramStartIndex.value++, mappedValue), params: [mappedValue], typings };\n      }\n      if (is(chunk, Placeholder)) {\n        return { sql: escapeParam(paramStartIndex.value++, chunk), params: [chunk], typings: [\"none\"] };\n      }\n      if (is(chunk, SQL.Aliased) && chunk.fieldAlias !== void 0) {\n        return { sql: escapeName(chunk.fieldAlias), params: [] };\n      }\n      if (is(chunk, Subquery)) {\n        if (chunk._.isWith) {\n          return { sql: escapeName(chunk._.alias), params: [] };\n        }\n        return this.buildQueryFromSourceParams([\n          new StringChunk(\"(\"),\n          chunk._.sql,\n          new StringChunk(\") \"),\n          new Name(chunk._.alias)\n        ], config);\n      }\n      if (isPgEnum(chunk)) {\n        if (chunk.schema) {\n          return { sql: escapeName(chunk.schema) + \".\" + escapeName(chunk.enumName), params: [] };\n        }\n        return { sql: escapeName(chunk.enumName), params: [] };\n      }\n      if (isSQLWrapper(chunk)) {\n        if (chunk.shouldOmitSQLParens?.()) {\n          return this.buildQueryFromSourceParams([chunk.getSQL()], config);\n        }\n        return this.buildQueryFromSourceParams([\n          new StringChunk(\"(\"),\n          chunk.getSQL(),\n          new StringChunk(\")\")\n        ], config);\n      }\n      if (inlineParams) {\n        return { sql: this.mapInlineParam(chunk, config), params: [] };\n      }\n      return { sql: escapeParam(paramStartIndex.value++, chunk), params: [chunk], typings: [\"none\"] };\n    }));\n  }\n  mapInlineParam(chunk, { escapeString }) {\n    if (chunk === null) {\n      return \"null\";\n    }\n    if (typeof chunk === \"number\" || typeof chunk === \"boolean\") {\n      return chunk.toString();\n    }\n    if (typeof chunk === \"string\") {\n      return escapeString(chunk);\n    }\n    if (typeof chunk === \"object\") {\n      const mappedValueAsString = chunk.toString();\n      if (mappedValueAsString === \"[object Object]\") {\n        return escapeString(JSON.stringify(chunk));\n      }\n      return escapeString(mappedValueAsString);\n    }\n    throw new Error(\"Unexpected param value: \" + chunk);\n  }\n  getSQL() {\n    return this;\n  }\n  as(alias) {\n    if (alias === void 0) {\n      return this;\n    }\n    return new SQL.Aliased(this, alias);\n  }\n  mapWith(decoder) {\n    this.decoder = typeof decoder === \"function\" ? { mapFromDriverValue: decoder } : decoder;\n    return this;\n  }\n  inlineParams() {\n    this.shouldInlineParams = true;\n    return this;\n  }\n  /**\n   * This method is used to conditionally include a part of the query.\n   *\n   * @param condition - Condition to check\n   * @returns itself if the condition is `true`, otherwise `undefined`\n   */\n  if(condition) {\n    return condition ? this : void 0;\n  }\n}\nclass Name {\n  constructor(value) {\n    this.value = value;\n  }\n  static [entityKind] = \"Name\";\n  brand;\n  getSQL() {\n    return new SQL([this]);\n  }\n}\nfunction name(value) {\n  return new Name(value);\n}\nfunction isDriverValueEncoder(value) {\n  return typeof value === \"object\" && value !== null && \"mapToDriverValue\" in value && typeof value.mapToDriverValue === \"function\";\n}\nconst noopDecoder = {\n  mapFromDriverValue: (value) => value\n};\nconst noopEncoder = {\n  mapToDriverValue: (value) => value\n};\nconst noopMapper = {\n  ...noopDecoder,\n  ...noopEncoder\n};\nclass Param {\n  /**\n   * @param value - Parameter value\n   * @param encoder - Encoder to convert the value to a driver parameter\n   */\n  constructor(value, encoder = noopEncoder) {\n    this.value = value;\n    this.encoder = encoder;\n  }\n  static [entityKind] = \"Param\";\n  brand;\n  getSQL() {\n    return new SQL([this]);\n  }\n}\nfunction param(value, encoder) {\n  return new Param(value, encoder);\n}\nfunction sql(strings, ...params) {\n  const queryChunks = [];\n  if (params.length > 0 || strings.length > 0 && strings[0] !== \"\") {\n    queryChunks.push(new StringChunk(strings[0]));\n  }\n  for (const [paramIndex, param2] of params.entries()) {\n    queryChunks.push(param2, new StringChunk(strings[paramIndex + 1]));\n  }\n  return new SQL(queryChunks);\n}\n((sql2) => {\n  function empty() {\n    return new SQL([]);\n  }\n  sql2.empty = empty;\n  function fromList(list) {\n    return new SQL(list);\n  }\n  sql2.fromList = fromList;\n  function raw(str) {\n    return new SQL([new StringChunk(str)]);\n  }\n  sql2.raw = raw;\n  function join(chunks, separator) {\n    const result = [];\n    for (const [i, chunk] of chunks.entries()) {\n      if (i > 0 && separator !== void 0) {\n        result.push(separator);\n      }\n      result.push(chunk);\n    }\n    return new SQL(result);\n  }\n  sql2.join = join;\n  function identifier(value) {\n    return new Name(value);\n  }\n  sql2.identifier = identifier;\n  function placeholder2(name2) {\n    return new Placeholder(name2);\n  }\n  sql2.placeholder = placeholder2;\n  function param2(value, encoder) {\n    return new Param(value, encoder);\n  }\n  sql2.param = param2;\n})(sql || (sql = {}));\n((SQL2) => {\n  class Aliased {\n    constructor(sql2, fieldAlias) {\n      this.sql = sql2;\n      this.fieldAlias = fieldAlias;\n    }\n    static [entityKind] = \"SQL.Aliased\";\n    /** @internal */\n    isSelectionField = false;\n    getSQL() {\n      return this.sql;\n    }\n    /** @internal */\n    clone() {\n      return new Aliased(this.sql, this.fieldAlias);\n    }\n  }\n  SQL2.Aliased = Aliased;\n})(SQL || (SQL = {}));\nclass Placeholder {\n  constructor(name2) {\n    this.name = name2;\n  }\n  static [entityKind] = \"Placeholder\";\n  getSQL() {\n    return new SQL([this]);\n  }\n}\nfunction placeholder(name2) {\n  return new Placeholder(name2);\n}\nfunction fillPlaceholders(params, values) {\n  return params.map((p) => {\n    if (is(p, Placeholder)) {\n      if (!(p.name in values)) {\n        throw new Error(`No value for placeholder \"${p.name}\" was provided`);\n      }\n      return values[p.name];\n    }\n    if (is(p, Param) && is(p.value, Placeholder)) {\n      if (!(p.value.name in values)) {\n        throw new Error(`No value for placeholder \"${p.value.name}\" was provided`);\n      }\n      return p.encoder.mapToDriverValue(values[p.value.name]);\n    }\n    return p;\n  });\n}\nconst IsDrizzleView = Symbol.for(\"drizzle:IsDrizzleView\");\nclass View {\n  static [entityKind] = \"View\";\n  /** @internal */\n  [ViewBaseConfig];\n  /** @internal */\n  [IsDrizzleView] = true;\n  constructor({ name: name2, schema, selectedFields, query }) {\n    this[ViewBaseConfig] = {\n      name: name2,\n      originalName: name2,\n      schema,\n      selectedFields,\n      query,\n      isExisting: !query,\n      isAlias: false\n    };\n  }\n  getSQL() {\n    return new SQL([this]);\n  }\n}\nfunction isView(view) {\n  return typeof view === \"object\" && view !== null && IsDrizzleView in view;\n}\nfunction getViewName(view) {\n  return view[ViewBaseConfig].name;\n}\nColumn.prototype.getSQL = function() {\n  return new SQL([this]);\n};\nTable.prototype.getSQL = function() {\n  return new SQL([this]);\n};\nSubquery.prototype.getSQL = function() {\n  return new SQL([this]);\n};\nexport {\n  FakePrimitiveParam,\n  Name,\n  Param,\n  Placeholder,\n  SQL,\n  StringChunk,\n  View,\n  fillPlaceholders,\n  getViewName,\n  isDriverValueEncoder,\n  isSQLWrapper,\n  isView,\n  name,\n  noopDecoder,\n  noopEncoder,\n  noopMapper,\n  param,\n  placeholder,\n  sql\n};\n//# sourceMappingURL=sql.js.map","import { Column } from \"./column.js\";\nimport { is } from \"./entity.js\";\nimport { Param, SQL, View } from \"./sql/sql.js\";\nimport { Subquery } from \"./subquery.js\";\nimport { getTableName, Table } from \"./table.js\";\nimport { ViewBaseConfig } from \"./view-common.js\";\nfunction mapResultRow(columns, row, joinsNotNullableMap) {\n  const nullifyMap = {};\n  const result = columns.reduce(\n    (result2, { path, field }, columnIndex) => {\n      let decoder;\n      if (is(field, Column)) {\n        decoder = field;\n      } else if (is(field, SQL)) {\n        decoder = field.decoder;\n      } else {\n        decoder = field.sql.decoder;\n      }\n      let node = result2;\n      for (const [pathChunkIndex, pathChunk] of path.entries()) {\n        if (pathChunkIndex < path.length - 1) {\n          if (!(pathChunk in node)) {\n            node[pathChunk] = {};\n          }\n          node = node[pathChunk];\n        } else {\n          const rawValue = row[columnIndex];\n          const value = node[pathChunk] = rawValue === null ? null : decoder.mapFromDriverValue(rawValue);\n          if (joinsNotNullableMap && is(field, Column) && path.length === 2) {\n            const objectName = path[0];\n            if (!(objectName in nullifyMap)) {\n              nullifyMap[objectName] = value === null ? getTableName(field.table) : false;\n            } else if (typeof nullifyMap[objectName] === \"string\" && nullifyMap[objectName] !== getTableName(field.table)) {\n              nullifyMap[objectName] = false;\n            }\n          }\n        }\n      }\n      return result2;\n    },\n    {}\n  );\n  if (joinsNotNullableMap && Object.keys(nullifyMap).length > 0) {\n    for (const [objectName, tableName] of Object.entries(nullifyMap)) {\n      if (typeof tableName === \"string\" && !joinsNotNullableMap[tableName]) {\n        result[objectName] = null;\n      }\n    }\n  }\n  return result;\n}\nfunction orderSelectedFields(fields, pathPrefix) {\n  return Object.entries(fields).reduce((result, [name, field]) => {\n    if (typeof name !== \"string\") {\n      return result;\n    }\n    const newPath = pathPrefix ? [...pathPrefix, name] : [name];\n    if (is(field, Column) || is(field, SQL) || is(field, SQL.Aliased)) {\n      result.push({ path: newPath, field });\n    } else if (is(field, Table)) {\n      result.push(...orderSelectedFields(field[Table.Symbol.Columns], newPath));\n    } else {\n      result.push(...orderSelectedFields(field, newPath));\n    }\n    return result;\n  }, []);\n}\nfunction haveSameKeys(left, right) {\n  const leftKeys = Object.keys(left);\n  const rightKeys = Object.keys(right);\n  if (leftKeys.length !== rightKeys.length) {\n    return false;\n  }\n  for (const [index, key] of leftKeys.entries()) {\n    if (key !== rightKeys[index]) {\n      return false;\n    }\n  }\n  return true;\n}\nfunction mapUpdateSet(table, values) {\n  const entries = Object.entries(values).filter(([, value]) => value !== void 0).map(([key, value]) => {\n    if (is(value, SQL) || is(value, Column)) {\n      return [key, value];\n    } else {\n      return [key, new Param(value, table[Table.Symbol.Columns][key])];\n    }\n  });\n  if (entries.length === 0) {\n    throw new Error(\"No values to set\");\n  }\n  return Object.fromEntries(entries);\n}\nfunction applyMixins(baseClass, extendedClasses) {\n  for (const extendedClass of extendedClasses) {\n    for (const name of Object.getOwnPropertyNames(extendedClass.prototype)) {\n      if (name === \"constructor\") continue;\n      Object.defineProperty(\n        baseClass.prototype,\n        name,\n        Object.getOwnPropertyDescriptor(extendedClass.prototype, name) || /* @__PURE__ */ Object.create(null)\n      );\n    }\n  }\n}\nfunction getTableColumns(table) {\n  return table[Table.Symbol.Columns];\n}\nfunction getViewSelectedFields(view) {\n  return view[ViewBaseConfig].selectedFields;\n}\nfunction getTableLikeName(table) {\n  return is(table, Subquery) ? table._.alias : is(table, View) ? table[ViewBaseConfig].name : is(table, SQL) ? void 0 : table[Table.Symbol.IsAlias] ? table[Table.Symbol.Name] : table[Table.Symbol.BaseName];\n}\nfunction getColumnNameAndConfig(a, b) {\n  return {\n    name: typeof a === \"string\" && a.length > 0 ? a : \"\",\n    config: typeof a === \"object\" ? a : b\n  };\n}\nconst _ = {};\nconst __ = {};\nfunction isConfig(data) {\n  if (typeof data !== \"object\" || data === null) return false;\n  if (data.constructor.name !== \"Object\") return false;\n  if (\"logger\" in data) {\n    const type = typeof data[\"logger\"];\n    if (type !== \"boolean\" && (type !== \"object\" || typeof data[\"logger\"][\"logQuery\"] !== \"function\") && type !== \"undefined\") return false;\n    return true;\n  }\n  if (\"schema\" in data) {\n    const type = typeof data[\"schema\"];\n    if (type !== \"object\" && type !== \"undefined\") return false;\n    return true;\n  }\n  if (\"casing\" in data) {\n    const type = typeof data[\"casing\"];\n    if (type !== \"string\" && type !== \"undefined\") return false;\n    return true;\n  }\n  if (\"mode\" in data) {\n    if (data[\"mode\"] !== \"default\" || data[\"mode\"] !== \"planetscale\" || data[\"mode\"] !== void 0) return false;\n    return true;\n  }\n  if (\"connection\" in data) {\n    const type = typeof data[\"connection\"];\n    if (type !== \"string\" && type !== \"object\" && type !== \"undefined\") return false;\n    return true;\n  }\n  if (\"client\" in data) {\n    const type = typeof data[\"client\"];\n    if (type !== \"object\" && type !== \"function\" && type !== \"undefined\") return false;\n    return true;\n  }\n  if (Object.keys(data).length === 0) return true;\n  return false;\n}\nconst textDecoder = typeof TextDecoder === \"undefined\" ? null : new TextDecoder();\nexport {\n  applyMixins,\n  getColumnNameAndConfig,\n  getTableColumns,\n  getTableLikeName,\n  getViewSelectedFields,\n  haveSameKeys,\n  isConfig,\n  mapResultRow,\n  mapUpdateSet,\n  orderSelectedFields,\n  textDecoder\n};\n//# sourceMappingURL=utils.js.map","import { Column } from \"../../column.js\";\nimport { is } from \"../../entity.js\";\nimport { Table } from \"../../table.js\";\nimport {\n  isDriverValueEncoder,\n  isSQLWrapper,\n  Param,\n  Placeholder,\n  SQL,\n  sql,\n  StringChunk,\n  View\n} from \"../sql.js\";\nfunction bindIfParam(value, column) {\n  if (isDriverValueEncoder(column) && !isSQLWrapper(value) && !is(value, Param) && !is(value, Placeholder) && !is(value, Column) && !is(value, Table) && !is(value, View)) {\n    return new Param(value, column);\n  }\n  return value;\n}\nconst eq = (left, right) => {\n  return sql`${left} = ${bindIfParam(right, left)}`;\n};\nconst ne = (left, right) => {\n  return sql`${left} <> ${bindIfParam(right, left)}`;\n};\nfunction and(...unfilteredConditions) {\n  const conditions = unfilteredConditions.filter(\n    (c) => c !== void 0\n  );\n  if (conditions.length === 0) {\n    return void 0;\n  }\n  if (conditions.length === 1) {\n    return new SQL(conditions);\n  }\n  return new SQL([\n    new StringChunk(\"(\"),\n    sql.join(conditions, new StringChunk(\" and \")),\n    new StringChunk(\")\")\n  ]);\n}\nfunction or(...unfilteredConditions) {\n  const conditions = unfilteredConditions.filter(\n    (c) => c !== void 0\n  );\n  if (conditions.length === 0) {\n    return void 0;\n  }\n  if (conditions.length === 1) {\n    return new SQL(conditions);\n  }\n  return new SQL([\n    new StringChunk(\"(\"),\n    sql.join(conditions, new StringChunk(\" or \")),\n    new StringChunk(\")\")\n  ]);\n}\nfunction not(condition) {\n  return sql`not ${condition}`;\n}\nconst gt = (left, right) => {\n  return sql`${left} > ${bindIfParam(right, left)}`;\n};\nconst gte = (left, right) => {\n  return sql`${left} >= ${bindIfParam(right, left)}`;\n};\nconst lt = (left, right) => {\n  return sql`${left} < ${bindIfParam(right, left)}`;\n};\nconst lte = (left, right) => {\n  return sql`${left} <= ${bindIfParam(right, left)}`;\n};\nfunction inArray(column, values) {\n  if (Array.isArray(values)) {\n    if (values.length === 0) {\n      return sql`false`;\n    }\n    return sql`${column} in ${values.map((v) => bindIfParam(v, column))}`;\n  }\n  return sql`${column} in ${bindIfParam(values, column)}`;\n}\nfunction notInArray(column, values) {\n  if (Array.isArray(values)) {\n    if (values.length === 0) {\n      return sql`true`;\n    }\n    return sql`${column} not in ${values.map((v) => bindIfParam(v, column))}`;\n  }\n  return sql`${column} not in ${bindIfParam(values, column)}`;\n}\nfunction isNull(value) {\n  return sql`${value} is null`;\n}\nfunction isNotNull(value) {\n  return sql`${value} is not null`;\n}\nfunction exists(subquery) {\n  return sql`exists ${subquery}`;\n}\nfunction notExists(subquery) {\n  return sql`not exists ${subquery}`;\n}\nfunction between(column, min, max) {\n  return sql`${column} between ${bindIfParam(min, column)} and ${bindIfParam(\n    max,\n    column\n  )}`;\n}\nfunction notBetween(column, min, max) {\n  return sql`${column} not between ${bindIfParam(\n    min,\n    column\n  )} and ${bindIfParam(max, column)}`;\n}\nfunction like(column, value) {\n  return sql`${column} like ${value}`;\n}\nfunction notLike(column, value) {\n  return sql`${column} not like ${value}`;\n}\nfunction ilike(column, value) {\n  return sql`${column} ilike ${value}`;\n}\nfunction notIlike(column, value) {\n  return sql`${column} not ilike ${value}`;\n}\nfunction arrayContains(column, values) {\n  if (Array.isArray(values)) {\n    if (values.length === 0) {\n      throw new Error(\"arrayContains requires at least one value\");\n    }\n    const array = sql`${bindIfParam(values, column)}`;\n    return sql`${column} @> ${array}`;\n  }\n  return sql`${column} @> ${bindIfParam(values, column)}`;\n}\nfunction arrayContained(column, values) {\n  if (Array.isArray(values)) {\n    if (values.length === 0) {\n      throw new Error(\"arrayContained requires at least one value\");\n    }\n    const array = sql`${bindIfParam(values, column)}`;\n    return sql`${column} <@ ${array}`;\n  }\n  return sql`${column} <@ ${bindIfParam(values, column)}`;\n}\nfunction arrayOverlaps(column, values) {\n  if (Array.isArray(values)) {\n    if (values.length === 0) {\n      throw new Error(\"arrayOverlaps requires at least one value\");\n    }\n    const array = sql`${bindIfParam(values, column)}`;\n    return sql`${column} && ${array}`;\n  }\n  return sql`${column} && ${bindIfParam(values, column)}`;\n}\nexport {\n  and,\n  arrayContained,\n  arrayContains,\n  arrayOverlaps,\n  between,\n  bindIfParam,\n  eq,\n  exists,\n  gt,\n  gte,\n  ilike,\n  inArray,\n  isNotNull,\n  isNull,\n  like,\n  lt,\n  lte,\n  ne,\n  not,\n  notBetween,\n  notExists,\n  notIlike,\n  notInArray,\n  notLike,\n  or\n};\n//# sourceMappingURL=conditions.js.map","import { entityKind } from \"../entity.js\";\nimport { TableName } from \"../table.utils.js\";\nclass ForeignKeyBuilder {\n  static [entityKind] = \"SQLiteForeignKeyBuilder\";\n  /** @internal */\n  reference;\n  /** @internal */\n  _onUpdate;\n  /** @internal */\n  _onDelete;\n  constructor(config, actions) {\n    this.reference = () => {\n      const { name, columns, foreignColumns } = config();\n      return { name, columns, foreignTable: foreignColumns[0].table, foreignColumns };\n    };\n    if (actions) {\n      this._onUpdate = actions.onUpdate;\n      this._onDelete = actions.onDelete;\n    }\n  }\n  onUpdate(action) {\n    this._onUpdate = action;\n    return this;\n  }\n  onDelete(action) {\n    this._onDelete = action;\n    return this;\n  }\n  /** @internal */\n  build(table) {\n    return new ForeignKey(table, this);\n  }\n}\nclass ForeignKey {\n  constructor(table, builder) {\n    this.table = table;\n    this.reference = builder.reference;\n    this.onUpdate = builder._onUpdate;\n    this.onDelete = builder._onDelete;\n  }\n  static [entityKind] = \"SQLiteForeignKey\";\n  reference;\n  onUpdate;\n  onDelete;\n  getName() {\n    const { name, columns, foreignColumns } = this.reference();\n    const columnNames = columns.map((column) => column.name);\n    const foreignColumnNames = foreignColumns.map((column) => column.name);\n    const chunks = [\n      this.table[TableName],\n      ...columnNames,\n      foreignColumns[0].table[TableName],\n      ...foreignColumnNames\n    ];\n    return name ?? `${chunks.join(\"_\")}_fk`;\n  }\n}\nfunction foreignKey(config) {\n  function mappedConfig() {\n    if (typeof config === \"function\") {\n      const { name, columns, foreignColumns } = config();\n      return {\n        name,\n        columns,\n        foreignColumns\n      };\n    }\n    return config;\n  }\n  return new ForeignKeyBuilder(mappedConfig);\n}\nexport {\n  ForeignKey,\n  ForeignKeyBuilder,\n  foreignKey\n};\n//# sourceMappingURL=foreign-keys.js.map","import { entityKind } from \"../entity.js\";\nimport { TableName } from \"../table.utils.js\";\nfunction uniqueKeyName(table, columns) {\n  return `${table[TableName]}_${columns.join(\"_\")}_unique`;\n}\nfunction unique(name) {\n  return new UniqueOnConstraintBuilder(name);\n}\nclass UniqueConstraintBuilder {\n  constructor(columns, name) {\n    this.name = name;\n    this.columns = columns;\n  }\n  static [entityKind] = \"SQLiteUniqueConstraintBuilder\";\n  /** @internal */\n  columns;\n  /** @internal */\n  build(table) {\n    return new UniqueConstraint(table, this.columns, this.name);\n  }\n}\nclass UniqueOnConstraintBuilder {\n  static [entityKind] = \"SQLiteUniqueOnConstraintBuilder\";\n  /** @internal */\n  name;\n  constructor(name) {\n    this.name = name;\n  }\n  on(...columns) {\n    return new UniqueConstraintBuilder(columns, this.name);\n  }\n}\nclass UniqueConstraint {\n  constructor(table, columns, name) {\n    this.table = table;\n    this.columns = columns;\n    this.name = name ?? uniqueKeyName(this.table, this.columns.map((column) => column.name));\n  }\n  static [entityKind] = \"SQLiteUniqueConstraint\";\n  columns;\n  name;\n  getName() {\n    return this.name;\n  }\n}\nexport {\n  UniqueConstraint,\n  UniqueConstraintBuilder,\n  UniqueOnConstraintBuilder,\n  unique,\n  uniqueKeyName\n};\n//# sourceMappingURL=unique-constraint.js.map","import { ColumnBuilder } from \"../../column-builder.js\";\nimport { Column } from \"../../column.js\";\nimport { entityKind } from \"../../entity.js\";\nimport { ForeignKeyBuilder } from \"../foreign-keys.js\";\nimport { uniqueKeyName } from \"../unique-constraint.js\";\nclass SQLiteColumnBuilder extends ColumnBuilder {\n  static [entityKind] = \"SQLiteColumnBuilder\";\n  foreignKeyConfigs = [];\n  references(ref, actions = {}) {\n    this.foreignKeyConfigs.push({ ref, actions });\n    return this;\n  }\n  unique(name) {\n    this.config.isUnique = true;\n    this.config.uniqueName = name;\n    return this;\n  }\n  generatedAlwaysAs(as, config) {\n    this.config.generated = {\n      as,\n      type: \"always\",\n      mode: config?.mode ?? \"virtual\"\n    };\n    return this;\n  }\n  /** @internal */\n  buildForeignKeys(column, table) {\n    return this.foreignKeyConfigs.map(({ ref, actions }) => {\n      return ((ref2, actions2) => {\n        const builder = new ForeignKeyBuilder(() => {\n          const foreignColumn = ref2();\n          return { columns: [column], foreignColumns: [foreignColumn] };\n        });\n        if (actions2.onUpdate) {\n          builder.onUpdate(actions2.onUpdate);\n        }\n        if (actions2.onDelete) {\n          builder.onDelete(actions2.onDelete);\n        }\n        return builder.build(table);\n      })(ref, actions);\n    });\n  }\n}\nclass SQLiteColumn extends Column {\n  constructor(table, config) {\n    if (!config.uniqueName) {\n      config.uniqueName = uniqueKeyName(table, [config.name]);\n    }\n    super(table, config);\n    this.table = table;\n  }\n  static [entityKind] = \"SQLiteColumn\";\n}\nexport {\n  SQLiteColumn,\n  SQLiteColumnBuilder\n};\n//# sourceMappingURL=common.js.map","import { entityKind } from \"../../entity.js\";\nimport { getColumnNameAndConfig, textDecoder } from \"../../utils.js\";\nimport { SQLiteColumn, SQLiteColumnBuilder } from \"./common.js\";\nclass SQLiteBigIntBuilder extends SQLiteColumnBuilder {\n  static [entityKind] = \"SQLiteBigIntBuilder\";\n  constructor(name) {\n    super(name, \"bigint\", \"SQLiteBigInt\");\n  }\n  /** @internal */\n  build(table) {\n    return new SQLiteBigInt(table, this.config);\n  }\n}\nclass SQLiteBigInt extends SQLiteColumn {\n  static [entityKind] = \"SQLiteBigInt\";\n  getSQLType() {\n    return \"blob\";\n  }\n  mapFromDriverValue(value) {\n    if (typeof Buffer !== \"undefined\" && Buffer.from) {\n      const buf = Buffer.isBuffer(value) ? value : value instanceof ArrayBuffer ? Buffer.from(value) : value.buffer ? Buffer.from(value.buffer, value.byteOffset, value.byteLength) : Buffer.from(value);\n      return BigInt(buf.toString(\"utf8\"));\n    }\n    return BigInt(textDecoder.decode(value));\n  }\n  mapToDriverValue(value) {\n    return Buffer.from(value.toString());\n  }\n}\nclass SQLiteBlobJsonBuilder extends SQLiteColumnBuilder {\n  static [entityKind] = \"SQLiteBlobJsonBuilder\";\n  constructor(name) {\n    super(name, \"json\", \"SQLiteBlobJson\");\n  }\n  /** @internal */\n  build(table) {\n    return new SQLiteBlobJson(\n      table,\n      this.config\n    );\n  }\n}\nclass SQLiteBlobJson extends SQLiteColumn {\n  static [entityKind] = \"SQLiteBlobJson\";\n  getSQLType() {\n    return \"blob\";\n  }\n  mapFromDriverValue(value) {\n    if (typeof Buffer !== \"undefined\" && Buffer.from) {\n      const buf = Buffer.isBuffer(value) ? value : value instanceof ArrayBuffer ? Buffer.from(value) : value.buffer ? Buffer.from(value.buffer, value.byteOffset, value.byteLength) : Buffer.from(value);\n      return JSON.parse(buf.toString(\"utf8\"));\n    }\n    return JSON.parse(textDecoder.decode(value));\n  }\n  mapToDriverValue(value) {\n    return Buffer.from(JSON.stringify(value));\n  }\n}\nclass SQLiteBlobBufferBuilder extends SQLiteColumnBuilder {\n  static [entityKind] = \"SQLiteBlobBufferBuilder\";\n  constructor(name) {\n    super(name, \"buffer\", \"SQLiteBlobBuffer\");\n  }\n  /** @internal */\n  build(table) {\n    return new SQLiteBlobBuffer(table, this.config);\n  }\n}\nclass SQLiteBlobBuffer extends SQLiteColumn {\n  static [entityKind] = \"SQLiteBlobBuffer\";\n  mapFromDriverValue(value) {\n    if (Buffer.isBuffer(value)) {\n      return value;\n    }\n    return Buffer.from(value);\n  }\n  getSQLType() {\n    return \"blob\";\n  }\n}\nfunction blob(a, b) {\n  const { name, config } = getColumnNameAndConfig(a, b);\n  if (config?.mode === \"json\") {\n    return new SQLiteBlobJsonBuilder(name);\n  }\n  if (config?.mode === \"bigint\") {\n    return new SQLiteBigIntBuilder(name);\n  }\n  return new SQLiteBlobBufferBuilder(name);\n}\nexport {\n  SQLiteBigInt,\n  SQLiteBigIntBuilder,\n  SQLiteBlobBuffer,\n  SQLiteBlobBufferBuilder,\n  SQLiteBlobJson,\n  SQLiteBlobJsonBuilder,\n  blob\n};\n//# sourceMappingURL=blob.js.map","import { entityKind } from \"../../entity.js\";\nimport { getColumnNameAndConfig } from \"../../utils.js\";\nimport { SQLiteColumn, SQLiteColumnBuilder } from \"./common.js\";\nclass SQLiteCustomColumnBuilder extends SQLiteColumnBuilder {\n  static [entityKind] = \"SQLiteCustomColumnBuilder\";\n  constructor(name, fieldConfig, customTypeParams) {\n    super(name, \"custom\", \"SQLiteCustomColumn\");\n    this.config.fieldConfig = fieldConfig;\n    this.config.customTypeParams = customTypeParams;\n  }\n  /** @internal */\n  build(table) {\n    return new SQLiteCustomColumn(\n      table,\n      this.config\n    );\n  }\n}\nclass SQLiteCustomColumn extends SQLiteColumn {\n  static [entityKind] = \"SQLiteCustomColumn\";\n  sqlName;\n  mapTo;\n  mapFrom;\n  constructor(table, config) {\n    super(table, config);\n    this.sqlName = config.customTypeParams.dataType(config.fieldConfig);\n    this.mapTo = config.customTypeParams.toDriver;\n    this.mapFrom = config.customTypeParams.fromDriver;\n  }\n  getSQLType() {\n    return this.sqlName;\n  }\n  mapFromDriverValue(value) {\n    return typeof this.mapFrom === \"function\" ? this.mapFrom(value) : value;\n  }\n  mapToDriverValue(value) {\n    return typeof this.mapTo === \"function\" ? this.mapTo(value) : value;\n  }\n}\nfunction customType(customTypeParams) {\n  return (a, b) => {\n    const { name, config } = getColumnNameAndConfig(a, b);\n    return new SQLiteCustomColumnBuilder(\n      name,\n      config,\n      customTypeParams\n    );\n  };\n}\nexport {\n  SQLiteCustomColumn,\n  SQLiteCustomColumnBuilder,\n  customType\n};\n//# sourceMappingURL=custom.js.map","import { entityKind } from \"../../entity.js\";\nimport { sql } from \"../../sql/sql.js\";\nimport { getColumnNameAndConfig } from \"../../utils.js\";\nimport { SQLiteColumn, SQLiteColumnBuilder } from \"./common.js\";\nclass SQLiteBaseIntegerBuilder extends SQLiteColumnBuilder {\n  static [entityKind] = \"SQLiteBaseIntegerBuilder\";\n  constructor(name, dataType, columnType) {\n    super(name, dataType, columnType);\n    this.config.autoIncrement = false;\n  }\n  primaryKey(config) {\n    if (config?.autoIncrement) {\n      this.config.autoIncrement = true;\n    }\n    this.config.hasDefault = true;\n    return super.primaryKey();\n  }\n}\nclass SQLiteBaseInteger extends SQLiteColumn {\n  static [entityKind] = \"SQLiteBaseInteger\";\n  autoIncrement = this.config.autoIncrement;\n  getSQLType() {\n    return \"integer\";\n  }\n}\nclass SQLiteIntegerBuilder extends SQLiteBaseIntegerBuilder {\n  static [entityKind] = \"SQLiteIntegerBuilder\";\n  constructor(name) {\n    super(name, \"number\", \"SQLiteInteger\");\n  }\n  build(table) {\n    return new SQLiteInteger(\n      table,\n      this.config\n    );\n  }\n}\nclass SQLiteInteger extends SQLiteBaseInteger {\n  static [entityKind] = \"SQLiteInteger\";\n}\nclass SQLiteTimestampBuilder extends SQLiteBaseIntegerBuilder {\n  static [entityKind] = \"SQLiteTimestampBuilder\";\n  constructor(name, mode) {\n    super(name, \"date\", \"SQLiteTimestamp\");\n    this.config.mode = mode;\n  }\n  /**\n   * @deprecated Use `default()` with your own expression instead.\n   *\n   * Adds `DEFAULT (cast((julianday('now') - 2440587.5)*86400000 as integer))` to the column, which is the current epoch timestamp in milliseconds.\n   */\n  defaultNow() {\n    return this.default(sql`(cast((julianday('now') - 2440587.5)*86400000 as integer))`);\n  }\n  build(table) {\n    return new SQLiteTimestamp(\n      table,\n      this.config\n    );\n  }\n}\nclass SQLiteTimestamp extends SQLiteBaseInteger {\n  static [entityKind] = \"SQLiteTimestamp\";\n  mode = this.config.mode;\n  mapFromDriverValue(value) {\n    if (this.config.mode === \"timestamp\") {\n      return new Date(value * 1e3);\n    }\n    return new Date(value);\n  }\n  mapToDriverValue(value) {\n    const unix = value.getTime();\n    if (this.config.mode === \"timestamp\") {\n      return Math.floor(unix / 1e3);\n    }\n    return unix;\n  }\n}\nclass SQLiteBooleanBuilder extends SQLiteBaseIntegerBuilder {\n  static [entityKind] = \"SQLiteBooleanBuilder\";\n  constructor(name, mode) {\n    super(name, \"boolean\", \"SQLiteBoolean\");\n    this.config.mode = mode;\n  }\n  build(table) {\n    return new SQLiteBoolean(\n      table,\n      this.config\n    );\n  }\n}\nclass SQLiteBoolean extends SQLiteBaseInteger {\n  static [entityKind] = \"SQLiteBoolean\";\n  mode = this.config.mode;\n  mapFromDriverValue(value) {\n    return Number(value) === 1;\n  }\n  mapToDriverValue(value) {\n    return value ? 1 : 0;\n  }\n}\nfunction integer(a, b) {\n  const { name, config } = getColumnNameAndConfig(a, b);\n  if (config?.mode === \"timestamp\" || config?.mode === \"timestamp_ms\") {\n    return new SQLiteTimestampBuilder(name, config.mode);\n  }\n  if (config?.mode === \"boolean\") {\n    return new SQLiteBooleanBuilder(name, config.mode);\n  }\n  return new SQLiteIntegerBuilder(name);\n}\nconst int = integer;\nexport {\n  SQLiteBaseInteger,\n  SQLiteBaseIntegerBuilder,\n  SQLiteBoolean,\n  SQLiteBooleanBuilder,\n  SQLiteInteger,\n  SQLiteIntegerBuilder,\n  SQLiteTimestamp,\n  SQLiteTimestampBuilder,\n  int,\n  integer\n};\n//# sourceMappingURL=integer.js.map","import { entityKind } from \"../../entity.js\";\nimport { getColumnNameAndConfig } from \"../../utils.js\";\nimport { SQLiteColumn, SQLiteColumnBuilder } from \"./common.js\";\nclass SQLiteNumericBuilder extends SQLiteColumnBuilder {\n  static [entityKind] = \"SQLiteNumericBuilder\";\n  constructor(name) {\n    super(name, \"string\", \"SQLiteNumeric\");\n  }\n  /** @internal */\n  build(table) {\n    return new SQLiteNumeric(\n      table,\n      this.config\n    );\n  }\n}\nclass SQLiteNumeric extends SQLiteColumn {\n  static [entityKind] = \"SQLiteNumeric\";\n  mapFromDriverValue(value) {\n    if (typeof value === \"string\") return value;\n    return String(value);\n  }\n  getSQLType() {\n    return \"numeric\";\n  }\n}\nclass SQLiteNumericNumberBuilder extends SQLiteColumnBuilder {\n  static [entityKind] = \"SQLiteNumericNumberBuilder\";\n  constructor(name) {\n    super(name, \"number\", \"SQLiteNumericNumber\");\n  }\n  /** @internal */\n  build(table) {\n    return new SQLiteNumericNumber(\n      table,\n      this.config\n    );\n  }\n}\nclass SQLiteNumericNumber extends SQLiteColumn {\n  static [entityKind] = \"SQLiteNumericNumber\";\n  mapFromDriverValue(value) {\n    if (typeof value === \"number\") return value;\n    return Number(value);\n  }\n  mapToDriverValue = String;\n  getSQLType() {\n    return \"numeric\";\n  }\n}\nclass SQLiteNumericBigIntBuilder extends SQLiteColumnBuilder {\n  static [entityKind] = \"SQLiteNumericBigIntBuilder\";\n  constructor(name) {\n    super(name, \"bigint\", \"SQLiteNumericBigInt\");\n  }\n  /** @internal */\n  build(table) {\n    return new SQLiteNumericBigInt(\n      table,\n      this.config\n    );\n  }\n}\nclass SQLiteNumericBigInt extends SQLiteColumn {\n  static [entityKind] = \"SQLiteNumericBigInt\";\n  mapFromDriverValue = BigInt;\n  mapToDriverValue = String;\n  getSQLType() {\n    return \"numeric\";\n  }\n}\nfunction numeric(a, b) {\n  const { name, config } = getColumnNameAndConfig(a, b);\n  const mode = config?.mode;\n  return mode === \"number\" ? new SQLiteNumericNumberBuilder(name) : mode === \"bigint\" ? new SQLiteNumericBigIntBuilder(name) : new SQLiteNumericBuilder(name);\n}\nexport {\n  SQLiteNumeric,\n  SQLiteNumericBigInt,\n  SQLiteNumericBigIntBuilder,\n  SQLiteNumericBuilder,\n  SQLiteNumericNumber,\n  SQLiteNumericNumberBuilder,\n  numeric\n};\n//# sourceMappingURL=numeric.js.map","import { entityKind } from \"../../entity.js\";\nimport { SQLiteColumn, SQLiteColumnBuilder } from \"./common.js\";\nclass SQLiteRealBuilder extends SQLiteColumnBuilder {\n  static [entityKind] = \"SQLiteRealBuilder\";\n  constructor(name) {\n    super(name, \"number\", \"SQLiteReal\");\n  }\n  /** @internal */\n  build(table) {\n    return new SQLiteReal(table, this.config);\n  }\n}\nclass SQLiteReal extends SQLiteColumn {\n  static [entityKind] = \"SQLiteReal\";\n  getSQLType() {\n    return \"real\";\n  }\n}\nfunction real(name) {\n  return new SQLiteRealBuilder(name ?? \"\");\n}\nexport {\n  SQLiteReal,\n  SQLiteRealBuilder,\n  real\n};\n//# sourceMappingURL=real.js.map","import { entityKind } from \"../../entity.js\";\nimport { getColumnNameAndConfig } from \"../../utils.js\";\nimport { SQLiteColumn, SQLiteColumnBuilder } from \"./common.js\";\nclass SQLiteTextBuilder extends SQLiteColumnBuilder {\n  static [entityKind] = \"SQLiteTextBuilder\";\n  constructor(name, config) {\n    super(name, \"string\", \"SQLiteText\");\n    this.config.enumValues = config.enum;\n    this.config.length = config.length;\n  }\n  /** @internal */\n  build(table) {\n    return new SQLiteText(\n      table,\n      this.config\n    );\n  }\n}\nclass SQLiteText extends SQLiteColumn {\n  static [entityKind] = \"SQLiteText\";\n  enumValues = this.config.enumValues;\n  length = this.config.length;\n  constructor(table, config) {\n    super(table, config);\n  }\n  getSQLType() {\n    return `text${this.config.length ? `(${this.config.length})` : \"\"}`;\n  }\n}\nclass SQLiteTextJsonBuilder extends SQLiteColumnBuilder {\n  static [entityKind] = \"SQLiteTextJsonBuilder\";\n  constructor(name) {\n    super(name, \"json\", \"SQLiteTextJson\");\n  }\n  /** @internal */\n  build(table) {\n    return new SQLiteTextJson(\n      table,\n      this.config\n    );\n  }\n}\nclass SQLiteTextJson extends SQLiteColumn {\n  static [entityKind] = \"SQLiteTextJson\";\n  getSQLType() {\n    return \"text\";\n  }\n  mapFromDriverValue(value) {\n    return JSON.parse(value);\n  }\n  mapToDriverValue(value) {\n    return JSON.stringify(value);\n  }\n}\nfunction text(a, b = {}) {\n  const { name, config } = getColumnNameAndConfig(a, b);\n  if (config.mode === \"json\") {\n    return new SQLiteTextJsonBuilder(name);\n  }\n  return new SQLiteTextBuilder(name, config);\n}\nexport {\n  SQLiteText,\n  SQLiteTextBuilder,\n  SQLiteTextJson,\n  SQLiteTextJsonBuilder,\n  text\n};\n//# sourceMappingURL=text.js.map","import { blob } from \"./blob.js\";\nimport { customType } from \"./custom.js\";\nimport { integer } from \"./integer.js\";\nimport { numeric } from \"./numeric.js\";\nimport { real } from \"./real.js\";\nimport { text } from \"./text.js\";\nfunction getSQLiteColumnBuilders() {\n  return {\n    blob,\n    customType,\n    integer,\n    numeric,\n    real,\n    text\n  };\n}\nexport {\n  getSQLiteColumnBuilders\n};\n//# sourceMappingURL=all.js.map","import { entityKind } from \"../entity.js\";\nimport { Table } from \"../table.js\";\nimport { getSQLiteColumnBuilders } from \"./columns/all.js\";\nconst InlineForeignKeys = Symbol.for(\"drizzle:SQLiteInlineForeignKeys\");\nclass SQLiteTable extends Table {\n  static [entityKind] = \"SQLiteTable\";\n  /** @internal */\n  static Symbol = Object.assign({}, Table.Symbol, {\n    InlineForeignKeys\n  });\n  /** @internal */\n  [Table.Symbol.Columns];\n  /** @internal */\n  [InlineForeignKeys] = [];\n  /** @internal */\n  [Table.Symbol.ExtraConfigBuilder] = void 0;\n}\nfunction sqliteTableBase(name, columns, extraConfig, schema, baseName = name) {\n  const rawTable = new SQLiteTable(name, schema, baseName);\n  const parsedColumns = typeof columns === \"function\" ? columns(getSQLiteColumnBuilders()) : columns;\n  const builtColumns = Object.fromEntries(\n    Object.entries(parsedColumns).map(([name2, colBuilderBase]) => {\n      const colBuilder = colBuilderBase;\n      colBuilder.setName(name2);\n      const column = colBuilder.build(rawTable);\n      rawTable[InlineForeignKeys].push(...colBuilder.buildForeignKeys(column, rawTable));\n      return [name2, column];\n    })\n  );\n  const table = Object.assign(rawTable, builtColumns);\n  table[Table.Symbol.Columns] = builtColumns;\n  table[Table.Symbol.ExtraConfigColumns] = builtColumns;\n  if (extraConfig) {\n    table[SQLiteTable.Symbol.ExtraConfigBuilder] = extraConfig;\n  }\n  return table;\n}\nconst sqliteTable = (name, columns, extraConfig) => {\n  return sqliteTableBase(name, columns, extraConfig);\n};\nfunction sqliteTableCreator(customizeTableName) {\n  return (name, columns, extraConfig) => {\n    return sqliteTableBase(customizeTableName(name), columns, extraConfig, void 0, name);\n  };\n}\nexport {\n  InlineForeignKeys,\n  SQLiteTable,\n  sqliteTable,\n  sqliteTableCreator\n};\n//# sourceMappingURL=table.js.map","import { createdAt, cuid, updatedAt } from '@ycore/forge/utils';\nimport { integer, sqliteTable, text } from 'drizzle-orm/sqlite-core';\n\n/**\n * Pending data types stored in users.pending field\n */\nexport type PendingEmailChange = {\n  type: 'email-change';\n  email: string;\n  timestamp: number;\n};\n\nexport type PendingRecovery = {\n  type: 'recovery';\n  timestamp: number;\n};\n\nexport type PendingAccountDelete = {\n  type: 'account-delete';\n  timestamp: number;\n};\n\nexport type PendingData = PendingEmailChange | PendingRecovery | PendingAccountDelete;\n\n/**\n * User account status values\n */\nexport type UserStatus = 'active' | 'unverified' | 'unrecovered' | 'deleted';\n\nexport const users = sqliteTable('users', {\n  id: cuid('id').primaryKey().notNull(),\n  email: text('email').notNull().unique(),\n  displayName: text('display_name').notNull(),\n  status: text('status', { enum: ['active', 'unverified', 'unrecovered', 'deleted'] as const })\n    .notNull()\n    .default('unverified')\n    .$type<UserStatus>(),\n  pending: text('pending', { mode: 'json' }).$type<PendingData | null>(),\n  createdAt,\n  updatedAt,\n});\n\nexport const authenticators = sqliteTable('authenticators', {\n  id: text('id').primaryKey().notNull(),\n  userId: text('user_id')\n    .notNull()\n    .references(() => users.id, { onDelete: 'cascade' }),\n  credentialPublicKey: text('credential_public_key').notNull(),\n  counter: integer('counter').notNull(),\n  credentialDeviceType: text('credential_device_type').notNull(),\n  credentialBackedUp: integer('credential_backed_up', { mode: 'boolean' }).notNull(),\n  transports: text('transports', { mode: 'json' }).notNull().$type<string[]>(),\n  aaguid: text('aaguid').notNull(),\n  name: text('name'),\n  lastUsedAt: integer('last_used_at', { mode: 'timestamp' }),\n  attestationType: text('attestation_type').notNull().default('none'),\n  rpId: text('rp_id').notNull(),\n  algorithm: integer('algorithm').notNull(),\n  createdAt,\n  updatedAt,\n});\n","import type { Result } from '@ycore/forge/result';\nimport { err, notFoundError, serverError, tryCatch } from '@ycore/forge/result';\nimport { getDatabase } from '@ycore/forge/services';\nimport { and, eq, lt } from 'drizzle-orm';\nimport type { DrizzleD1Database } from 'drizzle-orm/d1';\nimport type { RouterContextProvider } from 'react-router';\nimport type { Authenticator, NewAuthenticator, NewUser, PendingData, User, UserStatus } from '../schema';\nimport { authenticators, users } from '../schema';\n\nexport interface AuthRepository {\n  getUserById: (id: string) => Promise<Result<User>>;\n  getUserByEmail: (email: string) => Promise<Result<User>>;\n  createUser: (email: string, displayName: string) => Promise<Result<User>>;\n  getAuthenticatorById: (id: string) => Promise<Result<Authenticator>>;\n  getAuthenticatorsByUserId: (userId: string) => Promise<Result<Authenticator[]>>;\n  createAuthenticator: (authenticator: Omit<NewAuthenticator, 'createdAt' | 'updatedAt'>) => Promise<Result<Authenticator>>;\n  updateAuthenticatorCounter: (id: string, counter: number) => Promise<Result<boolean>>;\n  updateAuthenticatorUsage: (id: string, counter: number, lastUsedAt: Date) => Promise<Result<boolean>>;\n  updateAuthenticatorName: (id: string, name: string) => Promise<Result<Authenticator>>;\n  deleteAuthenticator: (id: string) => Promise<Result<boolean>>;\n  authenticatorBelongsToUser: (id: string, userId: string) => Promise<Result<boolean>>;\n  countAuthenticatorsByUserId: (userId: string) => Promise<Result<number>>;\n  deleteAuthenticatorsByTimestamp: (userId: string, beforeTimestamp: number) => Promise<Result<number>>;\n  updateUserEmail: (id: string, newEmail: string) => Promise<Result<User>>;\n  updateUserStatus: (id: string, status: UserStatus) => Promise<Result<User>>;\n  updateUserPending: (id: string, pending: PendingData | null) => Promise<Result<User>>;\n  deleteUser: (id: string) => Promise<Result<boolean>>;\n  deleteUserAccount: (id: string) => Promise<Result<User>>;\n}\n\n/**\n * Create authentication repository instance with database operations\n */\nexport function createAuthRepository(db: DrizzleD1Database<Record<string, unknown>>): AuthRepository {\n  return {\n    /** Get user by ID */\n    getUserById: async (id: string) => {\n      return tryCatch(async () => {\n        const result = await db.select().from(users).where(eq(users.id, id)).get();\n\n        if (!result) {\n          return notFoundError('User', id);\n        }\n\n        return result;\n      }, `Failed to get user by ID: ${id}`);\n    },\n\n    /** Get user by email */\n    getUserByEmail: async (email: string) => {\n      return tryCatch(async () => {\n        const result = await db.select().from(users).where(eq(users.email, email)).get();\n\n        if (!result) {\n          return notFoundError('User', email);\n        }\n\n        return result;\n      }, `Failed to get user by email: ${email}`);\n    },\n\n    /** Create a new user */\n    createUser: async (email: string, displayName: string) => {\n      try {\n        const newUser: NewUser = { email, displayName };\n        const [result] = await db.insert(users).values(newUser).returning();\n\n        if (!result) {\n          return err('Failed to create user', { email, displayName });\n        }\n\n        return result;\n      } catch (error) {\n        // Check for unique constraint violation\n        if (error instanceof Error && error.message.includes('UNIQUE')) {\n          return err('Email already exists', {\n            email,\n            code: 'DUPLICATE_USER',\n          });\n        }\n\n        return serverError('Failed to create user', error as Error);\n      }\n    },\n\n    /** Get authenticator by ID */\n    getAuthenticatorById: async (id: string) => {\n      return tryCatch(async () => {\n        const result = await db.select().from(authenticators).where(eq(authenticators.id, id)).get();\n\n        if (!result) {\n          return notFoundError('Authenticator', id);\n        }\n\n        return result;\n      }, `Failed to get authenticator by ID: ${id}`);\n    },\n\n    /** Get all authenticators for a user */\n    getAuthenticatorsByUserId: async (userId: string) => {\n      return tryCatch(async () => {\n        const result = await db.select().from(authenticators).where(eq(authenticators.userId, userId)).all();\n\n        return result;\n      }, `Failed to get authenticators for user: ${userId}`);\n    },\n\n    /** Create a new authenticator */\n    createAuthenticator: async (authenticator: Omit<NewAuthenticator, 'createdAt' | 'updatedAt'>) => {\n      try {\n        const [result] = await db.insert(authenticators).values(authenticator).returning();\n\n        if (!result) {\n          return err('Failed to create authenticator', { id: authenticator.id });\n        }\n\n        return result;\n      } catch (error) {\n        return serverError('Failed to create authenticator', error as Error);\n      }\n    },\n\n    /** Update authenticator counter */\n    updateAuthenticatorCounter: async (id: string, counter: number) => {\n      try {\n        const result = await db.update(authenticators).set({ counter }).where(eq(authenticators.id, id)).returning();\n\n        if (result.length === 0) {\n          return notFoundError('Authenticator', id);\n        }\n\n        return true;\n      } catch (error) {\n        return serverError('Failed to update authenticator counter', error as Error);\n      }\n    },\n\n    /** Update authenticator usage (counter and last used timestamp) */\n    updateAuthenticatorUsage: async (id: string, counter: number, lastUsedAt: Date) => {\n      try {\n        const result = await db\n          .update(authenticators)\n          .set({\n            counter,\n            lastUsedAt,\n          })\n          .where(eq(authenticators.id, id))\n          .returning();\n\n        if (result.length === 0) {\n          return notFoundError('Authenticator', id);\n        }\n\n        return true;\n      } catch (error) {\n        return serverError('Failed to update authenticator usage', error as Error);\n      }\n    },\n\n    /** Update authenticator name */\n    updateAuthenticatorName: async (id: string, name: string) => {\n      try {\n        const result = await db.update(authenticators).set({ name }).where(eq(authenticators.id, id)).returning();\n\n        if (result.length === 0) {\n          return notFoundError('Authenticator', id);\n        }\n\n        const updatedAuthenticator = result[0];\n        if (!updatedAuthenticator) {\n          return serverError('Failed to retrieve updated authenticator', new Error('Update returned empty result'));\n        }\n\n        return updatedAuthenticator;\n      } catch (error) {\n        return serverError('Failed to update authenticator name', error as Error);\n      }\n    },\n\n    /** Delete an authenticator */\n    deleteAuthenticator: async (id: string) => {\n      try {\n        const result = await db.delete(authenticators).where(eq(authenticators.id, id)).returning();\n\n        if (result.length === 0) {\n          return notFoundError('Authenticator', id);\n        }\n\n        return true;\n      } catch (error) {\n        return serverError('Failed to delete authenticator', error as Error);\n      }\n    },\n\n    /** Check if an authenticator belongs to a specific user */\n    authenticatorBelongsToUser: async (id: string, userId: string) => {\n      return tryCatch(async () => {\n        const result = await db.select().from(authenticators).where(eq(authenticators.id, id)).get();\n\n        if (!result) {\n          return false;\n        }\n\n        return result.userId === userId;\n      }, `Failed to verify authenticator ownership for ID: ${id}`);\n    },\n\n    /** Count authenticators for a user */\n    countAuthenticatorsByUserId: async (userId: string) => {\n      return tryCatch(async () => {\n        const result = await db.select().from(authenticators).where(eq(authenticators.userId, userId)).all();\n\n        return result.length;\n      }, `Failed to count authenticators for user: ${userId}`);\n    },\n\n    /** Update user email and set status to unverified */\n    updateUserEmail: async (id: string, newEmail: string) => {\n      try {\n        const result = await db.update(users).set({ email: newEmail, status: 'unverified' }).where(eq(users.id, id)).returning();\n\n        if (result.length === 0) {\n          return notFoundError('User', id);\n        }\n\n        const updatedUser = result[0];\n        if (!updatedUser) {\n          return serverError('Failed to retrieve updated user', new Error('Update returned empty result'));\n        }\n\n        return updatedUser;\n      } catch (error) {\n        // Check for unique constraint violation\n        if (error instanceof Error && error.message.includes('UNIQUE')) {\n          return err('Email already exists', {\n            email: newEmail,\n            code: 'DUPLICATE_EMAIL',\n          });\n        }\n\n        return serverError('Failed to update user email', error as Error);\n      }\n    },\n\n    /** Update user status */\n    updateUserStatus: async (id: string, status: UserStatus) => {\n      try {\n        const result = await db.update(users).set({ status }).where(eq(users.id, id)).returning();\n\n        if (result.length === 0) {\n          return notFoundError('User', id);\n        }\n\n        const updatedUser = result[0];\n        if (!updatedUser) {\n          return serverError('Failed to retrieve updated user', new Error('Update returned empty result'));\n        }\n\n        return updatedUser;\n      } catch (error) {\n        return serverError('Failed to update user status', error as Error);\n      }\n    },\n\n    /** Update user pending data */\n    updateUserPending: async (id: string, pending: PendingData | null) => {\n      try {\n        const result = await db.update(users).set({ pending }).where(eq(users.id, id)).returning();\n\n        if (result.length === 0) {\n          return notFoundError('User', id);\n        }\n\n        const updatedUser = result[0];\n        if (!updatedUser) {\n          return serverError('Failed to retrieve updated user', new Error('Update returned empty result'));\n        }\n\n        return updatedUser;\n      } catch (error) {\n        return serverError('Failed to update user pending data', error as Error);\n      }\n    },\n\n    /** Delete all authenticators created before a specific timestamp */\n    deleteAuthenticatorsByTimestamp: async (userId: string, beforeTimestamp: number) => {\n      try {\n        // Convert timestamp to Date for comparison\n        const beforeDate = new Date(beforeTimestamp);\n\n        const result = await db\n          .delete(authenticators)\n          .where(and(eq(authenticators.userId, userId), lt(authenticators.updatedAt, beforeDate)))\n          .returning();\n\n        return result.length;\n      } catch (error) {\n        return serverError('Failed to delete authenticators by timestamp', error as Error);\n      }\n    },\n\n    /** Delete a user and all their authenticators */\n    deleteUser: async (id: string) => {\n      try {\n        // Use a transaction to ensure consistency\n        const _deleteAuthenticatorsResult = await db.delete(authenticators).where(eq(authenticators.userId, id));\n        const deleteUserResult = await db.delete(users).where(eq(users.id, id)).returning();\n\n        if (deleteUserResult.length === 0) {\n          return notFoundError('User', id);\n        }\n\n        return true;\n      } catch (error) {\n        return serverError('Failed to delete user', error as Error);\n      }\n    },\n\n    /** Delete user account (soft delete with anonymization) */\n    deleteUserAccount: async (id: string) => {\n      try {\n        const timestamp = Date.now();\n        const anonymizedEmail = `deleted_${id}_${timestamp}@deleted.local`;\n\n        const result = await db\n          .update(users)\n          .set({\n            email: anonymizedEmail,\n            displayName: 'Deleted User',\n            status: 'deleted',\n            pending: null,\n          })\n          .where(eq(users.id, id))\n          .returning();\n\n        if (result.length === 0) {\n          return notFoundError('User', id);\n        }\n\n        const deletedUser = result[0];\n        if (!deletedUser) {\n          return serverError('Failed to retrieve deleted user', new Error('Update returned empty result'));\n        }\n\n        // Authenticators are cascade deleted automatically via schema\n        return deletedUser;\n      } catch (error) {\n        return serverError('Failed to delete user account', error as Error);\n      }\n    },\n  };\n}\n\n/**\n * Get authentication repository instance from context\n */\nexport function getAuthRepository(context: Readonly<RouterContextProvider>): AuthRepository {\n  const db = getDatabase(context);\n  return createAuthRepository(db);\n}\n","import type { Result } from '@ycore/forge/result';\nimport { isError, ok } from '@ycore/forge/result';\nimport type { RouterContextProvider } from 'react-router';\n\nimport type { Authenticator, User } from '../schema';\nimport { requireAuthUser } from './auth.context';\nimport { getAuthRepository } from './repository';\n\nexport interface ProfileLoaderArgs {\n  context: Readonly<RouterContextProvider>;\n}\n\nexport async function profileLoader({ context }: ProfileLoaderArgs): Promise<Result<{ user: User }>> {\n  // User is guaranteed to be authenticated due to middleware\n  const user = requireAuthUser(context);\n  return ok({ user });\n}\n\n/**\n * Get user with authenticators - combines user and authenticator data\n */\nexport async function getUserWithAuthenticators(context: Readonly<RouterContextProvider>, userId: string): Promise<Result<{ user: User; authenticators: Authenticator[] }>> {\n  const repository = getAuthRepository(context);\n\n  const userResult = await repository.getUserById(userId);\n\n  // Check for error (including not found)\n  if (isError(userResult)) {\n    return userResult;\n  }\n\n  const authenticatorsResult = await repository.getAuthenticatorsByUserId(userId);\n\n  // Check for error\n  if (isError(authenticatorsResult)) {\n    return authenticatorsResult;\n  }\n\n  return ok({\n    user: userResult,\n    authenticators: authenticatorsResult,\n  });\n}\n","import { createContext } from 'react-router';\nimport type { EmailConfig } from './@types/email.types';\n\nexport const emailContext = createContext<EmailConfig | null>(null);\n","import type { EmailConfig } from './@types/email.types';\n\n/**\n * Default Email Configuration\n *\n * IMPORTANT: This configuration uses local-dev provider by default for development.\n * For production deployments, you MUST:\n * 1. Override this config in your app's config file (e.g., app/config/config.system.ts)\n * 2. Set active provider to 'resend' or 'mailchannels'\n * 3. Configure valid sendFrom addresses for your domain\n * 4. Set API keys via environment variables or Cloudflare bindings\n *\n */\nexport const defaultEmailConfig: EmailConfig = {\n  active: 'local-dev',\n  providers: [\n    {\n      name: 'local-dev',\n      sendFrom: 'dev@localhost',\n    },\n  ],\n};\n","import { logger } from '@ycore/forge/logger';\nimport type { Result } from '@ycore/forge/result';\nimport { err, tryCatch } from '@ycore/forge/result';\nimport type { EmailProvider, SendEmailOptions } from '../@types/email.types';\n\n/**\n * Configuration delays for email providers (in milliseconds)\n */\nexport const EMAIL_PROVIDER_DELAYS = {\n  LOCAL_DEV: 800,\n  TEST_MOCK: 10,\n} as const;\n\n/**\n * Base email provider factory - creates an EmailProvider with common validation and error handling logic\n */\nexport function createEmailProviderBase(name: string, sendFn: (options: SendEmailOptions) => Promise<void>): EmailProvider {\n  return {\n    async sendEmail(options: SendEmailOptions): Promise<Result<void>> {\n      const { from, to, template } = options;\n\n      if (!from) {\n        return err('From address is required');\n      }\n\n      return tryCatch(async () => {\n        await sendFn(options);\n\n        logger.debug('email_sent_success', {\n          provider: name,\n          to,\n          subject: template.subject,\n        });\n      }, `Failed to send email via ${name}`);\n    },\n  };\n}\n","import { logger } from '@ycore/forge/logger';\nimport type { EmailProvider } from '../@types/email.types';\nimport { createEmailProviderBase, EMAIL_PROVIDER_DELAYS } from './base-provider';\n\n/**\n * Local Dev Email Provider - Development provider that logs emails instead of sending\n */\nexport function createLocalDevEmailProvider(): EmailProvider {\n  return createEmailProviderBase('local-dev', async options => {\n    const { to, from, template } = options;\n    // Simulate a slight delay like a real email service\n    await new Promise(resolve => setTimeout(resolve, EMAIL_PROVIDER_DELAYS.LOCAL_DEV));\n    // Log email metadata using structured logging\n    logger.info('local_dev_email_sent', { provider: 'local-dev', from, to, subject: template.subject });\n    // Display email content with proper line breaks (console.log for readability in dev)\n    console.log(' === Message content (plain text)', '='.repeat(48), '\\n', template.text, '\\n', '='.repeat(80));\n  });\n}\n","import type { EmailProvider } from '../@types/email.types';\nimport { createEmailProviderBase } from './base-provider';\n\n/**\n * MailChannels Email Provider\n * Implementation for MailChannels email service\n *\n * Requires DNS record for authorization:\n * Type: TXT, Name: _mailchannels, Content: \"v=mc1 auth=<AccountId>\"\n */\nexport function createMailChannelsEmailProvider(): EmailProvider {\n  const apiUrl = 'https://api.mailchannels.net/tx/v1/send';\n\n  return createEmailProviderBase('mailchannels', async options => {\n    const { apiKey, to, from, template } = options;\n\n    const payload = {\n      personalizations: [\n        {\n          to: [{ email: to }],\n        },\n      ],\n      from: { email: from },\n      subject: template.subject,\n      content: [\n        { type: 'text/plain', value: template.text },\n        { type: 'text/html', value: template.html },\n      ],\n    };\n\n    const response = await fetch(apiUrl, {\n      method: 'POST',\n      headers: {\n        'X-Api-Key': apiKey,\n        'Content-Type': 'application/json',\n        Accept: 'application/json',\n      },\n      body: JSON.stringify(payload),\n    });\n\n    if (!response.ok) {\n      const errorText = await response.text();\n      throw new Error(`MailChannels API error (${response.status}): ${errorText}`);\n    }\n  });\n}\n","import type { EmailProvider } from '../@types/email.types';\nimport { createEmailProviderBase } from './base-provider';\n\n/**\n * Resend Email Provider\n * Implementation for Resend email service (https://resend.com)\n */\nexport function createResendEmailProvider(): EmailProvider {\n  return createEmailProviderBase('resend', async options => {\n    const { apiKey, to, from, template } = options;\n\n    const response = await fetch('https://api.resend.com/emails', {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n        Authorization: `Bearer ${apiKey}`,\n      },\n      body: JSON.stringify({\n        from,\n        to,\n        subject: template.subject,\n        html: template.html,\n        text: template.text,\n      }),\n    });\n\n    if (!response.ok) {\n      const errorText = await response.text();\n      throw new Error(`Resend API error (${response.status}): ${errorText}`);\n    }\n  });\n}\n","import { logger } from '@ycore/forge/logger';\nimport { err } from '@ycore/forge/result';\nimport type { EmailProvider } from '../@types/email.types';\nimport { createEmailProviderBase, EMAIL_PROVIDER_DELAYS } from './base-provider';\n\n/**\n * Stored email metadata for test verification (excludes sensitive data)\n */\nexport interface StoredTestEmail {\n  to: string;\n  from: string;\n  template: {\n    subject: string;\n    html: string;\n    text: string;\n  };\n}\n\n/**\n * Module-level state for test email tracking\n * Isolated from production code for security\n */\nlet sentEmails: StoredTestEmail[] = [];\nlet shouldFail = false;\nlet failureReason = 'Simulated email failure';\n\n/**\n * Test Mock Email Provider\n * Enhanced mock provider for testing that tracks sent emails and allows failure simulation\n */\nexport function createTestMockEmailProvider(): EmailProvider {\n  return {\n    async sendEmail(options) {\n      const { to, from, template } = options;\n\n      if (!from) {\n        return err('From address is required');\n      }\n\n      // Store email metadata for test verification (excludes sensitive apiKey)\n      sentEmails.push({\n        to,\n        from,\n        template: {\n          subject: template.subject,\n          html: template.html,\n          text: template.text,\n        },\n      });\n\n      // Simulate failure if configured\n      if (shouldFail) {\n        return err(failureReason);\n      }\n\n      // Use base provider for consistent behavior\n      const baseProvider = createEmailProviderBase('test-mock', async opts => {\n        await new Promise(resolve => setTimeout(resolve, EMAIL_PROVIDER_DELAYS.TEST_MOCK));\n\n        logger.debug('email_test_mock_sent', {\n          provider: 'test-mock',\n          from: opts.from,\n          to: opts.to,\n          subject: opts.template.subject,\n          textLength: opts.template.text.length,\n          htmlLength: opts.template.html.length,\n        });\n      });\n\n      return baseProvider.sendEmail(options);\n    },\n  };\n}\n\n// ============================================================================\n// Test Utility Functions\n// ============================================================================\n\n/**\n * Get all sent emails (returns copy to prevent mutation)\n */\nexport function getTestSentEmails(): StoredTestEmail[] {\n  return sentEmails.map(email => ({\n    to: email.to,\n    from: email.from,\n    template: {\n      subject: email.template.subject,\n      html: email.template.html,\n      text: email.template.text,\n    },\n  }));\n}\n\n/**\n * Get the most recently sent email\n */\nexport function getTestLastSentEmail(): StoredTestEmail | undefined {\n  const lastEmail = sentEmails[sentEmails.length - 1];\n  if (!lastEmail) {\n    return undefined;\n  }\n\n  return {\n    to: lastEmail.to,\n    from: lastEmail.from,\n    template: {\n      subject: lastEmail.template.subject,\n      html: lastEmail.template.html,\n      text: lastEmail.template.text,\n    },\n  };\n}\n\n/**\n * Get count of sent emails\n */\nexport function getTestEmailCount(): number {\n  return sentEmails.length;\n}\n\n/**\n * Find email sent to specific recipient\n */\nexport function findTestEmailByTo(to: string): StoredTestEmail | undefined {\n  return sentEmails.find(email => email.to === to);\n}\n\n/**\n * Find all emails with subject containing search string\n */\nexport function findTestEmailsBySubject(subject: string): StoredTestEmail[] {\n  return sentEmails.filter(email => email.template.subject.includes(subject));\n}\n\n/**\n * Clear all sent emails\n */\nexport function clearTestSentEmails(): void {\n  sentEmails = [];\n}\n\n/**\n * Configure provider to simulate failures\n */\nexport function simulateTestEmailFailure(reason = 'Simulated email failure'): void {\n  shouldFail = true;\n  failureReason = reason;\n}\n\n/**\n * Reset provider to success mode\n */\nexport function resetTestEmailToSuccess(): void {\n  shouldFail = false;\n  failureReason = 'Simulated email failure';\n}\n\n/**\n * Full reset - clears emails and resets failure state\n */\nexport function resetTestEmailProvider(): void {\n  clearTestSentEmails();\n  resetTestEmailToSuccess();\n}\n\n/**\n * Get current failure configuration\n */\nexport function getTestEmailFailureState(): { shouldFail: boolean; reason: string } {\n  return {\n    shouldFail,\n    reason: failureReason,\n  };\n}\n\n// ============================================================================\n// Test Assertion Helpers\n// ============================================================================\n\n/**\n * Assert that an email was sent to a specific recipient\n * Throws if email not found\n */\nexport function assertTestEmailSent(to: string): StoredTestEmail {\n  const email = findTestEmailByTo(to);\n  if (!email) {\n    throw new Error(`Expected email to be sent to ${to}, but no email was found`);\n  }\n  return email;\n}\n\n/**\n * Assert specific number of emails were sent\n */\nexport function assertTestEmailCount(expectedCount: number): void {\n  const actualCount = getTestEmailCount();\n  if (actualCount !== expectedCount) {\n    throw new Error(`Expected ${expectedCount} emails to be sent, but ${actualCount} were sent`);\n  }\n}\n\n/**\n * Assert no emails were sent\n */\nexport function assertTestNoEmailsSent(): void {\n  assertTestEmailCount(0);\n}\n","import type { Result } from '@ycore/forge/result';\nimport { err, ok } from '@ycore/forge/result';\nimport type { EmailConfig, EmailProvider, EmailProviderConfig, EmailProviders } from './@types/email.types';\nimport { createLocalDevEmailProvider } from './providers/local-dev';\nimport { createMailChannelsEmailProvider } from './providers/mailchannels';\nimport { createResendEmailProvider } from './providers/resend';\nimport { createTestMockEmailProvider } from './providers/test-mock';\n\nconst providerRegistry: Record<EmailProviders, () => EmailProvider> = {\n  'local-dev': createLocalDevEmailProvider,\n  mailchannels: createMailChannelsEmailProvider,\n  resend: createResendEmailProvider,\n  'test-mock': createTestMockEmailProvider,\n};\n\nexport function createEmailProvider(providerName: string): Result<EmailProvider> {\n  if (!isValidProvider(providerName)) {\n    return err(`Unsupported email provider: ${providerName}`);\n  }\n\n  try {\n    const factory = providerRegistry[providerName];\n    const provider = factory();\n    return ok(provider);\n  } catch (error) {\n    return err(`Failed to create email provider: ${providerName}`, undefined, { cause: error });\n  }\n}\n\nexport function isValidProvider(providerName: string): providerName is EmailProviders {\n  return providerName in providerRegistry;\n}\n\nexport function getSupportedProviders(): EmailProviders[] {\n  return Object.keys(providerRegistry) as EmailProviders[];\n}\n\nexport function getEmailProviderNames(emailConfig: EmailConfig): EmailProviders[] {\n  return emailConfig.providers.map(provider => provider.name);\n}\n\nexport function getProviderConfig(emailConfig: EmailConfig, providerName: string): EmailProviderConfig | undefined {\n  return emailConfig.providers.find(provider => provider.name === providerName);\n}\n","import { getContext } from '@ycore/forge/context';\nimport { logger } from '@ycore/forge/logger';\nimport { err, flattenError, isError, ok, type Result } from '@ycore/forge/result';\nimport { getBindings } from '@ycore/forge/services';\nimport type { RouterContextProvider } from 'react-router';\nimport type { EmailProviderConfig, SendMailOptions } from '../@types/email.types';\nimport { defaultEmailConfig } from '../email.config';\nimport { emailContext } from '../email.context';\nimport { createEmailProvider, getProviderConfig } from '../email-provider';\n\n/**\n * Send email with cascading configuration fallback\n *\n * This is the primary email sending function for the application.\n * It implements a predictable configuration cascade:\n * 1. Provided options (highest priority)\n * 2. Email context from middleware\n * 3. Default email config (lowest priority)\n */\nexport async function sendMail(context: Readonly<RouterContextProvider>, options: SendMailOptions): Promise<Result<void>> {\n  try {\n    const { to, template, from: optionsFrom, provider: optionsProvider, apiKey: optionsApiKey } = options;\n\n    // Get email config from context (may be null if middleware not configured)\n    const emailConfig = getContext(context, emailContext, null);\n    const provider = optionsProvider || emailConfig?.active || defaultEmailConfig.active;\n\n    if (!provider) {\n      logger.error('email_no_provider', { optionsProvider, contextActive: emailConfig?.active, defaultActive: defaultEmailConfig.active, to });\n      return err('No email provider configured');\n    }\n\n    // Get provider config with cascading fallback\n    const providerConfig = (emailConfig && getProviderConfig(emailConfig, provider)) || getProviderConfig(defaultEmailConfig, provider);\n    if (!providerConfig) {\n      logger.error('email_provider_config_missing', { provider, to, contextProviders: emailConfig?.providers.map((p: EmailProviderConfig) => p.name) });\n      return err(`Provider configuration not found for: ${provider}`);\n    }\n\n    // Determine apiKey with cascading fallback\n    let apiKey = optionsApiKey;\n    if (!apiKey && providerConfig.apiKey) {\n      const bindings = getBindings(context);\n      apiKey = bindings[providerConfig.apiKey as keyof typeof bindings] as string | undefined;\n    }\n\n    // Determine from address with cascading fallback\n    const from = optionsFrom || providerConfig.sendFrom;\n\n    // Create email provider instance\n    const emailProviderResult = createEmailProvider(provider);\n    if (isError(emailProviderResult)) {\n      logger.error('email_provider_creation_failed', { provider, to, error: flattenError(emailProviderResult) });\n      return emailProviderResult;\n    }\n\n    // Send email\n    const sendResult = await emailProviderResult.sendEmail({\n      apiKey: apiKey || '',\n      to,\n      from,\n      template: {\n        subject: template.subject,\n        text: template.text,\n        html: template.html,\n      },\n    });\n\n    if (isError(sendResult)) {\n      logger.error('email_send_failed', { to, from, provider, error: flattenError(sendResult) });\n      return sendResult;\n    }\n\n    return ok(undefined);\n  } catch (error) {\n    logger.error('email_send_unexpected_error', { to: options.to, error: error });\n    return err('Failed to send email', { error });\n  }\n}\n","/**\n * Email Template Renderer\n *\n * This file provides the rendering interface for email templates\n * using the new custom email components system.\n */\n\nimport { type EmailRenderOptions, type EmailTemplatePropsWithSubject as NewEmailTemplatePropsWithSubject, renderEmail } from '@ycore/componentry/email/server';\nimport type { EmailTemplate } from '../@types/email.types';\nimport type { EmailTemplateObject } from '../@types/email-template-builder';\n\n/**\n * Generic email template renderer - handles rendering React email templates to HTML and plaintext\n *\n * Accepts EmailTemplateObject created by defineEmailTemplate() and renders it with the provided data.\n * Automatically extracts subject from the template definition and applies Tailwind styles map.\n *\n * @example\n * ```typescript\n * const email = await renderEmailTemplate(ContactEmailTemplate, {\n *   name: 'John Doe',\n *   email: 'john@example.com',\n *   message: 'Hello!',\n *   origin: 'https://example.com',\n * });\n * ```\n */\nexport async function renderEmailTemplate<TData>(template: EmailTemplateObject<TData>, data: TData, options?: EmailRenderOptions): Promise<EmailTemplate> {\n  // Use the new renderEmail function from custom components\n  const result = await renderEmail(\n    template.component,\n    {\n      ...data,\n      subject: template.subject,\n    } as NewEmailTemplatePropsWithSubject<TData>,\n    {\n      ...options,\n      tailwindStylesMap: template.stylesMap ?? options?.tailwindStylesMap,\n    }\n  );\n\n  return {\n    subject: result.subject || '',\n    html: result.html,\n    text: result.text,\n  };\n}\n","import type { TailwindStylesMap } from '@ycore/componentry/email/server';\nimport type { JSXElementConstructor, ReactElement } from 'react';\n\n/**\n * Email Template Definition\n *\n * Type-safe structure for defining email templates with component, subject, and styles map\n */\nexport interface EmailTemplateDefinition<TData> {\n  component: (props: TData) => ReactElement<unknown, string | JSXElementConstructor<unknown>>;\n  subject: (data: TData) => string;\n  stylesMap?: TailwindStylesMap;\n}\n\n/**\n * Email Template Object\n *\n * Returned by defineEmailTemplate with helper methods\n */\nexport interface EmailTemplateObject<TData> {\n  component: (props: TData) => ReactElement<unknown, string | JSXElementConstructor<unknown>>;\n  subject: (data: TData) => string;\n  stylesMap?: TailwindStylesMap;\n  render: (data: TData) => {\n    component: ReactElement<unknown, string | JSXElementConstructor<unknown>>;\n    subject: string;\n    stylesMap?: TailwindStylesMap;\n  };\n}\n\n/**\n * Define Email Template\n *\n * Type-safe helper for creating unified email templates\n *\n * @example\n * ```typescript\n * export const ContactTemplate = defineEmailTemplate({\n *   component: ({ name, email }) => <Html>...</Html>,\n *   subject: ({ name }) => `Contact from ${name}`,\n *   stylesMap: TEMPLATE_TAILWIND_MAP,\n * });\n * ```\n */\nexport function defineEmailTemplate<TData>({ component, subject, stylesMap }: EmailTemplateDefinition<TData>): EmailTemplateObject<TData> {\n  return {\n    component,\n    subject,\n    stylesMap,\n    // Helper method for type-safe rendering\n    render: (data: TData) => ({\n      component: component(data),\n      subject: subject(data),\n      stylesMap,\n    }),\n  };\n}\n","/**\n * â ï¸  DO NOT EDIT THIS FILE MANUALLY\n * Auto-generated Tailwind CSS utility styles map for email components at: 2025-11-03T16:38:05.877Z\n *\n *   - Template files scanned: 4\n *   - Unique classes found: 37\n *   - Static styles mapped: 36\n *   - Dynamic patterns: 2\n */\n\nimport type { TailwindStylesMap } from '@ycore/componentry/email/server';\nimport type { CSSProperties } from 'react';\n\nexport const TAILWIND_TO_CSS_MAP: Record<string, Partial<CSSProperties>> = {\n  'm-0': {\"margin\":\"0rem\"},\n  'm-3': {\"margin\":\"0.75rem\"},\n  'm-4': {\"margin\":\"1rem\"},\n  'm-5': {\"margin\":\"1.25rem\"},\n  'mx-2': {\"marginInline\":\"0.5rem\"},\n  'mx-5': {\"marginInline\":\"1.25rem\"},\n  'mx-auto': {\"marginInline\":\"auto\"},\n  'my-5': {\"marginBlock\":\"1.25rem\"},\n  'max-w-2xl': {\"maxWidth\":\"42rem\"},\n  'max-w-md': {\"maxWidth\":\"28rem\"},\n  'rounded-2xl': {\"borderRadius\":\"1rem\"},\n  'rounded-lg': {\"borderRadius\":\"0.625rem\"},\n  'border-2': {\"borderStyle\":\"solid\",\"borderWidth\":\"2px\"},\n  'border-border': {\"borderColor\":\"oklch(70.7% 0.022 261.325)\"},\n  'bg-muted': {\"backgroundColor\":\"oklch(87.2% 0.01 258.338)\"},\n  'bg-white': {\"backgroundColor\":\"#fff\"},\n  'p-3': {\"padding\":\"0.75rem\"},\n  'p-5': {\"padding\":\"1.25rem\"},\n  'px-5': {\"paddingInline\":\"1.25rem\"},\n  'py-5': {\"paddingBlock\":\"1.25rem\"},\n  'pt-10': {\"paddingTop\":\"2.5rem\"},\n  'pb-5': {\"paddingBottom\":\"1.25rem\"},\n  'text-center': {\"textAlign\":\"center\"},\n  'text-left': {\"textAlign\":\"left\"},\n  'font-sans': {\"fontFamily\":\"ui-sans-serif, system-ui, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol',\\n    'Noto Color Emoji'\"},\n  'text-3xl': {\"fontSize\":\"1.875rem\",\"lineHeight\":\"var(--text-3xl--line-height)\"},\n  'text-sm': {\"fontSize\":\"0.875rem\",\"lineHeight\":\"var(--text-sm--line-height)\"},\n  'leading-relaxed': {\"lineHeight\":\"1.625\"},\n  'font-bold': {\"fontWeight\":\"700\"},\n  'text-destructive': {\"color\":\"oklch(50.5% 0.213 27.518)\"},\n  'text-foreground': {\"color\":\"oklch(27.8% 0.033 256.848)\"},\n  'text-muted-foreground': {\"color\":\"oklch(55.1% 0.027 264.364)\"},\n  'italic': {\"fontStyle\":\"italic\"},\n  'no-underline': {\"textDecorationLine\":\"none\"},\n  'underline': {\"textDecorationLine\":\"underline\"},\n  'dark': {\"color\":\"color-mix(in lab, red, red)) {\\n    & {\\n      --border: color-mix(in oklab, oklch(96.7% 0.003 264.542) 10%, transparent)\"},\n};\n\nexport const DYNAMIC_UTILITY_PATTERNS = [\n  {\n    regex: /^text-\\[(.+?)\\]$/,\n    converter: (matches: RegExpMatchArray) => ({ fontSize: matches[1] }),\n  },\n  {\n    regex: /^tracking-\\[(.+?)\\]$/,\n    converter: (matches: RegExpMatchArray) => ({ letterSpacing: matches[1] }),\n  },\n];\n\nexport const TEMPLATE_STYLES_MAP: TailwindStylesMap = {\n  cssMap: TAILWIND_TO_CSS_MAP,\n  dynamicPatterns: DYNAMIC_UTILITY_PATTERNS,\n};\n","import { Body, Container, Head, Heading, Html, Link, Section, Text } from '@ycore/componentry/email';\nimport { defineEmailTemplate } from '../../email/@types/email-template-builder';\nimport { TEMPLATE_STYLES_MAP } from './tailwind.styles';\n\nexport interface RecoveryVerificationData {\n  code: string;\n  email: string;\n  verificationUrl?: string;\n}\n\n/**\n * Account Recovery Verification Template\n * Sent when user requests account recovery (lost passkey access)\n * Combines security notification + verification code in a single email\n */\nexport const RecoveryVerificationTemplate = defineEmailTemplate({\n  component: ({ code, email, verificationUrl }: RecoveryVerificationData) => (\n    <Html lang=\"en\">\n      <Head />\n      <Body className=\"bg-white font-sans\">\n        <Container className=\"mx-auto max-w-2xl text-foreground leading-relaxed\">\n          <Section className=\"px-5 pt-10 pb-5 text-center\">\n            <Heading level={1}>Account Recovery Request</Heading>\n          </Section>\n\n          <Section className=\"m-5 rounded-lg border-2 border-border bg-muted p-5 text-center\">\n            <Text>\n              An account recovery request for <strong>{email}</strong> is pending approval.\n            </Text>\n            <Text>If approved, registration of a new passkey will be allowed to proceed.</Text>\n            <Text>Please approve the account recovery request using the code below.</Text>\n          </Section>\n\n          <Section className=\"m-5 rounded-lg border-2 border-border bg-muted p-5 text-center\">\n            <Text className=\"m-0 font-bold text-[32px] text-foreground tracking-[8px]\">{code}</Text>\n          </Section>\n\n          <Section className=\"m-3 text-center text-muted-foreground text-sm\">\n            <Text>\n              This code will expire within <strong>8 minutes</strong> if not approved.\n            </Text>\n          </Section>\n\n          {verificationUrl && (\n            <Section className=\"m-4 rounded-2xl bg-muted p-3 text-center\">\n              <Text className=\"mx-2\">\n                <Link href={verificationUrl} className=\"font-bold no-underline\">\n                  Click this link to approve the change\n                </Link>\n              </Text>\n\n              <Text className=\"mx-2\">\n                <Text>If having trouble using the link above, use the url below to verify.</Text>\n                <Link href={verificationUrl} className=\"underline\">\n                  {verificationUrl}\n                </Link>\n              </Text>\n            </Section>\n          )}\n\n          <Section className=\"m-4 text-center text-muted-foreground text-sm\">\n            <Text>If this code was not requested, consider that someone may have unauthorized access to the account. It may be necessary to secure the account.</Text>\n            <Heading level={3} className=\"text-destructive\">\n              If unauthorized, take immediate action:\n            </Heading>\n            <Section className=\"mx-auto max-w-md text-left\">\n              <Text className=\"italic\">\n                â¢ <strong>Do not enter the verification code.</strong>\n              </Text>\n              <Text className=\"italic\">â¢ Sign in to the account at {email}</Text>\n              <Text className=\"italic\">â¢ Review the security settings and passkeys</Text>\n              <Text className=\"italic\">â¢ Remove any unfamiliar devices</Text>\n            </Section>\n          </Section>\n        </Container>\n      </Body>\n    </Html>\n  ),\n\n  subject: () => 'Account Recovery Verification',\n\n  stylesMap: TEMPLATE_STYLES_MAP,\n});\n","import { getContext } from '@ycore/forge/context';\nimport { logger } from '@ycore/forge/logger';\nimport { err, ok, type Result } from '@ycore/forge/result';\nimport { getBindings } from '@ycore/forge/services';\nimport type { RouterContextProvider } from 'react-router';\n\nimport { authConfigContext } from './auth.context';\n\nexport type VerificationPurpose = 'signup' | 'passkey-add' | 'passkey-delete' | 'email-change' | 'account-delete' | 'recovery';\n\ninterface TOTPOptions {\n  secret: string | Uint8Array;\n  timestamp?: number;\n  period?: number;\n  digits?: number;\n  algorithm?: 'SHA-1' | 'SHA-256' | 'SHA-512';\n}\n\ninterface VerifyTOTPOptions extends TOTPOptions {\n  token: string;\n  window?: number;\n}\n\ninterface StoredVerification {\n  secret: string;\n  expireAt: number;\n  attempts: number;\n  purpose: VerificationPurpose;\n  metadata?: Record<string, unknown>;\n}\n\nfunction base32Decode(input: string): Uint8Array {\n  const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';\n  const cleanInput = input.replace(/[^A-Z2-7]/gi, '').toUpperCase();\n\n  let bits = '';\n  for (const char of cleanInput) {\n    const value = alphabet.indexOf(char);\n    if (value === -1) throw new Error(`Invalid base32 character: ${char}`);\n    bits += value.toString(2).padStart(5, '0');\n  }\n\n  const bytes = new Uint8Array(Math.floor(bits.length / 8));\n  for (let i = 0; i < bytes.length; i++) {\n    bytes[i] = Number.parseInt(bits.slice(i * 8, (i + 1) * 8), 2);\n  }\n\n  return bytes;\n}\n\nfunction normalizeSecret(secret: string | Uint8Array): Uint8Array {\n  if (secret instanceof Uint8Array) return secret;\n\n  try {\n    return base32Decode(secret);\n  } catch {\n    return new TextEncoder().encode(secret);\n  }\n}\n\nfunction uint64ToBytes(num: number): Uint8Array {\n  const bytes = new Uint8Array(8);\n  const high = Math.floor(num / 0x100000000);\n  const low = num & 0xffffffff;\n\n  bytes[0] = (high >>> 24) & 0xff;\n  bytes[1] = (high >>> 16) & 0xff;\n  bytes[2] = (high >>> 8) & 0xff;\n  bytes[3] = high & 0xff;\n  bytes[4] = (low >>> 24) & 0xff;\n  bytes[5] = (low >>> 16) & 0xff;\n  bytes[6] = (low >>> 8) & 0xff;\n  bytes[7] = low & 0xff;\n\n  return bytes;\n}\n\nasync function hmac(algorithm: string, key: Uint8Array, data: Uint8Array): Promise<Uint8Array> {\n  // Convert to ArrayBuffer for Web Crypto API\n  const keyBuffer = new ArrayBuffer(key.length);\n  new Uint8Array(keyBuffer).set(key);\n\n  const dataBuffer = new ArrayBuffer(data.length);\n  new Uint8Array(dataBuffer).set(data);\n\n  const cryptoKey = await crypto.subtle.importKey('raw', keyBuffer, { name: 'HMAC', hash: algorithm }, false, ['sign']);\n  const signature = await crypto.subtle.sign('HMAC', cryptoKey, dataBuffer);\n  return new Uint8Array(signature);\n}\n\nfunction dynamicTruncation(hash: Uint8Array, digits: number): string {\n  const offset = hash[hash.length - 1] & 0x0f;\n  const code = ((hash[offset] & 0x7f) << 24) | ((hash[offset + 1] & 0xff) << 16) | ((hash[offset + 2] & 0xff) << 8) | (hash[offset + 3] & 0xff);\n\n  return (code % 10 ** digits).toString().padStart(digits, '0');\n}\n\nexport function generateSecret(length = 32): Uint8Array {\n  if (length <= 0) throw new Error('Length must be positive');\n  return crypto.getRandomValues(new Uint8Array(length));\n}\n\nexport function base32Encode(bytes: Uint8Array): string {\n  const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';\n  let bits = '';\n\n  for (const byte of bytes) {\n    bits += byte.toString(2).padStart(8, '0');\n  }\n\n  let result = '';\n  for (let i = 0; i < bits.length; i += 5) {\n    const chunk = bits.slice(i, i + 5).padEnd(5, '0');\n    result += alphabet[Number.parseInt(chunk, 2)];\n  }\n\n  return result;\n}\n\nexport async function generateTOTP(options: TOTPOptions): Promise<string> {\n  const { secret, timestamp = Date.now(), period = 30, digits = 6, algorithm = 'SHA-1' } = options;\n\n  if (period <= 0) throw new Error('Period must be positive');\n\n  const counter = Math.floor(timestamp / 1000 / period);\n  const secretBytes = normalizeSecret(secret);\n  const counterBytes = uint64ToBytes(counter);\n  const algoName = algorithm === 'SHA-1' ? 'SHA-1' : algorithm === 'SHA-256' ? 'SHA-256' : 'SHA-512';\n\n  const hash = await hmac(algoName, secretBytes, counterBytes);\n  return dynamicTruncation(hash, digits);\n}\n\nexport async function verifyTOTP(options: VerifyTOTPOptions): Promise<{ valid: boolean; timestamp?: number }> {\n  const { token, window = 1, timestamp = Date.now(), period = 30, ...totpOptions } = options;\n\n  if (!/^\\d+$/.test(token)) {\n    return { valid: false };\n  }\n\n  const currentPeriod = Math.floor(timestamp / 1000 / period);\n\n  for (let i = -window; i <= window; i++) {\n    const testPeriod = currentPeriod + i;\n    const testTimestamp = testPeriod * period * 1000;\n    const expectedToken = await generateTOTP({\n      ...totpOptions,\n      timestamp: testTimestamp,\n      period,\n    });\n\n    if (token === expectedToken) {\n      return { valid: true, timestamp: testTimestamp };\n    }\n  }\n\n  return { valid: false };\n}\n\nconst kvKeyTemplate = (purpose: VerificationPurpose, email: string) => `totp:${purpose}:${email}`;\n\nexport async function createVerificationCode(email: string, purpose: VerificationPurpose, context: Readonly<RouterContextProvider>, metadata?: Record<string, unknown>): Promise<Result<string>> {\n  try {\n    const authConfig = getContext(context, authConfigContext);\n    if (!authConfig) {\n      return err('Auth configuration not found');\n    }\n\n    const env = getBindings(context);\n    const kv = env[authConfig.session.kvBinding as keyof typeof env] as KVNamespace;\n    if (!kv) {\n      return err(`KV binding '${authConfig.session.kvBinding}' not found`);\n    }\n\n    const secret = base32Encode(generateSecret());\n    const period = authConfig.verification.period;\n    const digits = authConfig.verification.digits;\n\n    const code = await generateTOTP({ secret, period, digits });\n\n    const verificationData: StoredVerification = {\n      secret,\n      expireAt: Date.now() + period * 1000,\n      attempts: 0,\n      purpose,\n      metadata,\n    };\n\n    await kv.put(kvKeyTemplate(purpose, email), JSON.stringify(verificationData), { expirationTtl: period });\n\n    logger.info('verification_code_created', { email, purpose });\n\n    return ok(code);\n  } catch (error) {\n    logger.error('verification_code_creation_failed', {\n      email,\n      purpose,\n      error: error instanceof Error ? error.message : String(error),\n      stack: error instanceof Error ? error.stack : undefined,\n    });\n    return err('Failed to create verification code', { error });\n  }\n}\n\nexport async function verifyCode(email: string, code: string, purpose: VerificationPurpose, context: Readonly<RouterContextProvider>): Promise<Result<StoredVerification>> {\n  try {\n    const authConfig = getContext(context, authConfigContext);\n    if (!authConfig) {\n      return err('Auth configuration not found');\n    }\n\n    const env = getBindings(context);\n    const kv = env[authConfig.session.kvBinding as keyof typeof env] as KVNamespace;\n    if (!kv) {\n      return err(`KV binding '${authConfig.session.kvBinding}' not found`);\n    }\n\n    const kvKey = kvKeyTemplate(purpose, email);\n    const storedData = await kv.get(kvKey);\n\n    if (!storedData) {\n      logger.warning('verification_code_not_found', { email, purpose });\n      return err('Verification code expired or not found');\n    }\n\n    const verification: StoredVerification = JSON.parse(storedData);\n\n    // Check purpose match\n    if (verification.purpose !== purpose) {\n      logger.warning('verification_purpose_mismatch', {\n        email,\n        expected: purpose,\n        actual: verification.purpose,\n      });\n      return err('Invalid verification code');\n    }\n\n    // Check max attempts\n    if (verification.attempts >= authConfig.verification.maxAttempts) {\n      await kv.delete(kvKey);\n      logger.warning('verification_max_attempts', { email, purpose });\n      return err('Maximum verification attempts reached');\n    }\n\n    // Check expiration\n    if (Date.now() > verification.expireAt) {\n      await kv.delete(kvKey);\n      logger.warning('verification_expired', { email, purpose });\n      return err('Verification code has expired');\n    }\n\n    // Verify the code\n    const result = await verifyTOTP({\n      secret: verification.secret,\n      token: code,\n      period: authConfig.verification.period,\n      digits: authConfig.verification.digits,\n      window: authConfig.verification.window,\n    });\n\n    if (!result.valid) {\n      // Increment attempts\n      await kv.put(kvKey, JSON.stringify({ ...verification, attempts: verification.attempts + 1 }), { expirationTtl: authConfig.verification.period });\n      logger.warning('verification_code_invalid', { email, purpose, attempts: verification.attempts + 1 });\n      return err('Invalid verification code');\n    }\n\n    // Success - delete the verification data\n    await kv.delete(kvKey);\n    logger.info('verification_code_verified', { email, purpose });\n\n    return ok(verification);\n  } catch (error) {\n    logger.error('verification_code_verification_failed', {\n      email,\n      purpose,\n      error: error instanceof Error ? error.message : String(error),\n    });\n    return err('Failed to verify code', { error });\n  }\n}\n","import { logger } from '@ycore/forge/logger';\nimport { err, flattenError, isError, ok, type Result } from '@ycore/forge/result';\nimport type { RouterContextProvider } from 'react-router';\n\nimport { sendMail } from '../../email/server';\nimport { renderEmailTemplate } from '../../email/server/render-email';\nimport type { User } from '../schema';\nimport { RecoveryVerificationTemplate } from '../templates/recovery-verification';\nimport { getAuthRepository } from './repository';\nimport { createVerificationCode } from './totp-service';\n\n/**\n * Send recovery verification email with custom template\n * Generates TOTP code and sends custom recovery verification email\n */\nasync function sendRecoveryVerification(email: string, context: Readonly<RouterContextProvider>, verificationUrl?: string): Promise<Result<void>> {\n  try {\n    // Generate TOTP code\n    const codeResult = await createVerificationCode(email, 'recovery', context, { email });\n\n    if (isError(codeResult)) {\n      logger.error('recovery_verification_code_generation_failed', { email, error: flattenError(codeResult) });\n      return codeResult;\n    }\n\n    const code = codeResult;\n\n    // Create custom recovery verification email template\n    const emailTemplate = await renderEmailTemplate(RecoveryVerificationTemplate, {\n      code,\n      email,\n      verificationUrl,\n    });\n\n    // Send email directly using centralized service\n    const sendResult = await sendMail(context, { to: email, template: emailTemplate });\n\n    if (isError(sendResult)) {\n      logger.error('recovery_verification_send_failed', { email, error: flattenError(sendResult) });\n      return sendResult;\n    }\n\n    logger.info('recovery_verification_sent', { email });\n    return ok(undefined);\n  } catch (error) {\n    logger.error('recovery_verification_unexpected_error', { email, error: error instanceof Error ? error.message : 'Unknown error', stack: error instanceof Error ? error.stack : undefined });\n    return err('Failed to send recovery verification', { error });\n  }\n}\n\n/**\n * Orchestrate account recovery request flow\n */\nexport async function requestAccountRecovery(email: string, context: Readonly<RouterContextProvider>, verificationUrl?: string): Promise<Result<User | null>> {\n  const repository = getAuthRepository(context);\n  const userResult = await repository.getUserByEmail(email);\n\n  if (isError(userResult)) {\n    logger.info('recovery_request_email_not_found', { email });\n    return ok(null);\n  }\n\n  const user = userResult;\n  const statusUpdateResult = await repository.updateUserStatus(user.id, 'unrecovered');\n\n  if (isError(statusUpdateResult)) {\n    logger.error('recovery_request_status_update_failed', { userId: user.id, email, error: flattenError(statusUpdateResult) });\n    return statusUpdateResult;\n  }\n\n  const verificationResult = await sendRecoveryVerification(email, context, verificationUrl);\n\n  if (isError(verificationResult)) {\n    logger.error('recovery_request_verification_email_failed', { userId: user.id, email, error: flattenError(verificationResult) });\n    await repository.updateUserStatus(user.id, user.status);\n    return verificationResult;\n  }\n\n  return ok(statusUpdateResult);\n}\n","import { getContext } from '@ycore/forge/context';\nimport type { IntentHandlers } from '@ycore/forge/intent/server';\nimport { handleIntent } from '@ycore/forge/intent/server';\nimport { logger } from '@ycore/forge/logger';\nimport { err, flattenError, isError, isSystemError, ok, respondError, respondOk, respondRedirect, throwSystemError, validateFormData } from '@ycore/forge/result';\nimport { requireCSRFToken } from '@ycore/foundry/secure/server';\nimport type { RouterContextProvider } from 'react-router';\nimport { email, minLength, object, pipe, string } from 'valibot';\nimport { defaultAuthRoutes } from '../auth.config';\nimport { authConfigContext } from './auth.context';\nimport { requestAccountRecovery } from './recovery-service';\nimport { createAuthSession } from './session';\n\nconst recoverFormSchema = object({\n  email: pipe(string(), minLength(1, 'Email is required'), email('Must be a valid email address')),\n});\n\nexport interface RecoverLoaderArgs {\n  context: Readonly<RouterContextProvider>;\n}\n\nexport interface RecoverActionArgs {\n  request: Request;\n  context: Readonly<RouterContextProvider>;\n}\n\n/**\n * Recover page loader\n * Returns CSRF token\n */\nexport async function recoverLoader({ context }: RecoverLoaderArgs) {\n  const token = requireCSRFToken(context);\n\n  return respondOk({\n    token,\n  });\n}\n\n/**\n * Recover page action\n * Handles account recovery request using intent-based routing\n */\nexport async function recoverAction({ request, context }: RecoverActionArgs) {\n  const formData = await request.formData();\n  const authConfig = getContext(context, authConfigContext);\n\n  // Define intent handlers\n  const handlers: IntentHandlers = {\n    /**\n     * Request account recovery\n     */\n    recover: async (formData: FormData) => {\n      // Validate form data\n      const validationResult = await validateFormData(recoverFormSchema, formData);\n      if (isError(validationResult)) {\n        return validationResult; // User error - no logging needed\n      }\n\n      const { email } = validationResult;\n\n      // Request account recovery (returns user if email exists, null otherwise)\n      const result = await requestAccountRecovery(email, context);\n\n      if (isError(result)) {\n        // System error - email service failure\n        if (isSystemError(result)) {\n          logger.error('recover_email_system_error', { email, error: flattenError(result) });\n        }\n        return result;\n      }\n\n      const user = result;\n\n      // If user exists, create session and redirect to verify\n      if (user) {\n        const sessionResult = await createAuthSession(context, { user });\n\n        if (isError(sessionResult)) {\n          // System error - session creation failed\n          if (isSystemError(sessionResult)) {\n            logger.error('recover_session_system_error', { userId: user.id, email, error: flattenError(sessionResult) });\n          }\n          return err('Failed to create recovery session');\n        }\n\n        // Return success with session cookie and redirect info\n        return ok({\n          message: 'If this email exists, a verification code has been sent.',\n          redirectTo: authConfig?.routes.verify || defaultAuthRoutes.verify,\n          sessionCookie: sessionResult,\n        });\n      }\n\n      // Email doesn't exist - return generic message (prevent enumeration)\n      return ok({\n        message: 'If this email exists, a verification code has been sent.',\n      });\n    },\n  };\n\n  // Handle intent\n  const result = await handleIntent(formData, handlers);\n\n  if (isError(result)) {\n    // System error - throw to boundary\n    if (isSystemError(result)) {\n      logger.error('recover_system_error', { error: flattenError(result) });\n      throwSystemError(result.message, result.status as 503);\n    }\n\n    // User error - show in form\n    return respondError(result);\n  }\n\n  const resultData = result as { message?: string; redirectTo?: string; sessionCookie?: string };\n\n  // If we have a redirect with session cookie, use it\n  if (resultData.redirectTo && resultData.sessionCookie) {\n    throw respondRedirect(resultData.redirectTo, {\n      headers: { 'Set-Cookie': resultData.sessionCookie },\n    });\n  }\n\n  // Otherwise just return success (email didn't exist, stay on page)\n  return respondOk(result);\n}\n","import type { DeviceInfo } from './@types/auth.types';\n\n// WebAuthn Algorithm Constants\nexport const WEBAUTHN_ALGORITHMS = {\n  ES256: -7,\n  RS256: -257,\n} as const;\n\n// WebAuthn Configuration Constants\nexport const WEBAUTHN_CONFIG = {\n  CHALLENGE_TIMEOUT: 60000, // 60 seconds\n  CHALLENGE_SIZE: 32, // 32 bytes\n  USER_ID_SIZE: 16, // 16 bytes\n  COORDINATE_LENGTH: 32, // P-256 coordinates should be 32 bytes each\n  HEX_COORDINATE_LENGTH: 64, // 32 bytes = 64 hex characters\n} as const;\n\n// Transport Methods\nexport const TRANSPORT_METHODS = {\n  INTERNAL: 'internal',\n  HYBRID: 'hybrid',\n  USB: 'usb',\n  NFC: 'nfc',\n  BLE: 'ble',\n  SMART_CARD: 'smart-card',\n} as const;\n\n// Attestation Types\nexport const ATTESTATION_TYPES = {\n  NONE: 'none',\n  BASIC: 'basic',\n  SELF: 'self',\n  ATTCA: 'attca',\n  ECDAA: 'ecdaa',\n} as const;\n\n// Device Types\nexport const DEVICE_TYPES = {\n  PLATFORM: 'platform',\n  CROSS_PLATFORM: 'cross-platform',\n} as const;\n\n// Authenticator Flags (WebAuthn spec bit positions)\nexport const AUTHENTICATOR_FLAGS = {\n  BACKUP_ELIGIBLE: 0x08, // BE flag (bit 3)\n  BACKUP_STATE: 0x10, // BS flag (bit 4)\n} as const;\n\n// Legacy device registry removed - replaced with KV-based MDS lookup with fallback to DEFAULT_DEVICE_INFO\n\n// Default Device Info for Unknown Devices\nexport const DEFAULT_DEVICE_INFO: Record<'platform' | 'cross-platform', DeviceInfo> = {\n  platform: {\n    type: DEVICE_TYPES.PLATFORM,\n    vendor: 'Unknown',\n    model: 'Platform Authenticator',\n    certified: false,\n    transports: [TRANSPORT_METHODS.INTERNAL, TRANSPORT_METHODS.HYBRID],\n  },\n  'cross-platform': {\n    type: DEVICE_TYPES.CROSS_PLATFORM,\n    vendor: 'Unknown',\n    model: 'Security Key',\n    certified: false,\n    transports: [TRANSPORT_METHODS.USB, TRANSPORT_METHODS.NFC, TRANSPORT_METHODS.HYBRID],\n  },\n} as const;\n\n// Attestation Format to Type Mapping using Command Pattern\ntype AttestationFormatHandler = (attStmt: any) => string;\n\nexport const ATTESTATION_FORMAT_HANDLERS = new Map<string, AttestationFormatHandler>([\n  ['none', () => ATTESTATION_TYPES.NONE],\n  [\n    'packed',\n    attStmt => {\n      if (attStmt.x5c && attStmt.x5c.length > 0) {\n        return ATTESTATION_TYPES.BASIC;\n      }\n      if (attStmt.sig && !attStmt.x5c) {\n        return ATTESTATION_TYPES.SELF;\n      }\n      return ATTESTATION_TYPES.NONE;\n    },\n  ],\n  [\n    'fido-u2f',\n    attStmt => {\n      if (attStmt.x5c && attStmt.x5c.length > 0) {\n        return ATTESTATION_TYPES.BASIC;\n      }\n      return ATTESTATION_TYPES.SELF;\n    },\n  ],\n  ['android-key', () => ATTESTATION_TYPES.BASIC],\n  ['android-safetynet', () => ATTESTATION_TYPES.ATTCA],\n  ['tpm', () => ATTESTATION_TYPES.BASIC],\n  ['apple', () => ATTESTATION_TYPES.BASIC],\n]);\n\nexport enum WebAuthnErrorCode {\n  INVALID_CHALLENGE = 'INVALID_CHALLENGE',\n  INVALID_ORIGIN = 'INVALID_ORIGIN',\n  INVALID_RPID = 'INVALID_RPID',\n  USER_NOT_PRESENT = 'USER_NOT_PRESENT',\n  INVALID_COUNTER = 'INVALID_COUNTER',\n  SIGNATURE_FAILED = 'SIGNATURE_FAILED',\n  UNSUPPORTED_ALGORITHM = 'UNSUPPORTED_ALGORITHM',\n  INVALID_CREDENTIAL = 'INVALID_CREDENTIAL',\n  CHALLENGE_EXPIRED = 'CHALLENGE_EXPIRED',\n  INVALID_KEY_FORMAT = 'INVALID_KEY_FORMAT',\n  DEFAULT = 'DEFAULT',\n}\n\n// Error Message Resolver Type\ntype ErrorMessageResolver = (operation: 'registration' | 'authentication') => string;\n\n// WebAuthn Error Messages using Command Pattern\nexport const WEBAUTHN_ERROR_MESSAGES = new Map<WebAuthnErrorCode, ErrorMessageResolver>([\n  [WebAuthnErrorCode.CHALLENGE_EXPIRED, () => 'Session expired. Please refresh the page and try again.'],\n  [WebAuthnErrorCode.INVALID_CHALLENGE, () => 'Security check failed. Please refresh the page and try again.'],\n  [WebAuthnErrorCode.INVALID_COUNTER, () => 'Security violation detected. Your authenticator may be compromised. Please contact support immediately.'],\n  [WebAuthnErrorCode.INVALID_KEY_FORMAT, () => 'Invalid security key format. Please re-register your device.'],\n  [WebAuthnErrorCode.INVALID_ORIGIN, () => 'Request origin not recognized. Please ensure you are on the correct website.'],\n  [WebAuthnErrorCode.INVALID_RPID, () => 'Security configuration error. Please contact support.'],\n  [WebAuthnErrorCode.UNSUPPORTED_ALGORITHM, () => 'Your authenticator uses an unsupported security algorithm. Please use a different device.'],\n  [WebAuthnErrorCode.USER_NOT_PRESENT, () => 'User presence verification failed. Please interact with your authenticator when prompted.'],\n  [WebAuthnErrorCode.INVALID_CREDENTIAL, operation => (operation === 'registration' ? 'Failed to create credential. Please try again.' : 'Authenticator not recognized. Please use the device you registered with.')],\n  [\n    WebAuthnErrorCode.SIGNATURE_FAILED,\n    operation => (operation === 'registration' ? 'Failed to verify authenticator. Please try a different device.' : 'Authentication failed. Please verify you are using the correct authenticator.'),\n  ],\n  [WebAuthnErrorCode.DEFAULT, operation => (operation === 'registration' ? 'Registration failed. Please try again.' : 'Authentication failed. Please try again.')],\n]);\n\n// Utility Functions\nexport function convertAAGUIDToUUID(aaguid: Uint8Array): string {\n  const aaguidString = Array.from(aaguid)\n    .map(b => b.toString(16).padStart(2, '0'))\n    .join('');\n\n  return [aaguidString.slice(0, 8), aaguidString.slice(8, 12), aaguidString.slice(12, 16), aaguidString.slice(16, 20), aaguidString.slice(20, 32)].join('-');\n}\n\nexport function isAAGUIDAllZeros(aaguid: Uint8Array): boolean {\n  return Array.from(aaguid).every(byte => byte === 0);\n}\n","import { decodePKIXECDSASignature, ECDSAPublicKey, p256, verifyECDSASignature } from '@oslojs/crypto/ecdsa';\nimport { sha256 } from '@oslojs/crypto/sha2';\nimport { decodeBase64url, encodeBase64url } from '@oslojs/encoding';\nimport { ClientDataType, COSEKeyType, createAssertionSignatureMessage, parseAttestationObject, parseAuthenticatorData, parseClientDataJSON } from '@oslojs/webauthn';\nimport { logger } from '@ycore/forge/logger';\nimport { err, type Result } from '@ycore/forge/result';\n\nimport type { DeviceInfo, EnhancedDeviceInfo, WebAuthnAuthenticationData, WebAuthnRegistrationData } from '../@types/auth.types';\nimport {\n  ATTESTATION_FORMAT_HANDLERS,\n  ATTESTATION_TYPES,\n  AUTHENTICATOR_FLAGS,\n  convertAAGUIDToUUID,\n  DEFAULT_DEVICE_INFO,\n  isAAGUIDAllZeros,\n  WEBAUTHN_ALGORITHMS,\n  WEBAUTHN_CONFIG,\n  WEBAUTHN_ERROR_MESSAGES,\n  WebAuthnErrorCode,\n} from '../auth.constants';\nimport type { Authenticator as AuthenticatorModel } from '../schema';\n\n/**\n * Helper function to convert Uint8Array to ArrayBuffer\n * This ensures we get a proper ArrayBuffer instead of SharedArrayBuffer\n */\nfunction toArrayBuffer(uint8Array: Uint8Array): ArrayBuffer {\n  const buffer = new ArrayBuffer(uint8Array.byteLength);\n  new Uint8Array(buffer).set(uint8Array);\n  return buffer;\n}\n\n/**\n * Extract backup state from authenticator data flags\n */\nfunction extractBackupState(authenticatorData: any): { isBackupEligible: boolean; isBackedUp: boolean } {\n  const flags = authenticatorData.flags || 0;\n\n  const isBackupEligible = (flags & AUTHENTICATOR_FLAGS.BACKUP_ELIGIBLE) !== 0;\n  const isBackedUp = (flags & AUTHENTICATOR_FLAGS.BACKUP_STATE) !== 0;\n\n  return { isBackupEligible, isBackedUp };\n}\n\n/**\n * Extract transport methods based on device characteristics\n */\nfunction extractTransportMethods(deviceInfo: DeviceInfo): string[] {\n  return [...deviceInfo.transports];\n}\n\n/**\n * Extract attestation type from attestation object using command pattern\n */\nfunction extractAttestationType(attestationObject: any): string {\n  try {\n    const fmt = attestationObject.fmt;\n    const attStmt = attestationObject.attStmt;\n\n    const handler = ATTESTATION_FORMAT_HANDLERS.get(fmt);\n    if (handler) {\n      return handler(attStmt);\n    }\n\n    logger.warning('webauthn_unknown_attestation_format', { format: fmt });\n    return ATTESTATION_TYPES.NONE;\n  } catch (error) {\n    logger.error('webauthn_attestation_extraction_error', {\n      error: error instanceof Error ? error.message : 'Unknown error',\n    });\n    return ATTESTATION_TYPES.NONE;\n  }\n}\n\n/**\n * Generate a default friendly name for an authenticator\n */\nfunction generateDefaultAuthenticatorName(deviceInfo: DeviceInfo): string {\n  // If we have specific vendor/model info, use it\n  if (deviceInfo.vendor !== 'Unknown' && deviceInfo.model !== 'Security Key' && deviceInfo.model !== 'Device') {\n    return `${deviceInfo.vendor} ${deviceInfo.model}`;\n  }\n\n  // Fall back to generic names with timestamp\n  const deviceType = deviceInfo.type === 'platform' ? 'Biometric Device' : 'Security Key';\n  const timestamp = new Date().toLocaleDateString('en-US', {\n    month: 'short',\n    day: 'numeric',\n  });\n\n  return `${deviceType} (${timestamp})`;\n}\n\n/**\n * Get comprehensive device information by AAGUID with KV lookup and fallback\n */\nasync function getDeviceInfoByAAGUID(aaguid: Uint8Array, metadataKV?: KVNamespace): Promise<DeviceInfo> {\n  // If AAGUID is all zeros, it's likely a platform authenticator\n  if (isAAGUIDAllZeros(aaguid)) {\n    return DEFAULT_DEVICE_INFO.platform;\n  }\n\n  const uuid = convertAAGUIDToUUID(aaguid);\n\n  // Try KV lookup first (MDS data)\n  if (metadataKV) {\n    try {\n      const mdsData = await metadataKV.get(`device:${uuid}`, 'json');\n      if (mdsData) {\n        logger.debug('device_info_mds_hit', { uuid });\n        return mdsData as EnhancedDeviceInfo;\n      }\n    } catch (error) {\n      logger.warning('device_info_kv_lookup_failed', {\n        uuid,\n        error: error instanceof Error ? error.message : 'Unknown',\n      });\n    }\n  }\n\n  // Fallback to default\n  logger.debug('device_info_fallback', { uuid });\n  return DEFAULT_DEVICE_INFO['cross-platform'];\n}\n\nexport function getWebAuthnErrorMessage(code: WebAuthnErrorCode | undefined, operation: 'registration' | 'authentication'): string {\n  if (!code) {\n    return WEBAUTHN_ERROR_MESSAGES.get(WebAuthnErrorCode.DEFAULT)?.(operation) || 'Auth failure. Please try again.';\n  }\n\n  const messageResolver = WEBAUTHN_ERROR_MESSAGES.get(code);\n  return messageResolver ? messageResolver(operation) : WEBAUTHN_ERROR_MESSAGES.get(WebAuthnErrorCode.DEFAULT)?.(operation) || 'Auth failure. Please try again.';\n}\n\n/**\n * Generate a cryptographically secure challenge\n */\nexport function generateChallenge(): string {\n  const bytes = new Uint8Array(WEBAUTHN_CONFIG.CHALLENGE_SIZE);\n  crypto.getRandomValues(bytes);\n  return encodeBase64url(bytes);\n}\n\n/**\n * Generate a unique user ID\n */\nexport function generateUserId(): string {\n  const bytes = new Uint8Array(WEBAUTHN_CONFIG.USER_ID_SIZE);\n  crypto.getRandomValues(bytes);\n  return encodeBase64url(bytes);\n}\n\n/**\n * Create WebAuthn registration options\n */\nexport function createRegistrationOptions(\n  rpName: string,\n  rpId: string,\n  userName: string,\n  userDisplayName: string,\n  challenge: string,\n  excludeCredentials: Array<{ id: string; transports?: AuthenticatorTransport[] }> = []\n): PublicKeyCredentialCreationOptions {\n  return {\n    challenge: toArrayBuffer(decodeBase64url(challenge)),\n    rp: {\n      name: rpName,\n      id: rpId,\n    },\n    user: {\n      id: toArrayBuffer(decodeBase64url(generateUserId())),\n      name: userName,\n      displayName: userDisplayName,\n    },\n    pubKeyCredParams: [\n      { alg: WEBAUTHN_ALGORITHMS.ES256, type: 'public-key' },\n      { alg: WEBAUTHN_ALGORITHMS.RS256, type: 'public-key' },\n    ],\n    timeout: WEBAUTHN_CONFIG.CHALLENGE_TIMEOUT,\n    attestation: 'none',\n    excludeCredentials: excludeCredentials.map(cred => ({\n      id: toArrayBuffer(decodeBase64url(cred.id)),\n      type: 'public-key' as PublicKeyCredentialType,\n      // Use actual transports if available, otherwise omit (let browser decide)\n      ...(cred.transports && cred.transports.length > 0 ? { transports: cred.transports } : {}),\n    })),\n    authenticatorSelection: {\n      residentKey: 'discouraged',\n      requireResidentKey: false,\n      userVerification: 'preferred',\n    },\n  };\n}\n\n/**\n * Create WebAuthn authentication options\n */\nexport function createAuthenticationOptions(rpId: string, challenge: string, allowCredentials: Array<{ id: string; transports?: AuthenticatorTransport[] }> = []): PublicKeyCredentialRequestOptions {\n  return {\n    challenge: toArrayBuffer(decodeBase64url(challenge)),\n    rpId,\n    timeout: WEBAUTHN_CONFIG.CHALLENGE_TIMEOUT,\n    userVerification: 'preferred',\n    allowCredentials:\n      allowCredentials.length > 0\n        ? allowCredentials.map(cred => ({\n            id: toArrayBuffer(decodeBase64url(cred.id)),\n            type: 'public-key' as PublicKeyCredentialType,\n            // Use actual transports if available, otherwise omit (let browser decide)\n            ...(cred.transports && cred.transports.length > 0 ? { transports: cred.transports } : {}),\n          }))\n        : [],\n  };\n}\n\n/**\n * Verify registration response using Oslo WebAuthn\n */\nexport async function verifyRegistration(\n  credential: WebAuthnRegistrationData,\n  expectedChallenge: string,\n  expectedOrigin: string,\n  expectedRPID: string,\n  metadataKV?: KVNamespace\n): Promise<Result<Omit<AuthenticatorModel, 'userId' | 'createdAt' | 'updatedAt'>>> {\n  try {\n    // Parse attestation object\n    const attestationObject = await parseAttestationObject(new Uint8Array(credential.response.attestationObject));\n    const { authenticatorData } = attestationObject;\n\n    // Parse client data\n    const clientData = parseClientDataJSON(new Uint8Array(credential.response.clientDataJSON));\n\n    // Verify challenge - convert Uint8Array to base64url for comparison\n    const receivedChallenge = encodeBase64url(new Uint8Array(clientData.challenge));\n    if (receivedChallenge !== expectedChallenge) {\n      return err('Invalid challenge', {\n        field: 'challenge',\n        code: WebAuthnErrorCode.INVALID_CHALLENGE,\n      });\n    }\n\n    // Verify origin\n    if (clientData.origin !== expectedOrigin) {\n      return err('Invalid origin', {\n        field: 'origin',\n        code: WebAuthnErrorCode.INVALID_ORIGIN,\n      });\n    }\n\n    // Verify type\n    if (clientData.type !== ClientDataType.Create) {\n      return err('Invalid request type', {\n        field: 'type',\n        code: WebAuthnErrorCode.INVALID_CREDENTIAL,\n      });\n    }\n\n    // Verify RP ID hash\n    if (!authenticatorData.verifyRelyingPartyIdHash(expectedRPID)) {\n      return err('Invalid relying party', {\n        field: 'rpId',\n        code: WebAuthnErrorCode.INVALID_RPID,\n      });\n    }\n\n    // Verify user presence\n    if (!authenticatorData.userPresent) {\n      return err('User presence required', {\n        field: 'userPresence',\n        code: WebAuthnErrorCode.USER_NOT_PRESENT,\n      });\n    }\n\n    // Extract credential\n    const attestedCredential = authenticatorData.credential;\n    if (!attestedCredential) {\n      return err('No credential found', {\n        field: 'credential',\n        code: WebAuthnErrorCode.INVALID_CREDENTIAL,\n      });\n    }\n\n    // Verify supported algorithm - we only support ES256 (ECDSA with P-256)\n    const publicKey = attestedCredential.publicKey;\n    if (publicKey.type() !== COSEKeyType.EC2) {\n      return err('Only ES256 algorithm is supported', {\n        field: 'keyType',\n        code: WebAuthnErrorCode.UNSUPPORTED_ALGORITHM,\n      });\n    }\n\n    // Verify it's using ES256 algorithm\n    const publicKeyAlgorithm = publicKey.algorithm();\n    if (publicKeyAlgorithm !== WEBAUTHN_ALGORITHMS.ES256) {\n      return err('Only ES256 algorithm is supported', {\n        field: 'algorithm',\n        code: WebAuthnErrorCode.UNSUPPORTED_ALGORITHM,\n      });\n    }\n\n    // Store the public key's decoded object as JSON (we'll reconstruct it during verification)\n    // This approach maintains the complete COSE key structure\n    const credentialPublicKey = encodeBase64url(new TextEncoder().encode(JSON.stringify(attestedCredential.publicKey.decoded)));\n\n    // Use actual transports from the credential if available, otherwise fall back to device info\n    let transports: string[] = [];\n    if (credential.response.transports && credential.response.transports.length > 0) {\n      // Use the actual transports reported by the authenticator\n      transports = credential.response.transports;\n      logger.debug('webauthn_using_actual_transports', { transports });\n    } else {\n      // Fall back to device info based on AAGUID\n      const deviceInfo = await getDeviceInfoByAAGUID(attestedCredential.authenticatorAAGUID, metadataKV);\n      transports = extractTransportMethods(deviceInfo);\n      logger.debug('webauthn_using_fallback_transports', { transports, source: 'deviceInfo' });\n    }\n\n    // Determine device type from authenticatorAttachment if available\n    let credentialDeviceType: 'platform' | 'cross-platform' = 'cross-platform';\n    if (credential.authenticatorAttachment) {\n      credentialDeviceType = credential.authenticatorAttachment === 'platform' ? 'platform' : 'cross-platform';\n      logger.debug('webauthn_device_type_from_attachment', {\n        authenticatorAttachment: credential.authenticatorAttachment,\n        credentialDeviceType,\n      });\n    } else {\n      // Fall back to AAGUID-based detection\n      const deviceInfo = await getDeviceInfoByAAGUID(attestedCredential.authenticatorAAGUID, metadataKV);\n      credentialDeviceType = deviceInfo.type;\n      logger.debug('webauthn_device_type_from_aaguid', {\n        aaguid: encodeBase64url(attestedCredential.authenticatorAAGUID),\n        credentialDeviceType,\n      });\n    }\n\n    // Get device info for generating a friendly name\n    const deviceInfo = await getDeviceInfoByAAGUID(attestedCredential.authenticatorAAGUID, metadataKV);\n\n    // Extract backup state from authenticator flags\n    const backupState = extractBackupState(authenticatorData);\n\n    // Get algorithm from public key\n    const keyAlgorithm = attestedCredential.publicKey.algorithm();\n\n    // Extract attestation type from attestation object\n    const attestationType = extractAttestationType(attestationObject);\n\n    // Generate a default friendly name based on device info\n    const defaultName = generateDefaultAuthenticatorName(deviceInfo);\n\n    return {\n      id: encodeBase64url(attestedCredential.id),\n      credentialPublicKey,\n      counter: authenticatorData.signatureCounter,\n      credentialDeviceType,\n      credentialBackedUp: backupState.isBackedUp,\n      transports,\n      aaguid: encodeBase64url(attestedCredential.authenticatorAAGUID),\n      name: defaultName,\n      lastUsedAt: null,\n      attestationType,\n      rpId: expectedRPID,\n      algorithm: keyAlgorithm,\n    };\n  } catch (error) {\n    logger.error('webauthn_registration_error', {\n      error: error instanceof Error ? error.message : 'Unknown error',\n    });\n    return err('Registration verification failed', { field: 'general' }, { status: 500 });\n  }\n}\n\n/**\n * Verify authentication response using Oslo WebAuthn\n */\nexport async function verifyAuthentication(\n  credential: WebAuthnAuthenticationData,\n  expectedChallenge: string,\n  expectedOrigin: string,\n  expectedRPID: string,\n  storedCredential: AuthenticatorModel\n): Promise<Result<{ verified: boolean; newCounter: number }>> {\n  try {\n    // Parse authenticator data\n    const authenticatorData = parseAuthenticatorData(new Uint8Array(credential.response.authenticatorData));\n\n    // Parse client data\n    const clientData = parseClientDataJSON(new Uint8Array(credential.response.clientDataJSON));\n\n    // Verify challenge - convert Uint8Array to base64url for comparison\n    const receivedChallenge = encodeBase64url(new Uint8Array(clientData.challenge));\n    if (receivedChallenge !== expectedChallenge) {\n      return err('Invalid challenge', {\n        field: 'challenge',\n        code: WebAuthnErrorCode.INVALID_CHALLENGE,\n      });\n    }\n\n    // Verify origin\n    if (clientData.origin !== expectedOrigin) {\n      return err('Invalid origin', {\n        field: 'origin',\n        code: WebAuthnErrorCode.INVALID_ORIGIN,\n      });\n    }\n\n    // Verify type\n    if (clientData.type !== ClientDataType.Get) {\n      return err('Invalid request type', {\n        field: 'type',\n        code: WebAuthnErrorCode.INVALID_CREDENTIAL,\n      });\n    }\n\n    // Verify RP ID hash\n    if (!authenticatorData.verifyRelyingPartyIdHash(expectedRPID)) {\n      return err('Invalid relying party', {\n        field: 'rpId',\n        code: WebAuthnErrorCode.INVALID_RPID,\n      });\n    }\n\n    // Verify user presence\n    if (!authenticatorData.userPresent) {\n      return err('User presence required', {\n        field: 'userPresence',\n        code: WebAuthnErrorCode.USER_NOT_PRESENT,\n      });\n    }\n\n    // Verify counter BEFORE signature verification (prevent replay attacks)\n    // If counter is greater than 0, it must be strictly greater than stored counter\n    if (storedCredential.counter > 0 || authenticatorData.signatureCounter > 0) {\n      if (authenticatorData.signatureCounter <= storedCredential.counter) {\n        logger.critical('webauthn_authentication_counter_rollback_detected', {\n          stored: storedCredential.counter,\n          received: authenticatorData.signatureCounter,\n          credentialId: credential.id,\n          userId: storedCredential.userId,\n        });\n        return err('Security violation: Counter rollback detected', {\n          field: 'counter',\n          code: WebAuthnErrorCode.INVALID_COUNTER,\n        });\n      }\n    }\n\n    // Create assertion message for signature verification using Oslo.js utility\n    const signatureMessage = createAssertionSignatureMessage(new Uint8Array(credential.response.authenticatorData), new Uint8Array(credential.response.clientDataJSON));\n\n    // Reconstruct the COSE key from stored JSON\n    let publicKeyData: any;\n    try {\n      // Decode the stored COSE key JSON\n      const storedKeyJson = new TextDecoder().decode(decodeBase64url(storedCredential.credentialPublicKey));\n      publicKeyData = JSON.parse(storedKeyJson);\n\n      if (!publicKeyData) {\n        return err(\n          'Invalid stored public key',\n          {\n            field: 'publicKey',\n            code: WebAuthnErrorCode.INVALID_KEY_FORMAT,\n          },\n          { status: 500 }\n        ); // System error - corrupted data in DB\n      }\n    } catch (error) {\n      logger.error('webauthn_authentication_key_parse_error', {\n        error: error instanceof Error ? error.message : 'Unknown error',\n      });\n      return err(\n        'Failed to parse stored public key',\n        {\n          field: 'publicKey',\n          code: WebAuthnErrorCode.INVALID_KEY_FORMAT,\n        },\n        { status: 500 }\n      ); // System error - corrupted data in DB\n    }\n\n    // Verify the signature using ECDSA with P-256\n    try {\n      const signatureBytes = new Uint8Array(credential.response.signature);\n\n      // Extract EC2 key components for ES256 (algorithm -7)\n      // COSE key type 2 (EC2) with curve P-256 (1)\n      // Note: COSE uses negative integers as key labels: -2 for x, -3 for y\n\n      // Parse COSE key structure\n\n      const xCoordinate = publicKeyData[-2]; // x coordinate in COSE key\n      const yCoordinate = publicKeyData[-3]; // y coordinate in COSE key\n\n      if (!xCoordinate || !yCoordinate) {\n        return err('Invalid public key structure', {\n          field: 'publicKey',\n          code: WebAuthnErrorCode.INVALID_KEY_FORMAT,\n        });\n      }\n\n      // Convert coordinates to Uint8Array\n      let xBytes: Uint8Array;\n      let yBytes: Uint8Array;\n\n      try {\n        if (typeof xCoordinate === 'string') {\n          xBytes = decodeBase64url(xCoordinate);\n        } else if (Array.isArray(xCoordinate)) {\n          xBytes = new Uint8Array(xCoordinate);\n        } else if (typeof xCoordinate === 'object' && xCoordinate !== null) {\n          // Handle object format like {\"0\":179,\"1\":124,...}\n          const values = Object.values(xCoordinate) as number[];\n          xBytes = new Uint8Array(values);\n        } else {\n          xBytes = new Uint8Array(xCoordinate);\n        }\n\n        if (typeof yCoordinate === 'string') {\n          yBytes = decodeBase64url(yCoordinate);\n        } else if (Array.isArray(yCoordinate)) {\n          yBytes = new Uint8Array(yCoordinate);\n        } else if (typeof yCoordinate === 'object' && yCoordinate !== null) {\n          // Handle object format like {\"0\":179,\"1\":124,...}\n          const values = Object.values(yCoordinate) as number[];\n          yBytes = new Uint8Array(values);\n        } else {\n          yBytes = new Uint8Array(yCoordinate);\n        }\n      } catch (error) {\n        logger.error('webauthn_authentication_coordinate_decode_error', {\n          error: error instanceof Error ? error.message : 'Unknown error',\n        });\n        return err('Failed to decode key coordinates', {\n          field: 'publicKey',\n          code: WebAuthnErrorCode.INVALID_KEY_FORMAT,\n        });\n      }\n\n      // Validate coordinate lengths (P-256 coordinates should be 32 bytes each)\n      if (xBytes.length !== WEBAUTHN_CONFIG.COORDINATE_LENGTH || yBytes.length !== WEBAUTHN_CONFIG.COORDINATE_LENGTH) {\n        return err('Invalid coordinate length for P-256 key', {\n          field: 'publicKey',\n          code: WebAuthnErrorCode.INVALID_KEY_FORMAT,\n        });\n      }\n\n      // Convert bytes to bigint for ECDSAPublicKey constructor\n      const xHex = Array.from(xBytes)\n        .map(b => b.toString(16).padStart(2, '0'))\n        .join('');\n      const yHex = Array.from(yBytes)\n        .map(b => b.toString(16).padStart(2, '0'))\n        .join('');\n\n      if (xHex.length === 0 || yHex.length === 0) {\n        return err('Empty coordinate data', {\n          field: 'publicKey',\n          code: WebAuthnErrorCode.INVALID_KEY_FORMAT,\n        });\n      }\n\n      // Ensure coordinates are exactly 64 hex characters (32 bytes)\n      const xHexPadded = xHex.padStart(WEBAUTHN_CONFIG.HEX_COORDINATE_LENGTH, '0');\n      const yHexPadded = yHex.padStart(WEBAUTHN_CONFIG.HEX_COORDINATE_LENGTH, '0');\n\n      const xBigInt = BigInt(`0x${xHexPadded}`);\n      const yBigInt = BigInt(`0x${yHexPadded}`);\n\n      // Convert coordinates for ECDSAPublicKey constructor\n\n      // Create public key using ECDSAPublicKey constructor with P-256 curve\n      const publicKey = new ECDSAPublicKey(p256, xBigInt, yBigInt);\n\n      // Validate that the public key is on the P-256 curve\n      if (!publicKey.isCurve(p256)) {\n        return err('Public key not on P-256 curve', {\n          field: 'publicKey',\n          code: WebAuthnErrorCode.INVALID_KEY_FORMAT,\n        });\n      }\n\n      // Additional validation: try encoding the public key to SEC1 format to verify it's valid\n      try {\n        publicKey.encodeSEC1Uncompressed();\n      } catch (error) {\n        logger.error('webauthn_authentication_public_key_encoding_error', {\n          error: error instanceof Error ? error.message : 'Unknown error',\n        });\n        return err('Invalid public key encoding', {\n          field: 'publicKey',\n          code: WebAuthnErrorCode.INVALID_KEY_FORMAT,\n        });\n      }\n\n      const messageHash = sha256(signatureMessage);\n\n      // WebAuthn signatures are DER-encoded, we need to decode them first\n      const signature = decodePKIXECDSASignature(signatureBytes);\n      const isValid = verifyECDSASignature(publicKey, messageHash, signature);\n\n      if (!isValid) {\n        return err('Invalid signature', {\n          field: 'signature',\n          code: WebAuthnErrorCode.SIGNATURE_FAILED,\n        });\n      }\n    } catch (error) {\n      logger.error('webauthn_authentication_signature_verification_error', {\n        error: error instanceof Error ? error.message : 'Unknown error',\n        credentialId: credential.id,\n      });\n      return err(\n        'Signature verification failed',\n        {\n          field: 'signature',\n          code: WebAuthnErrorCode.SIGNATURE_FAILED,\n        },\n        { status: 500 }\n      ); // System error - crypto operation failed\n    }\n\n    return {\n      verified: true,\n      newCounter: authenticatorData.signatureCounter,\n    };\n  } catch (error) {\n    logger.error('webauthn_authentication_error', {\n      error: error instanceof Error ? error.message : 'Unknown error',\n    });\n    return err('Authentication verification failed', { field: 'general' }, { status: 500 });\n  }\n}\n","import { getContext } from '@ycore/forge/context';\nimport { logger } from '@ycore/forge/logger';\nimport { err, isError, ok, type Result } from '@ycore/forge/result';\nimport type { RouterContextProvider } from 'react-router';\n\nimport { defaultAuthRoutes } from '../auth.config';\nimport type { User } from '../schema';\nimport { authConfigContext } from './auth.context';\nimport { createAuthSession } from './session';\n\n/**\n * Parse WebAuthn credential from FormData\n *\n * @param formData - The form data containing webauthn_response\n * @param operation - The operation being performed (for error messages)\n * @returns Result with parsed credential or error\n *\n * @example\n * ```ts\n * const result = parseWebAuthnCredential(formData, 'signin');\n * if (isError(result)) {\n *   return respondError(result);\n * }\n * const credential = result;\n * ```\n */\nexport function parseWebAuthnCredential(formData: FormData, operation: 'signin' | 'signup' | 'add-passkey'): Result<any> {\n  const webauthnResponse = formData.get('webauthn_response')?.toString();\n\n  if (!webauthnResponse) {\n    const errorMessage = operation === 'signin' ? 'Authentication failed. Please try again.' : 'Registration failed. Please try again.';\n    logger.warning(`${operation}_missing_webauthn_response`);\n    return err(errorMessage, { field: 'general' });\n  }\n\n  try {\n    const credential = JSON.parse(webauthnResponse);\n    return ok(credential);\n  } catch (error) {\n    logger.error(`${operation}_webauthn_parse_error`, {\n      error: error instanceof Error ? error.message : 'Unknown error',\n    });\n    return err('Invalid authentication data. Please try again.', { field: 'general' });\n  }\n}\n\n/**\n * Create authenticated session with standardized error handling\n *\n * @param context - Router context provider\n * @param user - The authenticated user\n * @param email - User's email for logging\n * @param operation - The operation being performed (for logging)\n * @returns Result with cookie string or error\n *\n * @example\n * ```ts\n * const result = await createAuthenticatedSession(context, user, user.email, 'signin');\n * if (isError(result)) {\n *   return respondError(result);\n * }\n * const cookie = result;\n * ```\n */\nexport async function createAuthenticatedSession(context: Readonly<RouterContextProvider>, user: User, email: string, operation: 'signin' | 'signup'): Promise<Result<string>> {\n  const sessionResult = await createAuthSession(context, { user });\n\n  if (isError(sessionResult)) {\n    logger.error(`${operation}_session_creation_failed`, {\n      email,\n      userId: user.id,\n      error: sessionResult.message,\n    });\n    return err('Failed to create session', { field: 'general' });\n  }\n\n  return ok(sessionResult);\n}\n\n/**\n * Create auth success response with redirect\n * Always checks email verification status - redirects to verify if not verified\n *\n * @param context - Router context provider\n * @param cookie - The Set-Cookie header value\n * @param user - The authenticated user (optional, used to check verification status)\n * @returns Object with redirectTo and cookie for redirect response\n *\n * @example\n * ```ts\n * const response = createAuthSuccessResponse(context, cookie, user);\n * return ok(response);\n * ```\n */\nexport function createAuthSuccessResponse(context: Readonly<RouterContextProvider>, cookie: string, user?: User): { redirectTo: string; cookie: string } {\n  const authConfig = getContext(context, authConfigContext);\n\n  // Always check verification status - active status is mandatory\n  if (user && user.status !== 'active') {\n    logger.info('user_not_verified_redirect_to_verify', {\n      userId: user.id,\n      email: user.email,\n      status: user.status,\n    });\n    const redirectTo = authConfig?.routes.verify || defaultAuthRoutes.verify;\n    return { redirectTo, cookie };\n  }\n\n  const redirectTo = authConfig?.routes.signedin || defaultAuthRoutes.signedin;\n  return { redirectTo, cookie };\n}\n","import { getOrigin, getOriginDomain, isDevelopment } from '@ycore/forge/services';\nimport type { RouterContextProvider } from 'react-router';\n\n/**\n * Detect if the request is for localhost or 127.0.0.1\n */\nfunction isLocalhostDomain(domain: string): boolean {\n  return domain === 'localhost' || domain === '127.0.0.1' || domain === '[::1]';\n}\n\n/**\n * Resolve WebAuthn rpID from context and request\n */\nexport function resolveRpId(context: Readonly<RouterContextProvider>, request: Request): string {\n  const originDomain = getOriginDomain(context, request);\n\n  // WebAuthn spec requires exactly 'localhost' for localhost requests\n  if (isLocalhostDomain(originDomain)) {\n    return 'localhost';\n  }\n\n  return originDomain;\n}\n\n/**\n * Resolve WebAuthn origins from context and request\n *\n * Security model:\n * - Production: Strict - only allows configured origin (from SITE_URL env or request origin)\n * - Development: Permissive - allows both configured origin and request origin\n *\n * This ensures production deployments validate against the configured origin while\n * development environments automatically work with localhost on any port.\n */\nexport function resolveOrigins(context: Readonly<RouterContextProvider>, request: Request): string[] {\n  const originUrl = getOrigin(context, request);\n  const requestOrigin = new URL(request.url).origin;\n  const isDevMode = isDevelopment(context);\n\n  // Development: Allow both configured origin and request origin for flexibility\n  if (isDevMode) {\n    return [...new Set([originUrl, requestOrigin])];\n  }\n\n  // Production: Strict - only configured origin\n  return [originUrl];\n}\n\n/**\n * Validate that a client origin is in the list of allowed origins\n */\nexport function validateOrigin(clientOrigin: string, allowedOrigins: string[]): boolean {\n  return allowedOrigins.includes(clientOrigin);\n}\n","import { decodeBase64url } from '@oslojs/encoding';\nimport { logger } from '@ycore/forge/logger';\nimport { err, isError, ok, type Result } from '@ycore/forge/result';\nimport type { RouterContextProvider } from 'react-router';\nimport { WebAuthnErrorCode } from '../auth.constants';\nimport { verifyChallengeUniqueness } from './session';\nimport { resolveOrigins, resolveRpId, validateOrigin } from './webauthn-config';\n\n/**\n * Result of WebAuthn validation containing validated challenge, origin, and rpId\n */\nexport interface WebAuthnValidationResult {\n  challenge: string;\n  origin: string;\n  rpId: string;\n}\n\n/**\n * Options for challenge validation\n */\nexport interface ChallengeValidationOptions {\n  /**\n   * The stored challenge from session\n   */\n  storedChallenge: string;\n\n  /**\n   * When the challenge was created (timestamp)\n   */\n  challengeCreatedAt: number;\n\n  /**\n   * Maximum age of challenge in milliseconds (default: 5 minutes)\n   */\n  maxAge?: number;\n}\n\n/**\n * Options for origin validation\n */\nexport interface OriginValidationOptions {\n  /**\n   * The client data JSON from WebAuthn credential\n   */\n  clientDataJSON: string;\n\n  /**\n   * Additional context for logging (e.g., email, userId)\n   */\n  logContext?: Record<string, unknown>;\n\n  /**\n   * The operation being performed (for logging)\n   */\n  operation: 'signin' | 'signup' | 'add-passkey';\n}\n\n/**\n * Validates a WebAuthn challenge for expiration and uniqueness\n *\n * This function performs three critical security checks:\n * 1. Verifies challenge exists in session\n * 2. Checks challenge hasn't expired (default 5 minutes)\n * 3. Verifies challenge uniqueness to prevent replay attacks\n *\n * @param options - Challenge validation options\n * @param context - Router context for KV access\n * @returns Result with success or error details\n *\n * @example\n * ```ts\n * const result = await validateChallenge({\n *   storedChallenge: session.get('challenge'),\n *   challengeCreatedAt: session.get('challengeCreatedAt'),\n * }, context);\n *\n * if (isError(result)) {\n *   return respondError(result);\n * }\n * ```\n */\nexport async function validateChallenge(options: ChallengeValidationOptions, context: Readonly<RouterContextProvider>): Promise<Result<void>> {\n  const { storedChallenge, challengeCreatedAt, maxAge = 5 * 60 * 1000 } = options;\n\n  // Check challenge expiration\n  if (Date.now() - challengeCreatedAt > maxAge) {\n    return err('Session expired. Please refresh and try again.', {\n      field: 'general',\n      code: WebAuthnErrorCode.CHALLENGE_EXPIRED,\n    });\n  }\n\n  // Verify challenge uniqueness (prevents replay attacks)\n  const uniquenessResult = await verifyChallengeUniqueness(storedChallenge, context);\n  if (!uniquenessResult) {\n    return err('Invalid challenge. Please refresh and try again.', {\n      field: 'general',\n      code: WebAuthnErrorCode.INVALID_CHALLENGE,\n    });\n  }\n\n  // Return success (void)\n  return ok(undefined);\n}\n\n/**\n * Validates WebAuthn origin using server-determined origin (not client-provided)\n *\n * This function implements critical security measures:\n * 1. Uses server-determined origin from request URL (NOT client data)\n * 2. Validates server origin is in allowed origins list\n * 3. Parses client data and verifies origin matches server origin\n * 4. Prevents origin confusion attacks\n *\n * @param request - The incoming request\n * @param options - Origin validation options\n * @param context - Router context\n * @returns Result with validated origin or error\n *\n * @example\n * ```ts\n * const result = await validateOrigin(request, {\n *   clientDataJSON: credential.response.clientDataJSON,\n *   operation: 'signin',\n *   logContext: { email: user.email }\n * }, context);\n *\n * if (isError(result)) {\n *   return respondError(result);\n * }\n *\n * const { origin } = result;\n * ```\n */\nexport async function validateWebAuthnOrigin(request: Request, options: OriginValidationOptions, context: Readonly<RouterContextProvider>): Promise<Result<string>> {\n  const { clientDataJSON, logContext = {}, operation } = options;\n\n  // Resolve allowed origins from configuration\n  const allowedOrigins = resolveOrigins(context, request);\n\n  // SECURITY: Use server-determined origin, not client-provided\n  // The server determines the origin from the request URL\n  const serverOrigin = new URL(request.url).origin;\n\n  // Verify the server origin is in our allowed origins (sanity check)\n  if (!validateOrigin(serverOrigin, allowedOrigins)) {\n    logger.error(`${operation}_server_origin_not_allowed`, {\n      serverOrigin,\n      allowedOrigins,\n      ...logContext,\n    });\n\n    return err('Server configuration error', { field: 'general' });\n  }\n\n  // Parse client data to verify origin matches server-determined origin\n  const clientData = JSON.parse(new TextDecoder().decode(decodeBase64url(clientDataJSON))) as { origin: string };\n  const clientOrigin = clientData.origin;\n\n  // SECURITY: Verify client-provided origin matches server-determined origin\n  // This prevents origin confusion attacks\n  if (clientOrigin !== serverOrigin) {\n    return err('Origin mismatch', { field: 'general' });\n  }\n\n  return ok(serverOrigin);\n}\n\n/**\n * Validates a complete WebAuthn request including challenge and origin\n *\n * This is a convenience function that combines challenge and origin validation\n * in a single call. Use this when you need both validations.\n *\n * @param request - The incoming request\n * @param options - Combined validation options\n * @param context - Router context\n * @returns Result with validation data or error\n *\n * @example\n * ```ts\n * const result = await validateWebAuthnRequest(request, {\n *   storedChallenge: session.get('challenge'),\n *   challengeCreatedAt: session.get('challengeCreatedAt'),\n *   clientDataJSON: credential.response.clientDataJSON,\n *   operation: 'signin',\n *   logContext: { email: user.email }\n * }, context);\n *\n * if (isError(result)) {\n *   return respondError(result);\n * }\n *\n * const { challenge, origin, rpId } = result;\n * ```\n */\nexport async function validateWebAuthnRequest(request: Request, options: ChallengeValidationOptions & OriginValidationOptions, context: Readonly<RouterContextProvider>): Promise<Result<WebAuthnValidationResult>> {\n  const { storedChallenge, challengeCreatedAt, clientDataJSON, logContext, operation, maxAge } = options;\n\n  // Validate challenge\n  const challengeResult = await validateChallenge({ storedChallenge, challengeCreatedAt, maxAge }, context);\n\n  if (isError(challengeResult)) {\n    return challengeResult;\n  }\n\n  // Validate origin\n  const originResult = await validateWebAuthnOrigin(request, { clientDataJSON, logContext, operation }, context);\n\n  if (isError(originResult)) {\n    return originResult;\n  }\n\n  // Resolve RP ID\n  const rpId = resolveRpId(context, request);\n\n  return ok({ challenge: storedChallenge, origin: originResult, rpId });\n}\n","import { decodeBase64url } from '@oslojs/encoding';\nimport { getContext } from '@ycore/forge/context';\nimport type { IntentHandlers } from '@ycore/forge/intent/server';\nimport { handleIntent } from '@ycore/forge/intent/server';\nimport { logger } from '@ycore/forge/logger';\nimport { err, flattenError, isError, isSystemError, ok, respondError, respondOk, respondRedirect, throwSystemError, transformError, validateFormData } from '@ycore/forge/result';\nimport { requireCSRFToken } from '@ycore/foundry/secure/server';\n\nimport type { SignInActionArgs, SignInLoaderArgs } from '../@types/auth.types';\nimport { defaultAuthRoutes } from '../auth.config';\nimport type { WebAuthnErrorCode } from '../auth.constants';\nimport type { Authenticator } from '../schema';\nimport { authConfigContext } from './auth.context';\nimport { signinFormSchema } from './auth.validation';\nimport { getAuthRepository } from './repository';\nimport { createChallengeSession, destroyChallengeSession, getChallengeFromSession } from './session';\nimport { generateChallenge, getWebAuthnErrorMessage, verifyAuthentication } from './webauthn';\nimport { createAuthenticatedSession, parseWebAuthnCredential } from './webauthn-utils';\nimport { validateWebAuthnRequest } from './webauthn-validation';\n\nexport async function signinLoader({ context }: SignInLoaderArgs) {\n  const token = requireCSRFToken(context);\n  const challenge = generateChallenge();\n\n  const cookieResult = await createChallengeSession(context, challenge);\n  if (isError(cookieResult)) {\n    logger.error('signin_loader_session_creation_failed', { error: cookieResult.message });\n    return respondError(cookieResult);\n  }\n\n  return respondOk({ token, challenge }, { headers: { 'Set-Cookie': cookieResult } });\n}\n\nexport async function signinAction({ request, context }: SignInActionArgs) {\n  const repository = getAuthRepository(context);\n  const authConfig = getContext(context, authConfigContext);\n  const formData = await request.formData();\n\n  const handlers: IntentHandlers = {\n    signin: async (formData: FormData) => {\n      try {\n        const validationResult = await validateFormData(signinFormSchema, formData);\n        if (isError(validationResult)) {\n          return validationResult; // User error - no logging needed\n        }\n\n        const email = validationResult.email;\n\n        // Timing-safe user lookup - always perform the same operations; prevents user enumeration attacks\n        const userResult = await repository.getUserByEmail(email);\n        const userExists = !isError(userResult);\n        const user = userExists ? userResult : null;\n\n        // Get user's authenticators - empty if user doesn't exist\n        const authenticatorsResult = user ? await repository.getAuthenticatorsByUserId(user.id) : ([] as any);\n        const hasAuthenticators = !isError(authenticatorsResult) && authenticatorsResult.length > 0;\n\n        // Timing-safe fail after all lookups complete\n        if (!userExists || !hasAuthenticators) {\n          return err('The credentials are incorrect', { email: 'The credentials are incorrect' }); // User error - no logging needed\n        }\n\n        // At this point we know authenticatorsResult is an array of Authenticator\n        const authenticators = authenticatorsResult;\n\n        // Get stored challenge from session\n        const sessionResult = await getChallengeFromSession(request, context);\n        if (isError(sessionResult)) {\n          return sessionResult; // User error - session expired\n        }\n\n        const { challenge: storedChallenge, challengeCreatedAt, session } = sessionResult;\n\n        // Get WebAuthn response from form\n        const credentialResult = parseWebAuthnCredential(formData, 'signin');\n        if (isError(credentialResult)) {\n          return credentialResult;\n        }\n\n        const credential = credentialResult;\n\n        // Verify credential ownership BEFORE signature verification\n        const authenticator = authenticators.find((auth: Authenticator) => auth.id === credential.rawId);\n\n        if (!authenticator) {\n          return err('The credentials are incorrect', { email: 'The credentials are incorrect' }); // User error\n        }\n\n        // Verify the authenticator belongs to this user (defense in depth)\n        if (authenticator.userId !== user?.id) {\n          logger.critical('signin_authenticator_user_mismatch', {\n            authenticatorUserId: authenticator.userId,\n            requestUserId: user?.id,\n            email,\n            credentialId: credential.rawId,\n          });\n          return err('The credentials are incorrect', { email: 'The credentials are incorrect' });\n        }\n\n        // Validate challenge and origin using shared utility\n        const webauthnValidationResult = await validateWebAuthnRequest(\n          request,\n          {\n            storedChallenge,\n            challengeCreatedAt,\n            clientDataJSON: credential.response.clientDataJSON,\n            operation: 'signin',\n            logContext: { email },\n          },\n          context\n        );\n\n        if (isError(webauthnValidationResult)) {\n          return webauthnValidationResult; // User error\n        }\n\n        const { challenge, origin, rpId } = webauthnValidationResult;\n\n        // Convert base64url strings back to ArrayBuffers for verification\n        const authenticationData = {\n          id: credential.id,\n          rawId: decodeBase64url(credential.rawId).buffer,\n          response: {\n            authenticatorData: decodeBase64url(credential.response.authenticatorData).buffer,\n            clientDataJSON: decodeBase64url(credential.response.clientDataJSON).buffer,\n            signature: decodeBase64url(credential.response.signature).buffer,\n            userHandle: credential.response.userHandle ? decodeBase64url(credential.response.userHandle).buffer : undefined,\n          },\n          type: 'public-key' as const,\n        };\n\n        // Verify authentication using the validated challenge, origin, and rpId\n        const verificationResult = await verifyAuthentication(authenticationData, challenge, origin, rpId, authenticator);\n\n        if (isError(verificationResult)) {\n          // System error - unexpected WebAuthn failure\n          if (isSystemError(verificationResult)) {\n            logger.error('signin_verification_system_error', { email, error: flattenError(verificationResult), code: verificationResult.code });\n          }\n\n          // Provide user-friendly error messages based on error code\n          const errorMessage = getWebAuthnErrorMessage(verificationResult.code as WebAuthnErrorCode, 'authentication');\n          return err(errorMessage, { field: 'general', code: verificationResult.code });\n        }\n\n        // Update authenticator counter and last used timestamp\n        const updateResult = await repository.updateAuthenticatorUsage(authenticator.id, verificationResult.newCounter, new Date());\n\n        if (isError(updateResult)) {\n          logger.warning('signin_authenticator_update_failed', { authenticatorId: authenticator.id, error: updateResult.message });\n          // Continue with signin even if update fails\n        }\n\n        // Handle pending operations - signin clears all dangling pending states\n        if (user?.pending) {\n          const pendingType = user?.pending.type;\n\n          // Recovery mode: delete old authenticators from before recovery\n          if (pendingType === 'recovery') {\n            const recoveryTimestamp = user?.pending.timestamp;\n\n            logger.info('recovery_cleanup_detected', { userId: user?.id, email, recoveryTimestamp });\n\n            // Delete all authenticators older than recovery timestamp\n            const deleteResult = await repository.deleteAuthenticatorsByTimestamp(user?.id, recoveryTimestamp);\n\n            if (isError(deleteResult)) {\n              logger.warning('recovery_cleanup_delete_failed', { userId: user?.id, email, error: flattenError(deleteResult) });\n              // Continue with signin even if cleanup fails\n            } else {\n              logger.info('recovery_cleanup_completed', { userId: user?.id, email, deletedCount: deleteResult });\n            }\n          } else {\n            // Email-change or account-delete: user abandoned operation, clear it\n            logger.info('pending_operation_abandoned_on_signin', { userId: user?.id, email, pendingType });\n          }\n\n          // Clear pending data for all cases\n          const pendingUpdateResult = await repository.updateUserPending(user?.id, null);\n\n          if (isError(pendingUpdateResult)) {\n            logger.warning('pending_clear_failed_on_signin', { userId: user?.id, email, pendingType, error: flattenError(pendingUpdateResult) });\n            // Continue with signin even if pending clear fails\n          }\n\n          // If user status is not active, restore it (abandoned operations should restore status)\n          if (user?.status !== 'active') {\n            const statusUpdateResult = await repository.updateUserStatus(user?.id, 'active');\n\n            if (isError(statusUpdateResult)) {\n              logger.warning('status_restore_failed_on_signin', { userId: user?.id, email, error: flattenError(statusUpdateResult) });\n              // Continue with signin even if status update fails\n            } else {\n              // Update user object so redirect logic uses correct status\n              user.status = 'active';\n              logger.info('status_restored_on_signin', { userId: user?.id, email });\n            }\n          }\n        }\n\n        // Clear challenge from session\n        const cleanupResult = await destroyChallengeSession(session, context);\n        if (isError(cleanupResult)) {\n          // Log but continue - not critical\n          logger.warning('signin_challenge_cleanup_failed', { error: flattenError(cleanupResult) });\n        }\n\n        // Create authenticated session\n        const authSessionResult = await createAuthenticatedSession(context, user!, email, 'signin');\n        if (isError(authSessionResult)) {\n          // System error - session creation failed\n          if (isSystemError(authSessionResult)) {\n            logger.error('signin_session_creation_failed', { email, error: flattenError(authSessionResult) });\n          }\n          return authSessionResult;\n        }\n\n        // Determine redirect path based on user status\n        const redirectTo = user?.status === 'active' ? authConfig?.routes.signedin || defaultAuthRoutes.signedin : authConfig?.routes.verify || defaultAuthRoutes.verify;\n\n        // Return session cookie and redirect info\n        return ok({\n          sessionCookie: authSessionResult,\n          redirectTo,\n        });\n      } catch (error) {\n        if (error instanceof Response) {\n          throw error;\n        }\n\n        logger.error('signin_error', { error: transformError(error) });\n        return err('Authentication failed', { field: 'general' });\n      }\n    },\n  };\n\n  const result = await handleIntent(formData, handlers);\n\n  if (isError(result)) {\n    // System error\n    if (isSystemError(result)) {\n      logger.error('signin_system_error', { error: flattenError(result) });\n      throwSystemError(result.message, result.status as 503);\n    }\n\n    // User error - show in form\n    return respondError(result);\n  }\n\n  // Success - redirect with session cookie\n  const { redirectTo, sessionCookie } = result as {\n    redirectTo: string;\n    sessionCookie: string;\n  };\n\n  throw respondRedirect(redirectTo, {\n    headers: { 'Set-Cookie': sessionCookie },\n  });\n}\n","import { getContext } from '@ycore/forge/context';\nimport { logger } from '@ycore/forge/logger';\nimport { flattenError, isError, isSystemError, respondRedirect } from '@ycore/forge/result';\nimport type { RouterContextProvider } from 'react-router';\n\nimport { defaultAuthRoutes } from '../auth.config';\nimport { authConfigContext } from './auth.context';\nimport { destroyAuthSession } from './session';\n\nexport interface SignOutActionArgs {\n  request: Request;\n  context: Readonly<RouterContextProvider>;\n}\n\nexport async function signoutAction({ request, context }: SignOutActionArgs) {\n  const destroyResult = await destroyAuthSession(request, context);\n\n  if (isError(destroyResult)) {\n    // System error - log session destruction failure\n    if (isSystemError(destroyResult)) {\n      logger.error('signout_session_destruction_failed', { error: flattenError(destroyResult) });\n    }\n  }\n\n  const authConfig = getContext(context, authConfigContext);\n  const redirectTo = authConfig?.routes.signedout || defaultAuthRoutes.signedout;\n\n  throw respondRedirect(redirectTo, {\n    headers: { 'Set-Cookie': !isError(destroyResult) ? destroyResult : '' },\n  });\n}\n\nexport async function signoutLoader({ context }: { context: Readonly<RouterContextProvider> }) {\n  const authConfig = getContext(context, authConfigContext);\n  const redirectTo = authConfig?.routes.signedout || defaultAuthRoutes.signedout;\n\n  throw respondRedirect(redirectTo);\n}\n","import { Body, Container, Head, Heading, Html, Section, Text } from '@ycore/componentry/email';\nimport { defineEmailTemplate } from '../../email/@types/email-template-builder';\nimport { TEMPLATE_STYLES_MAP } from './tailwind.styles';\n\nexport type VerificationPurpose = 'signup' | 'passkey-add' | 'passkey-delete' | 'email-change' | 'account-delete' | 'recovery';\n\nexport interface TotpTemplateData {\n  code: string;\n  purpose: VerificationPurpose;\n}\n\n/**\n * TOTP content structure for each verification purpose\n */\nexport interface TotpContent {\n  title: string;\n  message: string;\n  action: string;\n}\n\n/**\n * Type-safe repository mapping all verification purposes to their content\n * TypeScript will error if any VerificationPurpose is missing or extra keys exist\n */\nexport type TotpRepository = Record<VerificationPurpose, TotpContent>;\n\n/**\n * Repository of TOTP email content for each verification purpose\n * Indexed by VerificationPurpose for type-safe lookups\n */\nexport const totpRepository = {\n  signup: {\n    title: 'Verify Email Address',\n    message: 'Thank you for signing up. Please verify the email address to complete the sign-up.',\n    action: 'verify your email',\n  },\n  'passkey-add': {\n    title: 'Confirm Adding Passkey',\n    message: 'Please verify adding a new passkey to the user account.',\n    action: 'confirm adding the passkey',\n  },\n  'passkey-delete': {\n    title: 'Confirm Removing Passkey',\n    message: 'Please verify removing a passkey from the user account.',\n    action: 'confirm removing the passkey',\n  },\n  'email-change': {\n    title: 'Verify Email Address Update',\n    message: 'Please verify the email address change.',\n    action: 'verify email address change',\n  },\n  'account-delete': {\n    title: 'Confirm Account Deletion',\n    message: 'Please confirm account delete. This action cannot be undone.',\n    action: 'confirm account deletion',\n  },\n  recovery: {\n    title: 'Confirm Account Recovery',\n    message: 'An account recovery request is pending. Use this code to regain access to the account.',\n    action: 'recover your account',\n  },\n} as const satisfies TotpRepository;\n\n/**\n * TOTP Email Template\n * Email template for TOTP verification codes with purpose-specific content\n */\nexport const TotpEmailTemplate = defineEmailTemplate({\n  component: ({ code, purpose }: TotpTemplateData) => {\n    const content = totpRepository[purpose];\n    const isHighRisk = purpose === 'account-delete' || purpose === 'passkey-delete';\n    const isAccountDelete = purpose === 'account-delete';\n\n    return (\n      <Html lang=\"en\">\n        <Head />\n        <Body className=\"bg-white font-sans\">\n          <Container className={`mx-auto max-w-2xl text-foreground leading-relaxed ${isAccountDelete ? 'rounded-lg border-2 border-warning-200 bg-warning-100 p-5' : ''}`}>\n            <Section className=\"px-5 pt-10 pb-5 text-center\">\n              <Heading level={1}>{content.title}</Heading>\n            </Section>\n\n            <Section className=\"px-5 pb-5 text-center text-muted-foreground\">\n              <Text>{content.message}</Text>\n            </Section>\n\n            <Section className=\"mx-5 my-5 rounded-lg border-2 border-border bg-muted p-5 text-center\">\n              <Text className=\"m-0 font-bold text-3xl text-foreground tracking-[8px]\">{code}</Text>\n            </Section>\n\n            <Section className=\"px-5 py-5 text-center text-muted-foreground text-sm\">\n              <Text>\n                This code will expire within <strong>8 minutes</strong> of issuing.\n              </Text>\n              <Text>If this code was not requested,{isHighRisk ? ' consider securing your account' : ' it can be safely ignored'}.</Text>\n            </Section>\n          </Container>\n        </Body>\n      </Html>\n    );\n  },\n\n  subject: ({ purpose }) => totpRepository[purpose].title,\n\n  stylesMap: TEMPLATE_STYLES_MAP,\n});\n","import { logger } from '@ycore/forge/logger';\nimport { err, flattenError, isError, ok, type Result } from '@ycore/forge/result';\nimport type { RouterContextProvider } from 'react-router';\n\nimport { sendMail } from '../../email/server';\nimport { renderEmailTemplate } from '../../email/server/render-email';\nimport { TotpEmailTemplate } from '../templates/auth-totp';\nimport { createVerificationCode, type VerificationPurpose } from './totp-service';\n\nexport interface SendVerificationOptions {\n  email: string;\n  purpose: VerificationPurpose;\n  metadata?: Record<string, unknown>;\n  context: Readonly<RouterContextProvider>;\n}\n\n/**\n * Send verification email with TOTP code\n * Generates TOTP code and sends default TOTP template\n * For custom templates, use createVerificationCode + renderEmailTemplate + sendMail directly\n */\nexport async function sendVerificationEmail(options: SendVerificationOptions): Promise<Result<void>> {\n  const { email, purpose, metadata, context } = options;\n\n  try {\n    // Generate TOTP code\n    const codeResult = await createVerificationCode(email, purpose, context, metadata);\n\n    if (isError(codeResult)) {\n      logger.error('verification_email_code_generation_failed', {\n        email,\n        purpose,\n        error: flattenError(codeResult),\n      });\n      return codeResult;\n    }\n\n    const code = codeResult;\n\n    // Create default TOTP email template\n    const emailContent = await renderEmailTemplate(TotpEmailTemplate, {\n      code,\n      purpose,\n    });\n\n    // Send email using centralized service (handles provider setup automatically)\n    const sendResult = await sendMail(context, {\n      to: email,\n      template: emailContent,\n    });\n\n    if (isError(sendResult)) {\n      logger.error('verification_email_send_failed', {\n        email,\n        purpose,\n        error: flattenError(sendResult),\n      });\n      return sendResult;\n    }\n\n    logger.info('verification_email_sent', { email, purpose });\n    return ok(undefined);\n  } catch (error) {\n    logger.error('verification_email_unexpected_error', {\n      email,\n      purpose,\n      error: error instanceof Error ? error.message : 'Unknown error',\n      stack: error instanceof Error ? error.stack : undefined,\n    });\n    return err('Failed to send verification email', { error });\n  }\n}\n","import { decodeBase64url } from '@oslojs/encoding';\nimport { getContext } from '@ycore/forge/context';\nimport type { IntentHandlers } from '@ycore/forge/intent/server';\nimport { handleIntent } from '@ycore/forge/intent/server';\nimport { logger } from '@ycore/forge/logger';\nimport { err, flattenError, isError, isSystemError, ok, respondError, respondOk, respondRedirect, throwSystemError, transformError, validateFormData } from '@ycore/forge/result';\nimport { getKVStore } from '@ycore/forge/services';\nimport { requireCSRFToken } from '@ycore/foundry/secure/server';\n\nimport type { SignUpActionArgs, SignUpLoaderArgs } from '../@types/auth.types';\nimport { defaultAuthRoutes } from '../auth.config';\nimport type { WebAuthnErrorCode } from '../auth.constants';\nimport type { User } from '../schema';\nimport { authConfigContext } from './auth.context';\nimport { signupFormSchema } from './auth.validation';\nimport { getAuthRepository } from './repository';\nimport { createChallengeSession, destroyChallengeSession, getChallengeFromSession } from './session';\nimport { sendVerificationEmail } from './verification-service';\nimport { generateChallenge, getWebAuthnErrorMessage, verifyRegistration } from './webauthn';\nimport { createAuthenticatedSession, parseWebAuthnCredential } from './webauthn-utils';\nimport { validateWebAuthnRequest } from './webauthn-validation';\n\nexport async function signupLoader({ context }: SignUpLoaderArgs) {\n  const token = requireCSRFToken(context);\n  const challenge = generateChallenge();\n\n  const cookieResult = await createChallengeSession(context, challenge);\n  if (isError(cookieResult)) {\n    logger.error('signup_loader_session_creation_failed', { error: cookieResult.message });\n    return respondError(cookieResult);\n  }\n\n  return respondOk({ token, challenge }, { headers: { 'Set-Cookie': cookieResult } });\n}\n\nexport async function signupAction({ request, context }: SignUpActionArgs) {\n  const repository = getAuthRepository(context);\n  const authConfig = getContext(context, authConfigContext);\n  const formData = await request.formData();\n\n  const handlers: IntentHandlers = {\n    signup: async (formData: FormData) => {\n      try {\n        // Validate form data\n        const validationResult = await validateFormData(signupFormSchema, formData);\n        if (isError(validationResult)) {\n          return validationResult; // User error - no logging needed\n        }\n\n        const { email, displayName } = validationResult;\n\n        // Check if user already exists\n        const existingUserResult = await repository.getUserByEmail(email);\n\n        // Allow recovery mode if user exists with status='unrecovered'\n        const isRecoveryMode = !isError(existingUserResult) && existingUserResult.status === 'unrecovered';\n\n        if (!isError(existingUserResult) && !isRecoveryMode) {\n          return err('An account already exists with this email', { email: 'An account already exists with this email' });\n        }\n\n        logger.info('signup_mode_detected', { email, isRecoveryMode });\n\n        // Get stored challenge from session\n        const sessionResult = await getChallengeFromSession(request, context);\n        if (isError(sessionResult)) {\n          return sessionResult; // User error - session expired\n        }\n\n        const { challenge: storedChallenge, challengeCreatedAt, session } = sessionResult;\n\n        // Get WebAuthn response from form\n        const credentialResult = parseWebAuthnCredential(formData, 'signup');\n        if (isError(credentialResult)) {\n          return credentialResult;\n        }\n\n        const credential = credentialResult;\n\n        // Validate challenge and origin using shared utility\n        const webauthnValidationResult = await validateWebAuthnRequest(\n          request,\n          {\n            storedChallenge,\n            challengeCreatedAt,\n            clientDataJSON: credential.response.clientDataJSON,\n            operation: 'signup',\n            logContext: { email },\n          },\n          context\n        );\n\n        if (isError(webauthnValidationResult)) {\n          return webauthnValidationResult;\n        }\n\n        const { challenge, origin, rpId } = webauthnValidationResult;\n\n        // Convert base64url strings back to ArrayBuffers for verification\n        const registrationData = {\n          id: credential.id,\n          rawId: decodeBase64url(credential.rawId).buffer,\n          response: {\n            attestationObject: decodeBase64url(credential.response.attestationObject).buffer,\n            clientDataJSON: decodeBase64url(credential.response.clientDataJSON).buffer,\n            transports: credential.response?.transports || [],\n          },\n          type: 'public-key' as const,\n          authenticatorAttachment: credential.authenticatorAttachment || null,\n        };\n\n        // Get metadata KV from config (follows CSRF pattern)\n        const metadataKV = authConfig?.webauthn.kvBinding ? getKVStore(context, authConfig.webauthn.kvBinding) : undefined;\n\n        // Verify registration using the validated challenge, origin, and rpId\n        const verificationResult = await verifyRegistration(registrationData, challenge, origin, rpId, metadataKV);\n\n        if (isError(verificationResult)) {\n          // System error - unexpected WebAuthn failure\n          if (isSystemError(verificationResult)) {\n            logger.error('signup_verification_system_error', { email, error: flattenError(verificationResult), code: verificationResult.code });\n          }\n\n          // Provide user-friendly error messages based on error code\n          const errorMessage = getWebAuthnErrorMessage(verificationResult.code as WebAuthnErrorCode, 'registration');\n          return err(errorMessage, { field: 'general', code: verificationResult.code });\n        }\n\n        // Get or create user based on mode\n        let user: User;\n        if (isRecoveryMode) {\n          // Use existing user for recovery\n          user = existingUserResult;\n          logger.info('recovery_mode_using_existing_user', { userId: user.id, email });\n        } else {\n          // Create new user for normal signup\n          const createUserResult = await repository.createUser(email, displayName);\n          if (isError(createUserResult)) {\n            // System error - database failure\n            logger.error('signup_create_user_failed', { email, error: flattenError(createUserResult) });\n            return err('Failed to create account', { field: 'general' }, { status: 503 });\n          }\n          user = createUserResult;\n        }\n\n        // Create authenticator for the user\n        const createAuthResult = await repository.createAuthenticator({ ...verificationResult, userId: user.id });\n\n        if (isError(createAuthResult)) {\n          // System error - database failure\n          logger.error('signup_create_authenticator_failed', { email, userId: user.id, error: flattenError(createAuthResult) });\n          // Attempt cleanup only if we created a new user\n          if (!isRecoveryMode) {\n            await repository.deleteUser(user.id);\n          }\n          return err('Failed to register authenticator', { field: 'general' }, { status: 503 });\n        }\n\n        // Handle recovery mode: set pending recovery timestamp and update status\n        if (isRecoveryMode) {\n          const recoveryTimestamp = Date.now();\n\n          // Store recovery timestamp for cleanup\n          const pendingUpdateResult = await repository.updateUserPending(user.id, {\n            type: 'recovery',\n            timestamp: recoveryTimestamp,\n          });\n\n          if (isError(pendingUpdateResult)) {\n            logger.error('recovery_pending_update_failed', { userId: user.id, error: flattenError(pendingUpdateResult) });\n            // Continue anyway - passkey is registered, we'll just miss cleanup\n          }\n\n          // Update user status to active\n          const statusUpdateResult = await repository.updateUserStatus(user.id, 'active');\n\n          if (isError(statusUpdateResult)) {\n            logger.error('recovery_status_update_failed', { userId: user.id, error: flattenError(statusUpdateResult) });\n            // Continue anyway - user can still sign in\n          }\n\n          logger.info('recovery_passkey_registered', { userId: user.id, email, recoveryTimestamp });\n        }\n\n        // Clear challenge from session\n        const cleanupResult = await destroyChallengeSession(session, context);\n        if (isError(cleanupResult)) {\n          // Log but continue - not critical\n          logger.warning('signup_challenge_cleanup_failed', { error: flattenError(cleanupResult) });\n        }\n\n        // Create authenticated session\n        const authSessionResult = await createAuthenticatedSession(context, user, email, 'signup');\n        if (isError(authSessionResult)) {\n          // System error - session creation failed\n          if (isSystemError(authSessionResult)) {\n            logger.error('signup_session_creation_failed', { email, error: flattenError(authSessionResult) });\n          }\n          return authSessionResult;\n        }\n\n        if (user.status !== 'active') {\n          const verificationResult = await sendVerificationEmail({ email, purpose: 'signup', context });\n\n          if (isError(verificationResult)) {\n            logger.warning('signup_verification_email_error', { email, error: flattenError(verificationResult) });\n          }\n        }\n\n        // Determine redirect path based on user status\n        const redirectTo = user.status === 'active' ? authConfig?.routes.signedin || defaultAuthRoutes.signedin : authConfig?.routes.verify || defaultAuthRoutes.verify;\n\n        // Return session cookie and redirect info\n        return ok({ sessionCookie: authSessionResult, redirectTo });\n      } catch (error) {\n        if (error instanceof Response) {\n          throw error;\n        }\n\n        logger.error('signup_error', { error: transformError(error) });\n        return err('Registration failed', { field: 'general' });\n      }\n    },\n  };\n\n  const result = await handleIntent(formData, handlers);\n\n  if (isError(result)) {\n    // System error\n    if (isSystemError(result)) {\n      logger.error('signup_system_error', { error: flattenError(result) });\n      throwSystemError(result.message, result.status as 503);\n    }\n\n    // User error - show in form\n    return respondError(result);\n  }\n\n  // Success - redirect with session cookie\n  const { redirectTo, sessionCookie } = result as {\n    redirectTo: string;\n    sessionCookie: string;\n  };\n\n  throw respondRedirect(redirectTo, {\n    headers: { 'Set-Cookie': sessionCookie },\n  });\n}\n","import { getContext } from '@ycore/forge/context';\nimport type { IntentHandlers } from '@ycore/forge/intent/server';\nimport { handleIntent } from '@ycore/forge/intent/server';\nimport { logger } from '@ycore/forge/logger';\nimport { err, flattenError, isError, isSystemError, ok, respondError, respondOk, respondRedirect, throwSystemError, validateFormData } from '@ycore/forge/result';\nimport { requireCSRFToken } from '@ycore/foundry/secure/server';\nimport type { RouterContextProvider } from 'react-router';\nimport { minLength, object, pipe, string } from 'valibot';\nimport { defaultAuthRoutes } from '../auth.config';\nimport { authConfigContext } from './auth.context';\nimport { getAuthRepository } from './repository';\nimport { destroyAuthSession, getAuthSession, updateAuthSession } from './session';\nimport { type VerificationPurpose, verifyCode } from './totp-service';\nimport { sendVerificationEmail } from './verification-service';\n\nconst verifyFormSchema = object({\n  email: pipe(string(), minLength(1, 'Email is required')),\n  code: pipe(string(), minLength(6, 'Code must be 6 digits')),\n});\n\nexport interface VerifyLoaderArgs {\n  request: Request;\n  context: Readonly<RouterContextProvider>;\n}\n\nexport interface VerifyActionArgs {\n  request: Request;\n  context: Readonly<RouterContextProvider>;\n}\n\n/**\n * Verify page loader\n * Returns user email and CSRF token\n */\nexport async function verifyLoader({ request, context }: VerifyLoaderArgs) {\n  const token = requireCSRFToken(context);\n  const sessionResult = await getAuthSession(request, context);\n\n  if (isError(sessionResult)) {\n    // System error - session service failure\n    if (isSystemError(sessionResult)) {\n      logger.error('verify_loader_session_error', { error: flattenError(sessionResult) });\n      throwSystemError(sessionResult.message, sessionResult.status as 503);\n    }\n    return respondError(err('Failed to get session'));\n  }\n\n  const session = sessionResult;\n  if (!session || !session.user) {\n    const authConfig = getContext(context, authConfigContext);\n    throw respondRedirect(authConfig?.routes.signin || defaultAuthRoutes.signin);\n  }\n\n  // Determine verification purpose based on pending state\n  let emailToVerify = session.user.email;\n  let purpose: VerificationPurpose = 'signup';\n\n  // Check for pending operations\n  if (session.user.pending?.type === 'email-change') {\n    emailToVerify = session.user.pending.email;\n    purpose = 'email-change';\n\n    logger.info('verify_loader_email_change_detected', { userId: session.user.id, oldEmail: session.user.email, newEmail: emailToVerify });\n  } else if (session.user.pending?.type === 'account-delete') {\n    purpose = 'account-delete';\n\n    logger.info('verify_loader_account_delete_detected', { userId: session.user.id, email: session.user.email });\n  }\n\n  return respondOk({\n    token,\n    email: emailToVerify,\n    status: session.user.status,\n    purpose,\n  });\n}\n\n/**\n * Verify page action\n * Handles code verification and resend using intent-based routing\n */\nexport async function verifyAction({ request, context }: VerifyActionArgs) {\n  const repository = getAuthRepository(context);\n  const authConfig = getContext(context, authConfigContext);\n  const formData = await request.formData();\n  const purpose = (formData.get('purpose')?.toString() as VerificationPurpose) || 'signup';\n\n  // Get session once for all handlers\n  const sessionResult = await getAuthSession(request, context);\n\n  if (isError(sessionResult)) {\n    // System error - session service failure\n    if (isSystemError(sessionResult)) {\n      logger.error('verify_action_session_error', { error: flattenError(sessionResult) });\n      throwSystemError(sessionResult.message, sessionResult.status as 503);\n    }\n    return respondError(err('Failed to get session'));\n  }\n\n  const session = sessionResult;\n  if (!session || !session.user) {\n    return respondError(err('No active session found'));\n  }\n\n  // Define intent handlers\n  const handlers: IntentHandlers = {\n    /**\n     * Resend verification code\n     */\n    resend: async () => {\n      // Determine which email to send to based on purpose\n      let emailToSendTo = session.user.email;\n\n      // For email-change, send to the NEW email from pending change\n      if (purpose === 'email-change' && session.user.pending?.type === 'email-change') {\n        emailToSendTo = session.user.pending.email;\n        logger.info('verify_resend_email_change', {\n          userId: session.user.id,\n          oldEmail: session.user.email,\n          newEmail: emailToSendTo,\n        });\n      }\n\n      // Send the verification email (this handles code generation internally)\n      const sendResult = await sendVerificationEmail({\n        email: emailToSendTo,\n        purpose,\n        context,\n      });\n\n      if (isError(sendResult)) {\n        // System error - email service failure\n        if (isSystemError(sendResult)) {\n          logger.error('verify_resend_email_system_error', { email: emailToSendTo, purpose, error: flattenError(sendResult) });\n        }\n        return sendResult;\n      }\n\n      // Return success to trigger cooldown in UI\n      return ok({ resent: true });\n    },\n\n    /**\n     * Unverify user (set status to unverified)\n     */\n    unverify: async () => {\n      // Update user status to unverified\n      const updateResult = await repository.updateUserStatus(session.user.id, 'unverified');\n\n      if (isError(updateResult)) {\n        // System error - database failure\n        if (isSystemError(updateResult)) {\n          logger.error('verify_unverify_system_error', { userId: session.user.id, error: flattenError(updateResult) });\n        }\n        return updateResult;\n      }\n\n      return ok({ unverified: true });\n    },\n\n    /**\n     * Verify the code\n     */\n    verify: async (formData: FormData) => {\n      // Validate form data\n      const validationResult = await validateFormData(verifyFormSchema, formData);\n      if (isError(validationResult)) {\n        return validationResult; // User error - no logging needed\n      }\n\n      const { email, code } = validationResult;\n\n      // For email-change, email will be the NEW email, not session email\n      // So we skip the session email check for email-change purpose\n      if (purpose !== 'email-change') {\n        // Check session email matches for non-email-change purposes\n        if (session.user.email !== email) {\n          return err('Session mismatch', { email: 'Email does not match session' });\n        }\n      }\n\n      // Verify the code\n      const verifyResult = await verifyCode(email, code, purpose, context);\n\n      if (isError(verifyResult)) {\n        return err(verifyResult.message, { code: verifyResult.message }); // User error\n      }\n\n      const verification = verifyResult;\n\n      // Get user from database\n      // For email-change, use session user ID instead of email lookup\n      // because the email in the form is the NEW email which doesn't exist yet\n      let userResult;\n      if (purpose === 'email-change') {\n        userResult = await repository.getUserById(session.user.id);\n      } else {\n        userResult = await repository.getUserByEmail(email);\n      }\n\n      if (isError(userResult)) {\n        // System error or data inconsistency\n        logger.error('verify_user_not_found', { email, purpose, userId: session.user.id, error: flattenError(userResult) });\n        return err('User not found', undefined, { status: 500 });\n      }\n\n      const user = userResult;\n\n      // Handle different verification purposes\n      switch (purpose) {\n        case 'signup': {\n          // Update user status to active\n          const updateResult = await repository.updateUserStatus(user.id, 'active');\n\n          if (isError(updateResult)) {\n            // System error - database failure\n            if (isSystemError(updateResult)) {\n              logger.error('verify_update_system_error', { userId: user.id, purpose, error: flattenError(updateResult) });\n            }\n            return updateResult;\n          }\n\n          // Update session with active status (important for auth context)\n          const updatedUser = {\n            ...user,\n            status: 'active' as const,\n          };\n\n          const sessionUpdateResult = await updateAuthSession(request, context, { user: updatedUser });\n\n          if (isError(sessionUpdateResult)) {\n            // Log but continue - status was updated in DB\n            logger.warning('verify_session_update_failed', { userId: user.id, error: flattenError(sessionUpdateResult) });\n          }\n\n          // Return redirect info\n          return ok({\n            sessionCookie: isError(sessionUpdateResult) ? undefined : sessionUpdateResult,\n            redirectTo: authConfig?.routes.signedin || defaultAuthRoutes.signedin,\n          });\n        }\n\n        case 'email-change': {\n          // Get pending email change from user.pending field\n          if (!user.pending || user.pending.type !== 'email-change') {\n            logger.error('verify_email_change_no_pending_request', { userId: user.id, email });\n            return err('No pending email change request found. Request may have expired.');\n          }\n\n          const newEmail = user.pending.email;\n          const oldEmail = user.email;\n\n          // Verify the email matches the new email in the pending field\n          if (email !== newEmail) {\n            logger.error('verify_email_change_email_mismatch', {\n              userId: user.id,\n              expectedEmail: newEmail,\n              actualEmail: email,\n            });\n            return err('Email mismatch. Please try again.');\n          }\n\n          // Update user email (repository sets status to 'unverified' by default)\n          const updateResult = await repository.updateUserEmail(user.id, newEmail);\n\n          if (isError(updateResult)) {\n            // System error - database failure\n            if (isSystemError(updateResult)) {\n              logger.error('verify_email_change_update_system_error', { userId: user.id, error: flattenError(updateResult) });\n            }\n            return updateResult;\n          }\n\n          // Set status to 'active' since we just verified the new email\n          const verifyResult = await repository.updateUserStatus(user.id, 'active');\n\n          if (isError(verifyResult)) {\n            // Log but don't fail - email was already updated\n            logger.warning('verify_email_change_status_update_failed', { userId: user.id, error: flattenError(verifyResult) });\n          }\n\n          // Clear pending field\n          const pendingClearResult = await repository.updateUserPending(user.id, null);\n\n          if (isError(pendingClearResult)) {\n            // Log but don't fail\n            logger.warning('verify_email_change_pending_clear_failed', {\n              userId: user.id,\n              error: flattenError(pendingClearResult),\n            });\n          }\n\n          // Update session with new email and status (important for auth context)\n          const updatedUser = {\n            ...user,\n            email: newEmail,\n            status: 'active' as const,\n            pending: null,\n          };\n\n          const sessionUpdateResult = await updateAuthSession(request, context, { user: updatedUser });\n\n          if (isError(sessionUpdateResult)) {\n            // Log but don't fail - email was already updated in DB\n            logger.warning('verify_email_change_session_update_failed', { userId: user.id, error: flattenError(sessionUpdateResult) });\n          }\n\n          logger.info('email_changed_successfully', {\n            userId: user.id,\n            oldEmail,\n            newEmail,\n          });\n\n          // Return redirect info (back to profile page for profile management actions)\n          return ok({\n            sessionCookie: isError(sessionUpdateResult) ? undefined : sessionUpdateResult,\n            redirectTo: authConfig?.routes.profile || defaultAuthRoutes.profile,\n          });\n        }\n\n        case 'recovery': {\n          // User has verified their email for recovery\n          // Redirect to signup page for passkey registration\n          logger.info('recovery_email_verified', { userId: user.id, email });\n\n          return ok({\n            redirectTo: authConfig?.routes.signup || defaultAuthRoutes.signup,\n          });\n        }\n\n        case 'account-delete': {\n          // User has verified their email for account deletion\n          // Check if user has pending account delete\n          if (!user.pending || user.pending.type !== 'account-delete') {\n            logger.error('verify_account_delete_no_pending_request', { userId: user.id, email });\n            return err('No pending account deletion request found. Request may have expired.');\n          }\n\n          // Delete the account (anonymize email, set status to deleted)\n          const deleteResult = await repository.deleteUserAccount(user.id);\n\n          if (isError(deleteResult)) {\n            // System error - database failure\n            if (isSystemError(deleteResult)) {\n              logger.error('verify_account_delete_system_error', { userId: user.id, error: flattenError(deleteResult) });\n            }\n            return deleteResult;\n          }\n\n          logger.info('account_deleted_successfully', {\n            userId: user.id,\n            email,\n          });\n\n          // Destroy session and redirect to signout\n          return ok({\n            redirectTo: authConfig?.routes.signedout || defaultAuthRoutes.signedout,\n            destroySession: true,\n          });\n        }\n\n        case 'passkey-add':\n        case 'passkey-delete': {\n          // These will be handled by their respective action handlers\n          return ok({\n            verified: true,\n            purpose,\n            metadata: verification.metadata,\n          });\n        }\n\n        default: {\n          return err('Unknown verification purpose');\n        }\n      }\n    },\n  };\n\n  // Handle intent\n  const result = await handleIntent(formData, handlers);\n\n  if (isError(result)) {\n    // System error\n    if (isSystemError(result)) {\n      logger.error('verify_system_error', { error: flattenError(result), email: session.user.email });\n      throwSystemError(result.message, result.status as 503);\n    }\n\n    // User error\n    return respondError(result);\n  }\n\n  // Check if result contains redirect info\n  const resultData = result as any;\n  if (resultData.redirectTo) {\n    // Check if session should be destroyed (account deletion)\n    if (resultData.destroySession) {\n      const destroyResult = await destroyAuthSession(request, context);\n\n      // Redirect with session destruction cookie\n      throw respondRedirect(resultData.redirectTo, {\n        headers: { 'Set-Cookie': !isError(destroyResult) ? destroyResult : '' },\n      });\n    }\n\n    // Redirect with optional session cookie\n    throw respondRedirect(resultData.redirectTo, {\n      headers: resultData.sessionCookie ? { 'Set-Cookie': resultData.sessionCookie } : undefined,\n    });\n  }\n\n  // Return data (for resend, unverify operations)\n  return respondOk(result);\n}\n","import { Body, Container, Head, Heading, Html, Section, Text } from '@ycore/componentry/email';\nimport { defineEmailTemplate } from '../../email/@types/email-template-builder';\nimport { TEMPLATE_STYLES_MAP } from './tailwind.styles';\n\nexport interface EmailChangeNotificationData {\n  oldEmail: string;\n  newEmail: string;\n}\n\n/**\n * Email Change Notification Template\n * Sent to the old email address to inform about email change request\n * This is an informational notification, not a verification email\n */\nexport const EmailChangeNotificationTemplate = defineEmailTemplate({\n  component: ({ oldEmail, newEmail }: EmailChangeNotificationData) => (\n    <Html lang=\"en\">\n      <Head />\n      <Body className=\"bg-white font-sans\">\n        <Container className=\"mx-auto max-w-2xl text-foreground leading-relaxed\">\n          <Section className=\"m-5 text-center\">\n            <Heading level={1}>Important security notification</Heading>\n          </Section>\n\n          <Section className=\"m-5 rounded-lg border-2 border-border bg-muted p-5 text-center\">\n            <Text>\n              A request was received to change the account access email from <strong>{oldEmail}</strong> to <strong>{newEmail}</strong>, and is pending approval.\n            </Text>\n            <Text>\n              A verification code was sent to <strong>{newEmail}</strong>.\n            </Text>\n            <Text>The account email will only be changed once the new address is successfully verified.</Text>\n          </Section>\n\n          <Section className=\"m-4 text-center text-muted-foreground text-sm\">\n            <Text>If the email change was not requested, consider that someone may have unauthorized access to the account. It may be necessary to secure the account.</Text>\n            <Heading level={3} className=\"text-destructive\">\n              If unauthorized, take immediate action:\n            </Heading>\n            <Section className=\"mx-auto max-w-md text-left\">\n              <Text className=\"italic\">â¢ Sign in to the account at {oldEmail}</Text>\n              <Text className=\"italic\">â¢ Review the security settings and passkeys</Text>\n              <Text className=\"italic\">â¢ Remove any unfamiliar devices</Text>\n            </Section>\n          </Section>\n        </Container>\n      </Body>\n    </Html>\n  ),\n\n  subject: () => 'Important Security Notification - Email Change Request',\n\n  stylesMap: TEMPLATE_STYLES_MAP,\n});\n","import { Body, Container, Head, Heading, Html, Link, Section, Text } from '@ycore/componentry/email';\nimport { defineEmailTemplate } from '../../email/@types/email-template-builder';\nimport { TEMPLATE_STYLES_MAP } from './tailwind.styles';\n\nexport interface EmailChangeVerificationData {\n  code: string;\n  oldEmail: string;\n  newEmail: string;\n  verificationUrl?: string;\n}\n\n/**\n * Email Change Verification Template\n * Sent to the NEW email address with verification code and email change context\n * Combines notification + verification in a single email\n */\nexport const EmailChangeVerificationTemplate = defineEmailTemplate({\n  component: ({ code, oldEmail, newEmail, verificationUrl }: EmailChangeVerificationData) => (\n    <Html lang=\"en\">\n      <Head />\n      <Body className=\"bg-white font-sans\">\n        <Container className=\"mx-auto max-w-2xl text-foreground leading-relaxed\">\n          <Section className=\"px-5 pt-10 pb-5 text-center\">\n            <Heading level={1}>Email Address Change Verification</Heading>\n          </Section>\n\n          <Section className=\"m-5 rounded-lg border-2 border-border bg-muted p-5 text-center\">\n            <Text>\n              An account email address change from <strong>{oldEmail}</strong> to <strong>{newEmail}</strong> is pending.\n            </Text>\n            <Text>Please approve the email address change using the code below.</Text>\n          </Section>\n\n          <Section className=\"m-5 rounded-lg border-2 border-border bg-muted p-5 text-center\">\n            <Text className=\"m-0 font-bold text-[32px] text-foreground tracking-[8px]\">{code}</Text>\n          </Section>\n\n          <Section className=\"m-3 text-center text-muted-foreground text-sm\">\n            <Text>\n              This code will expire within <strong>8 minutes</strong> if not approved.\n            </Text>\n          </Section>\n\n          {verificationUrl && (\n            <Section className=\"m-4 rounded-2xl bg-muted p-3 text-center\">\n              <Text className=\"mx-2\">\n                <Link href={verificationUrl} className=\"font-bold no-underline\">\n                  Click this link to approve the change\n                </Link>\n              </Text>\n\n              <Text className=\"mx-2\">\n                <Text>If having trouble using the link above, use the url below to verify.</Text>\n                <Link href={verificationUrl} className=\"underline\">\n                  {verificationUrl}\n                </Link>\n              </Text>\n            </Section>\n          )}\n\n          <Section className=\"m-4 text-center text-muted-foreground text-sm\">\n            <Text>If this code was not requested, consider that someone may have unauthorized access to the account. It may be necessary to secure the account.</Text>\n            <Heading level={3} className=\"text-destructive\">\n              If unauthorized, take immediate action:\n            </Heading>\n            <Section className=\"mx-auto max-w-md text-left\">\n              <Text className=\"italic\">\n                â¢ <strong>Do not enter the verification code.</strong>\n              </Text>\n              <Text className=\"italic\">â¢ Sign in to the account at {oldEmail}</Text>\n              <Text className=\"italic\">â¢ Review the security settings and passkeys</Text>\n              <Text className=\"italic\">â¢ Remove any unfamiliar devices</Text>\n            </Section>\n          </Section>\n        </Container>\n      </Body>\n    </Html>\n  ),\n\n  subject: () => 'Email Address Change Verification',\n\n  stylesMap: TEMPLATE_STYLES_MAP,\n});\n","import { logger } from '@ycore/forge/logger';\nimport { err, flattenError, isError, ok, type Result } from '@ycore/forge/result';\nimport { getKVStore, type KVBindings } from '@ycore/forge/services';\nimport type { RouterContextProvider } from 'react-router';\n\nimport { sendMail } from '../../email/server';\nimport { renderEmailTemplate } from '../../email/server/render-email';\nimport { EmailChangeNotificationTemplate } from '../templates/email-change-notification';\nimport { EmailChangeVerificationTemplate } from '../templates/email-change-verification';\nimport { createVerificationCode } from './totp-service';\n\n/**\n * Pending email change request structure\n */\nexport interface PendingEmailChange {\n  userId: string;\n  oldEmail: string;\n  newEmail: string;\n  requestedAt: number;\n}\n\n/**\n * Get KV key for pending email change\n */\nfunction getEmailChangeKey(userId: string): string {\n  return `email_change:${userId}`;\n}\n\n/**\n * Create a pending email change request\n * Stores the request in KV with TTL matching verification code expiry\n */\nexport async function createEmailChangeRequest(\n  userId: string,\n  oldEmail: string,\n  newEmail: string,\n  context: Readonly<RouterContextProvider>,\n  kvBinding: string,\n  expirationTtl = 480 // 8 minutes (matches TOTP expiry)\n): Promise<Result<void>> {\n  try {\n    const kv = getKVStore(context, kvBinding as KVBindings);\n\n    if (!kv) {\n      logger.error('email_change_request_kv_not_found', { userId, kvBinding });\n      return err('KV storage not configured');\n    }\n\n    const pendingChange: PendingEmailChange = {\n      userId,\n      oldEmail,\n      newEmail,\n      requestedAt: Date.now(),\n    };\n\n    await kv.put(getEmailChangeKey(userId), JSON.stringify(pendingChange), {\n      expirationTtl,\n    });\n\n    logger.info('email_change_request_created', {\n      userId,\n      oldEmail,\n      newEmail,\n      expirationTtl,\n    });\n\n    return ok(undefined);\n  } catch (error) {\n    logger.error('email_change_request_creation_failed', {\n      userId,\n      error: error instanceof Error ? error.message : 'Unknown error',\n    });\n    return err('Failed to create email change request', { error });\n  }\n}\n\n/**\n * Get pending email change request for a user\n * Returns null if no pending request exists\n */\nexport async function getEmailChangeRequest(userId: string, context: Readonly<RouterContextProvider>, kvBinding: string): Promise<Result<PendingEmailChange | null>> {\n  try {\n    const kv = getKVStore(context, kvBinding as KVBindings);\n\n    if (!kv) {\n      logger.error('email_change_request_kv_not_found', { userId, kvBinding });\n      return err('KV storage not configured');\n    }\n\n    const value = await kv.get(getEmailChangeKey(userId), 'text');\n\n    if (!value) {\n      return ok(null);\n    }\n\n    const pendingChange = JSON.parse(value) as PendingEmailChange;\n\n    logger.debug('email_change_request_retrieved', {\n      userId,\n      newEmail: pendingChange.newEmail,\n    });\n\n    return ok(pendingChange);\n  } catch (error) {\n    logger.error('email_change_request_retrieval_failed', {\n      userId,\n      error: error instanceof Error ? error.message : 'Unknown error',\n    });\n    return err('Failed to retrieve email change request', { error });\n  }\n}\n\n/**\n * Delete pending email change request\n * Used after successful completion or cancellation\n */\nexport async function deleteEmailChangeRequest(userId: string, context: Readonly<RouterContextProvider>, kvBinding: string): Promise<Result<void>> {\n  try {\n    const kv = getKVStore(context, kvBinding as KVBindings);\n\n    if (!kv) {\n      logger.error('email_change_request_kv_not_found', { userId, kvBinding });\n      return err('KV storage not configured');\n    }\n\n    await kv.delete(getEmailChangeKey(userId));\n\n    logger.info('email_change_request_deleted', { userId });\n\n    return ok(undefined);\n  } catch (error) {\n    logger.error('email_change_request_deletion_failed', {\n      userId,\n      error: error instanceof Error ? error.message : 'Unknown error',\n    });\n    return err('Failed to delete email change request', { error });\n  }\n}\n\n/**\n * Send notification to old email address about email change request\n * Does NOT include a verification code - just informational\n */\nexport async function sendEmailChangeNotification(oldEmail: string, newEmail: string, context: Readonly<RouterContextProvider>): Promise<Result<void>> {\n  try {\n    const emailContent = await renderEmailTemplate(EmailChangeNotificationTemplate, {\n      oldEmail,\n      newEmail,\n    });\n\n    // Send email using centralized service (handles provider setup automatically)\n    const sendResult = await sendMail(context, {\n      to: oldEmail,\n      template: emailContent,\n    });\n\n    if (isError(sendResult)) {\n      logger.error('email_change_notification_send_failed', {\n        oldEmail,\n        newEmail,\n        error: flattenError(sendResult),\n      });\n      return sendResult;\n    }\n\n    logger.info('email_change_notification_sent', { oldEmail, newEmail });\n    return ok(undefined);\n  } catch (error) {\n    logger.error('email_change_notification_unexpected_error', {\n      oldEmail,\n      newEmail,\n      error: error instanceof Error ? error.message : 'Unknown error',\n      stack: error instanceof Error ? error.stack : undefined,\n    });\n    return err('Failed to send email change notification', { error });\n  }\n}\n\n/**\n * Send email change verification email with custom template\n * Generates TOTP code and sends custom email template with email change context\n */\nasync function sendEmailChangeVerification(newEmail: string, oldEmail: string, context: Readonly<RouterContextProvider>, verificationUrl?: string): Promise<Result<void>> {\n  try {\n    // Generate TOTP code\n    const codeResult = await createVerificationCode(newEmail, 'email-change', context, { oldEmail, newEmail });\n\n    if (isError(codeResult)) {\n      logger.error('email_change_verification_code_generation_failed', {\n        newEmail,\n        oldEmail,\n        error: flattenError(codeResult),\n      });\n      return codeResult;\n    }\n\n    const code = codeResult;\n\n    // Create custom email template with code and email change context\n    const emailTemplate = await renderEmailTemplate(EmailChangeVerificationTemplate, {\n      code,\n      oldEmail,\n      newEmail,\n      verificationUrl,\n    });\n\n    // Send email directly using centralized service\n    const sendResult = await sendMail(context, {\n      to: newEmail,\n      template: emailTemplate,\n    });\n\n    if (isError(sendResult)) {\n      logger.error('email_change_verification_send_failed', {\n        newEmail,\n        oldEmail,\n        error: flattenError(sendResult),\n      });\n      return sendResult;\n    }\n\n    logger.info('email_change_verification_sent', { newEmail, oldEmail });\n    return ok(undefined);\n  } catch (error) {\n    logger.error('email_change_verification_unexpected_error', {\n      newEmail,\n      oldEmail,\n      error: error instanceof Error ? error.message : 'Unknown error',\n      stack: error instanceof Error ? error.stack : undefined,\n    });\n    return err('Failed to send email change verification', { error });\n  }\n}\n\n/**\n * Orchestrate complete email change request flow\n * 1. Create pending change in KV\n * 2. Send verification code to new email\n * 3. Send notification to old email\n */\nexport async function requestEmailChange(userId: string, oldEmail: string, newEmail: string, context: Readonly<RouterContextProvider>, kvBinding: string, verificationUrl?: string): Promise<Result<void>> {\n  // Create pending change request\n  const createResult = await createEmailChangeRequest(userId, oldEmail, newEmail, context, kvBinding);\n\n  if (isError(createResult)) {\n    return createResult;\n  }\n\n  // Send verification code to new email with custom template\n  const verificationResult = await sendEmailChangeVerification(newEmail, oldEmail, context, verificationUrl);\n\n  if (isError(verificationResult)) {\n    // Clean up pending request if verification email fails\n    await deleteEmailChangeRequest(userId, context, kvBinding);\n    return verificationResult;\n  }\n\n  // Send notification to old email (non-blocking - don't fail if this fails)\n  const notificationResult = await sendEmailChangeNotification(oldEmail, newEmail, context);\n\n  if (isError(notificationResult)) {\n    // Log warning but don't fail the request\n    logger.warning('email_change_old_email_notification_failed', {\n      userId,\n      oldEmail,\n      newEmail,\n      error: flattenError(notificationResult),\n    });\n  }\n\n  logger.info('email_change_request_completed', { userId, oldEmail, newEmail });\n\n  return ok(undefined);\n}\n","import { getContext } from '@ycore/forge/context';\nimport { logger } from '@ycore/forge/logger';\nimport { err, isError, ok, type Result } from '@ycore/forge/result';\nimport { getKVStore } from '@ycore/forge/services';\nimport type { RouterContextProvider } from 'react-router';\n\nimport type { WebAuthnRegistrationData } from '../@types/auth.types';\nimport type { Authenticator } from '../schema';\nimport { authConfigContext } from './auth.context';\nimport { getAuthRepository } from './repository';\nimport { getAuthSession } from './session';\nimport { createRegistrationOptions, generateChallenge, verifyRegistration } from './webauthn';\nimport { resolveRpId } from './webauthn-config';\n\nconst MAX_AUTHENTICATORS_PER_USER = 10;\nconst MIN_AUTHENTICATORS_PER_USER = 1;\n\n/**\n * Add a new passkey for an existing authenticated user\n *\n * @param context - Router context provider\n * @param userId - User ID to associate the passkey with\n * @param credential - WebAuthn registration credential data\n * @param challenge - The challenge used for registration\n * @param origin - The validated origin (should come from validateWebAuthnOrigin)\n * @param request - Request object for rpId resolution\n */\nexport async function addPasskeyForUser(context: Readonly<RouterContextProvider>, userId: string, credential: WebAuthnRegistrationData, challenge: string, origin: string, request: Request): Promise<Result<Authenticator>> {\n  const repo = getAuthRepository(context);\n  const authConfig = getContext(context, authConfigContext);\n\n  if (!authConfig) {\n    return err('Auth configuration not found', { field: 'general' });\n  }\n\n  // Resolve rpId from context/request (always use resolveRpId for consistency)\n  const rpId = resolveRpId(context, request);\n\n  // Get metadata KV from config (follows CSRF pattern)\n  const metadataKV = authConfig.webauthn.kvBinding ? getKVStore(context, authConfig.webauthn.kvBinding) : undefined;\n\n  // Check current authenticator count\n  const countResult = await repo.countAuthenticatorsByUserId(userId);\n  if (isError(countResult)) {\n    return countResult;\n  }\n\n  if (countResult >= MAX_AUTHENTICATORS_PER_USER) {\n    logger.warning('passkey_add_max_reached', { userId, count: countResult });\n    return err('Maximum number of authenticators reached', {\n      limit: `You can have a maximum of ${MAX_AUTHENTICATORS_PER_USER} authenticators`,\n    });\n  }\n\n  // Verify the registration\n  const verificationResult = await verifyRegistration(credential, challenge, origin, rpId, metadataKV);\n\n  if (isError(verificationResult)) {\n    logger.error('passkey_add_verification_failed', { userId, error: verificationResult });\n    return verificationResult;\n  }\n\n  // Create the new authenticator\n  const createResult = await repo.createAuthenticator({ ...verificationResult, userId });\n\n  if (isError(createResult)) {\n    logger.error('passkey_add_create_failed', { userId, error: createResult });\n    return createResult;\n  }\n\n  return ok(createResult);\n}\n\n/**\n * Rename an existing passkey\n */\nexport async function renamePasskey(context: Readonly<RouterContextProvider>, userId: string, authenticatorId: string, newName: string): Promise<Result<Authenticator>> {\n  const repo = getAuthRepository(context);\n\n  // Verify ownership\n  const ownershipResult = await repo.authenticatorBelongsToUser(authenticatorId, userId);\n  if (isError(ownershipResult)) {\n    logger.error('passkey_rename_ownership_check_failed', { userId, authenticatorId, error: ownershipResult });\n    return ownershipResult;\n  }\n\n  if (!ownershipResult) {\n    logger.warning('passkey_rename_unauthorized', { userId, authenticatorId });\n    return err('Authenticator not found or unauthorized', {\n      authenticator: 'You do not have permission to modify this authenticator',\n    });\n  }\n\n  // Validate name\n  const trimmedName = newName.trim();\n  if (trimmedName.length < 1 || trimmedName.length > 50) {\n    return err('Invalid authenticator name', {\n      name: 'Name must be between 1 and 50 characters',\n    });\n  }\n\n  // Update the name\n  const updateResult = await repo.updateAuthenticatorName(authenticatorId, trimmedName);\n  if (isError(updateResult)) {\n    logger.error('passkey_rename_failed', { userId, authenticatorId, error: updateResult });\n    return updateResult;\n  }\n\n  return ok(updateResult);\n}\n\n/**\n * Delete a passkey (with minimum authenticator enforcement)\n */\nexport async function deletePasskey(context: Readonly<RouterContextProvider>, userId: string, authenticatorId: string): Promise<Result<boolean>> {\n  const repo = getAuthRepository(context);\n\n  // Verify ownership\n  const ownershipResult = await repo.authenticatorBelongsToUser(authenticatorId, userId);\n  if (isError(ownershipResult)) {\n    logger.error('passkey_delete_ownership_check_failed', { userId, authenticatorId, error: ownershipResult });\n    return ownershipResult;\n  }\n\n  if (!ownershipResult) {\n    logger.warning('passkey_delete_unauthorized', { userId, authenticatorId });\n    return err('Authenticator not found or unauthorized', {\n      authenticator: 'You do not have permission to delete this authenticator',\n    });\n  }\n\n  // Check if user would have minimum authenticators after deletion\n  const countResult = await repo.countAuthenticatorsByUserId(userId);\n  if (isError(countResult)) {\n    logger.error('passkey_delete_count_failed', { userId, error: countResult });\n    return countResult;\n  }\n\n  if (countResult <= MIN_AUTHENTICATORS_PER_USER) {\n    logger.warning('passkey_delete_minimum_required', { userId, count: countResult });\n    return err('Cannot delete last authenticator', {\n      authenticator: 'You must have at least one authenticator for security',\n    });\n  }\n\n  // Delete the authenticator\n  const deleteResult = await repo.deleteAuthenticator(authenticatorId);\n  if (isError(deleteResult)) {\n    logger.error('passkey_delete_failed', { userId, authenticatorId, error: deleteResult });\n    return deleteResult;\n  }\n\n  return ok(true);\n}\n\n/**\n * Generate registration options for adding a new passkey\n */\nexport async function generateAddPasskeyOptions(\n  context: Readonly<RouterContextProvider>,\n  request: Request,\n  userId: string,\n  rpName: string,\n  rpId: string\n): Promise<Result<{ challenge: string; options: PublicKeyCredentialCreationOptions }>> {\n  const repo = getAuthRepository(context);\n  const authSession = await getAuthSession(request, context);\n\n  if (isError(authSession)) {\n    return authSession;\n  }\n\n  if (!authSession || !authSession.user) {\n    return err('User not authenticated', { user: 'Session does not contain user data' });\n  }\n\n  const session = authSession;\n\n  // Get existing authenticators to exclude\n  const existingAuthsResult = await repo.getAuthenticatorsByUserId(userId);\n  if (isError(existingAuthsResult)) {\n    logger.error('passkey_options_get_existing_failed', { userId, error: existingAuthsResult });\n    return existingAuthsResult;\n  }\n\n  // Map to include both ID and transports for proper exclusion\n  const excludeCredentials = existingAuthsResult.map((auth: Authenticator) => ({ id: auth.id, transports: auth.transports as AuthenticatorTransport[] }));\n  const challenge = generateChallenge();\n  const options = createRegistrationOptions(rpName, rpId, session.user.email, session.user.displayName, challenge, excludeCredentials);\n\n  return ok({ challenge, options });\n}\n","import { decodeBase64url } from '@oslojs/encoding';\n\n/**\n * Helper function to convert serialized ArrayBuffer back to ArrayBuffer\n *\n * Handles multiple input formats:\n * - Native ArrayBuffer (passthrough)\n * - Serialized object format: {\"0\": byte, \"1\": byte, ...}\n * - Base64url encoded string\n */\nexport function arrayBufferFromObject(obj: any): ArrayBuffer {\n  if (obj instanceof ArrayBuffer) {\n    return obj;\n  }\n\n  // Handle serialized ArrayBuffer format: {\"0\": byte, \"1\": byte, ...}\n  if (typeof obj === 'object' && obj !== null) {\n    const keys = Object.keys(obj);\n    // Check if it looks like a serialized ArrayBuffer (numeric keys)\n    if (keys.length > 0 && keys.every(key => /^\\d+$/.test(key))) {\n      const bytes = Object.values(obj) as number[];\n      const uint8Array = new Uint8Array(bytes);\n      // Create a new ArrayBuffer and copy the data to ensure it's an ArrayBuffer, not SharedArrayBuffer\n      const buffer = new ArrayBuffer(uint8Array.length);\n      new Uint8Array(buffer).set(uint8Array);\n      return buffer;\n    }\n  }\n\n  // If it's a string, assume it's base64url encoded\n  if (typeof obj === 'string') {\n    const uint8Array = decodeBase64url(obj);\n    const buffer = new ArrayBuffer(uint8Array.length);\n    new Uint8Array(buffer).set(uint8Array);\n    return buffer;\n  }\n\n  // If conversion fails, create empty buffer (will handle below)\n  return new ArrayBuffer(0);\n}\n\n/**\n * Convert server-generated WebAuthn options to browser-compatible format\n *\n * Key transformations:\n * - Reconstructs ArrayBuffer from base64url challenge string\n * - Converts user.id from serialized to ArrayBuffer\n * - Processes excludeCredentials with proper ArrayBuffer IDs\n */\nexport function convertServerOptionsToWebAuthn(serverOptions: any, challengeString: string): PublicKeyCredentialCreationOptions {\n  // Use the challenge string from the response root, not from options\n  const challengeUint8Array = decodeBase64url(challengeString);\n  const challengeBuffer = new ArrayBuffer(challengeUint8Array.length);\n  new Uint8Array(challengeBuffer).set(challengeUint8Array);\n\n  return {\n    ...serverOptions,\n    challenge: challengeBuffer,\n    user: {\n      ...serverOptions.user,\n      id: arrayBufferFromObject(serverOptions.user.id),\n    },\n    excludeCredentials:\n      serverOptions.excludeCredentials?.map((cred: any) => ({\n        ...cred,\n        id: arrayBufferFromObject(cred.id),\n      })) || [],\n  };\n}\n\n/**\n * Convert WebAuthn credential from browser to server-compatible format\n *\n * Transforms credential data from browser's binary ArrayBuffer format\n * into a JSON-serializable format suitable for server processing and\n * database storage.\n */\nexport function convertWebAuthnCredentialToStorage(credential: {\n  id: string;\n  rawId: string;\n  response: {\n    attestationObject: string;\n    clientDataJSON: string;\n    transports?: string[];\n  };\n  authenticatorAttachment?: string | null;\n}): {\n  id: string;\n  rawId: ArrayBufferLike;\n  response: {\n    attestationObject: ArrayBufferLike;\n    clientDataJSON: ArrayBufferLike;\n    transports?: AuthenticatorTransport[];\n  };\n  type: 'public-key';\n  authenticatorAttachment?: AuthenticatorAttachment | null;\n} {\n  // Convert base64url strings to ArrayBuffers\n  const rawIdUint8Array = decodeBase64url(credential.rawId);\n  const rawIdBuffer = new ArrayBuffer(rawIdUint8Array.length);\n  new Uint8Array(rawIdBuffer).set(rawIdUint8Array);\n\n  const attestationUint8Array = decodeBase64url(credential.response.attestationObject);\n  const attestationBuffer = new ArrayBuffer(attestationUint8Array.length);\n  new Uint8Array(attestationBuffer).set(attestationUint8Array);\n\n  const clientDataUint8Array = decodeBase64url(credential.response.clientDataJSON);\n  const clientDataBuffer = new ArrayBuffer(clientDataUint8Array.length);\n  new Uint8Array(clientDataBuffer).set(clientDataUint8Array);\n\n  return {\n    id: credential.id,\n    rawId: rawIdBuffer as ArrayBufferLike,\n    response: {\n      attestationObject: attestationBuffer as ArrayBufferLike,\n      clientDataJSON: clientDataBuffer as ArrayBufferLike,\n      transports: credential.response?.transports as AuthenticatorTransport[] | undefined,\n    },\n    type: 'public-key' as const,\n    authenticatorAttachment: credential.authenticatorAttachment as AuthenticatorAttachment | null | undefined,\n  };\n}\n"],"names":["email","sql","_a","formData","result","WebAuthnErrorCode","deviceInfo","redirectTo","authenticators","verificationResult","verifyResult"],"mappings":";;;;;;;;;;;;;;;;;;;;AAOO,MAAM,oBAAoB,cAAiC,IAAI;AAE/D,MAAM,kBAAkB,cAA2B,IAAI;AAgBvD,SAAS,gBAAgB,SAA+B;AAC7D,QAAM,OAAO,eAAe,SAAS,iBAAiB;AAAA,IACpD,cAAc;AAAA,IACd,aAAa;AAAA,EAAA,CACd;AAED,SAAO;AACT;AAgBO,SAAS,YAAY,SAAsC;AAChE,SAAO,WAAW,SAAS,iBAAiB,IAAI;AAClD;AAgBO,SAAS,gBAAgB,SAAkC;AAChE,SAAO,WAAW,SAAS,iBAAiB,IAAI,MAAM;AACxD;AClEO,MAAM,oBAAgC;AAAA,EAC3C,QAAQ;AAAA,EACR,QAAQ;AAAA,EACR,SAAS;AAAA,EACT,UAAU;AAAA,EACV,WAAW;AAAA,EACX,SAAS;AAAA,EACT,QAAQ;AAAA,EACR,SAAS;AACX;AAEO,MAAM,oBAAgC;AAAA,EAE3C,SAAS;AAAA,IAGP,QAAQ;AAAA,MACN,MAAM;AAAA,IAMR;AAAA,EAAA;AAcJ;ACvCA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAaA,SAAS,8BAA8B;AAAA,EACrC;AAAA,EACA;AACF,GAAG;AACD,SAAO,qBAAqB;AAAA,IAC1B;AAAA,IACA,MAAM,WAAW,MAAM,SAAS;AAC9B,aAAO,MAAM;AACX,YAAI,cAAc,OAAO,gBAAgB,IAAI,WAAW,CAAC,CAAC;AAC1D,YAAI,KAAK,CAAC,GAAG,WAAW,EAAE,IAAI,CAAC,MAAM,EAAE,SAAS,EAAE,EAAE,SAAS,GAAG,GAAG,CAAC,EAAE,KAAK,EAAE;AAC7E,YAAI,MAAM,GAAG,IAAI,IAAI,MAAM,GAAG;AAC5B;AAAA,QACF;AACA,cAAM,GAAG,IAAI,IAAI,KAAK,UAAU,IAAI,GAAG;AAAA,UACrC,YAAY,UAAU,KAAK,MAAM,QAAQ,QAAA,IAAY,GAAG,IAAI;AAAA,QAAA,CAC7D;AACD,eAAO;AAAA,MACT;AAAA,IACF;AAAA,IACA,MAAM,SAAS,IAAI;AACjB,UAAI,UAAU,MAAM,GAAG,IAAI,EAAE;AAC7B,UAAI,CAAC,SAAS;AACZ,eAAO;AAAA,MACT;AACA,aAAO,KAAK,MAAM,OAAO;AAAA,IAC3B;AAAA,IACA,MAAM,WAAW,IAAI,MAAM,SAAS;AAClC,YAAM,GAAG,IAAI,IAAI,KAAK,UAAU,IAAI,GAAG;AAAA,QACrC,YAAY,UAAU,KAAK,MAAM,QAAQ,QAAA,IAAY,GAAG,IAAI;AAAA,MAAA,CAC7D;AAAA,IACH;AAAA,IACA,MAAM,WAAW,IAAI;AACnB,YAAM,GAAG,OAAO,EAAE;AAAA,IACpB;AAAA,EAAA,CACD;AACH;ACtCA,MAAM,sBAAsB,CAACA,WAA0B,aAAaA,MAAK;AACzE,MAAM,4BAA4B,CAAC,cAA8B,oBAAoB,SAAS;AAM9F,SAAS,oBAAoB,SAA+E;AAC1G,QAAM,aAAa,WAAW,SAAS,iBAAiB;AACxD,MAAI,CAAC,YAAY;AACf,UAAM,IAAI,MAAM,yFAAyF;AAAA,EAC3G;AAEA,QAAM,EAAE,YAAY;AAGpB,MAAI,QAAQ,cAAc,cAAc;AACtC,UAAM,IAAI,MAAM,0FAA0F;AAAA,EAC5G;AACA,MAAI,QAAQ,cAAc,cAAc;AACtC,UAAM,IAAI,MAAM,0FAA0F;AAAA,EAC5G;AAEA,QAAM,WAAW,YAAY,OAAO;AAEpC,QAAM,SAAS,SAAS,QAAQ,SAAkC;AAClE,MAAI,CAAC,QAAQ;AACX,UAAM,IAAI,MAAM,wBAAwB,QAAQ,SAAS,mDAAwD,OAAO,KAAK,QAAQ,EAAE,KAAK,IAAI,CAAC,EAAE;AAAA,EACrJ;AAEA,QAAM,KAAK,WAAW,SAAS,QAAQ,SAAS;AAChD,MAAI,CAAC,IAAI;AACP,UAAM,IAAI,MAAM,eAAe,QAAQ,SAAS,2BAA2B;AAAA,EAC7E;AAEA,SAAO,EAAE,QAAQ,GAAA;AACnB;AAEO,SAAS,yBAAyB,SAA0C;AACjF,QAAM,aAAa,WAAW,SAAS,iBAAiB;AACxD,MAAI,CAAC,YAAY;AACf,UAAM,IAAI,MAAM,yFAAyF;AAAA,EAC3G;AAEA,QAAM,EAAE,QAAQ,OAAO,oBAAoB,OAAO;AAClD,QAAM,EAAE,YAAY;AAEpB,SAAO,8BAA6D;AAAA,IAClE;AAAA,IACA,QAAQ;AAAA,MACN,MAAM,QAAQ,OAAO;AAAA,MACrB,UAAU,QAAQ,OAAO;AAAA,MACzB,QAAQ,QAAQ,OAAO;AAAA,MACvB,MAAM,QAAQ,OAAO;AAAA,MACrB,UAAU,QAAQ,OAAO;AAAA,MACzB,SAAS,CAAC,MAAM;AAAA,MAChB,QAAQ,QAAQ,OAAO,WAAW,SAAS,aAAa,OAAO,IAAK,QAAQ,OAAO,UAAU;AAAA,IAAA;AAAA,EAC/F,CACD;AACH;AAKA,eAAsB,eAAe,SAAkB,SAA+E;AACpI,MAAI;AACF,UAAM,iBAAiB,yBAAyB,OAAO;AACvD,UAAM,UAAU,MAAM,eAAe,WAAW,QAAQ,QAAQ,IAAI,QAAQ,CAAC;AAE7E,UAAM,OAAO,QAAQ,IAAI,MAAM;AAC/B,UAAM,YAAY,QAAQ,IAAI,WAAW;AAEzC,QAAI,CAAC,MAAM;AACT,aAAO,GAAG,IAAI;AAAA,IAChB;AAEA,WAAO,GAAG,EAAE,MAAM,WAAW;AAAA,EAC/B,SAAS,OAAO;AACd,WAAO,IAAI,yBAAyB,EAAE,OAAO;AAAA,EAC/C;AACF;AAKA,eAAsB,0BAA0B,WAAmB,SAAoE;AACrI,MAAI;AACF,UAAM,EAAE,GAAA,IAAO,oBAAoB,OAAO;AAE1C,UAAM,YAAY,0BAA0B,SAAS;AACrD,UAAM,WAAW,MAAM,GAAG,IAAI,SAAS;AAEvC,QAAI,UAAU;AACZ,aAAO,IAAI,0BAA0B,EAAE,WAAW;AAAA,IACpD;AAGA,UAAM,GAAG,IAAI,WAAW,QAAQ,EAAE,eAAe,KAAK;AACtD,WAAO,GAAG,IAAI;AAAA,EAChB,SAAS,OAAO;AACd,WAAO,IAAI,yCAAyC,EAAE,WAAW,OAAO;AAAA,EAC1E;AACF;AAKA,eAAsB,wBAAwBA,QAAe,SAAiE;AAC5H,MAAI;AACF,UAAM,EAAE,GAAA,IAAO,oBAAoB,OAAO;AAE1C,UAAM,eAAe,oBAAoBA,MAAK;AAC9C,UAAM,GAAG,OAAO,YAAY;AAE5B,WAAO,GAAG,MAAS;AAAA,EACrB,SAAS,OAAO;AACd,WAAO,IAAI,uCAAuC,EAAE,OAAAA,QAAO,OAAO;AAAA,EACpE;AACF;AAmBA,eAAsB,uBAAuB,SAA0C,WAA4C;AACjI,MAAI;AACF,UAAM,iBAAiB,yBAAyB,OAAO;AACvD,UAAM,UAAU,MAAM,eAAe,WAAA;AAErC,YAAQ,IAAI,aAAa,SAAS;AAClC,YAAQ,IAAI,sBAAsB,KAAK,IAAA,CAAK;AAE5C,UAAM,SAAS,MAAM,eAAe,cAAc,OAAO;AACzD,WAAO,GAAG,MAAM;AAAA,EAClB,SAAS,OAAO;AACd,WAAO,IAAI,sCAAsC,EAAE,OAAO;AAAA,EAC5D;AACF;AAkBA,eAAsB,wBAAwB,SAAkB,SAA+J;AAC7N,MAAI;AACF,UAAM,iBAAiB,yBAAyB,OAAO;AACvD,UAAM,UAAU,MAAM,eAAe,WAAW,QAAQ,QAAQ,IAAI,QAAQ,CAAC;AAC7E,UAAM,kBAAkB,QAAQ,IAAI,WAAW;AAC/C,UAAM,qBAAqB,QAAQ,IAAI,oBAAoB;AAE3D,QAAI,CAAC,mBAAmB,CAAC,oBAAoB;AAC3C,aAAO,IAAI,kDAAkD,EAAE,OAAO,WAAW;AAAA,IACnF;AAEA,WAAO,GAAG,EAAE,WAAW,iBAAiB,oBAAoB,SAAS;AAAA,EACvE,SAAS,OAAO;AACd,WAAO,IAAI,wCAAwC,EAAE,OAAO;AAAA,EAC9D;AACF;AAiBA,eAAsB,wBAAwB,SAAiD,SAAiE;AAC9J,MAAI;AACF,UAAM,iBAAiB,yBAAyB,OAAO;AACvD,UAAM,eAAe,eAAe,OAAO;AAC3C,WAAO,GAAG,MAAS;AAAA,EACrB,SAAS,OAAO;AACd,WAAO,IAAI,uCAAuC,EAAE,OAAO;AAAA,EAC7D;AACF;AAKA,eAAsB,kBAAkB,SAA0C,aAAmD;AACnI,MAAI;AACF,UAAM,iBAAiB,yBAAyB,OAAO;AAIvD,UAAM,aAAa,MAAM,eAAe,WAAA;AAExC,eAAW,IAAI,QAAQ,YAAY,IAAI;AACvC,eAAW,IAAI,mBAAmB,KAAK,IAAA,CAAK;AAE5C,UAAM,SAAS,MAAM,eAAe,cAAc,UAAU;AAC5D,WAAO,GAAG,MAAM;AAAA,EAClB,SAAS,OAAO;AACd,WAAO,IAAI,4BAA4B,EAAE,OAAO;AAAA,EAClD;AACF;AAMA,eAAsB,kBAAkB,SAAkB,SAA0C,aAA4D;AAC9J,MAAI;AACF,UAAM,iBAAiB,yBAAyB,OAAO;AACvD,UAAM,UAAU,MAAM,eAAe,WAAW,QAAQ,QAAQ,IAAI,QAAQ,CAAC;AAG7E,QAAI,YAAY,MAAM;AACpB,cAAQ,IAAI,QAAQ,YAAY,IAAI;AAAA,IACtC;AAIA,QAAI,YAAY,cAAc,QAAW;AACvC,cAAQ,IAAI,aAAa,YAAY,SAAS;AAAA,IAChD;AAEA,UAAM,SAAS,MAAM,eAAe,cAAc,OAAO;AACzD,WAAO,GAAG,MAAM;AAAA,EAClB,SAAS,OAAO;AACd,WAAO,IAAI,4BAA4B,EAAE,OAAO;AAAA,EAClD;AACF;AAKA,eAAsB,mBAAmB,SAAkB,SAAmE;AAC5H,MAAI;AACF,UAAM,iBAAiB,yBAAyB,OAAO;AACvD,UAAM,UAAU,MAAM,eAAe,WAAW,QAAQ,QAAQ,IAAI,QAAQ,CAAC;AAG7E,UAAMA,SAAQ,QAAQ,IAAI,OAAO;AACjC,QAAIA,QAAO;AACT,YAAM,wBAAwBA,QAAO,OAAO;AAAA,IAC9C;AAGA,UAAM,SAAS,MAAM,eAAe,eAAe,OAAO;AAC1D,WAAO,GAAG,MAAM;AAAA,EAClB,SAAS,OAAO;AACd,WAAO,IAAI,6BAA6B,EAAE,OAAO;AAAA,EACnD;AACF;AClRO,SAAS,sBAAsB,YAAsD;AAC1F,SAAO,OAAO,EAAE,SAAS,QAAA,GAAW,SAAS;AAE3C,eAAW,SAAS,mBAAmB,UAAU;AAGjD,UAAM,cAAc,MAAM,eAAe,SAAS,OAAO;AAIzD,QAAI,CAAC,QAAQ,WAAW,KAAK,gBAAgB,QAAQ,YAAY,MAAM;AACrE,UAAI,YAAY,KAAK,WAAW,UAAU;AACxC,mBAAW,SAAS,iBAAiB,YAAY,IAAI;AAAA,MACvD;AACA,aAAO,KAAA;AAAA,IACT;AAGA,UAAM,eAAe,QAAQ,QAAQ,IAAI,QAAQ;AACjD,UAAM,oBAAoB,YAAY,QAAQ,OAAO,QAAQ,kBAAkB,QAAQ,OAAO;AAC9F,QAAI,cAAc,SAAS,iBAAiB,GAAG;AAE7C,YAAM,iBAAiB,yBAAyB,OAAO;AACvD,YAAM,UAAU,MAAM,eAAe,WAAW,YAAY;AAG5D,YAAM,UAAU,QAAQ,IAAI,MAAM;AAClC,YAAM,eAAe,QAAQ,IAAI,WAAW;AAE5C,UAAI,CAAC,WAAW,CAAC,cAAc;AAE7B,cAAM,gBAAgB,MAAM,mBAAmB,SAAS,OAAO;AAE/D,YAAI,CAAC,QAAQ,aAAa,GAAG;AAC3B,gBAAM,WAAW,MAAM,KAAA;AACvB,iBAAO,sBAAsB,UAAU,EAAE,KAAK,EAAE,cAAc,cAAA,GAAiB;AAAA,QACjF;AAAA,MACF;AAAA,IACF;AAEA,WAAO,KAAA;AAAA,EACT;AACF;AASO,SAAS,wBAAwB,YAAwD;AAC9F,SAAO,CAAC,sBAAsB,UAAU,GAAG,0BAA0B,UAAU,CAAC;AAClF;AAQO,SAAS,sBAAsB,YAAwD;AAC5F,SAAO,CAAC,sBAAsB,UAAU,GAAG,wBAAwB,UAAU,CAAC;AAChF;AAUO,SAAS,sBAAsB,YAAwD;AAC5F,SAAO,CAAC,sBAAsB,UAAU,GAAG,qBAAqB,UAAU,CAAC;AAC7E;AAMA,SAAS,qBAAqB,YAAsD;AAClF,SAAO,OAAO,EAAE,SAAS,QAAA,GAAW,SAAS;AAE3C,UAAM,OAAO,YAAY,OAAO;AAChC,QAAI,MAAM;AACR,YAAM,SAAS,YAAY,OAAO,YAAY,kBAAkB,QAAQ;AAAA,IAC1E;AAGA,UAAM,gBAAgB,MAAM,eAAe,SAAS,OAAO;AAC3D,QAAI,QAAQ,aAAa,KAAK,CAAC,eAAe,MAAM;AAClD,YAAM,SAAS,YAAY,OAAO,UAAU,kBAAkB,MAAM;AAAA,IACtE;AAGA,WAAO,KAAA;AAAA,EACT;AACF;AASA,SAAS,wBAAwB,YAAsD;AACrF,SAAO,OAAO,EAAE,QAAA,GAAW,SAAS;AAClC,UAAM,OAAO,YAAY,OAAO;AAChC,QAAI,CAAC,MAAM;AACT,YAAM,SAAS,YAAY,OAAO,aAAa,kBAAkB,SAAS;AAAA,IAC5E;AAEA,WAAO,KAAA;AAAA,EACT;AACF;AAQA,SAAS,0BAA0B,YAAsD;AACvF,SAAO,OAAO,EAAE,SAAS,QAAA,GAAW,SAAS;AAE3C,UAAM,OAAO,YAAY,OAAO;AAChC,QAAI,MAAM;AACR,YAAM,SAAS,YAAY,OAAO,YAAY,kBAAkB,QAAQ;AAAA,IAC1E;AAGA,UAAM,gBAAgB,MAAM,eAAe,SAAS,OAAO;AAC3D,QAAI,CAAC,QAAQ,aAAa,KAAK,eAAe,QAAQ,cAAc,KAAK,WAAW,UAAU;AAC5F,aAAO,KAAK,yCAAyC;AAAA,QACnD,QAAQ,cAAc,KAAK;AAAA,QAC3B,OAAO,cAAc,KAAK;AAAA,QAC1B,QAAQ,cAAc,KAAK;AAAA,MAAA,CAC5B;AACD,YAAM,SAAS,YAAY,OAAO,UAAU,kBAAkB,MAAM;AAAA,IACtE;AAEA,WAAO,KAAA;AAAA,EACT;AACF;AC5JA,MAAM,aAAa,KAAK,OAAA,GAAU,SAAS,0BAA0B,GAAG,MAAM,6BAA6B,GAAG,UAAU,KAAK,8BAA8B,CAAC;AAG5J,MAAM,mBAAmB,KAAK,OAAA,GAAU,SAAS,0BAA0B,GAAG,UAAU,GAAG,0BAA0B,CAAC;AAE/G,MAAM,iBAAiB,OAAO,EAAE,OAAO,YAAY;AAEnD,MAAM,mBAAmB,OAAO,EAAE,OAAO,YAAY,aAAa,kBAAkB;AAEpF,MAAM,mBAAmB,OAAO,EAAE,OAAO,YAAY;AAErD,MAAM,oBAAoB,OAAO,EAAE,UAAU,YAAY;ACdhE,MAAM,aAAa,OAAO,IAAI,oBAAoB;AAElD,SAAS,GAAG,OAAO,MAAM;AACvB,MAAI,CAAC,SAAS,OAAO,UAAU,UAAU;AACvC,WAAO;AAAA,EACT;AACA,MAAI,iBAAiB,MAAM;AACzB,WAAO;AAAA,EACT;AACA,MAAI,CAAC,OAAO,UAAU,eAAe,KAAK,MAAM,UAAU,GAAG;AAC3D,UAAM,IAAI;AAAA,MACR,UAAU,KAAK,QAAQ,WAAW;AAAA,IACxC;AAAA,EACE;AACA,MAAI,MAAM,OAAO,eAAe,KAAK,EAAE;AACvC,MAAI,KAAK;AACP,WAAO,KAAK;AACV,UAAI,cAAc,OAAO,IAAI,UAAU,MAAM,KAAK,UAAU,GAAG;AAC7D,eAAO;AAAA,MACT;AACA,YAAM,OAAO,eAAe,GAAG;AAAA,IACjC;AAAA,EACF;AACA,SAAO;AACT;ACHU;AApBV,MAAM,OAAO;AAAA,EACX,YAAY,OAAO,QAAQ;AAoB3B;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAnCE,SAAK,QAAQ;AACb,SAAK,SAAS;AACd,SAAK,OAAO,OAAO;AACnB,SAAK,YAAY,OAAO;AACxB,SAAK,UAAU,OAAO;AACtB,SAAK,UAAU,OAAO;AACtB,SAAK,YAAY,OAAO;AACxB,SAAK,aAAa,OAAO;AACzB,SAAK,aAAa,OAAO;AACzB,SAAK,UAAU,OAAO;AACtB,SAAK,WAAW,OAAO;AACvB,SAAK,aAAa,OAAO;AACzB,SAAK,aAAa,OAAO;AACzB,SAAK,WAAW,OAAO;AACvB,SAAK,aAAa,OAAO;AACzB,SAAK,YAAY,OAAO;AACxB,SAAK,oBAAoB,OAAO;AAAA,EAClC;AAAA,EAmBA,mBAAmB,OAAO;AACxB,WAAO;AAAA,EACT;AAAA,EACA,iBAAiB,OAAO;AACtB,WAAO;AAAA,EACT;AAAA;AAAA,EAEA,sBAAsB;AACpB,WAAO,KAAK,OAAO,cAAc,UAAU,KAAK,OAAO,UAAU,SAAS;AAAA,EAC5E;AACF;AA5BE,cApBI,QAoBI,IAAc;ACnBd;AADV,MAAM,cAAc;AAAA,EAGlB,YAAY,MAAM,UAAU,YAAY;AADxC;AAkEA;AAAA;AAAA;AAAA,oCAAW,KAAK;AAgBhB;AAAA;AAAA;AAAA,qCAAY,KAAK;AAhFf,SAAK,SAAS;AAAA,MACZ;AAAA,MACA,WAAW,SAAS;AAAA,MACpB,SAAS;AAAA,MACT,SAAS;AAAA,MACT,YAAY;AAAA,MACZ,YAAY;AAAA,MACZ,UAAU;AAAA,MACV,YAAY;AAAA,MACZ,YAAY;AAAA,MACZ;AAAA,MACA;AAAA,MACA,WAAW;AAAA,IACjB;AAAA,EACE;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAYA,QAAQ;AACN,WAAO;AAAA,EACT;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAMA,UAAU;AACR,SAAK,OAAO,UAAU;AACtB,WAAO;AAAA,EACT;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAQA,QAAQ,OAAO;AACb,SAAK,OAAO,UAAU;AACtB,SAAK,OAAO,aAAa;AACzB,WAAO;AAAA,EACT;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAOA,WAAW,IAAI;AACb,SAAK,OAAO,YAAY;AACxB,SAAK,OAAO,aAAa;AACzB,WAAO;AAAA,EACT;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAYA,YAAY,IAAI;AACd,SAAK,OAAO,aAAa;AACzB,SAAK,OAAO,aAAa;AACzB,WAAO;AAAA,EACT;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAUA,aAAa;AACX,SAAK,OAAO,aAAa;AACzB,SAAK,OAAO,UAAU;AACtB,WAAO;AAAA,EACT;AAAA;AAAA,EAEA,QAAQ,MAAM;AACZ,QAAI,KAAK,OAAO,SAAS,GAAI;AAC7B,SAAK,OAAO,OAAO;AAAA,EACrB;AACF;AAnGE,cADI,eACI,IAAc;ACFxB,MAAM,YAAY,OAAO,IAAI,cAAc;AC4B3C,MAAM,cAAc,OAAO,IAAI,kBAAkB;AACjD,SAAS,SAAS,KAAK;AACrB,SAAO,CAAC,CAAC,OAAO,OAAO,QAAQ,cAAc,eAAe,OAAO,IAAI,WAAW,MAAM;AAC1F;AC7BU;AADV,MAAM,SAAS;AAAA,EAEb,YAAYC,MAAK,QAAQ,OAAO,SAAS,OAAO,aAAa,IAAI;AAC/D,SAAK,IAAI;AAAA,MACP,OAAO;AAAA,MACP,KAAAA;AAAA,MACA,gBAAgB;AAAA,MAChB;AAAA,MACA;AAAA,MACA;AAAA,IACN;AAAA,EACE;AAAA;AAAA;AAAA;AAIF;AAdE,cADI,UACI,IAAc;ACExB,MAAM,SAAS;AAAA,EACb,gBAAgB,MAAM,IAAI;AACb;AACT,aAAO,GAAE;AAAA,IACX;AAAA,EAyBF;AACF;AClCA,MAAM,iBAAiB,OAAO,IAAI,wBAAwB;ACE1D,MAAM,SAAS,OAAO,IAAI,gBAAgB;AAC1C,MAAM,UAAU,OAAO,IAAI,iBAAiB;AAC5C,MAAM,qBAAqB,OAAO,IAAI,4BAA4B;AAClE,MAAM,eAAe,OAAO,IAAI,sBAAsB;AACtD,MAAM,WAAW,OAAO,IAAI,kBAAkB;AAC9C,MAAM,UAAU,OAAO,IAAI,iBAAiB;AAC5C,MAAM,qBAAqB,OAAO,IAAI,4BAA4B;AAClE,MAAM,iBAAiB,OAAO,IAAI,wBAAwB;AAEhD,iBAgBP,gBAKA,mBAEA,aAEA,cAEA,yBAKA,eAEA,cAEA,qBAEA;AAvCH,MAAM,MAAM;AAAA,EAwCV,YAAY,MAAM,QAAQ,UAAU;AAvBpC;AAAA;AAAA;AAAA;AAAA,wBAAC;AAKD;AAAA;AAAA;AAAA;AAAA,wBAAC;AAED;AAAA,wBAAC;AAED;AAAA,wBAAC;AAED;AAAA,wBAAC;AAKD;AAAA;AAAA;AAAA;AAAA,wBAAC;AAED;AAAA,wBAAC,IAAW;AAEZ;AAAA,wBAAC,IAAkB;AAEnB;AAAA,wBAAC;AAEC,SAAK,SAAS,IAAI,KAAK,YAAY,IAAI;AACvC,SAAK,MAAM,IAAI;AACf,SAAK,QAAQ,IAAI;AAAA,EACnB;AACF;AA5CE,cADI,OACI,IAAc;AAAA;AAEtB,cAHI,OAGG,UAAS;AAAA,EACd,MAAM;AAAA,EACN;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AACJ;ACZA,SAAS,aAAa,OAAO;AAC3B,SAAO,UAAU,QAAQ,UAAU,UAAU,OAAO,MAAM,WAAW;AACvE;AACA,SAAS,aAAa,SAAS;AAC7B,QAAM,SAAS,EAAE,KAAK,IAAI,QAAQ,CAAA,EAAE;AACpC,aAAW,SAAS,SAAS;AAC3B,WAAO,OAAO,MAAM;AACpB,WAAO,OAAO,KAAK,GAAG,MAAM,MAAM;AAClC,QAAI,MAAM,SAAS,QAAQ;AACzB,UAAI,CAAC,OAAO,SAAS;AACnB,eAAO,UAAU,CAAA;AAAA,MACnB;AACA,aAAO,QAAQ,KAAK,GAAG,MAAM,OAAO;AAAA,IACtC;AAAA,EACF;AACA,SAAO;AACT;AAEU;AADV,MAAM,YAAY;AAAA,EAGhB,YAAY,OAAO;AADnB;AAEE,SAAK,QAAQ,MAAM,QAAQ,KAAK,IAAI,QAAQ,CAAC,KAAK;AAAA,EACpD;AAAA,EACA,SAAS;AACP,WAAO,IAAI,IAAI,CAAC,IAAI,CAAC;AAAA,EACvB;AACF;AARE,cADI,aACI,IAAc;AAqBd;AAZV,MAAM,OAAN,MAAM,KAAI;AAAA,EACR,YAAY,aAAa;AAazB;AAAA,mCAAU;AACV,8CAAqB;AAErB;AAAA,sCAAa,CAAA;AAfX,SAAK,cAAc;AACnB,eAAW,SAAS,aAAa;AAC/B,UAAI,GAAG,OAAO,KAAK,GAAG;AACpB,cAAM,aAAa,MAAM,MAAM,OAAO,MAAM;AAC5C,aAAK,WAAW;AAAA,UACd,eAAe,SAAS,MAAM,MAAM,OAAO,IAAI,IAAI,aAAa,MAAM,MAAM,MAAM,OAAO,IAAI;AAAA,QACvG;AAAA,MACM;AAAA,IACF;AAAA,EACF;AAAA,EAOA,OAAO,OAAO;AACZ,SAAK,YAAY,KAAK,GAAG,MAAM,WAAW;AAC1C,WAAO;AAAA,EACT;AAAA,EACA,QAAQ,QAAQ;AACd,WAAO,OAAO,gBAAgB,oBAAoB,CAAC,SAAS;AAC1D,YAAM,QAAQ,KAAK,2BAA2B,KAAK,aAAa,MAAM;AACtE,YAAM,cAAc;AAAA,QAClB,sBAAsB,MAAM;AAAA,QAC5B,wBAAwB,KAAK,UAAU,MAAM,MAAM;AAAA,MAC3D,CAAO;AACD,aAAO;AAAA,IACT,CAAC;AAAA,EACH;AAAA,EACA,2BAA2B,QAAQ,SAAS;AAC1C,UAAM,SAAS,OAAO,OAAO,CAAA,GAAI,SAAS;AAAA,MACxC,cAAc,QAAQ,gBAAgB,KAAK;AAAA,MAC3C,iBAAiB,QAAQ,mBAAmB,EAAE,OAAO,EAAC;AAAA,IAC5D,CAAK;AACD,UAAM;AAAA,MACJ;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,IACN,IAAQ;AACJ,WAAO,aAAa,OAAO,IAAI,CAAC,UAAU;AACxC,UAAI,GAAG,OAAO,WAAW,GAAG;AAC1B,eAAO,EAAE,KAAK,MAAM,MAAM,KAAK,EAAE,GAAG,QAAQ,GAAE;AAAA,MAChD;AACA,UAAI,GAAG,OAAO,IAAI,GAAG;AACnB,eAAO,EAAE,KAAK,WAAW,MAAM,KAAK,GAAG,QAAQ,GAAE;AAAA,MACnD;AACA,UAAI,UAAU,QAAQ;AACpB,eAAO,EAAE,KAAK,IAAI,QAAQ,CAAA,EAAE;AAAA,MAC9B;AACA,UAAI,MAAM,QAAQ,KAAK,GAAG;AACxB,cAAM,SAAS,CAAC,IAAI,YAAY,GAAG,CAAC;AACpC,mBAAW,CAAC,GAAG,CAAC,KAAK,MAAM,QAAO,GAAI;AACpC,iBAAO,KAAK,CAAC;AACb,cAAI,IAAI,MAAM,SAAS,GAAG;AACxB,mBAAO,KAAK,IAAI,YAAY,IAAI,CAAC;AAAA,UACnC;AAAA,QACF;AACA,eAAO,KAAK,IAAI,YAAY,GAAG,CAAC;AAChC,eAAO,KAAK,2BAA2B,QAAQ,MAAM;AAAA,MACvD;AACA,UAAI,GAAG,OAAO,IAAG,GAAG;AAClB,eAAO,KAAK,2BAA2B,MAAM,aAAa;AAAA,UACxD,GAAG;AAAA,UACH,cAAc,gBAAgB,MAAM;AAAA,QAC9C,CAAS;AAAA,MACH;AACA,UAAI,GAAG,OAAO,KAAK,GAAG;AACpB,cAAM,aAAa,MAAM,MAAM,OAAO,MAAM;AAC5C,cAAM,YAAY,MAAM,MAAM,OAAO,IAAI;AACzC,eAAO;AAAA,UACL,KAAK,eAAe,UAAU,MAAM,OAAO,IAAI,WAAW,SAAS,IAAI,WAAW,UAAU,IAAI,MAAM,WAAW,SAAS;AAAA,UAC1H,QAAQ,CAAA;AAAA,QAClB;AAAA,MACM;AACA,UAAI,GAAG,OAAO,MAAM,GAAG;AACrB,cAAM,aAAa,OAAO,gBAAgB,KAAK;AAC/C,YAAI,QAAQ,iBAAiB,WAAW;AACtC,iBAAO,EAAE,KAAK,WAAW,UAAU,GAAG,QAAQ,CAAA,EAAE;AAAA,QAClD;AACA,cAAM,aAAa,MAAM,MAAM,MAAM,OAAO,MAAM;AAClD,eAAO;AAAA,UACL,KAAK,MAAM,MAAM,OAAO,KAAK,eAAe,SAAS,WAAW,MAAM,MAAM,MAAM,OAAO,IAAI,CAAC,IAAI,MAAM,WAAW,UAAU,IAAI,WAAW,UAAU,IAAI,MAAM,WAAW,MAAM,MAAM,MAAM,OAAO,IAAI,CAAC,IAAI,MAAM,WAAW,UAAU;AAAA,UACxO,QAAQ,CAAA;AAAA,QAClB;AAAA,MACM;AACA,UAAI,GAAG,OAAO,IAAI,GAAG;AACnB,cAAM,aAAa,MAAM,cAAc,EAAE;AACzC,cAAM,WAAW,MAAM,cAAc,EAAE;AACvC,eAAO;AAAA,UACL,KAAK,eAAe,UAAU,MAAM,cAAc,EAAE,UAAU,WAAW,QAAQ,IAAI,WAAW,UAAU,IAAI,MAAM,WAAW,QAAQ;AAAA,UACvI,QAAQ,CAAA;AAAA,QAClB;AAAA,MACM;AACA,UAAI,GAAG,OAAO,KAAK,GAAG;AACpB,YAAI,GAAG,MAAM,OAAO,WAAW,GAAG;AAChC,iBAAO,EAAE,KAAK,YAAY,gBAAgB,SAAS,KAAK,GAAG,QAAQ,CAAC,KAAK,GAAG,SAAS,CAAC,MAAM,EAAC;AAAA,QAC/F;AACA,cAAM,cAAc,MAAM,UAAU,OAAO,OAAO,MAAM,QAAQ,iBAAiB,MAAM,KAAK;AAC5F,YAAI,GAAG,aAAa,IAAG,GAAG;AACxB,iBAAO,KAAK,2BAA2B,CAAC,WAAW,GAAG,MAAM;AAAA,QAC9D;AACA,YAAI,cAAc;AAChB,iBAAO,EAAE,KAAK,KAAK,eAAe,aAAa,MAAM,GAAG,QAAQ,GAAE;AAAA,QACpE;AACA,YAAI,UAAU,CAAC,MAAM;AACrB,YAAI,eAAe;AACjB,oBAAU,CAAC,cAAc,MAAM,OAAO,CAAC;AAAA,QACzC;AACA,eAAO,EAAE,KAAK,YAAY,gBAAgB,SAAS,WAAW,GAAG,QAAQ,CAAC,WAAW,GAAG,QAAO;AAAA,MACjG;AACA,UAAI,GAAG,OAAO,WAAW,GAAG;AAC1B,eAAO,EAAE,KAAK,YAAY,gBAAgB,SAAS,KAAK,GAAG,QAAQ,CAAC,KAAK,GAAG,SAAS,CAAC,MAAM,EAAC;AAAA,MAC/F;AACA,UAAI,GAAG,OAAO,KAAI,OAAO,KAAK,MAAM,eAAe,QAAQ;AACzD,eAAO,EAAE,KAAK,WAAW,MAAM,UAAU,GAAG,QAAQ,GAAE;AAAA,MACxD;AACA,UAAI,GAAG,OAAO,QAAQ,GAAG;AACvB,YAAI,MAAM,EAAE,QAAQ;AAClB,iBAAO,EAAE,KAAK,WAAW,MAAM,EAAE,KAAK,GAAG,QAAQ,GAAE;AAAA,QACrD;AACA,eAAO,KAAK,2BAA2B;AAAA,UACrC,IAAI,YAAY,GAAG;AAAA,UACnB,MAAM,EAAE;AAAA,UACR,IAAI,YAAY,IAAI;AAAA,UACpB,IAAI,KAAK,MAAM,EAAE,KAAK;AAAA,QAChC,GAAW,MAAM;AAAA,MACX;AACA,UAAI,SAAS,KAAK,GAAG;AACnB,YAAI,MAAM,QAAQ;AAChB,iBAAO,EAAE,KAAK,WAAW,MAAM,MAAM,IAAI,MAAM,WAAW,MAAM,QAAQ,GAAG,QAAQ,CAAA,EAAE;AAAA,QACvF;AACA,eAAO,EAAE,KAAK,WAAW,MAAM,QAAQ,GAAG,QAAQ,GAAE;AAAA,MACtD;AACA,UAAI,aAAa,KAAK,GAAG;AACvB,YAAI,MAAM,yBAAyB;AACjC,iBAAO,KAAK,2BAA2B,CAAC,MAAM,OAAM,CAAE,GAAG,MAAM;AAAA,QACjE;AACA,eAAO,KAAK,2BAA2B;AAAA,UACrC,IAAI,YAAY,GAAG;AAAA,UACnB,MAAM,OAAM;AAAA,UACZ,IAAI,YAAY,GAAG;AAAA,QAC7B,GAAW,MAAM;AAAA,MACX;AACA,UAAI,cAAc;AAChB,eAAO,EAAE,KAAK,KAAK,eAAe,OAAO,MAAM,GAAG,QAAQ,GAAE;AAAA,MAC9D;AACA,aAAO,EAAE,KAAK,YAAY,gBAAgB,SAAS,KAAK,GAAG,QAAQ,CAAC,KAAK,GAAG,SAAS,CAAC,MAAM,EAAC;AAAA,IAC/F,CAAC,CAAC;AAAA,EACJ;AAAA,EACA,eAAe,OAAO,EAAE,gBAAgB;AACtC,QAAI,UAAU,MAAM;AAClB,aAAO;AAAA,IACT;AACA,QAAI,OAAO,UAAU,YAAY,OAAO,UAAU,WAAW;AAC3D,aAAO,MAAM,SAAQ;AAAA,IACvB;AACA,QAAI,OAAO,UAAU,UAAU;AAC7B,aAAO,aAAa,KAAK;AAAA,IAC3B;AACA,QAAI,OAAO,UAAU,UAAU;AAC7B,YAAM,sBAAsB,MAAM,SAAQ;AAC1C,UAAI,wBAAwB,mBAAmB;AAC7C,eAAO,aAAa,KAAK,UAAU,KAAK,CAAC;AAAA,MAC3C;AACA,aAAO,aAAa,mBAAmB;AAAA,IACzC;AACA,UAAM,IAAI,MAAM,6BAA6B,KAAK;AAAA,EACpD;AAAA,EACA,SAAS;AACP,WAAO;AAAA,EACT;AAAA,EACA,GAAG,OAAO;AACR,QAAI,UAAU,QAAQ;AACpB,aAAO;AAAA,IACT;AACA,WAAO,IAAI,KAAI,QAAQ,MAAM,KAAK;AAAA,EACpC;AAAA,EACA,QAAQ,SAAS;AACf,SAAK,UAAU,OAAO,YAAY,aAAa,EAAE,oBAAoB,QAAO,IAAK;AACjF,WAAO;AAAA,EACT;AAAA,EACA,eAAe;AACb,SAAK,qBAAqB;AAC1B,WAAO;AAAA,EACT;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAOA,GAAG,WAAW;AACZ,WAAO,YAAY,OAAO;AAAA,EAC5B;AACF;AA5LE,cAZI,MAYI,IAAc;AAZxB,IAAM,MAAN;AA6MU;AAJV,MAAM,KAAK;AAAA,EACT,YAAY,OAAO;AAInB;AAHE,SAAK,QAAQ;AAAA,EACf;AAAA,EAGA,SAAS;AACP,WAAO,IAAI,IAAI,CAAC,IAAI,CAAC;AAAA,EACvB;AACF;AALE,cAJI,MAII,IAAc;AASxB,SAAS,qBAAqB,OAAO;AACnC,SAAO,OAAO,UAAU,YAAY,UAAU,QAAQ,sBAAsB,SAAS,OAAO,MAAM,qBAAqB;AACzH;AACA,MAAM,cAAc;AAAA,EAClB,oBAAoB,CAAC,UAAU;AACjC;AACA,MAAM,cAAc;AAAA,EAClB,kBAAkB,CAAC,UAAU;AAC/B;AAAA,CACmB;AAAA,EACjB,GAAG;AAAA,EACH,GAAG;AACL;AAUU;AATV,MAAM,MAAM;AAAA;AAAA;AAAA;AAAA;AAAA,EAKV,YAAY,OAAO,UAAU,aAAa;AAK1C;AAJE,SAAK,QAAQ;AACb,SAAK,UAAU;AAAA,EACjB;AAAA,EAGA,SAAS;AACP,WAAO,IAAI,IAAI,CAAC,IAAI,CAAC;AAAA,EACvB;AACF;AALE,cATI,OASI,IAAc;AASxB,SAAS,IAAI,YAAY,QAAQ;AAC/B,QAAM,cAAc,CAAA;AACpB,MAAI,OAAO,SAAS,KAAK,QAAQ,SAAS,KAAK,QAAQ,CAAC,MAAM,IAAI;AAChE,gBAAY,KAAK,IAAI,YAAY,QAAQ,CAAC,CAAC,CAAC;AAAA,EAC9C;AACA,aAAW,CAAC,YAAY,MAAM,KAAK,OAAO,QAAO,GAAI;AACnD,gBAAY,KAAK,QAAQ,IAAI,YAAY,QAAQ,aAAa,CAAC,CAAC,CAAC;AAAA,EACnE;AACA,SAAO,IAAI,IAAI,WAAW;AAC5B;AAAA,CACC,CAAC,SAAS;AACT,WAAS,QAAQ;AACf,WAAO,IAAI,IAAI,EAAE;AAAA,EACnB;AACA,OAAK,QAAQ;AACb,WAAS,SAAS,MAAM;AACtB,WAAO,IAAI,IAAI,IAAI;AAAA,EACrB;AACA,OAAK,WAAW;AAChB,WAAS,IAAI,KAAK;AAChB,WAAO,IAAI,IAAI,CAAC,IAAI,YAAY,GAAG,CAAC,CAAC;AAAA,EACvC;AACA,OAAK,MAAM;AACX,WAAS,KAAK,QAAQ,WAAW;AAC/B,UAAM,SAAS,CAAA;AACf,eAAW,CAAC,GAAG,KAAK,KAAK,OAAO,QAAO,GAAI;AACzC,UAAI,IAAI,KAAK,cAAc,QAAQ;AACjC,eAAO,KAAK,SAAS;AAAA,MACvB;AACA,aAAO,KAAK,KAAK;AAAA,IACnB;AACA,WAAO,IAAI,IAAI,MAAM;AAAA,EACvB;AACA,OAAK,OAAO;AACZ,WAAS,WAAW,OAAO;AACzB,WAAO,IAAI,KAAK,KAAK;AAAA,EACvB;AACA,OAAK,aAAa;AAClB,WAAS,aAAa,OAAO;AAC3B,WAAO,IAAI,YAAY,KAAK;AAAA,EAC9B;AACA,OAAK,cAAc;AACnB,WAAS,OAAO,OAAO,SAAS;AAC9B,WAAO,IAAI,MAAM,OAAO,OAAO;AAAA,EACjC;AACA,OAAK,QAAQ;AACf,GAAG,QAAQ,MAAM,CAAA,EAAG;AAAA,CACnB,CAAC,SAAS;;AAMC,EAAAC,MAAA;AALV,QAAM,WAAN,MAAM,SAAQ;AAAA,IACZ,YAAY,MAAM,YAAY;AAM9B;AAAA,8CAAmB;AALjB,WAAK,MAAM;AACX,WAAK,aAAa;AAAA,IACpB;AAAA,IAIA,SAAS;AACP,aAAO,KAAK;AAAA,IACd;AAAA;AAAA,IAEA,QAAQ;AACN,aAAO,IAAI,SAAQ,KAAK,KAAK,KAAK,UAAU;AAAA,IAC9C;AAAA,EACJ;AAVI,gBALI,UAKIA,KAAc;AALxB,MAAM,UAAN;AAgBA,OAAK,UAAU;AACjB,GAAG,QAAQ,MAAM,CAAA,EAAG;AAKV;AAJV,MAAM,YAAY;AAAA,EAChB,YAAY,OAAO;AACjB,SAAK,OAAO;AAAA,EACd;AAAA,EAEA,SAAS;AACP,WAAO,IAAI,IAAI,CAAC,IAAI,CAAC;AAAA,EACvB;AACF;AAJE,cAJI,aAII,IAAc;AAyBxB,MAAM,gBAAgB,OAAO,IAAI,uBAAuB;AAE9C,iBAEP,qBAEA;AALH,MAAM,KAAK;AAAA,EAMT,YAAY,EAAE,MAAM,OAAO,QAAQ,gBAAgB,SAAS;AAH5D;AAAA,wBAAC;AAED;AAAA,wBAAC,IAAiB;AAEhB,SAAK,cAAc,IAAI;AAAA,MACrB,MAAM;AAAA,MACN,cAAc;AAAA,MACd;AAAA,MACA;AAAA,MACA;AAAA,MACA,YAAY,CAAC;AAAA,MACb,SAAS;AAAA,IACf;AAAA,EACE;AAAA,EACA,SAAS;AACP,WAAO,IAAI,IAAI,CAAC,IAAI,CAAC;AAAA,EACvB;AACF;AAnBE,cADI,MACI,IAAc;AA0BxB,OAAO,UAAU,SAAS,WAAW;AACnC,SAAO,IAAI,IAAI,CAAC,IAAI,CAAC;AACvB;AACA,MAAM,UAAU,SAAS,WAAW;AAClC,SAAO,IAAI,IAAI,CAAC,IAAI,CAAC;AACvB;AACA,SAAS,UAAU,SAAS,WAAW;AACrC,SAAO,IAAI,IAAI,CAAC,IAAI,CAAC;AACvB;AC3SA,SAAS,uBAAuB,GAAG,GAAG;AACpC,SAAO;AAAA,IACL,MAAM,OAAO,MAAM,YAAY,EAAE,SAAS,IAAI,IAAI;AAAA,IAClD,QAAQ,OAAO,MAAM,WAAW,IAAI;AAAA,EACxC;AACA;AAsCA,MAAM,cAAc,OAAO,gBAAgB,cAAc,OAAO,IAAI,YAAW;AChJ/E,SAAS,YAAY,OAAO,QAAQ;AAClC,MAAI,qBAAqB,MAAM,KAAK,CAAC,aAAa,KAAK,KAAK,CAAC,GAAG,OAAO,KAAK,KAAK,CAAC,GAAG,OAAO,WAAW,KAAK,CAAC,GAAG,OAAO,MAAM,KAAK,CAAC,GAAG,OAAO,KAAK,KAAK,CAAC,GAAG,OAAO,IAAI,GAAG;AACvK,WAAO,IAAI,MAAM,OAAO,MAAM;AAAA,EAChC;AACA,SAAO;AACT;AACA,MAAM,KAAK,CAAC,MAAM,UAAU;AAC1B,SAAO,MAAM,IAAI,MAAM,YAAY,OAAO,IAAI,CAAC;AACjD;AAIA,SAAS,OAAO,sBAAsB;AACpC,QAAM,aAAa,qBAAqB;AAAA,IACtC,CAAC,MAAM,MAAM;AAAA,EACjB;AACE,MAAI,WAAW,WAAW,GAAG;AAC3B,WAAO;AAAA,EACT;AACA,MAAI,WAAW,WAAW,GAAG;AAC3B,WAAO,IAAI,IAAI,UAAU;AAAA,EAC3B;AACA,SAAO,IAAI,IAAI;AAAA,IACb,IAAI,YAAY,GAAG;AAAA,IACnB,IAAI,KAAK,YAAY,IAAI,YAAY,OAAO,CAAC;AAAA,IAC7C,IAAI,YAAY,GAAG;AAAA,EACvB,CAAG;AACH;AA0BA,MAAM,KAAK,CAAC,MAAM,UAAU;AAC1B,SAAO,MAAM,IAAI,MAAM,YAAY,OAAO,IAAI,CAAC;AACjD;ACjEU;AADV,MAAM,kBAAkB;AAAA,EAQtB,YAAY,QAAQ,SAAS;AAL7B;AAAA;AAEA;AAAA;AAEA;AAAA;AAEE,SAAK,YAAY,MAAM;AACrB,YAAM,EAAE,MAAM,SAAS,eAAc,IAAK,OAAM;AAChD,aAAO,EAAE,MAAM,SAAS,cAAc,eAAe,CAAC,EAAE,OAAO,eAAc;AAAA,IAC/E;AACA,QAAI,SAAS;AACX,WAAK,YAAY,QAAQ;AACzB,WAAK,YAAY,QAAQ;AAAA,IAC3B;AAAA,EACF;AAAA,EACA,SAAS,QAAQ;AACf,SAAK,YAAY;AACjB,WAAO;AAAA,EACT;AAAA,EACA,SAAS,QAAQ;AACf,SAAK,YAAY;AACjB,WAAO;AAAA,EACT;AAAA;AAAA,EAEA,MAAM,OAAO;AACX,WAAO,IAAI,WAAW,OAAO,IAAI;AAAA,EACnC;AACF;AA7BE,cADI,mBACI,IAAc;AAqCd;AAPV,MAAM,WAAW;AAAA,EACf,YAAY,OAAO,SAAS;AAO5B;AACA;AACA;AARE,SAAK,QAAQ;AACb,SAAK,YAAY,QAAQ;AACzB,SAAK,WAAW,QAAQ;AACxB,SAAK,WAAW,QAAQ;AAAA,EAC1B;AAAA,EAKA,UAAU;AACR,UAAM,EAAE,MAAM,SAAS,eAAc,IAAK,KAAK,UAAS;AACxD,UAAM,cAAc,QAAQ,IAAI,CAAC,WAAW,OAAO,IAAI;AACvD,UAAM,qBAAqB,eAAe,IAAI,CAAC,WAAW,OAAO,IAAI;AACrE,UAAM,SAAS;AAAA,MACb,KAAK,MAAM,SAAS;AAAA,MACpB,GAAG;AAAA,MACH,eAAe,CAAC,EAAE,MAAM,SAAS;AAAA,MACjC,GAAG;AAAA,IACT;AACI,WAAO,QAAQ,GAAG,OAAO,KAAK,GAAG,CAAC;AAAA,EACpC;AACF;AAhBE,cAPI,YAOI,IAAc;ACtCxB,SAAS,cAAc,OAAO,SAAS;AACrC,SAAO,GAAG,MAAM,SAAS,CAAC,IAAI,QAAQ,KAAK,GAAG,CAAC;AACjD;ACCA,MAAM,6BAA4B,oBACxB,iBADwB,IAAc;AAAA,EAAhD;AAAA;AAEE,6CAAoB,CAAA;AAAA;AAAA,EACpB,WAAW,KAAK,UAAU,IAAI;AAC5B,SAAK,kBAAkB,KAAK,EAAE,KAAK,QAAO,CAAE;AAC5C,WAAO;AAAA,EACT;AAAA,EACA,OAAO,MAAM;AACX,SAAK,OAAO,WAAW;AACvB,SAAK,OAAO,aAAa;AACzB,WAAO;AAAA,EACT;AAAA,EACA,kBAAkB,IAAI,QAAQ;AAC5B,SAAK,OAAO,YAAY;AAAA,MACtB;AAAA,MACA,MAAM;AAAA,MACN,MAAM,QAAQ,QAAQ;AAAA,IAC5B;AACI,WAAO;AAAA,EACT;AAAA;AAAA,EAEA,iBAAiB,QAAQ,OAAO;AAC9B,WAAO,KAAK,kBAAkB,IAAI,CAAC,EAAE,KAAK,cAAc;AACtD,cAAQ,CAAC,MAAM,aAAa;AAC1B,cAAM,UAAU,IAAI,kBAAkB,MAAM;AAC1C,gBAAM,gBAAgB,KAAI;AAC1B,iBAAO,EAAE,SAAS,CAAC,MAAM,GAAG,gBAAgB,CAAC,aAAa,EAAC;AAAA,QAC7D,CAAC;AACD,YAAI,SAAS,UAAU;AACrB,kBAAQ,SAAS,SAAS,QAAQ;AAAA,QACpC;AACA,YAAI,SAAS,UAAU;AACrB,kBAAQ,SAAS,SAAS,QAAQ;AAAA,QACpC;AACA,eAAO,QAAQ,MAAM,KAAK;AAAA,MAC5B,GAAG,KAAK,OAAO;AAAA,IACjB,CAAC;AAAA,EACH;AACF;AArCE,cADI,qBACI,IAAc;AAsCxB,MAAM,sBAAqB,aAQjB,iBARiB,IAAO;AAAA,EAChC,YAAY,OAAO,QAAQ;AACzB,QAAI,CAAC,OAAO,YAAY;AACtB,aAAO,aAAa,cAAc,OAAO,CAAC,OAAO,IAAI,CAAC;AAAA,IACxD;AACA,UAAM,OAAO,MAAM;AACnB,SAAK,QAAQ;AAAA,EACf;AAEF;AADE,cARI,cAQI,IAAc;ACjDxB,MAAM,6BAA4B,0BACxB,iBADwB,IAAoB;AAAA,EAEpD,YAAY,MAAM;AAChB,UAAM,MAAM,UAAU,cAAc;AAAA,EACtC;AAAA;AAAA,EAEA,MAAM,OAAO;AACX,WAAO,IAAI,aAAa,OAAO,KAAK,MAAM;AAAA,EAC5C;AACF;AARE,cADI,qBACI,IAAc;AASxB,MAAM,sBAAqB,mBACjB,iBADiB,IAAa;AAAA,EAEtC,aAAa;AACX,WAAO;AAAA,EACT;AAAA,EACA,mBAAmB,OAAO;AACxB,QAAI,OAAO,WAAW,eAAe,OAAO,MAAM;AAChD,YAAM,MAAM,OAAO,SAAS,KAAK,IAAI,QAAQ,iBAAiB,cAAc,OAAO,KAAK,KAAK,IAAI,MAAM,SAAS,OAAO,KAAK,MAAM,QAAQ,MAAM,YAAY,MAAM,UAAU,IAAI,OAAO,KAAK,KAAK;AACjM,aAAO,OAAO,IAAI,SAAS,MAAM,CAAC;AAAA,IACpC;AACA,WAAO,OAAO,YAAY,OAAO,KAAK,CAAC;AAAA,EACzC;AAAA,EACA,iBAAiB,OAAO;AACtB,WAAO,OAAO,KAAK,MAAM,SAAQ,CAAE;AAAA,EACrC;AACF;AAdE,cADI,cACI,IAAc;AAexB,MAAM,+BAA8B,0BAC1B,iBAD0B,IAAoB;AAAA,EAEtD,YAAY,MAAM;AAChB,UAAM,MAAM,QAAQ,gBAAgB;AAAA,EACtC;AAAA;AAAA,EAEA,MAAM,OAAO;AACX,WAAO,IAAI;AAAA,MACT;AAAA,MACA,KAAK;AAAA,IACX;AAAA,EACE;AACF;AAXE,cADI,uBACI,IAAc;AAYxB,MAAM,wBAAuB,mBACnB,iBADmB,IAAa;AAAA,EAExC,aAAa;AACX,WAAO;AAAA,EACT;AAAA,EACA,mBAAmB,OAAO;AACxB,QAAI,OAAO,WAAW,eAAe,OAAO,MAAM;AAChD,YAAM,MAAM,OAAO,SAAS,KAAK,IAAI,QAAQ,iBAAiB,cAAc,OAAO,KAAK,KAAK,IAAI,MAAM,SAAS,OAAO,KAAK,MAAM,QAAQ,MAAM,YAAY,MAAM,UAAU,IAAI,OAAO,KAAK,KAAK;AACjM,aAAO,KAAK,MAAM,IAAI,SAAS,MAAM,CAAC;AAAA,IACxC;AACA,WAAO,KAAK,MAAM,YAAY,OAAO,KAAK,CAAC;AAAA,EAC7C;AAAA,EACA,iBAAiB,OAAO;AACtB,WAAO,OAAO,KAAK,KAAK,UAAU,KAAK,CAAC;AAAA,EAC1C;AACF;AAdE,cADI,gBACI,IAAc;AAexB,MAAM,iCAAgC,0BAC5B,iBAD4B,IAAoB;AAAA,EAExD,YAAY,MAAM;AAChB,UAAM,MAAM,UAAU,kBAAkB;AAAA,EAC1C;AAAA;AAAA,EAEA,MAAM,OAAO;AACX,WAAO,IAAI,iBAAiB,OAAO,KAAK,MAAM;AAAA,EAChD;AACF;AARE,cADI,yBACI,IAAc;AASxB,MAAM,0BAAyB,mBACrB,iBADqB,IAAa;AAAA,EAE1C,mBAAmB,OAAO;AACxB,QAAI,OAAO,SAAS,KAAK,GAAG;AAC1B,aAAO;AAAA,IACT;AACA,WAAO,OAAO,KAAK,KAAK;AAAA,EAC1B;AAAA,EACA,aAAa;AACX,WAAO;AAAA,EACT;AACF;AAVE,cADI,kBACI,IAAc;AAWxB,SAAS,KAAK,GAAG,GAAG;AAClB,QAAM,EAAE,MAAM,OAAM,IAAK,uBAAuB,GAAG,CAAC;AACpD,MAAI,QAAQ,SAAS,QAAQ;AAC3B,WAAO,IAAI,sBAAsB,IAAI;AAAA,EACvC;AACA,MAAI,QAAQ,SAAS,UAAU;AAC7B,WAAO,IAAI,oBAAoB,IAAI;AAAA,EACrC;AACA,SAAO,IAAI,wBAAwB,IAAI;AACzC;ACtFA,MAAM,mCAAkC,0BAC9B,iBAD8B,IAAoB;AAAA,EAE1D,YAAY,MAAM,aAAa,kBAAkB;AAC/C,UAAM,MAAM,UAAU,oBAAoB;AAC1C,SAAK,OAAO,cAAc;AAC1B,SAAK,OAAO,mBAAmB;AAAA,EACjC;AAAA;AAAA,EAEA,MAAM,OAAO;AACX,WAAO,IAAI;AAAA,MACT;AAAA,MACA,KAAK;AAAA,IACX;AAAA,EACE;AACF;AAbE,cADI,2BACI,IAAc;AAcxB,MAAM,4BAA2B,mBACvB,iBADuB,IAAa;AAAA,EAK5C,YAAY,OAAO,QAAQ;AACzB,UAAM,OAAO,MAAM;AAJrB;AACA;AACA;AAGE,SAAK,UAAU,OAAO,iBAAiB,SAAS,OAAO,WAAW;AAClE,SAAK,QAAQ,OAAO,iBAAiB;AACrC,SAAK,UAAU,OAAO,iBAAiB;AAAA,EACzC;AAAA,EACA,aAAa;AACX,WAAO,KAAK;AAAA,EACd;AAAA,EACA,mBAAmB,OAAO;AACxB,WAAO,OAAO,KAAK,YAAY,aAAa,KAAK,QAAQ,KAAK,IAAI;AAAA,EACpE;AAAA,EACA,iBAAiB,OAAO;AACtB,WAAO,OAAO,KAAK,UAAU,aAAa,KAAK,MAAM,KAAK,IAAI;AAAA,EAChE;AACF;AAnBE,cADI,oBACI,IAAc;AAoBxB,SAAS,WAAW,kBAAkB;AACpC,SAAO,CAAC,GAAG,MAAM;AACf,UAAM,EAAE,MAAM,OAAM,IAAK,uBAAuB,GAAG,CAAC;AACpD,WAAO,IAAI;AAAA,MACT;AAAA,MACA;AAAA,MACA;AAAA,IACN;AAAA,EACE;AACF;AC5CA,MAAM,kCAAiC,0BAC7B,iBAD6B,IAAoB;AAAA,EAEzD,YAAY,MAAM,UAAU,YAAY;AACtC,UAAM,MAAM,UAAU,UAAU;AAChC,SAAK,OAAO,gBAAgB;AAAA,EAC9B;AAAA,EACA,WAAW,QAAQ;AACjB,QAAI,QAAQ,eAAe;AACzB,WAAK,OAAO,gBAAgB;AAAA,IAC9B;AACA,SAAK,OAAO,aAAa;AACzB,WAAO,MAAM,WAAU;AAAA,EACzB;AACF;AAZE,cADI,0BACI,IAAc;AAaxB,MAAM,2BAA0B,mBACtB,iBADsB,IAAa;AAAA,EAA7C;AAAA;AAEE,yCAAgB,KAAK,OAAO;AAAA;AAAA,EAC5B,aAAa;AACX,WAAO;AAAA,EACT;AACF;AALE,cADI,mBACI,IAAc;AAMxB,MAAM,8BAA6B,+BACzB,iBADyB,IAAyB;AAAA,EAE1D,YAAY,MAAM;AAChB,UAAM,MAAM,UAAU,eAAe;AAAA,EACvC;AAAA,EACA,MAAM,OAAO;AACX,WAAO,IAAI;AAAA,MACT;AAAA,MACA,KAAK;AAAA,IACX;AAAA,EACE;AACF;AAVE,cADI,sBACI,IAAc;AAWxB,MAAM,uBAAsB,wBAClB,iBADkB,IAAkB;AAE9C;AADE,cADI,eACI,IAAc;AAExB,MAAM,gCAA+B,+BAC3B,iBAD2B,IAAyB;AAAA,EAE5D,YAAY,MAAM,MAAM;AACtB,UAAM,MAAM,QAAQ,iBAAiB;AACrC,SAAK,OAAO,OAAO;AAAA,EACrB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAMA,aAAa;AACX,WAAO,KAAK,QAAQ,+DAA+D;AAAA,EACrF;AAAA,EACA,MAAM,OAAO;AACX,WAAO,IAAI;AAAA,MACT;AAAA,MACA,KAAK;AAAA,IACX;AAAA,EACE;AACF;AAnBE,cADI,wBACI,IAAc;AAoBxB,MAAM,yBAAwB,yBACpB,iBADoB,KAAkB;AAAA,EAAhD;AAAA;AAEE,gCAAO,KAAK,OAAO;AAAA;AAAA,EACnB,mBAAmB,OAAO;AACxB,QAAI,KAAK,OAAO,SAAS,aAAa;AACpC,aAAO,IAAI,KAAK,QAAQ,GAAG;AAAA,IAC7B;AACA,WAAO,IAAI,KAAK,KAAK;AAAA,EACvB;AAAA,EACA,iBAAiB,OAAO;AACtB,UAAM,OAAO,MAAM,QAAO;AAC1B,QAAI,KAAK,OAAO,SAAS,aAAa;AACpC,aAAO,KAAK,MAAM,OAAO,GAAG;AAAA,IAC9B;AACA,WAAO;AAAA,EACT;AACF;AAfE,cADI,iBACI,IAAc;AAgBxB,MAAM,8BAA6B,gCACzB,kBADyB,KAAyB;AAAA,EAE1D,YAAY,MAAM,MAAM;AACtB,UAAM,MAAM,WAAW,eAAe;AACtC,SAAK,OAAO,OAAO;AAAA,EACrB;AAAA,EACA,MAAM,OAAO;AACX,WAAO,IAAI;AAAA,MACT;AAAA,MACA,KAAK;AAAA,IACX;AAAA,EACE;AACF;AAXE,cADI,sBACI,KAAc;AAYxB,MAAM,uBAAsB,yBAClB,kBADkB,KAAkB;AAAA,EAA9C;AAAA;AAEE,gCAAO,KAAK,OAAO;AAAA;AAAA,EACnB,mBAAmB,OAAO;AACxB,WAAO,OAAO,KAAK,MAAM;AAAA,EAC3B;AAAA,EACA,iBAAiB,OAAO;AACtB,WAAO,QAAQ,IAAI;AAAA,EACrB;AACF;AARE,cADI,eACI,KAAc;AASxB,SAAS,QAAQ,GAAG,GAAG;AACrB,QAAM,EAAE,MAAM,OAAM,IAAK,uBAAuB,GAAG,CAAC;AACpD,MAAI,QAAQ,SAAS,eAAe,QAAQ,SAAS,gBAAgB;AACnE,WAAO,IAAI,uBAAuB,MAAM,OAAO,IAAI;AAAA,EACrD;AACA,MAAI,QAAQ,SAAS,WAAW;AAC9B,WAAO,IAAI,qBAAqB,MAAM,OAAO,IAAI;AAAA,EACnD;AACA,SAAO,IAAI,qBAAqB,IAAI;AACtC;AC3GA,MAAM,8BAA6B,2BACzB,kBADyB,KAAoB;AAAA,EAErD,YAAY,MAAM;AAChB,UAAM,MAAM,UAAU,eAAe;AAAA,EACvC;AAAA;AAAA,EAEA,MAAM,OAAO;AACX,WAAO,IAAI;AAAA,MACT;AAAA,MACA,KAAK;AAAA,IACX;AAAA,EACE;AACF;AAXE,cADI,sBACI,KAAc;AAYxB,MAAM,uBAAsB,oBAClB,kBADkB,KAAa;AAAA,EAEvC,mBAAmB,OAAO;AACxB,QAAI,OAAO,UAAU,SAAU,QAAO;AACtC,WAAO,OAAO,KAAK;AAAA,EACrB;AAAA,EACA,aAAa;AACX,WAAO;AAAA,EACT;AACF;AARE,cADI,eACI,KAAc;AASxB,MAAM,oCAAmC,2BAC/B,kBAD+B,KAAoB;AAAA,EAE3D,YAAY,MAAM;AAChB,UAAM,MAAM,UAAU,qBAAqB;AAAA,EAC7C;AAAA;AAAA,EAEA,MAAM,OAAO;AACX,WAAO,IAAI;AAAA,MACT;AAAA,MACA,KAAK;AAAA,IACX;AAAA,EACE;AACF;AAXE,cADI,4BACI,KAAc;AAYxB,MAAM,6BAA4B,oBACxB,kBADwB,KAAa;AAAA,EAA/C;AAAA;AAME,4CAAmB;AAAA;AAAA,EAJnB,mBAAmB,OAAO;AACxB,QAAI,OAAO,UAAU,SAAU,QAAO;AACtC,WAAO,OAAO,KAAK;AAAA,EACrB;AAAA,EAEA,aAAa;AACX,WAAO;AAAA,EACT;AACF;AATE,cADI,qBACI,KAAc;AAUxB,MAAM,oCAAmC,2BAC/B,kBAD+B,KAAoB;AAAA,EAE3D,YAAY,MAAM;AAChB,UAAM,MAAM,UAAU,qBAAqB;AAAA,EAC7C;AAAA;AAAA,EAEA,MAAM,OAAO;AACX,WAAO,IAAI;AAAA,MACT;AAAA,MACA,KAAK;AAAA,IACX;AAAA,EACE;AACF;AAXE,cADI,4BACI,KAAc;AAYxB,MAAM,6BAA4B,oBACxB,kBADwB,KAAa;AAAA,EAA/C;AAAA;AAEE,8CAAqB;AACrB,4CAAmB;AAAA;AAAA,EACnB,aAAa;AACX,WAAO;AAAA,EACT;AACF;AANE,cADI,qBACI,KAAc;AAOxB,SAAS,QAAQ,GAAG,GAAG;AACrB,QAAM,EAAE,MAAM,OAAM,IAAK,uBAAuB,GAAG,CAAC;AACpD,QAAM,OAAO,QAAQ;AACrB,SAAO,SAAS,WAAW,IAAI,2BAA2B,IAAI,IAAI,SAAS,WAAW,IAAI,2BAA2B,IAAI,IAAI,IAAI,qBAAqB,IAAI;AAC5J;ACzEA,MAAM,2BAA0B,2BACtB,kBADsB,KAAoB;AAAA,EAElD,YAAY,MAAM;AAChB,UAAM,MAAM,UAAU,YAAY;AAAA,EACpC;AAAA;AAAA,EAEA,MAAM,OAAO;AACX,WAAO,IAAI,WAAW,OAAO,KAAK,MAAM;AAAA,EAC1C;AACF;AARE,cADI,mBACI,KAAc;AASxB,MAAM,oBAAmB,oBACf,kBADe,KAAa;AAAA,EAEpC,aAAa;AACX,WAAO;AAAA,EACT;AACF;AAJE,cADI,YACI,KAAc;AAKxB,SAAS,KAAK,MAAM;AAClB,SAAO,IAAI,kBAAkB,QAAQ,EAAE;AACzC;ACjBA,MAAM,2BAA0B,2BACtB,kBADsB,KAAoB;AAAA,EAElD,YAAY,MAAM,QAAQ;AACxB,UAAM,MAAM,UAAU,YAAY;AAClC,SAAK,OAAO,aAAa,OAAO;AAChC,SAAK,OAAO,SAAS,OAAO;AAAA,EAC9B;AAAA;AAAA,EAEA,MAAM,OAAO;AACX,WAAO,IAAI;AAAA,MACT;AAAA,MACA,KAAK;AAAA,IACX;AAAA,EACE;AACF;AAbE,cADI,mBACI,KAAc;AAcxB,MAAM,oBAAmB,oBACf,kBADe,KAAa;AAAA,EAIpC,YAAY,OAAO,QAAQ;AACzB,UAAM,OAAO,MAAM;AAHrB,sCAAa,KAAK,OAAO;AACzB,kCAAS,KAAK,OAAO;AAAA,EAGrB;AAAA,EACA,aAAa;AACX,WAAO,OAAO,KAAK,OAAO,SAAS,IAAI,KAAK,OAAO,MAAM,MAAM,EAAE;AAAA,EACnE;AACF;AATE,cADI,YACI,KAAc;AAUxB,MAAM,+BAA8B,2BAC1B,kBAD0B,KAAoB;AAAA,EAEtD,YAAY,MAAM;AAChB,UAAM,MAAM,QAAQ,gBAAgB;AAAA,EACtC;AAAA;AAAA,EAEA,MAAM,OAAO;AACX,WAAO,IAAI;AAAA,MACT;AAAA,MACA,KAAK;AAAA,IACX;AAAA,EACE;AACF;AAXE,cADI,uBACI,KAAc;AAYxB,MAAM,wBAAuB,oBACnB,kBADmB,KAAa;AAAA,EAExC,aAAa;AACX,WAAO;AAAA,EACT;AAAA,EACA,mBAAmB,OAAO;AACxB,WAAO,KAAK,MAAM,KAAK;AAAA,EACzB;AAAA,EACA,iBAAiB,OAAO;AACtB,WAAO,KAAK,UAAU,KAAK;AAAA,EAC7B;AACF;AAVE,cADI,gBACI,KAAc;AAWxB,SAAS,KAAK,GAAG,IAAI,IAAI;AACvB,QAAM,EAAE,MAAM,OAAM,IAAK,uBAAuB,GAAG,CAAC;AACpD,MAAI,OAAO,SAAS,QAAQ;AAC1B,WAAO,IAAI,sBAAsB,IAAI;AAAA,EACvC;AACA,SAAO,IAAI,kBAAkB,MAAM,MAAM;AAC3C;ACtDA,SAAS,0BAA0B;AACjC,SAAO;AAAA,IACL;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,EACJ;AACA;ACZA,MAAM,oBAAoB,OAAO,IAAI,iCAAiC;AACtE,MAAM,qBAAoB,aAChB,kBAMP,YAAM,OAAO,SAEb,yBAEA,YAAM,OAAO,oBAXU,KAAM;AAAA,EAAhC;AAAA;AAOE;AAAA,wBAAC;AAED;AAAA,wBAAC,KAAqB,CAAA;AAEtB;AAAA,wBAAC;AAAA;AACH;AAXE,cADI,aACI,KAAc;AAAA;AAEtB,cAHI,aAGG,UAAS,OAAO,OAAO,CAAA,GAAI,MAAM,QAAQ;AAAA,EAC9C;AACJ,CAAG;AAQH,SAAS,gBAAgB,MAAM,SAAS,aAAa,QAAQ,WAAW,MAAM;AAC5E,QAAM,WAAW,IAAI,YAAY,MAAM,QAAQ,QAAQ;AACvD,QAAM,gBAAgB,OAAO,YAAY,aAAa,QAAQ,wBAAuB,CAAE,IAAI;AAC3F,QAAM,eAAe,OAAO;AAAA,IAC1B,OAAO,QAAQ,aAAa,EAAE,IAAI,CAAC,CAAC,OAAO,cAAc,MAAM;AAC7D,YAAM,aAAa;AACnB,iBAAW,QAAQ,KAAK;AACxB,YAAM,SAAS,WAAW,MAAM,QAAQ;AACxC,eAAS,iBAAiB,EAAE,KAAK,GAAG,WAAW,iBAAiB,QAAQ,QAAQ,CAAC;AACjF,aAAO,CAAC,OAAO,MAAM;AAAA,IACvB,CAAC;AAAA,EACL;AACE,QAAM,QAAQ,OAAO,OAAO,UAAU,YAAY;AAClD,QAAM,MAAM,OAAO,OAAO,IAAI;AAC9B,QAAM,MAAM,OAAO,kBAAkB,IAAI;AAIzC,SAAO;AACT;AACA,MAAM,cAAc,CAAC,MAAM,SAAS,gBAAgB;AAClD,SAAO,gBAAgB,MAAM,OAAoB;AACnD;ACVO,MAAM,QAAQ,YAAY,SAAS;AAAA,EACxC,IAAI,KAAK,IAAI,EAAE,WAAA,EAAa,QAAA;AAAA,EAC5B,OAAO,KAAK,OAAO,EAAE,QAAA,EAAU,OAAA;AAAA,EAC/B,aAAa,KAAK,cAAc,EAAE,QAAA;AAAA,EAClC,QAAQ,KAAK,UAAU,EAAE,MAAM,CAAC,UAAU,cAAc,eAAe,SAAS,EAAA,CAAY,EACzF,QAAA,EACA,QAAQ,YAAY,EACpB,MAAA;AAAA,EACH,SAAS,KAAK,WAAW,EAAE,MAAM,OAAA,CAAQ,EAAE,MAAA;AAAA,EAC3C;AAAA,EACA;AACF,CAAC;AAEM,MAAM,iBAAiB,YAAY,kBAAkB;AAAA,EAC1D,IAAI,KAAK,IAAI,EAAE,WAAA,EAAa,QAAA;AAAA,EAC5B,QAAQ,KAAK,SAAS,EACnB,QAAA,EACA,WAAW,MAAM,MAAM,IAAI,EAAE,UAAU,WAAW;AAAA,EACrD,qBAAqB,KAAK,uBAAuB,EAAE,QAAA;AAAA,EACnD,SAAS,QAAQ,SAAS,EAAE,QAAA;AAAA,EAC5B,sBAAsB,KAAK,wBAAwB,EAAE,QAAA;AAAA,EACrD,oBAAoB,QAAQ,wBAAwB,EAAE,MAAM,UAAA,CAAW,EAAE,QAAA;AAAA,EACzE,YAAY,KAAK,cAAc,EAAE,MAAM,QAAQ,EAAE,QAAA,EAAU,MAAA;AAAA,EAC3D,QAAQ,KAAK,QAAQ,EAAE,QAAA;AAAA,EACvB,MAAM,KAAK,MAAM;AAAA,EACjB,YAAY,QAAQ,gBAAgB,EAAE,MAAM,aAAa;AAAA,EACzD,iBAAiB,KAAK,kBAAkB,EAAE,QAAA,EAAU,QAAQ,MAAM;AAAA,EAClE,MAAM,KAAK,OAAO,EAAE,QAAA;AAAA,EACpB,WAAW,QAAQ,WAAW,EAAE,QAAA;AAAA,EAChC;AAAA,EACA;AACF,CAAC;AC3BM,SAAS,qBAAqB,IAAgE;AACnG,SAAO;AAAA;AAAA,IAEL,aAAa,OAAO,OAAe;AACjC,aAAO,SAAS,YAAY;AAC1B,cAAM,SAAS,MAAM,GAAG,OAAA,EAAS,KAAK,KAAK,EAAE,MAAM,GAAG,MAAM,IAAI,EAAE,CAAC,EAAE,IAAA;AAErE,YAAI,CAAC,QAAQ;AACX,iBAAO,cAAc,QAAQ,EAAE;AAAA,QACjC;AAEA,eAAO;AAAA,MACT,GAAG,6BAA6B,EAAE,EAAE;AAAA,IACtC;AAAA;AAAA,IAGA,gBAAgB,OAAOF,WAAkB;AACvC,aAAO,SAAS,YAAY;AAC1B,cAAM,SAAS,MAAM,GAAG,OAAA,EAAS,KAAK,KAAK,EAAE,MAAM,GAAG,MAAM,OAAOA,MAAK,CAAC,EAAE,IAAA;AAE3E,YAAI,CAAC,QAAQ;AACX,iBAAO,cAAc,QAAQA,MAAK;AAAA,QACpC;AAEA,eAAO;AAAA,MACT,GAAG,gCAAgCA,MAAK,EAAE;AAAA,IAC5C;AAAA;AAAA,IAGA,YAAY,OAAOA,QAAe,gBAAwB;AACxD,UAAI;AACF,cAAM,UAAmB,EAAE,OAAAA,QAAO,YAAA;AAClC,cAAM,CAAC,MAAM,IAAI,MAAM,GAAG,OAAO,KAAK,EAAE,OAAO,OAAO,EAAE,UAAA;AAExD,YAAI,CAAC,QAAQ;AACX,iBAAO,IAAI,yBAAyB,EAAE,OAAAA,QAAO,aAAa;AAAA,QAC5D;AAEA,eAAO;AAAA,MACT,SAAS,OAAO;AAEd,YAAI,iBAAiB,SAAS,MAAM,QAAQ,SAAS,QAAQ,GAAG;AAC9D,iBAAO,IAAI,wBAAwB;AAAA,YACjC,OAAAA;AAAA,YACA,MAAM;AAAA,UAAA,CACP;AAAA,QACH;AAEA,eAAO,YAAY,yBAAyB,KAAc;AAAA,MAC5D;AAAA,IACF;AAAA;AAAA,IAGA,sBAAsB,OAAO,OAAe;AAC1C,aAAO,SAAS,YAAY;AAC1B,cAAM,SAAS,MAAM,GAAG,OAAA,EAAS,KAAK,cAAc,EAAE,MAAM,GAAG,eAAe,IAAI,EAAE,CAAC,EAAE,IAAA;AAEvF,YAAI,CAAC,QAAQ;AACX,iBAAO,cAAc,iBAAiB,EAAE;AAAA,QAC1C;AAEA,eAAO;AAAA,MACT,GAAG,sCAAsC,EAAE,EAAE;AAAA,IAC/C;AAAA;AAAA,IAGA,2BAA2B,OAAO,WAAmB;AACnD,aAAO,SAAS,YAAY;AAC1B,cAAM,SAAS,MAAM,GAAG,OAAA,EAAS,KAAK,cAAc,EAAE,MAAM,GAAG,eAAe,QAAQ,MAAM,CAAC,EAAE,IAAA;AAE/F,eAAO;AAAA,MACT,GAAG,0CAA0C,MAAM,EAAE;AAAA,IACvD;AAAA;AAAA,IAGA,qBAAqB,OAAO,kBAAqE;AAC/F,UAAI;AACF,cAAM,CAAC,MAAM,IAAI,MAAM,GAAG,OAAO,cAAc,EAAE,OAAO,aAAa,EAAE,UAAA;AAEvE,YAAI,CAAC,QAAQ;AACX,iBAAO,IAAI,kCAAkC,EAAE,IAAI,cAAc,IAAI;AAAA,QACvE;AAEA,eAAO;AAAA,MACT,SAAS,OAAO;AACd,eAAO,YAAY,kCAAkC,KAAc;AAAA,MACrE;AAAA,IACF;AAAA;AAAA,IAGA,4BAA4B,OAAO,IAAY,YAAoB;AACjE,UAAI;AACF,cAAM,SAAS,MAAM,GAAG,OAAO,cAAc,EAAE,IAAI,EAAE,QAAA,CAAS,EAAE,MAAM,GAAG,eAAe,IAAI,EAAE,CAAC,EAAE,UAAA;AAEjG,YAAI,OAAO,WAAW,GAAG;AACvB,iBAAO,cAAc,iBAAiB,EAAE;AAAA,QAC1C;AAEA,eAAO;AAAA,MACT,SAAS,OAAO;AACd,eAAO,YAAY,0CAA0C,KAAc;AAAA,MAC7E;AAAA,IACF;AAAA;AAAA,IAGA,0BAA0B,OAAO,IAAY,SAAiB,eAAqB;AACjF,UAAI;AACF,cAAM,SAAS,MAAM,GAClB,OAAO,cAAc,EACrB,IAAI;AAAA,UACH;AAAA,UACA;AAAA,QAAA,CACD,EACA,MAAM,GAAG,eAAe,IAAI,EAAE,CAAC,EAC/B,UAAA;AAEH,YAAI,OAAO,WAAW,GAAG;AACvB,iBAAO,cAAc,iBAAiB,EAAE;AAAA,QAC1C;AAEA,eAAO;AAAA,MACT,SAAS,OAAO;AACd,eAAO,YAAY,wCAAwC,KAAc;AAAA,MAC3E;AAAA,IACF;AAAA;AAAA,IAGA,yBAAyB,OAAO,IAAY,SAAiB;AAC3D,UAAI;AACF,cAAM,SAAS,MAAM,GAAG,OAAO,cAAc,EAAE,IAAI,EAAE,KAAA,CAAM,EAAE,MAAM,GAAG,eAAe,IAAI,EAAE,CAAC,EAAE,UAAA;AAE9F,YAAI,OAAO,WAAW,GAAG;AACvB,iBAAO,cAAc,iBAAiB,EAAE;AAAA,QAC1C;AAEA,cAAM,uBAAuB,OAAO,CAAC;AACrC,YAAI,CAAC,sBAAsB;AACzB,iBAAO,YAAY,4CAA4C,IAAI,MAAM,8BAA8B,CAAC;AAAA,QAC1G;AAEA,eAAO;AAAA,MACT,SAAS,OAAO;AACd,eAAO,YAAY,uCAAuC,KAAc;AAAA,MAC1E;AAAA,IACF;AAAA;AAAA,IAGA,qBAAqB,OAAO,OAAe;AACzC,UAAI;AACF,cAAM,SAAS,MAAM,GAAG,OAAO,cAAc,EAAE,MAAM,GAAG,eAAe,IAAI,EAAE,CAAC,EAAE,UAAA;AAEhF,YAAI,OAAO,WAAW,GAAG;AACvB,iBAAO,cAAc,iBAAiB,EAAE;AAAA,QAC1C;AAEA,eAAO;AAAA,MACT,SAAS,OAAO;AACd,eAAO,YAAY,kCAAkC,KAAc;AAAA,MACrE;AAAA,IACF;AAAA;AAAA,IAGA,4BAA4B,OAAO,IAAY,WAAmB;AAChE,aAAO,SAAS,YAAY;AAC1B,cAAM,SAAS,MAAM,GAAG,OAAA,EAAS,KAAK,cAAc,EAAE,MAAM,GAAG,eAAe,IAAI,EAAE,CAAC,EAAE,IAAA;AAEvF,YAAI,CAAC,QAAQ;AACX,iBAAO;AAAA,QACT;AAEA,eAAO,OAAO,WAAW;AAAA,MAC3B,GAAG,oDAAoD,EAAE,EAAE;AAAA,IAC7D;AAAA;AAAA,IAGA,6BAA6B,OAAO,WAAmB;AACrD,aAAO,SAAS,YAAY;AAC1B,cAAM,SAAS,MAAM,GAAG,OAAA,EAAS,KAAK,cAAc,EAAE,MAAM,GAAG,eAAe,QAAQ,MAAM,CAAC,EAAE,IAAA;AAE/F,eAAO,OAAO;AAAA,MAChB,GAAG,4CAA4C,MAAM,EAAE;AAAA,IACzD;AAAA;AAAA,IAGA,iBAAiB,OAAO,IAAY,aAAqB;AACvD,UAAI;AACF,cAAM,SAAS,MAAM,GAAG,OAAO,KAAK,EAAE,IAAI,EAAE,OAAO,UAAU,QAAQ,aAAA,CAAc,EAAE,MAAM,GAAG,MAAM,IAAI,EAAE,CAAC,EAAE,UAAA;AAE7G,YAAI,OAAO,WAAW,GAAG;AACvB,iBAAO,cAAc,QAAQ,EAAE;AAAA,QACjC;AAEA,cAAM,cAAc,OAAO,CAAC;AAC5B,YAAI,CAAC,aAAa;AAChB,iBAAO,YAAY,mCAAmC,IAAI,MAAM,8BAA8B,CAAC;AAAA,QACjG;AAEA,eAAO;AAAA,MACT,SAAS,OAAO;AAEd,YAAI,iBAAiB,SAAS,MAAM,QAAQ,SAAS,QAAQ,GAAG;AAC9D,iBAAO,IAAI,wBAAwB;AAAA,YACjC,OAAO;AAAA,YACP,MAAM;AAAA,UAAA,CACP;AAAA,QACH;AAEA,eAAO,YAAY,+BAA+B,KAAc;AAAA,MAClE;AAAA,IACF;AAAA;AAAA,IAGA,kBAAkB,OAAO,IAAY,WAAuB;AAC1D,UAAI;AACF,cAAM,SAAS,MAAM,GAAG,OAAO,KAAK,EAAE,IAAI,EAAE,OAAA,CAAQ,EAAE,MAAM,GAAG,MAAM,IAAI,EAAE,CAAC,EAAE,UAAA;AAE9E,YAAI,OAAO,WAAW,GAAG;AACvB,iBAAO,cAAc,QAAQ,EAAE;AAAA,QACjC;AAEA,cAAM,cAAc,OAAO,CAAC;AAC5B,YAAI,CAAC,aAAa;AAChB,iBAAO,YAAY,mCAAmC,IAAI,MAAM,8BAA8B,CAAC;AAAA,QACjG;AAEA,eAAO;AAAA,MACT,SAAS,OAAO;AACd,eAAO,YAAY,gCAAgC,KAAc;AAAA,MACnE;AAAA,IACF;AAAA;AAAA,IAGA,mBAAmB,OAAO,IAAY,YAAgC;AACpE,UAAI;AACF,cAAM,SAAS,MAAM,GAAG,OAAO,KAAK,EAAE,IAAI,EAAE,QAAA,CAAS,EAAE,MAAM,GAAG,MAAM,IAAI,EAAE,CAAC,EAAE,UAAA;AAE/E,YAAI,OAAO,WAAW,GAAG;AACvB,iBAAO,cAAc,QAAQ,EAAE;AAAA,QACjC;AAEA,cAAM,cAAc,OAAO,CAAC;AAC5B,YAAI,CAAC,aAAa;AAChB,iBAAO,YAAY,mCAAmC,IAAI,MAAM,8BAA8B,CAAC;AAAA,QACjG;AAEA,eAAO;AAAA,MACT,SAAS,OAAO;AACd,eAAO,YAAY,sCAAsC,KAAc;AAAA,MACzE;AAAA,IACF;AAAA;AAAA,IAGA,iCAAiC,OAAO,QAAgB,oBAA4B;AAClF,UAAI;AAEF,cAAM,aAAa,IAAI,KAAK,eAAe;AAE3C,cAAM,SAAS,MAAM,GAClB,OAAO,cAAc,EACrB,MAAM,IAAI,GAAG,eAAe,QAAQ,MAAM,GAAG,GAAG,eAAe,WAAW,UAAU,CAAC,CAAC,EACtF,UAAA;AAEH,eAAO,OAAO;AAAA,MAChB,SAAS,OAAO;AACd,eAAO,YAAY,gDAAgD,KAAc;AAAA,MACnF;AAAA,IACF;AAAA;AAAA,IAGA,YAAY,OAAO,OAAe;AAChC,UAAI;AAEF,cAAM,8BAA8B,MAAM,GAAG,OAAO,cAAc,EAAE,MAAM,GAAG,eAAe,QAAQ,EAAE,CAAC;AACvG,cAAM,mBAAmB,MAAM,GAAG,OAAO,KAAK,EAAE,MAAM,GAAG,MAAM,IAAI,EAAE,CAAC,EAAE,UAAA;AAExE,YAAI,iBAAiB,WAAW,GAAG;AACjC,iBAAO,cAAc,QAAQ,EAAE;AAAA,QACjC;AAEA,eAAO;AAAA,MACT,SAAS,OAAO;AACd,eAAO,YAAY,yBAAyB,KAAc;AAAA,MAC5D;AAAA,IACF;AAAA;AAAA,IAGA,mBAAmB,OAAO,OAAe;AACvC,UAAI;AACF,cAAM,YAAY,KAAK,IAAA;AACvB,cAAM,kBAAkB,WAAW,EAAE,IAAI,SAAS;AAElD,cAAM,SAAS,MAAM,GAClB,OAAO,KAAK,EACZ,IAAI;AAAA,UACH,OAAO;AAAA,UACP,aAAa;AAAA,UACb,QAAQ;AAAA,UACR,SAAS;AAAA,QAAA,CACV,EACA,MAAM,GAAG,MAAM,IAAI,EAAE,CAAC,EACtB,UAAA;AAEH,YAAI,OAAO,WAAW,GAAG;AACvB,iBAAO,cAAc,QAAQ,EAAE;AAAA,QACjC;AAEA,cAAM,cAAc,OAAO,CAAC;AAC5B,YAAI,CAAC,aAAa;AAChB,iBAAO,YAAY,mCAAmC,IAAI,MAAM,8BAA8B,CAAC;AAAA,QACjG;AAGA,eAAO;AAAA,MACT,SAAS,OAAO;AACd,eAAO,YAAY,iCAAiC,KAAc;AAAA,MACpE;AAAA,IACF;AAAA,EAAA;AAEJ;AAKO,SAAS,kBAAkB,SAA0D;AAC1F,QAAM,KAAK,YAAY,OAAO;AAC9B,SAAO,qBAAqB,EAAE;AAChC;AC3VA,eAAsB,cAAc,EAAE,WAA+D;AAEnG,QAAM,OAAO,gBAAgB,OAAO;AACpC,SAAO,GAAG,EAAE,MAAM;AACpB;AAKA,eAAsB,0BAA0B,SAA0C,QAAkF;AAC1K,QAAM,aAAa,kBAAkB,OAAO;AAE5C,QAAM,aAAa,MAAM,WAAW,YAAY,MAAM;AAGtD,MAAI,QAAQ,UAAU,GAAG;AACvB,WAAO;AAAA,EACT;AAEA,QAAM,uBAAuB,MAAM,WAAW,0BAA0B,MAAM;AAG9E,MAAI,QAAQ,oBAAoB,GAAG;AACjC,WAAO;AAAA,EACT;AAEA,SAAO,GAAG;AAAA,IACR,MAAM;AAAA,IACN,gBAAgB;AAAA,EAAA,CACjB;AACH;ACvCO,MAAM,eAAe,cAAkC,IAAI;ACU3D,MAAM,qBAAkC;AAAA,EAC7C,QAAQ;AAAA,EACR,WAAW;AAAA,IACT;AAAA,MACE,MAAM;AAAA,MACN,UAAU;AAAA,IAAA;AAAA,EACZ;AAEJ;ACbO,MAAM,wBAAwB;AAAA,EACnC,WAAW;AAAA,EACX,WAAW;AACb;AAKO,SAAS,wBAAwB,MAAc,QAAqE;AACzH,SAAO;AAAA,IACL,MAAM,UAAU,SAAkD;AAChE,YAAM,EAAE,MAAM,IAAI,SAAA,IAAa;AAE/B,UAAI,CAAC,MAAM;AACT,eAAO,IAAI,0BAA0B;AAAA,MACvC;AAEA,aAAO,SAAS,YAAY;AAC1B,cAAM,OAAO,OAAO;AAEpB,eAAO,MAAM,sBAAsB;AAAA,UACjC,UAAU;AAAA,UACV;AAAA,UACA,SAAS,SAAS;AAAA,QAAA,CACnB;AAAA,MACH,GAAG,4BAA4B,IAAI,EAAE;AAAA,IACvC;AAAA,EAAA;AAEJ;AC7BO,SAAS,8BAA6C;AAC3D,SAAO,wBAAwB,aAAa,OAAM,YAAW;AAC3D,UAAM,EAAE,IAAI,MAAM,SAAA,IAAa;AAE/B,UAAM,IAAI,QAAQ,CAAA,YAAW,WAAW,SAAS,sBAAsB,SAAS,CAAC;AAEjF,WAAO,KAAK,wBAAwB,EAAE,UAAU,aAAa,MAAM,IAAI,SAAS,SAAS,QAAA,CAAS;AAElG,YAAQ,IAAI,qCAAqC,IAAI,OAAO,EAAE,GAAG,MAAM,SAAS,MAAM,MAAM,IAAI,OAAO,EAAE,CAAC;AAAA,EAC5G,CAAC;AACH;ACPO,SAAS,kCAAiD;AAC/D,QAAM,SAAS;AAEf,SAAO,wBAAwB,gBAAgB,OAAM,YAAW;AAC9D,UAAM,EAAE,QAAQ,IAAI,MAAM,aAAa;AAEvC,UAAM,UAAU;AAAA,MACd,kBAAkB;AAAA,QAChB;AAAA,UACE,IAAI,CAAC,EAAE,OAAO,IAAI;AAAA,QAAA;AAAA,MACpB;AAAA,MAEF,MAAM,EAAE,OAAO,KAAA;AAAA,MACf,SAAS,SAAS;AAAA,MAClB,SAAS;AAAA,QACP,EAAE,MAAM,cAAc,OAAO,SAAS,KAAA;AAAA,QACtC,EAAE,MAAM,aAAa,OAAO,SAAS,KAAA;AAAA,MAAK;AAAA,IAC5C;AAGF,UAAM,WAAW,MAAM,MAAM,QAAQ;AAAA,MACnC,QAAQ;AAAA,MACR,SAAS;AAAA,QACP,aAAa;AAAA,QACb,gBAAgB;AAAA,QAChB,QAAQ;AAAA,MAAA;AAAA,MAEV,MAAM,KAAK,UAAU,OAAO;AAAA,IAAA,CAC7B;AAED,QAAI,CAAC,SAAS,IAAI;AAChB,YAAM,YAAY,MAAM,SAAS,KAAA;AACjC,YAAM,IAAI,MAAM,2BAA2B,SAAS,MAAM,MAAM,SAAS,EAAE;AAAA,IAC7E;AAAA,EACF,CAAC;AACH;ACtCO,SAAS,4BAA2C;AACzD,SAAO,wBAAwB,UAAU,OAAM,YAAW;AACxD,UAAM,EAAE,QAAQ,IAAI,MAAM,aAAa;AAEvC,UAAM,WAAW,MAAM,MAAM,iCAAiC;AAAA,MAC5D,QAAQ;AAAA,MACR,SAAS;AAAA,QACP,gBAAgB;AAAA,QAChB,eAAe,UAAU,MAAM;AAAA,MAAA;AAAA,MAEjC,MAAM,KAAK,UAAU;AAAA,QACnB;AAAA,QACA;AAAA,QACA,SAAS,SAAS;AAAA,QAClB,MAAM,SAAS;AAAA,QACf,MAAM,SAAS;AAAA,MAAA,CAChB;AAAA,IAAA,CACF;AAED,QAAI,CAAC,SAAS,IAAI;AAChB,YAAM,YAAY,MAAM,SAAS,KAAA;AACjC,YAAM,IAAI,MAAM,qBAAqB,SAAS,MAAM,MAAM,SAAS,EAAE;AAAA,IACvE;AAAA,EACF,CAAC;AACH;ACTA,IAAI,aAAgC,CAAA;AAQ7B,SAAS,8BAA6C;AAC3D,SAAO;AAAA,IACL,MAAM,UAAU,SAAS;AACvB,YAAM,EAAE,IAAI,MAAM,SAAA,IAAa;AAE/B,UAAI,CAAC,MAAM;AACT,eAAO,IAAI,0BAA0B;AAAA,MACvC;AAGA,iBAAW,KAAK;AAAA,QACd;AAAA,QACA;AAAA,QACA,UAAU;AAAA,UACR,SAAS,SAAS;AAAA,UAClB,MAAM,SAAS;AAAA,UACf,MAAM,SAAS;AAAA,QAAA;AAAA,MACjB,CACD;AAQD,YAAM,eAAe,wBAAwB,aAAa,OAAM,SAAQ;AACtE,cAAM,IAAI,QAAQ,CAAA,YAAW,WAAW,SAAS,sBAAsB,SAAS,CAAC;AAEjF,eAAO,MAAM,wBAAwB;AAAA,UACnC,UAAU;AAAA,UACV,MAAM,KAAK;AAAA,UACX,IAAI,KAAK;AAAA,UACT,SAAS,KAAK,SAAS;AAAA,UACvB,YAAY,KAAK,SAAS,KAAK;AAAA,UAC/B,YAAY,KAAK,SAAS,KAAK;AAAA,QAAA,CAChC;AAAA,MACH,CAAC;AAED,aAAO,aAAa,UAAU,OAAO;AAAA,IACvC;AAAA,EAAA;AAEJ;AChEA,MAAM,mBAAgE;AAAA,EACpE,aAAa;AAAA,EACb,cAAc;AAAA,EACd,QAAQ;AAAA,EACR,aAAa;AACf;AAEO,SAAS,oBAAoB,cAA6C;AAC/E,MAAI,CAAC,gBAAgB,YAAY,GAAG;AAClC,WAAO,IAAI,+BAA+B,YAAY,EAAE;AAAA,EAC1D;AAEA,MAAI;AACF,UAAM,UAAU,iBAAiB,YAAY;AAC7C,UAAM,WAAW,QAAA;AACjB,WAAO,GAAG,QAAQ;AAAA,EACpB,SAAS,OAAO;AACd,WAAO,IAAI,oCAAoC,YAAY,IAAI,QAAW,EAAE,OAAO,OAAO;AAAA,EAC5F;AACF;AAEO,SAAS,gBAAgB,cAAsD;AACpF,SAAO,gBAAgB;AACzB;AAUO,SAAS,kBAAkB,aAA0B,cAAuD;AACjH,SAAO,YAAY,UAAU,KAAK,CAAA,aAAY,SAAS,SAAS,YAAY;AAC9E;ACxBA,eAAsB,SAAS,SAA0C,SAAiD;AACxH,MAAI;AACF,UAAM,EAAE,IAAI,UAAU,MAAM,aAAa,UAAU,iBAAiB,QAAQ,cAAA,IAAkB;AAG9F,UAAM,cAAc,WAAW,SAAS,cAAc,IAAI;AAC1D,UAAM,WAAW,mBAAmB,aAAa,UAAU,mBAAmB;AAE9E,QAAI,CAAC,UAAU;AACb,aAAO,MAAM,qBAAqB,EAAE,iBAAiB,eAAe,aAAa,QAAQ,eAAe,mBAAmB,QAAQ,GAAA,CAAI;AACvI,aAAO,IAAI,8BAA8B;AAAA,IAC3C;AAGA,UAAM,iBAAkB,eAAe,kBAAkB,aAAa,QAAQ,KAAM,kBAAkB,oBAAoB,QAAQ;AAClI,QAAI,CAAC,gBAAgB;AACnB,aAAO,MAAM,iCAAiC,EAAE,UAAU,IAAI,kBAAkB,aAAa,UAAU,IAAI,CAAC,MAA2B,EAAE,IAAI,GAAG;AAChJ,aAAO,IAAI,yCAAyC,QAAQ,EAAE;AAAA,IAChE;AAGA,QAAI,SAAS;AACb,QAAI,CAAC,UAAU,eAAe,QAAQ;AACpC,YAAM,WAAW,YAAY,OAAO;AACpC,eAAS,SAAS,eAAe,MAA+B;AAAA,IAClE;AAGA,UAAM,OAAO,eAAe,eAAe;AAG3C,UAAM,sBAAsB,oBAAoB,QAAQ;AACxD,QAAI,QAAQ,mBAAmB,GAAG;AAChC,aAAO,MAAM,kCAAkC,EAAE,UAAU,IAAI,OAAO,aAAa,mBAAmB,GAAG;AACzG,aAAO;AAAA,IACT;AAGA,UAAM,aAAa,MAAM,oBAAoB,UAAU;AAAA,MACrD,QAAQ,UAAU;AAAA,MAClB;AAAA,MACA;AAAA,MACA,UAAU;AAAA,QACR,SAAS,SAAS;AAAA,QAClB,MAAM,SAAS;AAAA,QACf,MAAM,SAAS;AAAA,MAAA;AAAA,IACjB,CACD;AAED,QAAI,QAAQ,UAAU,GAAG;AACvB,aAAO,MAAM,qBAAqB,EAAE,IAAI,MAAM,UAAU,OAAO,aAAa,UAAU,GAAG;AACzF,aAAO;AAAA,IACT;AAEA,WAAO,GAAG,MAAS;AAAA,EACrB,SAAS,OAAO;AACd,WAAO,MAAM,+BAA+B,EAAE,IAAI,QAAQ,IAAI,OAAc;AAC5E,WAAO,IAAI,wBAAwB,EAAE,OAAO;AAAA,EAC9C;AACF;ACnDA,eAAsB,oBAA2B,UAAsC,MAAa,SAAsD;AAExJ,QAAM,SAAS,MAAM;AAAA,IACnB,SAAS;AAAA,IACT;AAAA,MACE,GAAG;AAAA,MACH,SAAS,SAAS;AAAA,IAAA;AAAA,IAEpB;AAAA,MACE,GAAG;AAAA,MACH,mBAAmB,SAAS,aAAa,SAAS;AAAA,IAAA;AAAA,EACpD;AAGF,SAAO;AAAA,IACL,SAAS,OAAO,WAAW;AAAA,IAC3B,MAAM,OAAO;AAAA,IACb,MAAM,OAAO;AAAA,EAAA;AAEjB;ACFO,SAAS,oBAA2B,EAAE,WAAW,SAAS,aAAyE;AACxI,SAAO;AAAA,IACL;AAAA,IACA;AAAA,IACA;AAAA;AAAA,IAEA,QAAQ,CAAC,UAAiB;AAAA,MACxB,WAAW,UAAU,IAAI;AAAA,MACzB,SAAS,QAAQ,IAAI;AAAA,MACrB;AAAA,IAAA;AAAA,EACF;AAEJ;AC3CO,MAAM,sBAA8D;AAAA,EACzE,OAAO,EAAC,UAAS,OAAA;AAAA,EACjB,OAAO,EAAC,UAAS,UAAA;AAAA,EACjB,OAAO,EAAC,UAAS,OAAA;AAAA,EACjB,OAAO,EAAC,UAAS,UAAA;AAAA,EACjB,QAAQ,EAAC,gBAAe,SAAA;AAAA,EACxB,QAAQ,EAAC,gBAAe,UAAA;AAAA,EACxB,WAAW,EAAC,gBAAe,OAAA;AAAA,EAC3B,QAAQ,EAAC,eAAc,UAAA;AAAA,EACvB,aAAa,EAAC,YAAW,QAAA;AAAA,EACzB,YAAY,EAAC,YAAW,QAAA;AAAA,EACxB,eAAe,EAAC,gBAAe,OAAA;AAAA,EAC/B,cAAc,EAAC,gBAAe,WAAA;AAAA,EAC9B,YAAY,EAAC,eAAc,SAAQ,eAAc,MAAA;AAAA,EACjD,iBAAiB,EAAC,eAAc,6BAAA;AAAA,EAChC,YAAY,EAAC,mBAAkB,4BAAA;AAAA,EAC/B,YAAY,EAAC,mBAAkB,OAAA;AAAA,EAC/B,OAAO,EAAC,WAAU,UAAA;AAAA,EAClB,OAAO,EAAC,WAAU,UAAA;AAAA,EAClB,QAAQ,EAAC,iBAAgB,UAAA;AAAA,EACzB,QAAQ,EAAC,gBAAe,UAAA;AAAA,EACxB,SAAS,EAAC,cAAa,SAAA;AAAA,EACvB,QAAQ,EAAC,iBAAgB,UAAA;AAAA,EACzB,eAAe,EAAC,aAAY,SAAA;AAAA,EAC5B,aAAa,EAAC,aAAY,OAAA;AAAA,EAC1B,aAAa,EAAC,cAAa,0HAAA;AAAA,EAC3B,YAAY,EAAC,YAAW,YAAW,cAAa,+BAAA;AAAA,EAChD,WAAW,EAAC,YAAW,YAAW,cAAa,8BAAA;AAAA,EAC/C,mBAAmB,EAAC,cAAa,QAAA;AAAA,EACjC,aAAa,EAAC,cAAa,MAAA;AAAA,EAC3B,oBAAoB,EAAC,SAAQ,4BAAA;AAAA,EAC7B,mBAAmB,EAAC,SAAQ,6BAAA;AAAA,EAC5B,yBAAyB,EAAC,SAAQ,6BAAA;AAAA,EAClC,UAAU,EAAC,aAAY,SAAA;AAAA,EACvB,gBAAgB,EAAC,sBAAqB,OAAA;AAAA,EACtC,aAAa,EAAC,sBAAqB,YAAA;AAAA,EACnC,QAAQ,EAAC,SAAQ,4HAAA;AACnB;AAEO,MAAM,2BAA2B;AAAA,EACtC;AAAA,IACE,OAAO;AAAA,IACP,WAAW,CAAC,aAA+B,EAAE,UAAU,QAAQ,CAAC,EAAA;AAAA,EAAE;AAAA,EAEpE;AAAA,IACE,OAAO;AAAA,IACP,WAAW,CAAC,aAA+B,EAAE,eAAe,QAAQ,CAAC,EAAA;AAAA,EAAE;AAE3E;AAEO,MAAM,sBAAyC;AAAA,EACpD,QAAQ;AAAA,EACR,iBAAiB;AACnB;ACnDO,MAAM,+BAA+B,oBAAoB;AAAA,EAC9D,WAAW,CAAC,EAAE,MAAM,OAAAA,QAAO,sBACzB,qBAAC,MAAA,EAAK,MAAK,MACT,UAAA;AAAA,IAAA,oBAAC,MAAA,EAAK;AAAA,wBACL,MAAA,EAAK,WAAU,sBACd,UAAA,qBAAC,WAAA,EAAU,WAAU,qDACnB,UAAA;AAAA,MAAA,oBAAC,SAAA,EAAQ,WAAU,+BACjB,UAAA,oBAAC,WAAQ,OAAO,GAAG,sCAAwB,EAAA,CAC7C;AAAA,MAEA,qBAAC,SAAA,EAAQ,WAAU,kEACjB,UAAA;AAAA,QAAA,qBAAC,MAAA,EAAK,UAAA;AAAA,UAAA;AAAA,UAC4B,oBAAC,YAAQ,UAAAA,OAAA,CAAM;AAAA,UAAS;AAAA,QAAA,GAC1D;AAAA,QACA,oBAAC,QAAK,UAAA,yEAAA,CAAsE;AAAA,QAC5E,oBAAC,QAAK,UAAA,oEAAA,CAAiE;AAAA,MAAA,GACzE;AAAA,MAEA,oBAAC,WAAQ,WAAU,kEACjB,8BAAC,MAAA,EAAK,WAAU,4DAA4D,UAAA,KAAA,CAAK,EAAA,CACnF;AAAA,MAEA,oBAAC,SAAA,EAAQ,WAAU,iDACjB,+BAAC,MAAA,EAAK,UAAA;AAAA,QAAA;AAAA,QACyB,oBAAC,YAAO,UAAA,YAAA,CAAS;AAAA,QAAS;AAAA,MAAA,EAAA,CACzD,EAAA,CACF;AAAA,MAEC,mBACC,qBAAC,SAAA,EAAQ,WAAU,4CACjB,UAAA;AAAA,QAAA,oBAAC,MAAA,EAAK,WAAU,QACd,UAAA,oBAAC,MAAA,EAAK,MAAM,iBAAiB,WAAU,0BAAyB,UAAA,wCAAA,CAEhE,GACF;AAAA,QAEA,qBAAC,MAAA,EAAK,WAAU,QACd,UAAA;AAAA,UAAA,oBAAC,QAAK,UAAA,uEAAA,CAAoE;AAAA,8BACzE,MAAA,EAAK,MAAM,iBAAiB,WAAU,aACpC,UAAA,gBAAA,CACH;AAAA,QAAA,EAAA,CACF;AAAA,MAAA,GACF;AAAA,MAGF,qBAAC,SAAA,EAAQ,WAAU,iDACjB,UAAA;AAAA,QAAA,oBAAC,QAAK,UAAA,gJAAA,CAA6I;AAAA,4BAClJ,SAAA,EAAQ,OAAO,GAAG,WAAU,oBAAmB,UAAA,2CAEhD;AAAA,QACA,qBAAC,SAAA,EAAQ,WAAU,8BACjB,UAAA;AAAA,UAAA,qBAAC,MAAA,EAAK,WAAU,UAAS,UAAA;AAAA,YAAA;AAAA,YACrB,oBAAC,YAAO,UAAA,sCAAA,CAAmC;AAAA,UAAA,GAC/C;AAAA,UACA,qBAAC,MAAA,EAAK,WAAU,UAAS,UAAA;AAAA,YAAA;AAAA,YAA6BA;AAAA,UAAA,GAAM;AAAA,UAC5D,oBAAC,MAAA,EAAK,WAAU,UAAS,UAAA,+CAA2C;AAAA,UACpE,oBAAC,MAAA,EAAK,WAAU,UAAS,UAAA,kCAAA,CAA+B;AAAA,QAAA,EAAA,CAC1D;AAAA,MAAA,EAAA,CACF;AAAA,IAAA,EAAA,CACF,EAAA,CACF;AAAA,EAAA,GACF;AAAA,EAGF,SAAS,MAAM;AAAA,EAEf,WAAW;AACb,CAAC;ACnDD,SAAS,aAAa,OAA2B;AAC/C,QAAM,WAAW;AACjB,QAAM,aAAa,MAAM,QAAQ,eAAe,EAAE,EAAE,YAAA;AAEpD,MAAI,OAAO;AACX,aAAW,QAAQ,YAAY;AAC7B,UAAM,QAAQ,SAAS,QAAQ,IAAI;AACnC,QAAI,UAAU,GAAI,OAAM,IAAI,MAAM,6BAA6B,IAAI,EAAE;AACrE,YAAQ,MAAM,SAAS,CAAC,EAAE,SAAS,GAAG,GAAG;AAAA,EAC3C;AAEA,QAAM,QAAQ,IAAI,WAAW,KAAK,MAAM,KAAK,SAAS,CAAC,CAAC;AACxD,WAAS,IAAI,GAAG,IAAI,MAAM,QAAQ,KAAK;AACrC,UAAM,CAAC,IAAI,OAAO,SAAS,KAAK,MAAM,IAAI,IAAI,IAAI,KAAK,CAAC,GAAG,CAAC;AAAA,EAC9D;AAEA,SAAO;AACT;AAEA,SAAS,gBAAgB,QAAyC;AAChE,MAAI,kBAAkB,WAAY,QAAO;AAEzC,MAAI;AACF,WAAO,aAAa,MAAM;AAAA,EAC5B,QAAQ;AACN,WAAO,IAAI,YAAA,EAAc,OAAO,MAAM;AAAA,EACxC;AACF;AAEA,SAAS,cAAc,KAAyB;AAC9C,QAAM,QAAQ,IAAI,WAAW,CAAC;AAC9B,QAAM,OAAO,KAAK,MAAM,MAAM,UAAW;AACzC,QAAM,MAAM,MAAM;AAElB,QAAM,CAAC,IAAK,SAAS,KAAM;AAC3B,QAAM,CAAC,IAAK,SAAS,KAAM;AAC3B,QAAM,CAAC,IAAK,SAAS,IAAK;AAC1B,QAAM,CAAC,IAAI,OAAO;AAClB,QAAM,CAAC,IAAK,QAAQ,KAAM;AAC1B,QAAM,CAAC,IAAK,QAAQ,KAAM;AAC1B,QAAM,CAAC,IAAK,QAAQ,IAAK;AACzB,QAAM,CAAC,IAAI,MAAM;AAEjB,SAAO;AACT;AAEA,eAAe,KAAK,WAAmB,KAAiB,MAAuC;AAE7F,QAAM,YAAY,IAAI,YAAY,IAAI,MAAM;AAC5C,MAAI,WAAW,SAAS,EAAE,IAAI,GAAG;AAEjC,QAAM,aAAa,IAAI,YAAY,KAAK,MAAM;AAC9C,MAAI,WAAW,UAAU,EAAE,IAAI,IAAI;AAEnC,QAAM,YAAY,MAAM,OAAO,OAAO,UAAU,OAAO,WAAW,EAAE,MAAM,QAAQ,MAAM,UAAA,GAAa,OAAO,CAAC,MAAM,CAAC;AACpH,QAAM,YAAY,MAAM,OAAO,OAAO,KAAK,QAAQ,WAAW,UAAU;AACxE,SAAO,IAAI,WAAW,SAAS;AACjC;AAEA,SAAS,kBAAkB,MAAkB,QAAwB;AACnE,QAAM,SAAS,KAAK,KAAK,SAAS,CAAC,IAAI;AACvC,QAAM,QAAS,KAAK,MAAM,IAAI,QAAS,MAAQ,KAAK,SAAS,CAAC,IAAI,QAAS,MAAQ,KAAK,SAAS,CAAC,IAAI,QAAS,IAAM,KAAK,SAAS,CAAC,IAAI;AAExI,UAAQ,OAAO,MAAM,QAAQ,WAAW,SAAS,QAAQ,GAAG;AAC9D;AAEO,SAAS,eAAe,SAAS,IAAgB;AACtD,MAAI,UAAU,EAAG,OAAM,IAAI,MAAM,yBAAyB;AAC1D,SAAO,OAAO,gBAAgB,IAAI,WAAW,MAAM,CAAC;AACtD;AAEO,SAAS,aAAa,OAA2B;AACtD,QAAM,WAAW;AACjB,MAAI,OAAO;AAEX,aAAW,QAAQ,OAAO;AACxB,YAAQ,KAAK,SAAS,CAAC,EAAE,SAAS,GAAG,GAAG;AAAA,EAC1C;AAEA,MAAI,SAAS;AACb,WAAS,IAAI,GAAG,IAAI,KAAK,QAAQ,KAAK,GAAG;AACvC,UAAM,QAAQ,KAAK,MAAM,GAAG,IAAI,CAAC,EAAE,OAAO,GAAG,GAAG;AAChD,cAAU,SAAS,OAAO,SAAS,OAAO,CAAC,CAAC;AAAA,EAC9C;AAEA,SAAO;AACT;AAEA,eAAsB,aAAa,SAAuC;AACxE,QAAM,EAAE,QAAQ,YAAY,KAAK,IAAA,GAAO,SAAS,IAAI,SAAS,GAAG,YAAY,QAAA,IAAY;AAEzF,MAAI,UAAU,EAAG,OAAM,IAAI,MAAM,yBAAyB;AAE1D,QAAM,UAAU,KAAK,MAAM,YAAY,MAAO,MAAM;AACpD,QAAM,cAAc,gBAAgB,MAAM;AAC1C,QAAM,eAAe,cAAc,OAAO;AAC1C,QAAM,WAAW,cAAc,UAAU,UAAU,cAAc,YAAY,YAAY;AAEzF,QAAM,OAAO,MAAM,KAAK,UAAU,aAAa,YAAY;AAC3D,SAAO,kBAAkB,MAAM,MAAM;AACvC;AAEA,eAAsB,WAAW,SAA6E;AAC5G,QAAM,EAAE,OAAO,SAAS,GAAG,YAAY,KAAK,IAAA,GAAO,SAAS,IAAI,GAAG,YAAA,IAAgB;AAEnF,MAAI,CAAC,QAAQ,KAAK,KAAK,GAAG;AACxB,WAAO,EAAE,OAAO,MAAA;AAAA,EAClB;AAEA,QAAM,gBAAgB,KAAK,MAAM,YAAY,MAAO,MAAM;AAE1D,WAAS,IAAI,CAAC,QAAQ,KAAK,QAAQ,KAAK;AACtC,UAAM,aAAa,gBAAgB;AACnC,UAAM,gBAAgB,aAAa,SAAS;AAC5C,UAAM,gBAAgB,MAAM,aAAa;AAAA,MACvC,GAAG;AAAA,MACH,WAAW;AAAA,MACX;AAAA,IAAA,CACD;AAED,QAAI,UAAU,eAAe;AAC3B,aAAO,EAAE,OAAO,MAAM,WAAW,cAAA;AAAA,IACnC;AAAA,EACF;AAEA,SAAO,EAAE,OAAO,MAAA;AAClB;AAEA,MAAM,gBAAgB,CAAC,SAA8BA,WAAkB,QAAQ,OAAO,IAAIA,MAAK;AAE/F,eAAsB,uBAAuBA,QAAe,SAA8B,SAA0C,UAA6D;AAC/L,MAAI;AACF,UAAM,aAAa,WAAW,SAAS,iBAAiB;AACxD,QAAI,CAAC,YAAY;AACf,aAAO,IAAI,8BAA8B;AAAA,IAC3C;AAEA,UAAM,MAAM,YAAY,OAAO;AAC/B,UAAM,KAAK,IAAI,WAAW,QAAQ,SAA6B;AAC/D,QAAI,CAAC,IAAI;AACP,aAAO,IAAI,eAAe,WAAW,QAAQ,SAAS,aAAa;AAAA,IACrE;AAEA,UAAM,SAAS,aAAa,gBAAgB;AAC5C,UAAM,SAAS,WAAW,aAAa;AACvC,UAAM,SAAS,WAAW,aAAa;AAEvC,UAAM,OAAO,MAAM,aAAa,EAAE,QAAQ,QAAQ,QAAQ;AAE1D,UAAM,mBAAuC;AAAA,MAC3C;AAAA,MACA,UAAU,KAAK,IAAA,IAAQ,SAAS;AAAA,MAChC,UAAU;AAAA,MACV;AAAA,MACA;AAAA,IAAA;AAGF,UAAM,GAAG,IAAI,cAAc,SAASA,MAAK,GAAG,KAAK,UAAU,gBAAgB,GAAG,EAAE,eAAe,QAAQ;AAEvG,WAAO,KAAK,6BAA6B,EAAE,OAAAA,QAAO,SAAS;AAE3D,WAAO,GAAG,IAAI;AAAA,EAChB,SAAS,OAAO;AACd,WAAO,MAAM,qCAAqC;AAAA,MAChD,OAAAA;AAAA,MACA;AAAA,MACA,OAAO,iBAAiB,QAAQ,MAAM,UAAU,OAAO,KAAK;AAAA,MAC5D,OAAO,iBAAiB,QAAQ,MAAM,QAAQ;AAAA,IAAA,CAC/C;AACD,WAAO,IAAI,sCAAsC,EAAE,OAAO;AAAA,EAC5D;AACF;AAEA,eAAsB,WAAWA,QAAe,MAAc,SAA8B,SAA+E;AACzK,MAAI;AACF,UAAM,aAAa,WAAW,SAAS,iBAAiB;AACxD,QAAI,CAAC,YAAY;AACf,aAAO,IAAI,8BAA8B;AAAA,IAC3C;AAEA,UAAM,MAAM,YAAY,OAAO;AAC/B,UAAM,KAAK,IAAI,WAAW,QAAQ,SAA6B;AAC/D,QAAI,CAAC,IAAI;AACP,aAAO,IAAI,eAAe,WAAW,QAAQ,SAAS,aAAa;AAAA,IACrE;AAEA,UAAM,QAAQ,cAAc,SAASA,MAAK;AAC1C,UAAM,aAAa,MAAM,GAAG,IAAI,KAAK;AAErC,QAAI,CAAC,YAAY;AACf,aAAO,QAAQ,+BAA+B,EAAE,OAAAA,QAAO,SAAS;AAChE,aAAO,IAAI,wCAAwC;AAAA,IACrD;AAEA,UAAM,eAAmC,KAAK,MAAM,UAAU;AAG9D,QAAI,aAAa,YAAY,SAAS;AACpC,aAAO,QAAQ,iCAAiC;AAAA,QAC9C,OAAAA;AAAA,QACA,UAAU;AAAA,QACV,QAAQ,aAAa;AAAA,MAAA,CACtB;AACD,aAAO,IAAI,2BAA2B;AAAA,IACxC;AAGA,QAAI,aAAa,YAAY,WAAW,aAAa,aAAa;AAChE,YAAM,GAAG,OAAO,KAAK;AACrB,aAAO,QAAQ,6BAA6B,EAAE,OAAAA,QAAO,SAAS;AAC9D,aAAO,IAAI,uCAAuC;AAAA,IACpD;AAGA,QAAI,KAAK,QAAQ,aAAa,UAAU;AACtC,YAAM,GAAG,OAAO,KAAK;AACrB,aAAO,QAAQ,wBAAwB,EAAE,OAAAA,QAAO,SAAS;AACzD,aAAO,IAAI,+BAA+B;AAAA,IAC5C;AAGA,UAAM,SAAS,MAAM,WAAW;AAAA,MAC9B,QAAQ,aAAa;AAAA,MACrB,OAAO;AAAA,MACP,QAAQ,WAAW,aAAa;AAAA,MAChC,QAAQ,WAAW,aAAa;AAAA,MAChC,QAAQ,WAAW,aAAa;AAAA,IAAA,CACjC;AAED,QAAI,CAAC,OAAO,OAAO;AAEjB,YAAM,GAAG,IAAI,OAAO,KAAK,UAAU,EAAE,GAAG,cAAc,UAAU,aAAa,WAAW,EAAA,CAAG,GAAG,EAAE,eAAe,WAAW,aAAa,QAAQ;AAC/I,aAAO,QAAQ,6BAA6B,EAAE,OAAAA,QAAO,SAAS,UAAU,aAAa,WAAW,GAAG;AACnG,aAAO,IAAI,2BAA2B;AAAA,IACxC;AAGA,UAAM,GAAG,OAAO,KAAK;AACrB,WAAO,KAAK,8BAA8B,EAAE,OAAAA,QAAO,SAAS;AAE5D,WAAO,GAAG,YAAY;AAAA,EACxB,SAAS,OAAO;AACd,WAAO,MAAM,yCAAyC;AAAA,MACpD,OAAAA;AAAA,MACA;AAAA,MACA,OAAO,iBAAiB,QAAQ,MAAM,UAAU,OAAO,KAAK;AAAA,IAAA,CAC7D;AACD,WAAO,IAAI,yBAAyB,EAAE,OAAO;AAAA,EAC/C;AACF;ACzQA,eAAe,yBAAyBA,QAAe,SAA0C,iBAAiD;AAChJ,MAAI;AAEF,UAAM,aAAa,MAAM,uBAAuBA,QAAO,YAAY,SAAS,EAAE,OAAAA,QAAO;AAErF,QAAI,QAAQ,UAAU,GAAG;AACvB,aAAO,MAAM,gDAAgD,EAAE,OAAAA,QAAO,OAAO,aAAa,UAAU,GAAG;AACvG,aAAO;AAAA,IACT;AAEA,UAAM,OAAO;AAGb,UAAM,gBAAgB,MAAM,oBAAoB,8BAA8B;AAAA,MAC5E;AAAA,MACA,OAAAA;AAAA,MACA;AAAA,IAAA,CACD;AAGD,UAAM,aAAa,MAAM,SAAS,SAAS,EAAE,IAAIA,QAAO,UAAU,eAAe;AAEjF,QAAI,QAAQ,UAAU,GAAG;AACvB,aAAO,MAAM,qCAAqC,EAAE,OAAAA,QAAO,OAAO,aAAa,UAAU,GAAG;AAC5F,aAAO;AAAA,IACT;AAEA,WAAO,KAAK,8BAA8B,EAAE,OAAAA,OAAA,CAAO;AACnD,WAAO,GAAG,MAAS;AAAA,EACrB,SAAS,OAAO;AACd,WAAO,MAAM,0CAA0C,EAAE,OAAAA,QAAO,OAAO,iBAAiB,QAAQ,MAAM,UAAU,iBAAiB,OAAO,iBAAiB,QAAQ,MAAM,QAAQ,QAAW;AAC1L,WAAO,IAAI,wCAAwC,EAAE,OAAO;AAAA,EAC9D;AACF;AAKA,eAAsB,uBAAuBA,QAAe,SAA0C,iBAAwD;AAC5J,QAAM,aAAa,kBAAkB,OAAO;AAC5C,QAAM,aAAa,MAAM,WAAW,eAAeA,MAAK;AAExD,MAAI,QAAQ,UAAU,GAAG;AACvB,WAAO,KAAK,oCAAoC,EAAE,OAAAA,OAAA,CAAO;AACzD,WAAO,GAAG,IAAI;AAAA,EAChB;AAEA,QAAM,OAAO;AACb,QAAM,qBAAqB,MAAM,WAAW,iBAAiB,KAAK,IAAI,aAAa;AAEnF,MAAI,QAAQ,kBAAkB,GAAG;AAC/B,WAAO,MAAM,yCAAyC,EAAE,QAAQ,KAAK,IAAI,OAAAA,QAAO,OAAO,aAAa,kBAAkB,EAAA,CAAG;AACzH,WAAO;AAAA,EACT;AAEA,QAAM,qBAAqB,MAAM,yBAAyBA,QAAO,SAAS,eAAe;AAEzF,MAAI,QAAQ,kBAAkB,GAAG;AAC/B,WAAO,MAAM,8CAA8C,EAAE,QAAQ,KAAK,IAAI,OAAAA,QAAO,OAAO,aAAa,kBAAkB,EAAA,CAAG;AAC9H,UAAM,WAAW,iBAAiB,KAAK,IAAI,KAAK,MAAM;AACtD,WAAO;AAAA,EACT;AAEA,SAAO,GAAG,kBAAkB;AAC9B;AClEA,MAAM,oBAAoB,OAAO;AAAA,EAC/B,OAAO,KAAK,UAAU,UAAU,GAAG,mBAAmB,GAAG,MAAM,+BAA+B,CAAC;AACjG,CAAC;AAeD,eAAsB,cAAc,EAAE,WAA8B;AAClE,QAAM,QAAQ,iBAAiB,OAAO;AAEtC,SAAO,UAAU;AAAA,IACf;AAAA,EAAA,CACD;AACH;AAMA,eAAsB,cAAc,EAAE,SAAS,WAA8B;AAC3E,QAAM,WAAW,MAAM,QAAQ,SAAA;AAC/B,QAAM,aAAa,WAAW,SAAS,iBAAiB;AAGxD,QAAM,WAA2B;AAAA;AAAA;AAAA;AAAA,IAI/B,SAAS,OAAOG,cAAuB;AAErC,YAAM,mBAAmB,MAAM,iBAAiB,mBAAmBA,SAAQ;AAC3E,UAAI,QAAQ,gBAAgB,GAAG;AAC7B,eAAO;AAAA,MACT;AAEA,YAAM,EAAE,OAAAH,OAAAA,IAAU;AAGlB,YAAMI,UAAS,MAAM,uBAAuBJ,QAAO,OAAO;AAE1D,UAAI,QAAQI,OAAM,GAAG;AAEnB,YAAI,cAAcA,OAAM,GAAG;AACzB,iBAAO,MAAM,8BAA8B,EAAE,OAAAJ,QAAO,OAAO,aAAaI,OAAM,GAAG;AAAA,QACnF;AACA,eAAOA;AAAAA,MACT;AAEA,YAAM,OAAOA;AAGb,UAAI,MAAM;AACR,cAAM,gBAAgB,MAAM,kBAAkB,SAAS,EAAE,MAAM;AAE/D,YAAI,QAAQ,aAAa,GAAG;AAE1B,cAAI,cAAc,aAAa,GAAG;AAChC,mBAAO,MAAM,gCAAgC,EAAE,QAAQ,KAAK,IAAI,OAAAJ,QAAO,OAAO,aAAa,aAAa,EAAA,CAAG;AAAA,UAC7G;AACA,iBAAO,IAAI,mCAAmC;AAAA,QAChD;AAGA,eAAO,GAAG;AAAA,UACR,SAAS;AAAA,UACT,YAAY,YAAY,OAAO,UAAU,kBAAkB;AAAA,UAC3D,eAAe;AAAA,QAAA,CAChB;AAAA,MACH;AAGA,aAAO,GAAG;AAAA,QACR,SAAS;AAAA,MAAA,CACV;AAAA,IACH;AAAA,EAAA;AAIF,QAAM,SAAS,MAAM,aAAa,UAAU,QAAQ;AAEpD,MAAI,QAAQ,MAAM,GAAG;AAEnB,QAAI,cAAc,MAAM,GAAG;AACzB,aAAO,MAAM,wBAAwB,EAAE,OAAO,aAAa,MAAM,GAAG;AACpE,uBAAiB,OAAO,SAAS,OAAO,MAAa;AAAA,IACvD;AAGA,WAAO,aAAa,MAAM;AAAA,EAC5B;AAEA,QAAM,aAAa;AAGnB,MAAI,WAAW,cAAc,WAAW,eAAe;AACrD,UAAM,gBAAgB,WAAW,YAAY;AAAA,MAC3C,SAAS,EAAE,cAAc,WAAW,cAAA;AAAA,IAAc,CACnD;AAAA,EACH;AAGA,SAAO,UAAU,MAAM;AACzB;AC1HO,MAAM,sBAAsB;AAAA,EACjC,OAAO;AAAA,EACP,OAAO;AACT;AAGO,MAAM,kBAAkB;AAAA,EAC7B,mBAAmB;AAAA;AAAA,EACnB,gBAAgB;AAAA;AAAA,EAChB,cAAc;AAAA;AAAA,EACd,mBAAmB;AAAA;AAAA,EACnB,uBAAuB;AAAA;AACzB;AAGO,MAAM,oBAAoB;AAAA,EAC/B,UAAU;AAAA,EACV,QAAQ;AAAA,EACR,KAAK;AAAA,EACL,KAAK;AAGP;AAGO,MAAM,oBAAoB;AAAA,EAC/B,MAAM;AAAA,EACN,OAAO;AAAA,EACP,MAAM;AAAA,EACN,OAAO;AAAA,EACP,OAAO;AACT;AAGO,MAAM,eAAe;AAAA,EAC1B,UAAU;AAAA,EACV,gBAAgB;AAClB;AAGO,MAAM,sBAAsB;AAAA,EACjC,iBAAiB;AAAA;AAAA,EACjB,cAAc;AAAA;AAChB;AAKO,MAAM,sBAAyE;AAAA,EACpF,UAAU;AAAA,IACR,MAAM,aAAa;AAAA,IACnB,QAAQ;AAAA,IACR,OAAO;AAAA,IACP,WAAW;AAAA,IACX,YAAY,CAAC,kBAAkB,UAAU,kBAAkB,MAAM;AAAA,EAAA;AAAA,EAEnE,kBAAkB;AAAA,IAChB,MAAM,aAAa;AAAA,IACnB,QAAQ;AAAA,IACR,OAAO;AAAA,IACP,WAAW;AAAA,IACX,YAAY,CAAC,kBAAkB,KAAK,kBAAkB,KAAK,kBAAkB,MAAM;AAAA,EAAA;AAEvF;AAKO,MAAM,kDAAkC,IAAsC;AAAA,EACnF,CAAC,QAAQ,MAAM,kBAAkB,IAAI;AAAA,EACrC;AAAA,IACE;AAAA,IACA,CAAA,YAAW;AACT,UAAI,QAAQ,OAAO,QAAQ,IAAI,SAAS,GAAG;AACzC,eAAO,kBAAkB;AAAA,MAC3B;AACA,UAAI,QAAQ,OAAO,CAAC,QAAQ,KAAK;AAC/B,eAAO,kBAAkB;AAAA,MAC3B;AACA,aAAO,kBAAkB;AAAA,IAC3B;AAAA,EAAA;AAAA,EAEF;AAAA,IACE;AAAA,IACA,CAAA,YAAW;AACT,UAAI,QAAQ,OAAO,QAAQ,IAAI,SAAS,GAAG;AACzC,eAAO,kBAAkB;AAAA,MAC3B;AACA,aAAO,kBAAkB;AAAA,IAC3B;AAAA,EAAA;AAAA,EAEF,CAAC,eAAe,MAAM,kBAAkB,KAAK;AAAA,EAC7C,CAAC,qBAAqB,MAAM,kBAAkB,KAAK;AAAA,EACnD,CAAC,OAAO,MAAM,kBAAkB,KAAK;AAAA,EACrC,CAAC,SAAS,MAAM,kBAAkB,KAAK;AACzC,CAAC;AAEM,IAAK,sCAAAK,uBAAL;AACLA,qBAAA,mBAAA,IAAoB;AACpBA,qBAAA,gBAAA,IAAiB;AACjBA,qBAAA,cAAA,IAAe;AACfA,qBAAA,kBAAA,IAAmB;AACnBA,qBAAA,iBAAA,IAAkB;AAClBA,qBAAA,kBAAA,IAAmB;AACnBA,qBAAA,uBAAA,IAAwB;AACxBA,qBAAA,oBAAA,IAAqB;AACrBA,qBAAA,mBAAA,IAAoB;AACpBA,qBAAA,oBAAA,IAAqB;AACrBA,qBAAA,SAAA,IAAU;AAXA,SAAAA;AAAA,GAAA,qBAAA,CAAA,CAAA;AAkBL,MAAM,8CAA8B,IAA6C;AAAA,EACtF,CAAC,qBAAqC,MAAM,yDAAyD;AAAA,EACrG,CAAC,qBAAqC,MAAM,+DAA+D;AAAA,EAC3G,CAAC,mBAAmC,MAAM,yGAAyG;AAAA,EACnJ,CAAC,sBAAsC,MAAM,8DAA8D;AAAA,EAC3G,CAAC,kBAAkC,MAAM,8EAA8E;AAAA,EACvH,CAAC,gBAAgC,MAAM,uDAAuD;AAAA,EAC9F,CAAC,yBAAyC,MAAM,2FAA2F;AAAA,EAC3I,CAAC,oBAAoC,MAAM,2FAA2F;AAAA,EACtI,CAAC,sBAAsC,CAAA,cAAc,cAAc,iBAAiB,mDAAmD,0EAA2E;AAAA,EAClN;AAAA,IACE;AAAA,IACA,CAAA,cAAc,cAAc,iBAAiB,mEAAmE;AAAA,EAAA;AAAA,EAElH,CAAC,WAA2B,CAAA,cAAc,cAAc,iBAAiB,2CAA2C,0CAA2C;AACjK,CAAC;AAGM,SAAS,oBAAoB,QAA4B;AAC9D,QAAM,eAAe,MAAM,KAAK,MAAM,EACnC,IAAI,CAAA,MAAK,EAAE,SAAS,EAAE,EAAE,SAAS,GAAG,GAAG,CAAC,EACxC,KAAK,EAAE;AAEV,SAAO,CAAC,aAAa,MAAM,GAAG,CAAC,GAAG,aAAa,MAAM,GAAG,EAAE,GAAG,aAAa,MAAM,IAAI,EAAE,GAAG,aAAa,MAAM,IAAI,EAAE,GAAG,aAAa,MAAM,IAAI,EAAE,CAAC,EAAE,KAAK,GAAG;AAC3J;AAEO,SAAS,iBAAiB,QAA6B;AAC5D,SAAO,MAAM,KAAK,MAAM,EAAE,MAAM,CAAA,SAAQ,SAAS,CAAC;AACpD;ACxHA,SAAS,cAAc,YAAqC;AAC1D,QAAM,SAAS,IAAI,YAAY,WAAW,UAAU;AACpD,MAAI,WAAW,MAAM,EAAE,IAAI,UAAU;AACrC,SAAO;AACT;AAKA,SAAS,mBAAmB,mBAA4E;AACtG,QAAM,QAAQ,kBAAkB,SAAS;AAEzC,QAAM,oBAAoB,QAAQ,oBAAoB,qBAAqB;AAC3E,QAAM,cAAc,QAAQ,oBAAoB,kBAAkB;AAElE,SAAO,EAAE,kBAAkB,WAAA;AAC7B;AAKA,SAAS,wBAAwB,YAAkC;AACjE,SAAO,CAAC,GAAG,WAAW,UAAU;AAClC;AAKA,SAAS,uBAAuB,mBAAgC;AAC9D,MAAI;AACF,UAAM,MAAM,kBAAkB;AAC9B,UAAM,UAAU,kBAAkB;AAElC,UAAM,UAAU,4BAA4B,IAAI,GAAG;AACnD,QAAI,SAAS;AACX,aAAO,QAAQ,OAAO;AAAA,IACxB;AAEA,WAAO,QAAQ,uCAAuC,EAAE,QAAQ,KAAK;AACrE,WAAO,kBAAkB;AAAA,EAC3B,SAAS,OAAO;AACd,WAAO,MAAM,yCAAyC;AAAA,MACpD,OAAO,iBAAiB,QAAQ,MAAM,UAAU;AAAA,IAAA,CACjD;AACD,WAAO,kBAAkB;AAAA,EAC3B;AACF;AAKA,SAAS,iCAAiC,YAAgC;AAExE,MAAI,WAAW,WAAW,aAAa,WAAW,UAAU,kBAAkB,WAAW,UAAU,UAAU;AAC3G,WAAO,GAAG,WAAW,MAAM,IAAI,WAAW,KAAK;AAAA,EACjD;AAGA,QAAM,aAAa,WAAW,SAAS,aAAa,qBAAqB;AACzE,QAAM,aAAY,oBAAI,KAAA,GAAO,mBAAmB,SAAS;AAAA,IACvD,OAAO;AAAA,IACP,KAAK;AAAA,EAAA,CACN;AAED,SAAO,GAAG,UAAU,KAAK,SAAS;AACpC;AAKA,eAAe,sBAAsB,QAAoB,YAA+C;AAEtG,MAAI,iBAAiB,MAAM,GAAG;AAC5B,WAAO,oBAAoB;AAAA,EAC7B;AAEA,QAAM,OAAO,oBAAoB,MAAM;AAGvC,MAAI,YAAY;AACd,QAAI;AACF,YAAM,UAAU,MAAM,WAAW,IAAI,UAAU,IAAI,IAAI,MAAM;AAC7D,UAAI,SAAS;AACX,eAAO,MAAM,uBAAuB,EAAE,KAAA,CAAM;AAC5C,eAAO;AAAA,MACT;AAAA,IACF,SAAS,OAAO;AACd,aAAO,QAAQ,gCAAgC;AAAA,QAC7C;AAAA,QACA,OAAO,iBAAiB,QAAQ,MAAM,UAAU;AAAA,MAAA,CACjD;AAAA,IACH;AAAA,EACF;AAGA,SAAO,MAAM,wBAAwB,EAAE,KAAA,CAAM;AAC7C,SAAO,oBAAoB,gBAAgB;AAC7C;AAEO,SAAS,wBAAwB,MAAqC,WAAsD;AACjI,MAAI,CAAC,MAAM;AACT,WAAO,wBAAwB,IAAI,kBAAkB,OAAO,IAAI,SAAS,KAAK;AAAA,EAChF;AAEA,QAAM,kBAAkB,wBAAwB,IAAI,IAAI;AACxD,SAAO,kBAAkB,gBAAgB,SAAS,IAAI,wBAAwB,IAAI,kBAAkB,OAAO,IAAI,SAAS,KAAK;AAC/H;AAKO,SAAS,oBAA4B;AAC1C,QAAM,QAAQ,IAAI,WAAW,gBAAgB,cAAc;AAC3D,SAAO,gBAAgB,KAAK;AAC5B,SAAO,gBAAgB,KAAK;AAC9B;AAKO,SAAS,iBAAyB;AACvC,QAAM,QAAQ,IAAI,WAAW,gBAAgB,YAAY;AACzD,SAAO,gBAAgB,KAAK;AAC5B,SAAO,gBAAgB,KAAK;AAC9B;AAKO,SAAS,0BACd,QACA,MACA,UACA,iBACA,WACA,qBAAmF,IAC/C;AACpC,SAAO;AAAA,IACL,WAAW,cAAc,gBAAgB,SAAS,CAAC;AAAA,IACnD,IAAI;AAAA,MACF,MAAM;AAAA,MACN,IAAI;AAAA,IAAA;AAAA,IAEN,MAAM;AAAA,MACJ,IAAI,cAAc,gBAAgB,eAAA,CAAgB,CAAC;AAAA,MACnD,MAAM;AAAA,MACN,aAAa;AAAA,IAAA;AAAA,IAEf,kBAAkB;AAAA,MAChB,EAAE,KAAK,oBAAoB,OAAO,MAAM,aAAA;AAAA,MACxC,EAAE,KAAK,oBAAoB,OAAO,MAAM,aAAA;AAAA,IAAa;AAAA,IAEvD,SAAS,gBAAgB;AAAA,IACzB,aAAa;AAAA,IACb,oBAAoB,mBAAmB,IAAI,CAAA,UAAS;AAAA,MAClD,IAAI,cAAc,gBAAgB,KAAK,EAAE,CAAC;AAAA,MAC1C,MAAM;AAAA;AAAA,MAEN,GAAI,KAAK,cAAc,KAAK,WAAW,SAAS,IAAI,EAAE,YAAY,KAAK,eAAe,CAAA;AAAA,IAAC,EACvF;AAAA,IACF,wBAAwB;AAAA,MACtB,aAAa;AAAA,MACb,oBAAoB;AAAA,MACpB,kBAAkB;AAAA,IAAA;AAAA,EACpB;AAEJ;AA0BA,eAAsB,mBACpB,YACA,mBACA,gBACA,cACA,YACiF;AACjF,MAAI;AAEF,UAAM,oBAAoB,MAAM,uBAAuB,IAAI,WAAW,WAAW,SAAS,iBAAiB,CAAC;AAC5G,UAAM,EAAE,sBAAsB;AAG9B,UAAM,aAAa,oBAAoB,IAAI,WAAW,WAAW,SAAS,cAAc,CAAC;AAGzF,UAAM,oBAAoB,gBAAgB,IAAI,WAAW,WAAW,SAAS,CAAC;AAC9E,QAAI,sBAAsB,mBAAmB;AAC3C,aAAO,IAAI,qBAAqB;AAAA,QAC9B,OAAO;AAAA,QACP,MAAM,kBAAkB;AAAA,MAAA,CACzB;AAAA,IACH;AAGA,QAAI,WAAW,WAAW,gBAAgB;AACxC,aAAO,IAAI,kBAAkB;AAAA,QAC3B,OAAO;AAAA,QACP,MAAM,kBAAkB;AAAA,MAAA,CACzB;AAAA,IACH;AAGA,QAAI,WAAW,SAAS,eAAe,QAAQ;AAC7C,aAAO,IAAI,wBAAwB;AAAA,QACjC,OAAO;AAAA,QACP,MAAM,kBAAkB;AAAA,MAAA,CACzB;AAAA,IACH;AAGA,QAAI,CAAC,kBAAkB,yBAAyB,YAAY,GAAG;AAC7D,aAAO,IAAI,yBAAyB;AAAA,QAClC,OAAO;AAAA,QACP,MAAM,kBAAkB;AAAA,MAAA,CACzB;AAAA,IACH;AAGA,QAAI,CAAC,kBAAkB,aAAa;AAClC,aAAO,IAAI,0BAA0B;AAAA,QACnC,OAAO;AAAA,QACP,MAAM,kBAAkB;AAAA,MAAA,CACzB;AAAA,IACH;AAGA,UAAM,qBAAqB,kBAAkB;AAC7C,QAAI,CAAC,oBAAoB;AACvB,aAAO,IAAI,uBAAuB;AAAA,QAChC,OAAO;AAAA,QACP,MAAM,kBAAkB;AAAA,MAAA,CACzB;AAAA,IACH;AAGA,UAAM,YAAY,mBAAmB;AACrC,QAAI,UAAU,WAAW,YAAY,KAAK;AACxC,aAAO,IAAI,qCAAqC;AAAA,QAC9C,OAAO;AAAA,QACP,MAAM,kBAAkB;AAAA,MAAA,CACzB;AAAA,IACH;AAGA,UAAM,qBAAqB,UAAU,UAAA;AACrC,QAAI,uBAAuB,oBAAoB,OAAO;AACpD,aAAO,IAAI,qCAAqC;AAAA,QAC9C,OAAO;AAAA,QACP,MAAM,kBAAkB;AAAA,MAAA,CACzB;AAAA,IACH;AAIA,UAAM,sBAAsB,gBAAgB,IAAI,YAAA,EAAc,OAAO,KAAK,UAAU,mBAAmB,UAAU,OAAO,CAAC,CAAC;AAG1H,QAAI,aAAuB,CAAA;AAC3B,QAAI,WAAW,SAAS,cAAc,WAAW,SAAS,WAAW,SAAS,GAAG;AAE/E,mBAAa,WAAW,SAAS;AACjC,aAAO,MAAM,oCAAoC,EAAE,WAAA,CAAY;AAAA,IACjE,OAAO;AAEL,YAAMC,cAAa,MAAM,sBAAsB,mBAAmB,qBAAqB,UAAU;AACjG,mBAAa,wBAAwBA,WAAU;AAC/C,aAAO,MAAM,sCAAsC,EAAE,YAAY,QAAQ,cAAc;AAAA,IACzF;AAGA,QAAI,uBAAsD;AAC1D,QAAI,WAAW,yBAAyB;AACtC,6BAAuB,WAAW,4BAA4B,aAAa,aAAa;AACxF,aAAO,MAAM,wCAAwC;AAAA,QACnD,yBAAyB,WAAW;AAAA,QACpC;AAAA,MAAA,CACD;AAAA,IACH,OAAO;AAEL,YAAMA,cAAa,MAAM,sBAAsB,mBAAmB,qBAAqB,UAAU;AACjG,6BAAuBA,YAAW;AAClC,aAAO,MAAM,oCAAoC;AAAA,QAC/C,QAAQ,gBAAgB,mBAAmB,mBAAmB;AAAA,QAC9D;AAAA,MAAA,CACD;AAAA,IACH;AAGA,UAAM,aAAa,MAAM,sBAAsB,mBAAmB,qBAAqB,UAAU;AAGjG,UAAM,cAAc,mBAAmB,iBAAiB;AAGxD,UAAM,eAAe,mBAAmB,UAAU,UAAA;AAGlD,UAAM,kBAAkB,uBAAuB,iBAAiB;AAGhE,UAAM,cAAc,iCAAiC,UAAU;AAE/D,WAAO;AAAA,MACL,IAAI,gBAAgB,mBAAmB,EAAE;AAAA,MACzC;AAAA,MACA,SAAS,kBAAkB;AAAA,MAC3B;AAAA,MACA,oBAAoB,YAAY;AAAA,MAChC;AAAA,MACA,QAAQ,gBAAgB,mBAAmB,mBAAmB;AAAA,MAC9D,MAAM;AAAA,MACN,YAAY;AAAA,MACZ;AAAA,MACA,MAAM;AAAA,MACN,WAAW;AAAA,IAAA;AAAA,EAEf,SAAS,OAAO;AACd,WAAO,MAAM,+BAA+B;AAAA,MAC1C,OAAO,iBAAiB,QAAQ,MAAM,UAAU;AAAA,IAAA,CACjD;AACD,WAAO,IAAI,oCAAoC,EAAE,OAAO,aAAa,EAAE,QAAQ,KAAK;AAAA,EACtF;AACF;AAKA,eAAsB,qBACpB,YACA,mBACA,gBACA,cACA,kBAC4D;AAC5D,MAAI;AAEF,UAAM,oBAAoB,uBAAuB,IAAI,WAAW,WAAW,SAAS,iBAAiB,CAAC;AAGtG,UAAM,aAAa,oBAAoB,IAAI,WAAW,WAAW,SAAS,cAAc,CAAC;AAGzF,UAAM,oBAAoB,gBAAgB,IAAI,WAAW,WAAW,SAAS,CAAC;AAC9E,QAAI,sBAAsB,mBAAmB;AAC3C,aAAO,IAAI,qBAAqB;AAAA,QAC9B,OAAO;AAAA,QACP,MAAM,kBAAkB;AAAA,MAAA,CACzB;AAAA,IACH;AAGA,QAAI,WAAW,WAAW,gBAAgB;AACxC,aAAO,IAAI,kBAAkB;AAAA,QAC3B,OAAO;AAAA,QACP,MAAM,kBAAkB;AAAA,MAAA,CACzB;AAAA,IACH;AAGA,QAAI,WAAW,SAAS,eAAe,KAAK;AAC1C,aAAO,IAAI,wBAAwB;AAAA,QACjC,OAAO;AAAA,QACP,MAAM,kBAAkB;AAAA,MAAA,CACzB;AAAA,IACH;AAGA,QAAI,CAAC,kBAAkB,yBAAyB,YAAY,GAAG;AAC7D,aAAO,IAAI,yBAAyB;AAAA,QAClC,OAAO;AAAA,QACP,MAAM,kBAAkB;AAAA,MAAA,CACzB;AAAA,IACH;AAGA,QAAI,CAAC,kBAAkB,aAAa;AAClC,aAAO,IAAI,0BAA0B;AAAA,QACnC,OAAO;AAAA,QACP,MAAM,kBAAkB;AAAA,MAAA,CACzB;AAAA,IACH;AAIA,QAAI,iBAAiB,UAAU,KAAK,kBAAkB,mBAAmB,GAAG;AAC1E,UAAI,kBAAkB,oBAAoB,iBAAiB,SAAS;AAClE,eAAO,SAAS,qDAAqD;AAAA,UACnE,QAAQ,iBAAiB;AAAA,UACzB,UAAU,kBAAkB;AAAA,UAC5B,cAAc,WAAW;AAAA,UACzB,QAAQ,iBAAiB;AAAA,QAAA,CAC1B;AACD,eAAO,IAAI,iDAAiD;AAAA,UAC1D,OAAO;AAAA,UACP,MAAM,kBAAkB;AAAA,QAAA,CACzB;AAAA,MACH;AAAA,IACF;AAGA,UAAM,mBAAmB,gCAAgC,IAAI,WAAW,WAAW,SAAS,iBAAiB,GAAG,IAAI,WAAW,WAAW,SAAS,cAAc,CAAC;AAGlK,QAAI;AACJ,QAAI;AAEF,YAAM,gBAAgB,IAAI,YAAA,EAAc,OAAO,gBAAgB,iBAAiB,mBAAmB,CAAC;AACpG,sBAAgB,KAAK,MAAM,aAAa;AAExC,UAAI,CAAC,eAAe;AAClB,eAAO;AAAA,UACL;AAAA,UACA;AAAA,YACE,OAAO;AAAA,YACP,MAAM,kBAAkB;AAAA,UAAA;AAAA,UAE1B,EAAE,QAAQ,IAAA;AAAA,QAAI;AAAA,MAElB;AAAA,IACF,SAAS,OAAO;AACd,aAAO,MAAM,2CAA2C;AAAA,QACtD,OAAO,iBAAiB,QAAQ,MAAM,UAAU;AAAA,MAAA,CACjD;AACD,aAAO;AAAA,QACL;AAAA,QACA;AAAA,UACE,OAAO;AAAA,UACP,MAAM,kBAAkB;AAAA,QAAA;AAAA,QAE1B,EAAE,QAAQ,IAAA;AAAA,MAAI;AAAA,IAElB;AAGA,QAAI;AACF,YAAM,iBAAiB,IAAI,WAAW,WAAW,SAAS,SAAS;AAQnE,YAAM,cAAc,cAAc,EAAE;AACpC,YAAM,cAAc,cAAc,EAAE;AAEpC,UAAI,CAAC,eAAe,CAAC,aAAa;AAChC,eAAO,IAAI,gCAAgC;AAAA,UACzC,OAAO;AAAA,UACP,MAAM,kBAAkB;AAAA,QAAA,CACzB;AAAA,MACH;AAGA,UAAI;AACJ,UAAI;AAEJ,UAAI;AACF,YAAI,OAAO,gBAAgB,UAAU;AACnC,mBAAS,gBAAgB,WAAW;AAAA,QACtC,WAAW,MAAM,QAAQ,WAAW,GAAG;AACrC,mBAAS,IAAI,WAAW,WAAW;AAAA,QACrC,WAAW,OAAO,gBAAgB,YAAY,gBAAgB,MAAM;AAElE,gBAAM,SAAS,OAAO,OAAO,WAAW;AACxC,mBAAS,IAAI,WAAW,MAAM;AAAA,QAChC,OAAO;AACL,mBAAS,IAAI,WAAW,WAAW;AAAA,QACrC;AAEA,YAAI,OAAO,gBAAgB,UAAU;AACnC,mBAAS,gBAAgB,WAAW;AAAA,QACtC,WAAW,MAAM,QAAQ,WAAW,GAAG;AACrC,mBAAS,IAAI,WAAW,WAAW;AAAA,QACrC,WAAW,OAAO,gBAAgB,YAAY,gBAAgB,MAAM;AAElE,gBAAM,SAAS,OAAO,OAAO,WAAW;AACxC,mBAAS,IAAI,WAAW,MAAM;AAAA,QAChC,OAAO;AACL,mBAAS,IAAI,WAAW,WAAW;AAAA,QACrC;AAAA,MACF,SAAS,OAAO;AACd,eAAO,MAAM,mDAAmD;AAAA,UAC9D,OAAO,iBAAiB,QAAQ,MAAM,UAAU;AAAA,QAAA,CACjD;AACD,eAAO,IAAI,oCAAoC;AAAA,UAC7C,OAAO;AAAA,UACP,MAAM,kBAAkB;AAAA,QAAA,CACzB;AAAA,MACH;AAGA,UAAI,OAAO,WAAW,gBAAgB,qBAAqB,OAAO,WAAW,gBAAgB,mBAAmB;AAC9G,eAAO,IAAI,2CAA2C;AAAA,UACpD,OAAO;AAAA,UACP,MAAM,kBAAkB;AAAA,QAAA,CACzB;AAAA,MACH;AAGA,YAAM,OAAO,MAAM,KAAK,MAAM,EAC3B,IAAI,CAAA,MAAK,EAAE,SAAS,EAAE,EAAE,SAAS,GAAG,GAAG,CAAC,EACxC,KAAK,EAAE;AACV,YAAM,OAAO,MAAM,KAAK,MAAM,EAC3B,IAAI,CAAA,MAAK,EAAE,SAAS,EAAE,EAAE,SAAS,GAAG,GAAG,CAAC,EACxC,KAAK,EAAE;AAEV,UAAI,KAAK,WAAW,KAAK,KAAK,WAAW,GAAG;AAC1C,eAAO,IAAI,yBAAyB;AAAA,UAClC,OAAO;AAAA,UACP,MAAM,kBAAkB;AAAA,QAAA,CACzB;AAAA,MACH;AAGA,YAAM,aAAa,KAAK,SAAS,gBAAgB,uBAAuB,GAAG;AAC3E,YAAM,aAAa,KAAK,SAAS,gBAAgB,uBAAuB,GAAG;AAE3E,YAAM,UAAU,OAAO,KAAK,UAAU,EAAE;AACxC,YAAM,UAAU,OAAO,KAAK,UAAU,EAAE;AAKxC,YAAM,YAAY,IAAI,eAAe,MAAM,SAAS,OAAO;AAG3D,UAAI,CAAC,UAAU,QAAQ,IAAI,GAAG;AAC5B,eAAO,IAAI,iCAAiC;AAAA,UAC1C,OAAO;AAAA,UACP,MAAM,kBAAkB;AAAA,QAAA,CACzB;AAAA,MACH;AAGA,UAAI;AACF,kBAAU,uBAAA;AAAA,MACZ,SAAS,OAAO;AACd,eAAO,MAAM,qDAAqD;AAAA,UAChE,OAAO,iBAAiB,QAAQ,MAAM,UAAU;AAAA,QAAA,CACjD;AACD,eAAO,IAAI,+BAA+B;AAAA,UACxC,OAAO;AAAA,UACP,MAAM,kBAAkB;AAAA,QAAA,CACzB;AAAA,MACH;AAEA,YAAM,cAAc,OAAO,gBAAgB;AAG3C,YAAM,YAAY,yBAAyB,cAAc;AACzD,YAAM,UAAU,qBAAqB,WAAW,aAAa,SAAS;AAEtE,UAAI,CAAC,SAAS;AACZ,eAAO,IAAI,qBAAqB;AAAA,UAC9B,OAAO;AAAA,UACP,MAAM,kBAAkB;AAAA,QAAA,CACzB;AAAA,MACH;AAAA,IACF,SAAS,OAAO;AACd,aAAO,MAAM,wDAAwD;AAAA,QACnE,OAAO,iBAAiB,QAAQ,MAAM,UAAU;AAAA,QAChD,cAAc,WAAW;AAAA,MAAA,CAC1B;AACD,aAAO;AAAA,QACL;AAAA,QACA;AAAA,UACE,OAAO;AAAA,UACP,MAAM,kBAAkB;AAAA,QAAA;AAAA,QAE1B,EAAE,QAAQ,IAAA;AAAA,MAAI;AAAA,IAElB;AAEA,WAAO;AAAA,MACL,UAAU;AAAA,MACV,YAAY,kBAAkB;AAAA,IAAA;AAAA,EAElC,SAAS,OAAO;AACd,WAAO,MAAM,iCAAiC;AAAA,MAC5C,OAAO,iBAAiB,QAAQ,MAAM,UAAU;AAAA,IAAA,CACjD;AACD,WAAO,IAAI,sCAAsC,EAAE,OAAO,aAAa,EAAE,QAAQ,KAAK;AAAA,EACxF;AACF;AC/lBO,SAAS,wBAAwB,UAAoB,WAA6D;AACvH,QAAM,mBAAmB,SAAS,IAAI,mBAAmB,GAAG,SAAA;AAE5D,MAAI,CAAC,kBAAkB;AACrB,UAAM,eAAe,cAAc,WAAW,6CAA6C;AAC3F,WAAO,QAAQ,GAAG,SAAS,4BAA4B;AACvD,WAAO,IAAI,cAAc,EAAE,OAAO,WAAW;AAAA,EAC/C;AAEA,MAAI;AACF,UAAM,aAAa,KAAK,MAAM,gBAAgB;AAC9C,WAAO,GAAG,UAAU;AAAA,EACtB,SAAS,OAAO;AACd,WAAO,MAAM,GAAG,SAAS,yBAAyB;AAAA,MAChD,OAAO,iBAAiB,QAAQ,MAAM,UAAU;AAAA,IAAA,CACjD;AACD,WAAO,IAAI,kDAAkD,EAAE,OAAO,WAAW;AAAA,EACnF;AACF;AAoBA,eAAsB,2BAA2B,SAA0C,MAAYN,QAAe,WAAyD;AAC7K,QAAM,gBAAgB,MAAM,kBAAkB,SAAS,EAAE,MAAM;AAE/D,MAAI,QAAQ,aAAa,GAAG;AAC1B,WAAO,MAAM,GAAG,SAAS,4BAA4B;AAAA,MACnD,OAAAA;AAAA,MACA,QAAQ,KAAK;AAAA,MACb,OAAO,cAAc;AAAA,IAAA,CACtB;AACD,WAAO,IAAI,4BAA4B,EAAE,OAAO,WAAW;AAAA,EAC7D;AAEA,SAAO,GAAG,aAAa;AACzB;AAiBO,SAAS,0BAA0B,SAA0C,QAAgB,MAAqD;AACvJ,QAAM,aAAa,WAAW,SAAS,iBAAiB;AAGxD,MAAI,QAAQ,KAAK,WAAW,UAAU;AACpC,WAAO,KAAK,wCAAwC;AAAA,MAClD,QAAQ,KAAK;AAAA,MACb,OAAO,KAAK;AAAA,MACZ,QAAQ,KAAK;AAAA,IAAA,CACd;AACD,UAAMO,cAAa,YAAY,OAAO,UAAU,kBAAkB;AAClE,WAAO,EAAE,YAAAA,aAAY,OAAA;AAAA,EACvB;AAEA,QAAM,aAAa,YAAY,OAAO,YAAY,kBAAkB;AACpE,SAAO,EAAE,YAAY,OAAA;AACvB;ACxGA,SAAS,kBAAkB,QAAyB;AAClD,SAAO,WAAW,eAAe,WAAW,eAAe,WAAW;AACxE;AAKO,SAAS,YAAY,SAA0C,SAA0B;AAC9F,QAAM,eAAe,gBAAgB,SAAS,OAAO;AAGrD,MAAI,kBAAkB,YAAY,GAAG;AACnC,WAAO;AAAA,EACT;AAEA,SAAO;AACT;AAYO,SAAS,eAAe,SAA0C,SAA4B;AACnG,QAAM,YAAY,UAAU,SAAS,OAAO;AAC5C,QAAM,gBAAgB,IAAI,IAAI,QAAQ,GAAG,EAAE;AAC3C,QAAM,YAAY,cAAc,OAAO;AAGvC,MAAI,WAAW;AACb,WAAO,CAAC,GAAG,oBAAI,IAAI,CAAC,WAAW,aAAa,CAAC,CAAC;AAAA,EAChD;AAGA,SAAO,CAAC,SAAS;AACnB;AAKO,SAAS,eAAe,cAAsB,gBAAmC;AACtF,SAAO,eAAe,SAAS,YAAY;AAC7C;AC4BA,eAAsB,kBAAkB,SAAqC,SAAiE;AAC5I,QAAM,EAAE,iBAAiB,oBAAoB,SAAS,IAAI,KAAK,QAAS;AAGxE,MAAI,KAAK,QAAQ,qBAAqB,QAAQ;AAC5C,WAAO,IAAI,kDAAkD;AAAA,MAC3D,OAAO;AAAA,MACP,MAAM,kBAAkB;AAAA,IAAA,CACzB;AAAA,EACH;AAGA,QAAM,mBAAmB,MAAM,0BAA0B,iBAAiB,OAAO;AACjF,MAAI,CAAC,kBAAkB;AACrB,WAAO,IAAI,oDAAoD;AAAA,MAC7D,OAAO;AAAA,MACP,MAAM,kBAAkB;AAAA,IAAA,CACzB;AAAA,EACH;AAGA,SAAO,GAAG,MAAS;AACrB;AA+BA,eAAsB,uBAAuB,SAAkB,SAAkC,SAAmE;AAClK,QAAM,EAAE,gBAAgB,aAAa,CAAA,GAAI,cAAc;AAGvD,QAAM,iBAAiB,eAAe,SAAS,OAAO;AAItD,QAAM,eAAe,IAAI,IAAI,QAAQ,GAAG,EAAE;AAG1C,MAAI,CAAC,eAAe,cAAc,cAAc,GAAG;AACjD,WAAO,MAAM,GAAG,SAAS,8BAA8B;AAAA,MACrD;AAAA,MACA;AAAA,MACA,GAAG;AAAA,IAAA,CACJ;AAED,WAAO,IAAI,8BAA8B,EAAE,OAAO,WAAW;AAAA,EAC/D;AAGA,QAAM,aAAa,KAAK,MAAM,IAAI,YAAA,EAAc,OAAO,gBAAgB,cAAc,CAAC,CAAC;AACvF,QAAM,eAAe,WAAW;AAIhC,MAAI,iBAAiB,cAAc;AACjC,WAAO,IAAI,mBAAmB,EAAE,OAAO,WAAW;AAAA,EACpD;AAEA,SAAO,GAAG,YAAY;AACxB;AA8BA,eAAsB,wBAAwB,SAAkB,SAA+D,SAAqF;AAClN,QAAM,EAAE,iBAAiB,oBAAoB,gBAAgB,YAAY,WAAW,WAAW;AAG/F,QAAM,kBAAkB,MAAM,kBAAkB,EAAE,iBAAiB,oBAAoB,OAAA,GAAU,OAAO;AAExG,MAAI,QAAQ,eAAe,GAAG;AAC5B,WAAO;AAAA,EACT;AAGA,QAAM,eAAe,MAAM,uBAAuB,SAAS,EAAE,gBAAgB,YAAY,UAAA,GAAa,OAAO;AAE7G,MAAI,QAAQ,YAAY,GAAG;AACzB,WAAO;AAAA,EACT;AAGA,QAAM,OAAO,YAAY,SAAS,OAAO;AAEzC,SAAO,GAAG,EAAE,WAAW,iBAAiB,QAAQ,cAAc,MAAM;AACtE;ACrMA,eAAsB,aAAa,EAAE,WAA6B;AAChE,QAAM,QAAQ,iBAAiB,OAAO;AACtC,QAAM,YAAY,kBAAA;AAElB,QAAM,eAAe,MAAM,uBAAuB,SAAS,SAAS;AACpE,MAAI,QAAQ,YAAY,GAAG;AACzB,WAAO,MAAM,yCAAyC,EAAE,OAAO,aAAa,SAAS;AACrF,WAAO,aAAa,YAAY;AAAA,EAClC;AAEA,SAAO,UAAU,EAAE,OAAO,UAAA,GAAa,EAAE,SAAS,EAAE,cAAc,aAAA,GAAgB;AACpF;AAEA,eAAsB,aAAa,EAAE,SAAS,WAA6B;AACzE,QAAM,aAAa,kBAAkB,OAAO;AAC5C,QAAM,aAAa,WAAW,SAAS,iBAAiB;AACxD,QAAM,WAAW,MAAM,QAAQ,SAAA;AAE/B,QAAM,WAA2B;AAAA,IAC/B,QAAQ,OAAOJ,cAAuB;AACpC,UAAI;AACF,cAAM,mBAAmB,MAAM,iBAAiB,kBAAkBA,SAAQ;AAC1E,YAAI,QAAQ,gBAAgB,GAAG;AAC7B,iBAAO;AAAA,QACT;AAEA,cAAMH,SAAQ,iBAAiB;AAG/B,cAAM,aAAa,MAAM,WAAW,eAAeA,MAAK;AACxD,cAAM,aAAa,CAAC,QAAQ,UAAU;AACtC,cAAM,OAAO,aAAa,aAAa;AAGvC,cAAM,uBAAuB,OAAO,MAAM,WAAW,0BAA0B,KAAK,EAAE,IAAK,CAAA;AAC3F,cAAM,oBAAoB,CAAC,QAAQ,oBAAoB,KAAK,qBAAqB,SAAS;AAG1F,YAAI,CAAC,cAAc,CAAC,mBAAmB;AACrC,iBAAO,IAAI,iCAAiC,EAAE,OAAO,iCAAiC;AAAA,QACxF;AAGA,cAAMQ,kBAAiB;AAGvB,cAAM,gBAAgB,MAAM,wBAAwB,SAAS,OAAO;AACpE,YAAI,QAAQ,aAAa,GAAG;AAC1B,iBAAO;AAAA,QACT;AAEA,cAAM,EAAE,WAAW,iBAAiB,oBAAoB,YAAY;AAGpE,cAAM,mBAAmB,wBAAwBL,WAAU,QAAQ;AACnE,YAAI,QAAQ,gBAAgB,GAAG;AAC7B,iBAAO;AAAA,QACT;AAEA,cAAM,aAAa;AAGnB,cAAM,gBAAgBK,gBAAe,KAAK,CAAC,SAAwB,KAAK,OAAO,WAAW,KAAK;AAE/F,YAAI,CAAC,eAAe;AAClB,iBAAO,IAAI,iCAAiC,EAAE,OAAO,iCAAiC;AAAA,QACxF;AAGA,YAAI,cAAc,WAAW,MAAM,IAAI;AACrC,iBAAO,SAAS,sCAAsC;AAAA,YACpD,qBAAqB,cAAc;AAAA,YACnC,eAAe,MAAM;AAAA,YACrB,OAAAR;AAAA,YACA,cAAc,WAAW;AAAA,UAAA,CAC1B;AACD,iBAAO,IAAI,iCAAiC,EAAE,OAAO,iCAAiC;AAAA,QACxF;AAGA,cAAM,2BAA2B,MAAM;AAAA,UACrC;AAAA,UACA;AAAA,YACE;AAAA,YACA;AAAA,YACA,gBAAgB,WAAW,SAAS;AAAA,YACpC,WAAW;AAAA,YACX,YAAY,EAAE,OAAAA,OAAA;AAAA,UAAM;AAAA,UAEtB;AAAA,QAAA;AAGF,YAAI,QAAQ,wBAAwB,GAAG;AACrC,iBAAO;AAAA,QACT;AAEA,cAAM,EAAE,WAAW,QAAQ,KAAA,IAAS;AAGpC,cAAM,qBAAqB;AAAA,UACzB,IAAI,WAAW;AAAA,UACf,OAAO,gBAAgB,WAAW,KAAK,EAAE;AAAA,UACzC,UAAU;AAAA,YACR,mBAAmB,gBAAgB,WAAW,SAAS,iBAAiB,EAAE;AAAA,YAC1E,gBAAgB,gBAAgB,WAAW,SAAS,cAAc,EAAE;AAAA,YACpE,WAAW,gBAAgB,WAAW,SAAS,SAAS,EAAE;AAAA,YAC1D,YAAY,WAAW,SAAS,aAAa,gBAAgB,WAAW,SAAS,UAAU,EAAE,SAAS;AAAA,UAAA;AAAA,UAExG,MAAM;AAAA,QAAA;AAIR,cAAM,qBAAqB,MAAM,qBAAqB,oBAAoB,WAAW,QAAQ,MAAM,aAAa;AAEhH,YAAI,QAAQ,kBAAkB,GAAG;AAE/B,cAAI,cAAc,kBAAkB,GAAG;AACrC,mBAAO,MAAM,oCAAoC,EAAE,OAAAA,QAAO,OAAO,aAAa,kBAAkB,GAAG,MAAM,mBAAmB,KAAA,CAAM;AAAA,UACpI;AAGA,gBAAM,eAAe,wBAAwB,mBAAmB,MAA2B,gBAAgB;AAC3G,iBAAO,IAAI,cAAc,EAAE,OAAO,WAAW,MAAM,mBAAmB,MAAM;AAAA,QAC9E;AAGA,cAAM,eAAe,MAAM,WAAW,yBAAyB,cAAc,IAAI,mBAAmB,YAAY,oBAAI,MAAM;AAE1H,YAAI,QAAQ,YAAY,GAAG;AACzB,iBAAO,QAAQ,sCAAsC,EAAE,iBAAiB,cAAc,IAAI,OAAO,aAAa,SAAS;AAAA,QAEzH;AAGA,YAAI,MAAM,SAAS;AACjB,gBAAM,cAAc,MAAM,QAAQ;AAGlC,cAAI,gBAAgB,YAAY;AAC9B,kBAAM,oBAAoB,MAAM,QAAQ;AAExC,mBAAO,KAAK,6BAA6B,EAAE,QAAQ,MAAM,IAAI,OAAAA,QAAO,mBAAmB;AAGvF,kBAAM,eAAe,MAAM,WAAW,gCAAgC,MAAM,IAAI,iBAAiB;AAEjG,gBAAI,QAAQ,YAAY,GAAG;AACzB,qBAAO,QAAQ,kCAAkC,EAAE,QAAQ,MAAM,IAAI,OAAAA,QAAO,OAAO,aAAa,YAAY,EAAA,CAAG;AAAA,YAEjH,OAAO;AACL,qBAAO,KAAK,8BAA8B,EAAE,QAAQ,MAAM,IAAI,OAAAA,QAAO,cAAc,cAAc;AAAA,YACnG;AAAA,UACF,OAAO;AAEL,mBAAO,KAAK,yCAAyC,EAAE,QAAQ,MAAM,IAAI,OAAAA,QAAO,aAAa;AAAA,UAC/F;AAGA,gBAAM,sBAAsB,MAAM,WAAW,kBAAkB,MAAM,IAAI,IAAI;AAE7E,cAAI,QAAQ,mBAAmB,GAAG;AAChC,mBAAO,QAAQ,kCAAkC,EAAE,QAAQ,MAAM,IAAI,OAAAA,QAAO,aAAa,OAAO,aAAa,mBAAmB,EAAA,CAAG;AAAA,UAErI;AAGA,cAAI,MAAM,WAAW,UAAU;AAC7B,kBAAM,qBAAqB,MAAM,WAAW,iBAAiB,MAAM,IAAI,QAAQ;AAE/E,gBAAI,QAAQ,kBAAkB,GAAG;AAC/B,qBAAO,QAAQ,mCAAmC,EAAE,QAAQ,MAAM,IAAI,OAAAA,QAAO,OAAO,aAAa,kBAAkB,EAAA,CAAG;AAAA,YAExH,OAAO;AAEL,mBAAK,SAAS;AACd,qBAAO,KAAK,6BAA6B,EAAE,QAAQ,MAAM,IAAI,OAAAA,QAAO;AAAA,YACtE;AAAA,UACF;AAAA,QACF;AAGA,cAAM,gBAAgB,MAAM,wBAAwB,SAAS,OAAO;AACpE,YAAI,QAAQ,aAAa,GAAG;AAE1B,iBAAO,QAAQ,mCAAmC,EAAE,OAAO,aAAa,aAAa,GAAG;AAAA,QAC1F;AAGA,cAAM,oBAAoB,MAAM,2BAA2B,SAAS,MAAOA,QAAO,QAAQ;AAC1F,YAAI,QAAQ,iBAAiB,GAAG;AAE9B,cAAI,cAAc,iBAAiB,GAAG;AACpC,mBAAO,MAAM,kCAAkC,EAAE,OAAAA,QAAO,OAAO,aAAa,iBAAiB,GAAG;AAAA,UAClG;AACA,iBAAO;AAAA,QACT;AAGA,cAAMO,cAAa,MAAM,WAAW,WAAW,YAAY,OAAO,YAAY,kBAAkB,WAAW,YAAY,OAAO,UAAU,kBAAkB;AAG1J,eAAO,GAAG;AAAA,UACR,eAAe;AAAA,UACf,YAAAA;AAAAA,QAAA,CACD;AAAA,MACH,SAAS,OAAO;AACd,YAAI,iBAAiB,UAAU;AAC7B,gBAAM;AAAA,QACR;AAEA,eAAO,MAAM,gBAAgB,EAAE,OAAO,eAAe,KAAK,GAAG;AAC7D,eAAO,IAAI,yBAAyB,EAAE,OAAO,WAAW;AAAA,MAC1D;AAAA,IACF;AAAA,EAAA;AAGF,QAAM,SAAS,MAAM,aAAa,UAAU,QAAQ;AAEpD,MAAI,QAAQ,MAAM,GAAG;AAEnB,QAAI,cAAc,MAAM,GAAG;AACzB,aAAO,MAAM,uBAAuB,EAAE,OAAO,aAAa,MAAM,GAAG;AACnE,uBAAiB,OAAO,SAAS,OAAO,MAAa;AAAA,IACvD;AAGA,WAAO,aAAa,MAAM;AAAA,EAC5B;AAGA,QAAM,EAAE,YAAY,cAAA,IAAkB;AAKtC,QAAM,gBAAgB,YAAY;AAAA,IAChC,SAAS,EAAE,cAAc,cAAA;AAAA,EAAc,CACxC;AACH;ACpPA,eAAsB,cAAc,EAAE,SAAS,WAA8B;AAC3E,QAAM,gBAAgB,MAAM,mBAAmB,SAAS,OAAO;AAE/D,MAAI,QAAQ,aAAa,GAAG;AAE1B,QAAI,cAAc,aAAa,GAAG;AAChC,aAAO,MAAM,sCAAsC,EAAE,OAAO,aAAa,aAAa,GAAG;AAAA,IAC3F;AAAA,EACF;AAEA,QAAM,aAAa,WAAW,SAAS,iBAAiB;AACxD,QAAM,aAAa,YAAY,OAAO,aAAa,kBAAkB;AAErE,QAAM,gBAAgB,YAAY;AAAA,IAChC,SAAS,EAAE,cAAc,CAAC,QAAQ,aAAa,IAAI,gBAAgB,GAAA;AAAA,EAAG,CACvE;AACH;AAEA,eAAsB,cAAc,EAAE,WAAyD;AAC7F,QAAM,aAAa,WAAW,SAAS,iBAAiB;AACxD,QAAM,aAAa,YAAY,OAAO,aAAa,kBAAkB;AAErE,QAAM,gBAAgB,UAAU;AAClC;ACPO,MAAM,iBAAiB;AAAA,EAC5B,QAAQ;AAAA,IACN,OAAO;AAAA,IACP,SAAS;AAAA,IACT,QAAQ;AAAA,EAAA;AAAA,EAEV,eAAe;AAAA,IACb,OAAO;AAAA,IACP,SAAS;AAAA,IACT,QAAQ;AAAA,EAAA;AAAA,EAEV,kBAAkB;AAAA,IAChB,OAAO;AAAA,IACP,SAAS;AAAA,IACT,QAAQ;AAAA,EAAA;AAAA,EAEV,gBAAgB;AAAA,IACd,OAAO;AAAA,IACP,SAAS;AAAA,IACT,QAAQ;AAAA,EAAA;AAAA,EAEV,kBAAkB;AAAA,IAChB,OAAO;AAAA,IACP,SAAS;AAAA,IACT,QAAQ;AAAA,EAAA;AAAA,EAEV,UAAU;AAAA,IACR,OAAO;AAAA,IACP,SAAS;AAAA,IACT,QAAQ;AAAA,EAAA;AAEZ;AAMO,MAAM,oBAAoB,oBAAoB;AAAA,EACnD,WAAW,CAAC,EAAE,MAAM,cAAgC;AAClD,UAAM,UAAU,eAAe,OAAO;AACtC,UAAM,aAAa,YAAY,oBAAoB,YAAY;AAC/D,UAAM,kBAAkB,YAAY;AAEpC,WACE,qBAAC,MAAA,EAAK,MAAK,MACT,UAAA;AAAA,MAAA,oBAAC,MAAA,EAAK;AAAA,MACN,oBAAC,MAAA,EAAK,WAAU,sBACd,UAAA,qBAAC,WAAA,EAAU,WAAW,qDAAqD,kBAAkB,8DAA8D,EAAE,IAC3J,UAAA;AAAA,QAAA,oBAAC,SAAA,EAAQ,WAAU,+BACjB,UAAA,oBAAC,WAAQ,OAAO,GAAI,UAAA,QAAQ,MAAA,CAAM,EAAA,CACpC;AAAA,QAEA,oBAAC,WAAQ,WAAU,+CACjB,8BAAC,MAAA,EAAM,UAAA,QAAQ,SAAQ,EAAA,CACzB;AAAA,QAEA,oBAAC,WAAQ,WAAU,wEACjB,8BAAC,MAAA,EAAK,WAAU,yDAAyD,UAAA,KAAA,CAAK,EAAA,CAChF;AAAA,QAEA,qBAAC,SAAA,EAAQ,WAAU,uDACjB,UAAA;AAAA,UAAA,qBAAC,MAAA,EAAK,UAAA;AAAA,YAAA;AAAA,YACyB,oBAAC,YAAO,UAAA,YAAA,CAAS;AAAA,YAAS;AAAA,UAAA,GACzD;AAAA,+BACC,MAAA,EAAK,UAAA;AAAA,YAAA;AAAA,YAAgC,aAAa,oCAAoC;AAAA,YAA4B;AAAA,UAAA,EAAA,CAAC;AAAA,QAAA,EAAA,CACtH;AAAA,MAAA,EAAA,CACF,EAAA,CACF;AAAA,IAAA,GACF;AAAA,EAEJ;AAAA,EAEA,SAAS,CAAC,EAAE,cAAc,eAAe,OAAO,EAAE;AAAA,EAElD,WAAW;AACb,CAAC;ACpFD,eAAsB,sBAAsB,SAAyD;AACnG,QAAM,EAAE,OAAAP,QAAO,SAAS,UAAU,YAAY;AAE9C,MAAI;AAEF,UAAM,aAAa,MAAM,uBAAuBA,QAAO,SAAS,SAAS,QAAQ;AAEjF,QAAI,QAAQ,UAAU,GAAG;AACvB,aAAO,MAAM,6CAA6C;AAAA,QACxD,OAAAA;AAAA,QACA;AAAA,QACA,OAAO,aAAa,UAAU;AAAA,MAAA,CAC/B;AACD,aAAO;AAAA,IACT;AAEA,UAAM,OAAO;AAGb,UAAM,eAAe,MAAM,oBAAoB,mBAAmB;AAAA,MAChE;AAAA,MACA;AAAA,IAAA,CACD;AAGD,UAAM,aAAa,MAAM,SAAS,SAAS;AAAA,MACzC,IAAIA;AAAA,MACJ,UAAU;AAAA,IAAA,CACX;AAED,QAAI,QAAQ,UAAU,GAAG;AACvB,aAAO,MAAM,kCAAkC;AAAA,QAC7C,OAAAA;AAAA,QACA;AAAA,QACA,OAAO,aAAa,UAAU;AAAA,MAAA,CAC/B;AACD,aAAO;AAAA,IACT;AAEA,WAAO,KAAK,2BAA2B,EAAE,OAAAA,QAAO,SAAS;AACzD,WAAO,GAAG,MAAS;AAAA,EACrB,SAAS,OAAO;AACd,WAAO,MAAM,uCAAuC;AAAA,MAClD,OAAAA;AAAA,MACA;AAAA,MACA,OAAO,iBAAiB,QAAQ,MAAM,UAAU;AAAA,MAChD,OAAO,iBAAiB,QAAQ,MAAM,QAAQ;AAAA,IAAA,CAC/C;AACD,WAAO,IAAI,qCAAqC,EAAE,OAAO;AAAA,EAC3D;AACF;ACjDA,eAAsB,aAAa,EAAE,WAA6B;AAChE,QAAM,QAAQ,iBAAiB,OAAO;AACtC,QAAM,YAAY,kBAAA;AAElB,QAAM,eAAe,MAAM,uBAAuB,SAAS,SAAS;AACpE,MAAI,QAAQ,YAAY,GAAG;AACzB,WAAO,MAAM,yCAAyC,EAAE,OAAO,aAAa,SAAS;AACrF,WAAO,aAAa,YAAY;AAAA,EAClC;AAEA,SAAO,UAAU,EAAE,OAAO,UAAA,GAAa,EAAE,SAAS,EAAE,cAAc,aAAA,GAAgB;AACpF;AAEA,eAAsB,aAAa,EAAE,SAAS,WAA6B;AACzE,QAAM,aAAa,kBAAkB,OAAO;AAC5C,QAAM,aAAa,WAAW,SAAS,iBAAiB;AACxD,QAAM,WAAW,MAAM,QAAQ,SAAA;AAE/B,QAAM,WAA2B;AAAA,IAC/B,QAAQ,OAAOG,cAAuB;AACpC,UAAI;AAEF,cAAM,mBAAmB,MAAM,iBAAiB,kBAAkBA,SAAQ;AAC1E,YAAI,QAAQ,gBAAgB,GAAG;AAC7B,iBAAO;AAAA,QACT;AAEA,cAAM,EAAE,OAAAH,QAAO,YAAA,IAAgB;AAG/B,cAAM,qBAAqB,MAAM,WAAW,eAAeA,MAAK;AAGhE,cAAM,iBAAiB,CAAC,QAAQ,kBAAkB,KAAK,mBAAmB,WAAW;AAErF,YAAI,CAAC,QAAQ,kBAAkB,KAAK,CAAC,gBAAgB;AACnD,iBAAO,IAAI,6CAA6C,EAAE,OAAO,6CAA6C;AAAA,QAChH;AAEA,eAAO,KAAK,wBAAwB,EAAE,OAAAA,QAAO,gBAAgB;AAG7D,cAAM,gBAAgB,MAAM,wBAAwB,SAAS,OAAO;AACpE,YAAI,QAAQ,aAAa,GAAG;AAC1B,iBAAO;AAAA,QACT;AAEA,cAAM,EAAE,WAAW,iBAAiB,oBAAoB,YAAY;AAGpE,cAAM,mBAAmB,wBAAwBG,WAAU,QAAQ;AACnE,YAAI,QAAQ,gBAAgB,GAAG;AAC7B,iBAAO;AAAA,QACT;AAEA,cAAM,aAAa;AAGnB,cAAM,2BAA2B,MAAM;AAAA,UACrC;AAAA,UACA;AAAA,YACE;AAAA,YACA;AAAA,YACA,gBAAgB,WAAW,SAAS;AAAA,YACpC,WAAW;AAAA,YACX,YAAY,EAAE,OAAAH,OAAA;AAAA,UAAM;AAAA,UAEtB;AAAA,QAAA;AAGF,YAAI,QAAQ,wBAAwB,GAAG;AACrC,iBAAO;AAAA,QACT;AAEA,cAAM,EAAE,WAAW,QAAQ,KAAA,IAAS;AAGpC,cAAM,mBAAmB;AAAA,UACvB,IAAI,WAAW;AAAA,UACf,OAAO,gBAAgB,WAAW,KAAK,EAAE;AAAA,UACzC,UAAU;AAAA,YACR,mBAAmB,gBAAgB,WAAW,SAAS,iBAAiB,EAAE;AAAA,YAC1E,gBAAgB,gBAAgB,WAAW,SAAS,cAAc,EAAE;AAAA,YACpE,YAAY,WAAW,UAAU,cAAc,CAAA;AAAA,UAAC;AAAA,UAElD,MAAM;AAAA,UACN,yBAAyB,WAAW,2BAA2B;AAAA,QAAA;AAIjE,cAAM,aAAa,YAAY,SAAS,YAAY,WAAW,SAAS,WAAW,SAAS,SAAS,IAAI;AAGzG,cAAM,qBAAqB,MAAM,mBAAmB,kBAAkB,WAAW,QAAQ,MAAM,UAAU;AAEzG,YAAI,QAAQ,kBAAkB,GAAG;AAE/B,cAAI,cAAc,kBAAkB,GAAG;AACrC,mBAAO,MAAM,oCAAoC,EAAE,OAAAA,QAAO,OAAO,aAAa,kBAAkB,GAAG,MAAM,mBAAmB,KAAA,CAAM;AAAA,UACpI;AAGA,gBAAM,eAAe,wBAAwB,mBAAmB,MAA2B,cAAc;AACzG,iBAAO,IAAI,cAAc,EAAE,OAAO,WAAW,MAAM,mBAAmB,MAAM;AAAA,QAC9E;AAGA,YAAI;AACJ,YAAI,gBAAgB;AAElB,iBAAO;AACP,iBAAO,KAAK,qCAAqC,EAAE,QAAQ,KAAK,IAAI,OAAAA,QAAO;AAAA,QAC7E,OAAO;AAEL,gBAAM,mBAAmB,MAAM,WAAW,WAAWA,QAAO,WAAW;AACvE,cAAI,QAAQ,gBAAgB,GAAG;AAE7B,mBAAO,MAAM,6BAA6B,EAAE,OAAAA,QAAO,OAAO,aAAa,gBAAgB,GAAG;AAC1F,mBAAO,IAAI,4BAA4B,EAAE,OAAO,aAAa,EAAE,QAAQ,KAAK;AAAA,UAC9E;AACA,iBAAO;AAAA,QACT;AAGA,cAAM,mBAAmB,MAAM,WAAW,oBAAoB,EAAE,GAAG,oBAAoB,QAAQ,KAAK,IAAI;AAExG,YAAI,QAAQ,gBAAgB,GAAG;AAE7B,iBAAO,MAAM,sCAAsC,EAAE,OAAAA,QAAO,QAAQ,KAAK,IAAI,OAAO,aAAa,gBAAgB,EAAA,CAAG;AAEpH,cAAI,CAAC,gBAAgB;AACnB,kBAAM,WAAW,WAAW,KAAK,EAAE;AAAA,UACrC;AACA,iBAAO,IAAI,oCAAoC,EAAE,OAAO,aAAa,EAAE,QAAQ,KAAK;AAAA,QACtF;AAGA,YAAI,gBAAgB;AAClB,gBAAM,oBAAoB,KAAK,IAAA;AAG/B,gBAAM,sBAAsB,MAAM,WAAW,kBAAkB,KAAK,IAAI;AAAA,YACtE,MAAM;AAAA,YACN,WAAW;AAAA,UAAA,CACZ;AAED,cAAI,QAAQ,mBAAmB,GAAG;AAChC,mBAAO,MAAM,kCAAkC,EAAE,QAAQ,KAAK,IAAI,OAAO,aAAa,mBAAmB,GAAG;AAAA,UAE9G;AAGA,gBAAM,qBAAqB,MAAM,WAAW,iBAAiB,KAAK,IAAI,QAAQ;AAE9E,cAAI,QAAQ,kBAAkB,GAAG;AAC/B,mBAAO,MAAM,iCAAiC,EAAE,QAAQ,KAAK,IAAI,OAAO,aAAa,kBAAkB,GAAG;AAAA,UAE5G;AAEA,iBAAO,KAAK,+BAA+B,EAAE,QAAQ,KAAK,IAAI,OAAAA,QAAO,mBAAmB;AAAA,QAC1F;AAGA,cAAM,gBAAgB,MAAM,wBAAwB,SAAS,OAAO;AACpE,YAAI,QAAQ,aAAa,GAAG;AAE1B,iBAAO,QAAQ,mCAAmC,EAAE,OAAO,aAAa,aAAa,GAAG;AAAA,QAC1F;AAGA,cAAM,oBAAoB,MAAM,2BAA2B,SAAS,MAAMA,QAAO,QAAQ;AACzF,YAAI,QAAQ,iBAAiB,GAAG;AAE9B,cAAI,cAAc,iBAAiB,GAAG;AACpC,mBAAO,MAAM,kCAAkC,EAAE,OAAAA,QAAO,OAAO,aAAa,iBAAiB,GAAG;AAAA,UAClG;AACA,iBAAO;AAAA,QACT;AAEA,YAAI,KAAK,WAAW,UAAU;AAC5B,gBAAMS,sBAAqB,MAAM,sBAAsB,EAAE,OAAAT,QAAO,SAAS,UAAU,SAAS;AAE5F,cAAI,QAAQS,mBAAkB,GAAG;AAC/B,mBAAO,QAAQ,mCAAmC,EAAE,OAAAT,QAAO,OAAO,aAAaS,mBAAkB,GAAG;AAAA,UACtG;AAAA,QACF;AAGA,cAAMF,cAAa,KAAK,WAAW,WAAW,YAAY,OAAO,YAAY,kBAAkB,WAAW,YAAY,OAAO,UAAU,kBAAkB;AAGzJ,eAAO,GAAG,EAAE,eAAe,mBAAmB,YAAAA,aAAY;AAAA,MAC5D,SAAS,OAAO;AACd,YAAI,iBAAiB,UAAU;AAC7B,gBAAM;AAAA,QACR;AAEA,eAAO,MAAM,gBAAgB,EAAE,OAAO,eAAe,KAAK,GAAG;AAC7D,eAAO,IAAI,uBAAuB,EAAE,OAAO,WAAW;AAAA,MACxD;AAAA,IACF;AAAA,EAAA;AAGF,QAAM,SAAS,MAAM,aAAa,UAAU,QAAQ;AAEpD,MAAI,QAAQ,MAAM,GAAG;AAEnB,QAAI,cAAc,MAAM,GAAG;AACzB,aAAO,MAAM,uBAAuB,EAAE,OAAO,aAAa,MAAM,GAAG;AACnE,uBAAiB,OAAO,SAAS,OAAO,MAAa;AAAA,IACvD;AAGA,WAAO,aAAa,MAAM;AAAA,EAC5B;AAGA,QAAM,EAAE,YAAY,cAAA,IAAkB;AAKtC,QAAM,gBAAgB,YAAY;AAAA,IAChC,SAAS,EAAE,cAAc,cAAA;AAAA,EAAc,CACxC;AACH;ACxOA,MAAM,mBAAmB,OAAO;AAAA,EAC9B,OAAO,KAAK,OAAA,GAAU,UAAU,GAAG,mBAAmB,CAAC;AAAA,EACvD,MAAM,KAAK,OAAA,GAAU,UAAU,GAAG,uBAAuB,CAAC;AAC5D,CAAC;AAgBD,eAAsB,aAAa,EAAE,SAAS,WAA6B;AACzE,QAAM,QAAQ,iBAAiB,OAAO;AACtC,QAAM,gBAAgB,MAAM,eAAe,SAAS,OAAO;AAE3D,MAAI,QAAQ,aAAa,GAAG;AAE1B,QAAI,cAAc,aAAa,GAAG;AAChC,aAAO,MAAM,+BAA+B,EAAE,OAAO,aAAa,aAAa,GAAG;AAClF,uBAAiB,cAAc,SAAS,cAAc,MAAa;AAAA,IACrE;AACA,WAAO,aAAa,IAAI,uBAAuB,CAAC;AAAA,EAClD;AAEA,QAAM,UAAU;AAChB,MAAI,CAAC,WAAW,CAAC,QAAQ,MAAM;AAC7B,UAAM,aAAa,WAAW,SAAS,iBAAiB;AACxD,UAAM,gBAAgB,YAAY,OAAO,UAAU,kBAAkB,MAAM;AAAA,EAC7E;AAGA,MAAI,gBAAgB,QAAQ,KAAK;AACjC,MAAI,UAA+B;AAGnC,MAAI,QAAQ,KAAK,SAAS,SAAS,gBAAgB;AACjD,oBAAgB,QAAQ,KAAK,QAAQ;AACrC,cAAU;AAEV,WAAO,KAAK,uCAAuC,EAAE,QAAQ,QAAQ,KAAK,IAAI,UAAU,QAAQ,KAAK,OAAO,UAAU,eAAe;AAAA,EACvI,WAAW,QAAQ,KAAK,SAAS,SAAS,kBAAkB;AAC1D,cAAU;AAEV,WAAO,KAAK,yCAAyC,EAAE,QAAQ,QAAQ,KAAK,IAAI,OAAO,QAAQ,KAAK,MAAA,CAAO;AAAA,EAC7G;AAEA,SAAO,UAAU;AAAA,IACf;AAAA,IACA,OAAO;AAAA,IACP,QAAQ,QAAQ,KAAK;AAAA,IACrB;AAAA,EAAA,CACD;AACH;AAMA,eAAsB,aAAa,EAAE,SAAS,WAA6B;AACzE,QAAM,aAAa,kBAAkB,OAAO;AAC5C,QAAM,aAAa,WAAW,SAAS,iBAAiB;AACxD,QAAM,WAAW,MAAM,QAAQ,SAAA;AAC/B,QAAM,UAAW,SAAS,IAAI,SAAS,GAAG,cAAsC;AAGhF,QAAM,gBAAgB,MAAM,eAAe,SAAS,OAAO;AAE3D,MAAI,QAAQ,aAAa,GAAG;AAE1B,QAAI,cAAc,aAAa,GAAG;AAChC,aAAO,MAAM,+BAA+B,EAAE,OAAO,aAAa,aAAa,GAAG;AAClF,uBAAiB,cAAc,SAAS,cAAc,MAAa;AAAA,IACrE;AACA,WAAO,aAAa,IAAI,uBAAuB,CAAC;AAAA,EAClD;AAEA,QAAM,UAAU;AAChB,MAAI,CAAC,WAAW,CAAC,QAAQ,MAAM;AAC7B,WAAO,aAAa,IAAI,yBAAyB,CAAC;AAAA,EACpD;AAGA,QAAM,WAA2B;AAAA;AAAA;AAAA;AAAA,IAI/B,QAAQ,YAAY;AAElB,UAAI,gBAAgB,QAAQ,KAAK;AAGjC,UAAI,YAAY,kBAAkB,QAAQ,KAAK,SAAS,SAAS,gBAAgB;AAC/E,wBAAgB,QAAQ,KAAK,QAAQ;AACrC,eAAO,KAAK,8BAA8B;AAAA,UACxC,QAAQ,QAAQ,KAAK;AAAA,UACrB,UAAU,QAAQ,KAAK;AAAA,UACvB,UAAU;AAAA,QAAA,CACX;AAAA,MACH;AAGA,YAAM,aAAa,MAAM,sBAAsB;AAAA,QAC7C,OAAO;AAAA,QACP;AAAA,QACA;AAAA,MAAA,CACD;AAED,UAAI,QAAQ,UAAU,GAAG;AAEvB,YAAI,cAAc,UAAU,GAAG;AAC7B,iBAAO,MAAM,oCAAoC,EAAE,OAAO,eAAe,SAAS,OAAO,aAAa,UAAU,GAAG;AAAA,QACrH;AACA,eAAO;AAAA,MACT;AAGA,aAAO,GAAG,EAAE,QAAQ,MAAM;AAAA,IAC5B;AAAA;AAAA;AAAA;AAAA,IAKA,UAAU,YAAY;AAEpB,YAAM,eAAe,MAAM,WAAW,iBAAiB,QAAQ,KAAK,IAAI,YAAY;AAEpF,UAAI,QAAQ,YAAY,GAAG;AAEzB,YAAI,cAAc,YAAY,GAAG;AAC/B,iBAAO,MAAM,gCAAgC,EAAE,QAAQ,QAAQ,KAAK,IAAI,OAAO,aAAa,YAAY,EAAA,CAAG;AAAA,QAC7G;AACA,eAAO;AAAA,MACT;AAEA,aAAO,GAAG,EAAE,YAAY,MAAM;AAAA,IAChC;AAAA;AAAA;AAAA;AAAA,IAKA,QAAQ,OAAOJ,cAAuB;AAEpC,YAAM,mBAAmB,MAAM,iBAAiB,kBAAkBA,SAAQ;AAC1E,UAAI,QAAQ,gBAAgB,GAAG;AAC7B,eAAO;AAAA,MACT;AAEA,YAAM,EAAE,OAAAH,QAAO,KAAA,IAAS;AAIxB,UAAI,YAAY,gBAAgB;AAE9B,YAAI,QAAQ,KAAK,UAAUA,QAAO;AAChC,iBAAO,IAAI,oBAAoB,EAAE,OAAO,gCAAgC;AAAA,QAC1E;AAAA,MACF;AAGA,YAAM,eAAe,MAAM,WAAWA,QAAO,MAAM,SAAS,OAAO;AAEnE,UAAI,QAAQ,YAAY,GAAG;AACzB,eAAO,IAAI,aAAa,SAAS,EAAE,MAAM,aAAa,SAAS;AAAA,MACjE;AAEA,YAAM,eAAe;AAKrB,UAAI;AACJ,UAAI,YAAY,gBAAgB;AAC9B,qBAAa,MAAM,WAAW,YAAY,QAAQ,KAAK,EAAE;AAAA,MAC3D,OAAO;AACL,qBAAa,MAAM,WAAW,eAAeA,MAAK;AAAA,MACpD;AAEA,UAAI,QAAQ,UAAU,GAAG;AAEvB,eAAO,MAAM,yBAAyB,EAAE,OAAAA,QAAO,SAAS,QAAQ,QAAQ,KAAK,IAAI,OAAO,aAAa,UAAU,GAAG;AAClH,eAAO,IAAI,kBAAkB,QAAW,EAAE,QAAQ,KAAK;AAAA,MACzD;AAEA,YAAM,OAAO;AAGb,cAAQ,SAAA;AAAA,QACN,KAAK,UAAU;AAEb,gBAAM,eAAe,MAAM,WAAW,iBAAiB,KAAK,IAAI,QAAQ;AAExE,cAAI,QAAQ,YAAY,GAAG;AAEzB,gBAAI,cAAc,YAAY,GAAG;AAC/B,qBAAO,MAAM,8BAA8B,EAAE,QAAQ,KAAK,IAAI,SAAS,OAAO,aAAa,YAAY,EAAA,CAAG;AAAA,YAC5G;AACA,mBAAO;AAAA,UACT;AAGA,gBAAM,cAAc;AAAA,YAClB,GAAG;AAAA,YACH,QAAQ;AAAA,UAAA;AAGV,gBAAM,sBAAsB,MAAM,kBAAkB,SAAS,SAAS,EAAE,MAAM,aAAa;AAE3F,cAAI,QAAQ,mBAAmB,GAAG;AAEhC,mBAAO,QAAQ,gCAAgC,EAAE,QAAQ,KAAK,IAAI,OAAO,aAAa,mBAAmB,GAAG;AAAA,UAC9G;AAGA,iBAAO,GAAG;AAAA,YACR,eAAe,QAAQ,mBAAmB,IAAI,SAAY;AAAA,YAC1D,YAAY,YAAY,OAAO,YAAY,kBAAkB;AAAA,UAAA,CAC9D;AAAA,QACH;AAAA,QAEA,KAAK,gBAAgB;AAEnB,cAAI,CAAC,KAAK,WAAW,KAAK,QAAQ,SAAS,gBAAgB;AACzD,mBAAO,MAAM,0CAA0C,EAAE,QAAQ,KAAK,IAAI,OAAAA,QAAO;AACjF,mBAAO,IAAI,kEAAkE;AAAA,UAC/E;AAEA,gBAAM,WAAW,KAAK,QAAQ;AAC9B,gBAAM,WAAW,KAAK;AAGtB,cAAIA,WAAU,UAAU;AACtB,mBAAO,MAAM,sCAAsC;AAAA,cACjD,QAAQ,KAAK;AAAA,cACb,eAAe;AAAA,cACf,aAAaA;AAAA,YAAA,CACd;AACD,mBAAO,IAAI,mCAAmC;AAAA,UAChD;AAGA,gBAAM,eAAe,MAAM,WAAW,gBAAgB,KAAK,IAAI,QAAQ;AAEvE,cAAI,QAAQ,YAAY,GAAG;AAEzB,gBAAI,cAAc,YAAY,GAAG;AAC/B,qBAAO,MAAM,2CAA2C,EAAE,QAAQ,KAAK,IAAI,OAAO,aAAa,YAAY,GAAG;AAAA,YAChH;AACA,mBAAO;AAAA,UACT;AAGA,gBAAMU,gBAAe,MAAM,WAAW,iBAAiB,KAAK,IAAI,QAAQ;AAExE,cAAI,QAAQA,aAAY,GAAG;AAEzB,mBAAO,QAAQ,4CAA4C,EAAE,QAAQ,KAAK,IAAI,OAAO,aAAaA,aAAY,GAAG;AAAA,UACnH;AAGA,gBAAM,qBAAqB,MAAM,WAAW,kBAAkB,KAAK,IAAI,IAAI;AAE3E,cAAI,QAAQ,kBAAkB,GAAG;AAE/B,mBAAO,QAAQ,4CAA4C;AAAA,cACzD,QAAQ,KAAK;AAAA,cACb,OAAO,aAAa,kBAAkB;AAAA,YAAA,CACvC;AAAA,UACH;AAGA,gBAAM,cAAc;AAAA,YAClB,GAAG;AAAA,YACH,OAAO;AAAA,YACP,QAAQ;AAAA,YACR,SAAS;AAAA,UAAA;AAGX,gBAAM,sBAAsB,MAAM,kBAAkB,SAAS,SAAS,EAAE,MAAM,aAAa;AAE3F,cAAI,QAAQ,mBAAmB,GAAG;AAEhC,mBAAO,QAAQ,6CAA6C,EAAE,QAAQ,KAAK,IAAI,OAAO,aAAa,mBAAmB,GAAG;AAAA,UAC3H;AAEA,iBAAO,KAAK,8BAA8B;AAAA,YACxC,QAAQ,KAAK;AAAA,YACb;AAAA,YACA;AAAA,UAAA,CACD;AAGD,iBAAO,GAAG;AAAA,YACR,eAAe,QAAQ,mBAAmB,IAAI,SAAY;AAAA,YAC1D,YAAY,YAAY,OAAO,WAAW,kBAAkB;AAAA,UAAA,CAC7D;AAAA,QACH;AAAA,QAEA,KAAK,YAAY;AAGf,iBAAO,KAAK,2BAA2B,EAAE,QAAQ,KAAK,IAAI,OAAAV,QAAO;AAEjE,iBAAO,GAAG;AAAA,YACR,YAAY,YAAY,OAAO,UAAU,kBAAkB;AAAA,UAAA,CAC5D;AAAA,QACH;AAAA,QAEA,KAAK,kBAAkB;AAGrB,cAAI,CAAC,KAAK,WAAW,KAAK,QAAQ,SAAS,kBAAkB;AAC3D,mBAAO,MAAM,4CAA4C,EAAE,QAAQ,KAAK,IAAI,OAAAA,QAAO;AACnF,mBAAO,IAAI,sEAAsE;AAAA,UACnF;AAGA,gBAAM,eAAe,MAAM,WAAW,kBAAkB,KAAK,EAAE;AAE/D,cAAI,QAAQ,YAAY,GAAG;AAEzB,gBAAI,cAAc,YAAY,GAAG;AAC/B,qBAAO,MAAM,sCAAsC,EAAE,QAAQ,KAAK,IAAI,OAAO,aAAa,YAAY,GAAG;AAAA,YAC3G;AACA,mBAAO;AAAA,UACT;AAEA,iBAAO,KAAK,gCAAgC;AAAA,YAC1C,QAAQ,KAAK;AAAA,YACb,OAAAA;AAAA,UAAA,CACD;AAGD,iBAAO,GAAG;AAAA,YACR,YAAY,YAAY,OAAO,aAAa,kBAAkB;AAAA,YAC9D,gBAAgB;AAAA,UAAA,CACjB;AAAA,QACH;AAAA,QAEA,KAAK;AAAA,QACL,KAAK,kBAAkB;AAErB,iBAAO,GAAG;AAAA,YACR,UAAU;AAAA,YACV;AAAA,YACA,UAAU,aAAa;AAAA,UAAA,CACxB;AAAA,QACH;AAAA,QAEA,SAAS;AACP,iBAAO,IAAI,8BAA8B;AAAA,QAC3C;AAAA,MAAA;AAAA,IAEJ;AAAA,EAAA;AAIF,QAAM,SAAS,MAAM,aAAa,UAAU,QAAQ;AAEpD,MAAI,QAAQ,MAAM,GAAG;AAEnB,QAAI,cAAc,MAAM,GAAG;AACzB,aAAO,MAAM,uBAAuB,EAAE,OAAO,aAAa,MAAM,GAAG,OAAO,QAAQ,KAAK,MAAA,CAAO;AAC9F,uBAAiB,OAAO,SAAS,OAAO,MAAa;AAAA,IACvD;AAGA,WAAO,aAAa,MAAM;AAAA,EAC5B;AAGA,QAAM,aAAa;AACnB,MAAI,WAAW,YAAY;AAEzB,QAAI,WAAW,gBAAgB;AAC7B,YAAM,gBAAgB,MAAM,mBAAmB,SAAS,OAAO;AAG/D,YAAM,gBAAgB,WAAW,YAAY;AAAA,QAC3C,SAAS,EAAE,cAAc,CAAC,QAAQ,aAAa,IAAI,gBAAgB,GAAA;AAAA,MAAG,CACvE;AAAA,IACH;AAGA,UAAM,gBAAgB,WAAW,YAAY;AAAA,MAC3C,SAAS,WAAW,gBAAgB,EAAE,cAAc,WAAW,kBAAkB;AAAA,IAAA,CAClF;AAAA,EACH;AAGA,SAAO,UAAU,MAAM;AACzB;AC/YO,MAAM,kCAAkC,oBAAoB;AAAA,EACjE,WAAW,CAAC,EAAE,UAAU,eACtB,qBAAC,MAAA,EAAK,MAAK,MACT,UAAA;AAAA,IAAA,oBAAC,MAAA,EAAK;AAAA,wBACL,MAAA,EAAK,WAAU,sBACd,UAAA,qBAAC,WAAA,EAAU,WAAU,qDACnB,UAAA;AAAA,MAAA,oBAAC,SAAA,EAAQ,WAAU,mBACjB,UAAA,oBAAC,WAAQ,OAAO,GAAG,6CAA+B,EAAA,CACpD;AAAA,MAEA,qBAAC,SAAA,EAAQ,WAAU,kEACjB,UAAA;AAAA,QAAA,qBAAC,MAAA,EAAK,UAAA;AAAA,UAAA;AAAA,UAC2D,oBAAC,YAAQ,UAAA,SAAA,CAAS;AAAA,UAAS;AAAA,UAAI,oBAAC,YAAQ,UAAA,SAAA,CAAS;AAAA,UAAS;AAAA,QAAA,GAC3H;AAAA,6BACC,MAAA,EAAK,UAAA;AAAA,UAAA;AAAA,UAC4B,oBAAC,YAAQ,UAAA,SAAA,CAAS;AAAA,UAAS;AAAA,QAAA,GAC7D;AAAA,QACA,oBAAC,QAAK,UAAA,wFAAA,CAAqF;AAAA,MAAA,GAC7F;AAAA,MAEA,qBAAC,SAAA,EAAQ,WAAU,iDACjB,UAAA;AAAA,QAAA,oBAAC,QAAK,UAAA,uJAAA,CAAoJ;AAAA,4BACzJ,SAAA,EAAQ,OAAO,GAAG,WAAU,oBAAmB,UAAA,2CAEhD;AAAA,QACA,qBAAC,SAAA,EAAQ,WAAU,8BACjB,UAAA;AAAA,UAAA,qBAAC,MAAA,EAAK,WAAU,UAAS,UAAA;AAAA,YAAA;AAAA,YAA6B;AAAA,UAAA,GAAS;AAAA,UAC/D,oBAAC,MAAA,EAAK,WAAU,UAAS,UAAA,+CAA2C;AAAA,UACpE,oBAAC,MAAA,EAAK,WAAU,UAAS,UAAA,kCAAA,CAA+B;AAAA,QAAA,EAAA,CAC1D;AAAA,MAAA,EAAA,CACF;AAAA,IAAA,EAAA,CACF,EAAA,CACF;AAAA,EAAA,GACF;AAAA,EAGF,SAAS,MAAM;AAAA,EAEf,WAAW;AACb,CAAC;ACrCM,MAAM,kCAAkC,oBAAoB;AAAA,EACjE,WAAW,CAAC,EAAE,MAAM,UAAU,UAAU,sBACtC,qBAAC,MAAA,EAAK,MAAK,MACT,UAAA;AAAA,IAAA,oBAAC,MAAA,EAAK;AAAA,wBACL,MAAA,EAAK,WAAU,sBACd,UAAA,qBAAC,WAAA,EAAU,WAAU,qDACnB,UAAA;AAAA,MAAA,oBAAC,SAAA,EAAQ,WAAU,+BACjB,UAAA,oBAAC,WAAQ,OAAO,GAAG,+CAAiC,EAAA,CACtD;AAAA,MAEA,qBAAC,SAAA,EAAQ,WAAU,kEACjB,UAAA;AAAA,QAAA,qBAAC,MAAA,EAAK,UAAA;AAAA,UAAA;AAAA,UACiC,oBAAC,YAAQ,UAAA,SAAA,CAAS;AAAA,UAAS;AAAA,UAAI,oBAAC,YAAQ,UAAA,SAAA,CAAS;AAAA,UAAS;AAAA,QAAA,GACjG;AAAA,QACA,oBAAC,QAAK,UAAA,gEAAA,CAA6D;AAAA,MAAA,GACrE;AAAA,MAEA,oBAAC,WAAQ,WAAU,kEACjB,8BAAC,MAAA,EAAK,WAAU,4DAA4D,UAAA,KAAA,CAAK,EAAA,CACnF;AAAA,MAEA,oBAAC,SAAA,EAAQ,WAAU,iDACjB,+BAAC,MAAA,EAAK,UAAA;AAAA,QAAA;AAAA,QACyB,oBAAC,YAAO,UAAA,YAAA,CAAS;AAAA,QAAS;AAAA,MAAA,EAAA,CACzD,EAAA,CACF;AAAA,MAEC,mBACC,qBAAC,SAAA,EAAQ,WAAU,4CACjB,UAAA;AAAA,QAAA,oBAAC,MAAA,EAAK,WAAU,QACd,UAAA,oBAAC,MAAA,EAAK,MAAM,iBAAiB,WAAU,0BAAyB,UAAA,wCAAA,CAEhE,GACF;AAAA,QAEA,qBAAC,MAAA,EAAK,WAAU,QACd,UAAA;AAAA,UAAA,oBAAC,QAAK,UAAA,uEAAA,CAAoE;AAAA,8BACzE,MAAA,EAAK,MAAM,iBAAiB,WAAU,aACpC,UAAA,gBAAA,CACH;AAAA,QAAA,EAAA,CACF;AAAA,MAAA,GACF;AAAA,MAGF,qBAAC,SAAA,EAAQ,WAAU,iDACjB,UAAA;AAAA,QAAA,oBAAC,QAAK,UAAA,gJAAA,CAA6I;AAAA,4BAClJ,SAAA,EAAQ,OAAO,GAAG,WAAU,oBAAmB,UAAA,2CAEhD;AAAA,QACA,qBAAC,SAAA,EAAQ,WAAU,8BACjB,UAAA;AAAA,UAAA,qBAAC,MAAA,EAAK,WAAU,UAAS,UAAA;AAAA,YAAA;AAAA,YACrB,oBAAC,YAAO,UAAA,sCAAA,CAAmC;AAAA,UAAA,GAC/C;AAAA,UACA,qBAAC,MAAA,EAAK,WAAU,UAAS,UAAA;AAAA,YAAA;AAAA,YAA6B;AAAA,UAAA,GAAS;AAAA,UAC/D,oBAAC,MAAA,EAAK,WAAU,UAAS,UAAA,+CAA2C;AAAA,UACpE,oBAAC,MAAA,EAAK,WAAU,UAAS,UAAA,kCAAA,CAA+B;AAAA,QAAA,EAAA,CAC1D;AAAA,MAAA,EAAA,CACF;AAAA,IAAA,EAAA,CACF,EAAA,CACF;AAAA,EAAA,GACF;AAAA,EAGF,SAAS,MAAM;AAAA,EAEf,WAAW;AACb,CAAC;AC1DD,SAAS,kBAAkB,QAAwB;AACjD,SAAO,gBAAgB,MAAM;AAC/B;AAMA,eAAsB,yBACpB,QACA,UACA,UACA,SACA,WACA,gBAAgB,KACO;AACvB,MAAI;AACF,UAAM,KAAK,WAAW,SAAS,SAAuB;AAEtD,QAAI,CAAC,IAAI;AACP,aAAO,MAAM,qCAAqC,EAAE,QAAQ,WAAW;AACvE,aAAO,IAAI,2BAA2B;AAAA,IACxC;AAEA,UAAM,gBAAoC;AAAA,MACxC;AAAA,MACA;AAAA,MACA;AAAA,MACA,aAAa,KAAK,IAAA;AAAA,IAAI;AAGxB,UAAM,GAAG,IAAI,kBAAkB,MAAM,GAAG,KAAK,UAAU,aAAa,GAAG;AAAA,MACrE;AAAA,IAAA,CACD;AAED,WAAO,KAAK,gCAAgC;AAAA,MAC1C;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,IAAA,CACD;AAED,WAAO,GAAG,MAAS;AAAA,EACrB,SAAS,OAAO;AACd,WAAO,MAAM,wCAAwC;AAAA,MACnD;AAAA,MACA,OAAO,iBAAiB,QAAQ,MAAM,UAAU;AAAA,IAAA,CACjD;AACD,WAAO,IAAI,yCAAyC,EAAE,OAAO;AAAA,EAC/D;AACF;AAMA,eAAsB,sBAAsB,QAAgB,SAA0C,WAA+D;AACnK,MAAI;AACF,UAAM,KAAK,WAAW,SAAS,SAAuB;AAEtD,QAAI,CAAC,IAAI;AACP,aAAO,MAAM,qCAAqC,EAAE,QAAQ,WAAW;AACvE,aAAO,IAAI,2BAA2B;AAAA,IACxC;AAEA,UAAM,QAAQ,MAAM,GAAG,IAAI,kBAAkB,MAAM,GAAG,MAAM;AAE5D,QAAI,CAAC,OAAO;AACV,aAAO,GAAG,IAAI;AAAA,IAChB;AAEA,UAAM,gBAAgB,KAAK,MAAM,KAAK;AAEtC,WAAO,MAAM,kCAAkC;AAAA,MAC7C;AAAA,MACA,UAAU,cAAc;AAAA,IAAA,CACzB;AAED,WAAO,GAAG,aAAa;AAAA,EACzB,SAAS,OAAO;AACd,WAAO,MAAM,yCAAyC;AAAA,MACpD;AAAA,MACA,OAAO,iBAAiB,QAAQ,MAAM,UAAU;AAAA,IAAA,CACjD;AACD,WAAO,IAAI,2CAA2C,EAAE,OAAO;AAAA,EACjE;AACF;AAMA,eAAsB,yBAAyB,QAAgB,SAA0C,WAA0C;AACjJ,MAAI;AACF,UAAM,KAAK,WAAW,SAAS,SAAuB;AAEtD,QAAI,CAAC,IAAI;AACP,aAAO,MAAM,qCAAqC,EAAE,QAAQ,WAAW;AACvE,aAAO,IAAI,2BAA2B;AAAA,IACxC;AAEA,UAAM,GAAG,OAAO,kBAAkB,MAAM,CAAC;AAEzC,WAAO,KAAK,gCAAgC,EAAE,OAAA,CAAQ;AAEtD,WAAO,GAAG,MAAS;AAAA,EACrB,SAAS,OAAO;AACd,WAAO,MAAM,wCAAwC;AAAA,MACnD;AAAA,MACA,OAAO,iBAAiB,QAAQ,MAAM,UAAU;AAAA,IAAA,CACjD;AACD,WAAO,IAAI,yCAAyC,EAAE,OAAO;AAAA,EAC/D;AACF;AAMA,eAAsB,4BAA4B,UAAkB,UAAkB,SAAiE;AACrJ,MAAI;AACF,UAAM,eAAe,MAAM,oBAAoB,iCAAiC;AAAA,MAC9E;AAAA,MACA;AAAA,IAAA,CACD;AAGD,UAAM,aAAa,MAAM,SAAS,SAAS;AAAA,MACzC,IAAI;AAAA,MACJ,UAAU;AAAA,IAAA,CACX;AAED,QAAI,QAAQ,UAAU,GAAG;AACvB,aAAO,MAAM,yCAAyC;AAAA,QACpD;AAAA,QACA;AAAA,QACA,OAAO,aAAa,UAAU;AAAA,MAAA,CAC/B;AACD,aAAO;AAAA,IACT;AAEA,WAAO,KAAK,kCAAkC,EAAE,UAAU,UAAU;AACpE,WAAO,GAAG,MAAS;AAAA,EACrB,SAAS,OAAO;AACd,WAAO,MAAM,8CAA8C;AAAA,MACzD;AAAA,MACA;AAAA,MACA,OAAO,iBAAiB,QAAQ,MAAM,UAAU;AAAA,MAChD,OAAO,iBAAiB,QAAQ,MAAM,QAAQ;AAAA,IAAA,CAC/C;AACD,WAAO,IAAI,4CAA4C,EAAE,OAAO;AAAA,EAClE;AACF;AAMA,eAAe,4BAA4B,UAAkB,UAAkB,SAA0C,iBAAiD;AACxK,MAAI;AAEF,UAAM,aAAa,MAAM,uBAAuB,UAAU,gBAAgB,SAAS,EAAE,UAAU,UAAU;AAEzG,QAAI,QAAQ,UAAU,GAAG;AACvB,aAAO,MAAM,oDAAoD;AAAA,QAC/D;AAAA,QACA;AAAA,QACA,OAAO,aAAa,UAAU;AAAA,MAAA,CAC/B;AACD,aAAO;AAAA,IACT;AAEA,UAAM,OAAO;AAGb,UAAM,gBAAgB,MAAM,oBAAoB,iCAAiC;AAAA,MAC/E;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,IAAA,CACD;AAGD,UAAM,aAAa,MAAM,SAAS,SAAS;AAAA,MACzC,IAAI;AAAA,MACJ,UAAU;AAAA,IAAA,CACX;AAED,QAAI,QAAQ,UAAU,GAAG;AACvB,aAAO,MAAM,yCAAyC;AAAA,QACpD;AAAA,QACA;AAAA,QACA,OAAO,aAAa,UAAU;AAAA,MAAA,CAC/B;AACD,aAAO;AAAA,IACT;AAEA,WAAO,KAAK,kCAAkC,EAAE,UAAU,UAAU;AACpE,WAAO,GAAG,MAAS;AAAA,EACrB,SAAS,OAAO;AACd,WAAO,MAAM,8CAA8C;AAAA,MACzD;AAAA,MACA;AAAA,MACA,OAAO,iBAAiB,QAAQ,MAAM,UAAU;AAAA,MAChD,OAAO,iBAAiB,QAAQ,MAAM,QAAQ;AAAA,IAAA,CAC/C;AACD,WAAO,IAAI,4CAA4C,EAAE,OAAO;AAAA,EAClE;AACF;AAQA,eAAsB,mBAAmB,QAAgB,UAAkB,UAAkB,SAA0C,WAAmB,iBAAiD;AAEzM,QAAM,eAAe,MAAM,yBAAyB,QAAQ,UAAU,UAAU,SAAS,SAAS;AAElG,MAAI,QAAQ,YAAY,GAAG;AACzB,WAAO;AAAA,EACT;AAGA,QAAM,qBAAqB,MAAM,4BAA4B,UAAU,UAAU,SAAS,eAAe;AAEzG,MAAI,QAAQ,kBAAkB,GAAG;AAE/B,UAAM,yBAAyB,QAAQ,SAAS,SAAS;AACzD,WAAO;AAAA,EACT;AAGA,QAAM,qBAAqB,MAAM,4BAA4B,UAAU,UAAU,OAAO;AAExF,MAAI,QAAQ,kBAAkB,GAAG;AAE/B,WAAO,QAAQ,8CAA8C;AAAA,MAC3D;AAAA,MACA;AAAA,MACA;AAAA,MACA,OAAO,aAAa,kBAAkB;AAAA,IAAA,CACvC;AAAA,EACH;AAEA,SAAO,KAAK,kCAAkC,EAAE,QAAQ,UAAU,UAAU;AAE5E,SAAO,GAAG,MAAS;AACrB;ACnQA,MAAM,8BAA8B;AACpC,MAAM,8BAA8B;AAYpC,eAAsB,kBAAkB,SAA0C,QAAgB,YAAsC,WAAmB,QAAgB,SAAkD;AAC3N,QAAM,OAAO,kBAAkB,OAAO;AACtC,QAAM,aAAa,WAAW,SAAS,iBAAiB;AAExD,MAAI,CAAC,YAAY;AACf,WAAO,IAAI,gCAAgC,EAAE,OAAO,WAAW;AAAA,EACjE;AAGA,QAAM,OAAO,YAAY,SAAS,OAAO;AAGzC,QAAM,aAAa,WAAW,SAAS,YAAY,WAAW,SAAS,WAAW,SAAS,SAAS,IAAI;AAGxG,QAAM,cAAc,MAAM,KAAK,4BAA4B,MAAM;AACjE,MAAI,QAAQ,WAAW,GAAG;AACxB,WAAO;AAAA,EACT;AAEA,MAAI,eAAe,6BAA6B;AAC9C,WAAO,QAAQ,2BAA2B,EAAE,QAAQ,OAAO,aAAa;AACxE,WAAO,IAAI,4CAA4C;AAAA,MACrD,OAAO,6BAA6B,2BAA2B;AAAA,IAAA,CAChE;AAAA,EACH;AAGA,QAAM,qBAAqB,MAAM,mBAAmB,YAAY,WAAW,QAAQ,MAAM,UAAU;AAEnG,MAAI,QAAQ,kBAAkB,GAAG;AAC/B,WAAO,MAAM,mCAAmC,EAAE,QAAQ,OAAO,oBAAoB;AACrF,WAAO;AAAA,EACT;AAGA,QAAM,eAAe,MAAM,KAAK,oBAAoB,EAAE,GAAG,oBAAoB,QAAQ;AAErF,MAAI,QAAQ,YAAY,GAAG;AACzB,WAAO,MAAM,6BAA6B,EAAE,QAAQ,OAAO,cAAc;AACzE,WAAO;AAAA,EACT;AAEA,SAAO,GAAG,YAAY;AACxB;AAKA,eAAsB,cAAc,SAA0C,QAAgB,iBAAyB,SAAiD;AACtK,QAAM,OAAO,kBAAkB,OAAO;AAGtC,QAAM,kBAAkB,MAAM,KAAK,2BAA2B,iBAAiB,MAAM;AACrF,MAAI,QAAQ,eAAe,GAAG;AAC5B,WAAO,MAAM,yCAAyC,EAAE,QAAQ,iBAAiB,OAAO,iBAAiB;AACzG,WAAO;AAAA,EACT;AAEA,MAAI,CAAC,iBAAiB;AACpB,WAAO,QAAQ,+BAA+B,EAAE,QAAQ,iBAAiB;AACzE,WAAO,IAAI,2CAA2C;AAAA,MACpD,eAAe;AAAA,IAAA,CAChB;AAAA,EACH;AAGA,QAAM,cAAc,QAAQ,KAAA;AAC5B,MAAI,YAAY,SAAS,KAAK,YAAY,SAAS,IAAI;AACrD,WAAO,IAAI,8BAA8B;AAAA,MACvC,MAAM;AAAA,IAAA,CACP;AAAA,EACH;AAGA,QAAM,eAAe,MAAM,KAAK,wBAAwB,iBAAiB,WAAW;AACpF,MAAI,QAAQ,YAAY,GAAG;AACzB,WAAO,MAAM,yBAAyB,EAAE,QAAQ,iBAAiB,OAAO,cAAc;AACtF,WAAO;AAAA,EACT;AAEA,SAAO,GAAG,YAAY;AACxB;AAKA,eAAsB,cAAc,SAA0C,QAAgB,iBAAmD;AAC/I,QAAM,OAAO,kBAAkB,OAAO;AAGtC,QAAM,kBAAkB,MAAM,KAAK,2BAA2B,iBAAiB,MAAM;AACrF,MAAI,QAAQ,eAAe,GAAG;AAC5B,WAAO,MAAM,yCAAyC,EAAE,QAAQ,iBAAiB,OAAO,iBAAiB;AACzG,WAAO;AAAA,EACT;AAEA,MAAI,CAAC,iBAAiB;AACpB,WAAO,QAAQ,+BAA+B,EAAE,QAAQ,iBAAiB;AACzE,WAAO,IAAI,2CAA2C;AAAA,MACpD,eAAe;AAAA,IAAA,CAChB;AAAA,EACH;AAGA,QAAM,cAAc,MAAM,KAAK,4BAA4B,MAAM;AACjE,MAAI,QAAQ,WAAW,GAAG;AACxB,WAAO,MAAM,+BAA+B,EAAE,QAAQ,OAAO,aAAa;AAC1E,WAAO;AAAA,EACT;AAEA,MAAI,eAAe,6BAA6B;AAC9C,WAAO,QAAQ,mCAAmC,EAAE,QAAQ,OAAO,aAAa;AAChF,WAAO,IAAI,oCAAoC;AAAA,MAC7C,eAAe;AAAA,IAAA,CAChB;AAAA,EACH;AAGA,QAAM,eAAe,MAAM,KAAK,oBAAoB,eAAe;AACnE,MAAI,QAAQ,YAAY,GAAG;AACzB,WAAO,MAAM,yBAAyB,EAAE,QAAQ,iBAAiB,OAAO,cAAc;AACtF,WAAO;AAAA,EACT;AAEA,SAAO,GAAG,IAAI;AAChB;AAKA,eAAsB,0BACpB,SACA,SACA,QACA,QACA,MACqF;AACrF,QAAM,OAAO,kBAAkB,OAAO;AACtC,QAAM,cAAc,MAAM,eAAe,SAAS,OAAO;AAEzD,MAAI,QAAQ,WAAW,GAAG;AACxB,WAAO;AAAA,EACT;AAEA,MAAI,CAAC,eAAe,CAAC,YAAY,MAAM;AACrC,WAAO,IAAI,0BAA0B,EAAE,MAAM,sCAAsC;AAAA,EACrF;AAEA,QAAM,UAAU;AAGhB,QAAM,sBAAsB,MAAM,KAAK,0BAA0B,MAAM;AACvE,MAAI,QAAQ,mBAAmB,GAAG;AAChC,WAAO,MAAM,uCAAuC,EAAE,QAAQ,OAAO,qBAAqB;AAC1F,WAAO;AAAA,EACT;AAGA,QAAM,qBAAqB,oBAAoB,IAAI,CAAC,UAAyB,EAAE,IAAI,KAAK,IAAI,YAAY,KAAK,WAAA,EAAyC;AACtJ,QAAM,YAAY,kBAAA;AAClB,QAAM,UAAU,0BAA0B,QAAQ,MAAM,QAAQ,KAAK,OAAO,QAAQ,KAAK,aAAa,WAAW,kBAAkB;AAEnI,SAAO,GAAG,EAAE,WAAW,SAAS;AAClC;ACrLO,SAAS,sBAAsB,KAAuB;AAC3D,MAAI,eAAe,aAAa;AAC9B,WAAO;AAAA,EACT;AAGA,MAAI,OAAO,QAAQ,YAAY,QAAQ,MAAM;AAC3C,UAAM,OAAO,OAAO,KAAK,GAAG;AAE5B,QAAI,KAAK,SAAS,KAAK,KAAK,MAAM,SAAO,QAAQ,KAAK,GAAG,CAAC,GAAG;AAC3D,YAAM,QAAQ,OAAO,OAAO,GAAG;AAC/B,YAAM,aAAa,IAAI,WAAW,KAAK;AAEvC,YAAM,SAAS,IAAI,YAAY,WAAW,MAAM;AAChD,UAAI,WAAW,MAAM,EAAE,IAAI,UAAU;AACrC,aAAO;AAAA,IACT;AAAA,EACF;AAGA,MAAI,OAAO,QAAQ,UAAU;AAC3B,UAAM,aAAa,gBAAgB,GAAG;AACtC,UAAM,SAAS,IAAI,YAAY,WAAW,MAAM;AAChD,QAAI,WAAW,MAAM,EAAE,IAAI,UAAU;AACrC,WAAO;AAAA,EACT;AAGA,SAAO,IAAI,YAAY,CAAC;AAC1B;AAUO,SAAS,+BAA+B,eAAoB,iBAA6D;AAE9H,QAAM,sBAAsB,gBAAgB,eAAe;AAC3D,QAAM,kBAAkB,IAAI,YAAY,oBAAoB,MAAM;AAClE,MAAI,WAAW,eAAe,EAAE,IAAI,mBAAmB;AAEvD,SAAO;AAAA,IACL,GAAG;AAAA,IACH,WAAW;AAAA,IACX,MAAM;AAAA,MACJ,GAAG,cAAc;AAAA,MACjB,IAAI,sBAAsB,cAAc,KAAK,EAAE;AAAA,IAAA;AAAA,IAEjD,oBACE,cAAc,oBAAoB,IAAI,CAAC,UAAe;AAAA,MACpD,GAAG;AAAA,MACH,IAAI,sBAAsB,KAAK,EAAE;AAAA,IAAA,EACjC,KAAK,CAAA;AAAA,EAAC;AAEd;AASO,SAAS,mCAAmC,YAmBjD;AAEA,QAAM,kBAAkB,gBAAgB,WAAW,KAAK;AACxD,QAAM,cAAc,IAAI,YAAY,gBAAgB,MAAM;AAC1D,MAAI,WAAW,WAAW,EAAE,IAAI,eAAe;AAE/C,QAAM,wBAAwB,gBAAgB,WAAW,SAAS,iBAAiB;AACnF,QAAM,oBAAoB,IAAI,YAAY,sBAAsB,MAAM;AACtE,MAAI,WAAW,iBAAiB,EAAE,IAAI,qBAAqB;AAE3D,QAAM,uBAAuB,gBAAgB,WAAW,SAAS,cAAc;AAC/E,QAAM,mBAAmB,IAAI,YAAY,qBAAqB,MAAM;AACpE,MAAI,WAAW,gBAAgB,EAAE,IAAI,oBAAoB;AAEzD,SAAO;AAAA,IACL,IAAI,WAAW;AAAA,IACf,OAAO;AAAA,IACP,UAAU;AAAA,MACR,mBAAmB;AAAA,MACnB,gBAAgB;AAAA,MAChB,YAAY,WAAW,UAAU;AAAA,IAAA;AAAA,IAEnC,MAAM;AAAA,IACN,yBAAyB,WAAW;AAAA,EAAA;AAExC;","x_google_ignoreList":[2,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28]}